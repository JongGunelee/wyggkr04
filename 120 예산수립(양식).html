<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê±´ë¬¼ ë™ë³„ ìš´ì˜ì„± ì‘ì—…ë¹„ ë° ì„¸ëŒ€ìˆ˜ ë¶„ì„ (Integrity Verified)</title>
    <!-- Tailwind CSS -->
    <script>
        // [Clean] Suppress Tailwind CDN production warning for standalone HTML
        (function () {
            const _warn = console.warn;
            console.warn = function (...args) {
                if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
                _warn.apply(console, args);
            };
        })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Table Sticky Header Styles */
        th.sticky-col {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        td.sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: inherit;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        #loadingOverlay.hidden {
            display: none !important;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Toast Animation */
        @keyframes fade-in {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }

        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 4px;
            vertical-align: middle;
        }

        /* [Integrity] ì „ì—­ íˆ´íŒ ë ˆì´ì–´ ìŠ¤íƒ€ì¼ (Global Tooltip) */
        #global-tooltip {
            position: fixed;
            z-index: 100000;
            /* ìµœìƒìœ„ ë ˆë²¨ */
            background-color: #1e293b;
            /* slate-800 */
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            line-height: 1.4;
            max-width: 300px;
            width: max-content;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            pointer-events: none;
            /* ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ í†µê³¼ */
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.15s ease, visibility 0.15s ease;
            white-space: normal;
            word-break: keep-all;
            text-align: left;
            /* ê¸°ë³¸ ì™¼ìª½ ì •ë ¬ */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* íˆ´íŒ ë‚´ë¶€ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        #global-tooltip table {
            width: 100%;
            margin-top: 4px;
            border-collapse: collapse;
        }

        #global-tooltip th {
            text-align: center;
            border-bottom: 1px solid #475569;
            color: #fbbf24;
            /* amber-400 */
            padding: 2px 4px;
        }

        #global-tooltip td {
            text-align: right;
            padding: 2px 4px;
            border-bottom: 1px solid #334155;
        }

        #global-tooltip .prediction-header {
            text-align: center;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid #475569;
        }

        /* ê¸°ì¡´ .tooltip-contentëŠ” ë°ì´í„° ì†ŒìŠ¤ë¡œë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ìˆ¨ê¹€ */
        .tooltip-content {
            display: none !important;
        }

        .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #334155 transparent transparent transparent;
        }

        /* [Integrity] íˆ´íŒì´ ì•„ë˜ë¡œ ë’¤ì§‘í ë•Œ í™”ì‚´í‘œë¥¼ ìœ„ë¡œ ì´ë™ */
        .tooltip-content.arrow-top::after {
            top: auto;
            bottom: 100%;
            border-color: transparent transparent #334155 transparent;
        }

        .tooltip-content.right-align {
            left: auto;
            right: 0;
            transform: none;
        }

        .tooltip-content.right-align::after {
            left: auto;
            right: 10px;
        }


        thead .tooltip-container:hover .tooltip-content,
        th .tooltip-container:hover .tooltip-content {
            z-index: 99999;
        }

        /* Prediction Tooltip Table Style */
        .tooltip-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 4px;
        }

        .tooltip-table th {
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2px;
            color: #fbbf24;
        }

        .tooltip-table td {
            text-align: right;
            padding: 2px 4px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tooltip-table tr:last-child td {
            border-bottom: none;
        }

        .prediction-header {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 4px;
            color: #fbbf24;
        }

        /* [Integrity] Tooltip Safety */
        .tooltip-content:empty {
            display: none !important;
        }

        .tooltip-container:empty {
            display: none !important;
        }

        /* [Integrity] ì¤‘ë³µ tooltip-content ì •ì˜ ì œê±°ë¨ - ë¼ì¸ 132-155ì—ì„œ ì •ì˜ë¨ */


        /* [Fix] í´ë¦­ ê¸°ë°˜ íˆ´íŒ - group-hover ë°©ì‹ ë¹„í™œì„±í™” */
        .click-tooltip {
            display: none;
        }

        .click-tooltip.show {
            display: block !important;
        }

        /* ë¬¼ìŒí‘œ ì•„ì´ì½˜ í´ë¦­ ì‹œê°ì  í‘œì‹œ */
        .tooltip-trigger {
            cursor: pointer !important;
            transition: all 0.2s ease;
        }

        .tooltip-trigger:hover {
            color: #6366f1 !important;
            transform: scale(1.1);
        }

        .tooltip-trigger.active {
            color: #4f46e5 !important;
        }

        /* [PRD/IMP] Draggable & Resizable Modal Styles */
        .modal-panel {
            position: fixed !important;
            /* [Fix] Center modal on screen - was missing causing off-screen positioning */
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            margin: 0 !important;
            display: flex !important;
            flex-direction: column !important;
            pointer-events: auto !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
            min-width: 400px;
            min-height: 200px;
            transition: none !important;
            /* ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ ì• ë‹ˆë©”ì´ì…˜ ê°„ì„­ ë°°ì œ */
            z-index: 50;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
        }

        .modal-header-handle {
            cursor: grab !important;
            user-select: none !important;
        }

        .modal-header-handle:active {
            cursor: grabbing !important;
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            background: transparent;
            z-index: 100;
        }

        .resize-handle-se {
            width: 20px;
            height: 20px;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, rgba(100, 116, 139, 0.2) 50%, rgba(100, 116, 139, 0.4) 100%);
            border-bottom-right-radius: 1rem;
        }

        .resize-handle-e {
            width: 8px;
            right: 0;
            top: 0;
            bottom: 0;
            cursor: ew-resize;
        }

        .resize-handle-s {
            height: 8px;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: ns-resize;
        }

        /* Overlay fix for draggable */
        .modal-background-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(4px);
            z-index: 40;
            pointer-events: auto !important;
            /* ë°°ê²½ í´ë¦­(ë‹«ê¸°) ê¸°ëŠ¥ ë³´ì¥ */
        }
    </style>

</head>

<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">
    <!-- User Manual Modal (Global Standalone) -->
    <div id="manualModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(4px); overflow-y: auto;"
        role="dialog" aria-modal="true">
        <div style="display: flex; min-height: 100%; align-items: center; justify-content: center; padding: 1rem;">
            <div
                style="position: relative; background: white; width: 100%; max-width: 64rem; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden;">
                <!-- Header -->
                <div
                    style="background: #f8fafc; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <h3
                        style="margin: 0; font-size: 1.25rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 0.5rem;">
                        <span style="color: #059669;">ğŸ“–</span> ê±´ë¬¼ë™ë³„ ê³µê°€ ìˆ˜ì¥ê³µì‚¬ ë¶„ì„ ì‹œìŠ¤í…œ ë§¤ë‰´ì–¼
                    </h3>
                    <button onclick="closeManualModal()"
                        style="background: none; border: none; font-size: 1.5rem; color: #94a3b8; cursor: pointer;">&times;</button>
                </div>
                <!-- Body -->
                <div style="padding: 2rem; max-height: 70vh; overflow-y: auto; color: #334155; line-height: 1.6;">
                    <div class="prose max-w-none">
                        <!-- 1. ê°œìš” -->
                        <section style="margin-bottom: 3rem;">
                            <h2
                                style="font-size: 1.6rem; font-weight: 800; color: #1e293b; border-left: 5px solid #059669; padding-left: 1rem; margin-bottom: 1.5rem;">
                                1. ì‹œìŠ¤í…œ ê°œìš” ë° ëª©ì </h2>
                            <p style="font-size: 1.05rem; color: #475569;">
                                ë³¸ ì‹œìŠ¤í…œì€ <strong>ê±´ë¬¼ë™ë³„ ê³µê°€ ìˆ˜ì¥ê³µì‚¬ ë¹„ìš© ë° ì„¸ëŒ€ìˆ˜ ë°ì´í„°</strong>ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê³¼ê±° 3ê°œë…„ ì´ìƒì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬,
                                ì°¨ê¸°ë…„ë„ ì˜ˆì‚°ì„ ê³¼í•™ì  ê·¼ê±°ì— ê¸°ë°˜í•´ ìˆ˜ë¦½í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” <strong>ì§€ëŠ¥í˜• ì˜ì‚¬ê²°ì • ì§€ì› ë„êµ¬</strong>ì…ë‹ˆë‹¤.
                            </p>
                            <div
                                style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 1.5rem; border-radius: 0.75rem; margin-top: 1rem;">
                                <ul style="margin: 0; padding-left: 1.2rem; color: #166534;">
                                    <li>ì—‘ì…€ ë°ì´í„°ì˜ ìë™ ì •ê·œí™” ë° ì˜¤íƒ€ êµì •ì„ í†µí•œ ë°ì´í„° ë¬´ê²°ì„± í™•ë³´</li>
                                    <li>ê°€ì¤‘ ì´ë™ í‰ê· (WMA) ë° ì¸í”Œë ˆì´ì…˜ ë³´ì •ì„ í†µí•œ ì˜ˆì¸¡ ì •í™•ë„ ê·¹ëŒ€í™”</li>
                                    <li>Sankey ë‹¤ì´ì–´ê·¸ë¨ì„ í†µí•œ ìê¸ˆ íë¦„(Fund Flow)ì˜ ì§ê´€ì  ì‹œê°í™”</li>
                                </ul>
                            </div>
                        </section>

                        <!-- 2. í•µì‹¬ ìš©ì–´ ì •ì˜ -->
                        <section style="margin-bottom: 3rem;">
                            <h2
                                style="font-size: 1.6rem; font-weight: 800; color: #1e293b; border-left: 5px solid #2563eb; padding-left: 1rem; margin-bottom: 1.5rem;">
                                2. í•µì‹¬ ìš©ì–´ ì •ì˜</h2>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div
                                    style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #94a3b8;">
                                    <strong style="display: block; color: #334155; margin-bottom: 0.3rem;">ê³µê°€ (Vacant
                                        Unit)</strong>
                                    <span style="font-size: 0.9rem; color: #64748b;">í‡´ê±° ë“±ìœ¼ë¡œ ë°œìƒí•œ ë¹ˆ ì„¸ëŒ€ë¡œ, ë³´ìˆ˜ ê³µì‚¬ê°€ í•„ìš”í•œ ê´€ë¦¬
                                        ëŒ€ìƒ</span>
                                </div>
                                <div
                                    style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #94a3b8;">
                                    <strong style="display: block; color: #334155; margin-bottom: 0.3rem;">ìˆ˜ì¥ê³µì‚¬
                                        (Finishing)</strong>
                                    <span style="font-size: 0.9rem; color: #64748b;">ë„ë°°, ì¥íŒ, ë„ì¥ ë“± ë¯¸ê´€ê³¼ ë‚´êµ¬ì„±ì„ ê²°ì •ì§“ëŠ” ë§ˆê°
                                        ê³µì‚¬</span>
                                </div>
                                <div
                                    style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
                                    <strong style="display: block; color: #1d4ed8; margin-bottom: 0.3rem;">WMA (Weighted
                                        Moving Average)</strong>
                                    <span style="font-size: 0.9rem; color: #64748b;">ê°€ì¤‘ ì´ë™ í‰ê· . ìµœì‹  ë°ì´í„°ì— ë†’ì€ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ëŠ” ì˜ˆì¸¡
                                        ê¸°ë²•</span>
                                </div>
                                <div
                                    style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #3b82f6;">
                                    <strong style="display: block; color: #1d4ed8; margin-bottom: 0.3rem;">ì¸í”Œë ˆì´ì…˜
                                        ë³´ì •</strong>
                                    <span style="font-size: 0.9rem; color: #64748b;">í™”í ê°€ì¹˜ í•˜ë½(ë¬¼ê°€ ìƒìŠ¹)ì„ ë°˜ì˜í•˜ì—¬ ê³¼ê±° ë¹„ìš©ì„ í˜„ì¬ ê°€ì¹˜ë¡œ
                                        í™˜ì‚°</span>
                                </div>
                            </div>
                        </section>

                        <!-- 3. ê³µì‹ ë° ì‚°ì‹ (Rich Content) -->
                        <section style="margin-bottom: 3rem;">
                            <h2
                                style="font-size: 1.6rem; font-weight: 800; color: #1e293b; border-left: 5px solid #7c3aed; padding-left: 1rem; margin-bottom: 1.5rem;">
                                3. ê³µì‹ ë° ì‚°ìˆ ì  ë…¼ë¦¬</h2>

                            <!-- 3.1 ë‹¨ìˆœ í‰ê·  vs ê°€ì¤‘ í‰ê·  -->
                            <div style="margin-bottom: 2rem;">
                                <h3 style="font-size: 1.25rem; font-weight: 700; color: #475569; margin-bottom: 1rem;">
                                    3.1 ì‚°ìˆ  í†µê³„ ëª¨ë¸ (Arithmetic Models)</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div
                                        style="background: #ffffff; border: 1px solid #e2e8f0; padding: 1.25rem; border-radius: 0.75rem;">
                                        <h4 style="margin-top: 0; color: #64748b; font-size: 0.95rem;">â‘  ë‹¨ìˆ˜ ì‚°ìˆ  í‰ê· 
                                            (Simple Average)</h4>
                                        <div
                                            style="background: #f1f5f9; padding: 0.75rem; font-family: monospace; border-radius: 0.4rem; font-size: 0.9rem; margin: 0.5rem 0;">
                                            Avg = (&Sigma;Yn) / n
                                        </div>
                                        <p style="font-size: 0.85rem; color: #64748b; margin: 0;">ëª¨ë“  ì—°ë„ì˜ ë°ì´í„°ë¥¼ ë™ì¼í•œ ë¹„ì¤‘ìœ¼ë¡œ
                                            ê³„ì‚°í•©ë‹ˆë‹¤. ë°ì´í„°ì˜ ë³€ë™ì„±ì´ ì ì„ ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.</p>
                                    </div>
                                    <div
                                        style="background: #ffffff; border: 1px solid #e2e8f0; padding: 1.25rem; border-radius: 0.75rem;">
                                        <h4 style="margin-top: 0; color: #7c3aed; font-size: 0.95rem;">â‘¡ ê°€ì¤‘ ì´ë™ í‰ê·  (WMA
                                            5:3:2)</h4>
                                        <div
                                            style="background: #f5f3ff; padding: 0.75rem; font-family: monospace; border-radius: 0.4rem; font-size: 0.9rem; margin: 0.5rem 0; color: #5b21b6;">
                                            WMA = (Yâ‚€&times;0.5) + (Yâ‚‹â‚&times;0.3) + (Yâ‚‹â‚‚&times;0.2)
                                        </div>
                                        <p style="font-size: 0.85rem; color: #64748b; margin: 0;">ìµœê·¼ 1ë…„ ë°ì´í„°ì— 50%, ì§ì „ 2ë…„ì—
                                            30%, 3ë…„ì— 20% ë¹„ì¤‘ì„ ë‘ì–´ <strong>ìµœì‹  íŠ¸ë Œë“œ</strong>ë¥¼ ê°•ë ¥íˆ ë°˜ì˜í•©ë‹ˆë‹¤.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 3.2 ì¸í”Œë ˆì´ì…˜ ë° ìê¸ˆ íë¦„ -->
                            <div style="margin-bottom: 2rem;">
                                <h3 style="font-size: 1.25rem; font-weight: 700; color: #475569; margin-bottom: 1rem;">
                                    3.2 ì¸í”Œë ˆì´ì…˜ ë° ìê¸ˆ íë¦„ ë…¼ë¦¬</h3>
                                <div
                                    style="background: #f8fafc; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <strong style="color: #334155;">ë³µë¦¬ ê¸°ë°˜ ì¸í”Œë ˆì´ì…˜ ë³´ì •:</strong>
                                        <div
                                            style="background: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; font-family: monospace; margin: 0.5rem 0;">
                                            ê³„ì‚°ë¹„ìš© = ê³¼ê±°ë¹„ìš© &times; (1 + r)^t
                                        </div>
                                        <p style="font-size: 0.9rem; color: #64748b;">(r: ì—°ê°„ ë¬¼ê°€ìƒìŠ¹ë¥ , t: ê²½ê³¼ ì—°ìˆ˜) - ê³¼ê±°ì˜ ê³µì‚¬
                                            ë¹„ìš©ì„ ëª©í‘œ ì—°ë„ì˜ ê°€ì¹˜ë¡œ ìë™ í™˜ì‚°í•©ë‹ˆë‹¤.</p>
                                    </div>
                                    <div>
                                        <strong style="color: #334155;">ìê¸ˆ íë¦„(Fund Flow) ì ìš© ì‚°ì‹:</strong>
                                        <div
                                            style="background: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; font-family: monospace; margin: 0.5rem 0;">
                                            ì´ ì˜ˆì¸¡ ì˜ˆì‚° = &sum; (ê±´ë¬¼ë™ë³„ ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜ &times; ì˜ˆì¸¡ ì„¸ëŒ€ë‹¹ ë‹¨ê°€)
                                        </div>
                                        <p style="font-size: 0.9rem; color: #64748b;">ê° ê±´ë¬¼ë™ë³„ë¡œ ê°œë³„ ì˜ˆì¸¡(WMA applied)ì„ ìˆ˜í–‰í•œ í›„,
                                            ì´ë¥¼ ì „ì²´ë¡œ í•©ì‚°í•˜ì—¬ ì‹œìŠ¤í…œ ì „ì²´ì˜ ìê¸ˆ íë¦„ì„ ë„ì¶œí•©ë‹ˆë‹¤.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- [New] 3.3 ë¶„ì„ ì‹¤ì  ë…„ë„ ë‹¤ì¤‘ ì„ íƒ ë¡œì§ -->
                            <div style="margin-bottom: 2rem;">
                                <h3 style="font-size: 1.25rem; font-weight: 700; color: #475569; margin-bottom: 1rem;">
                                    3.3 ë¶„ì„ ì‹¤ì  ë…„ë„ ë‹¤ì¤‘ ì„ íƒ ë§¤ì»¤ë‹ˆì¦˜</h3>
                                <div
                                    style="background: #f0f9ff; padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #bae6fd;">
                                    <h4
                                        style="margin-top: 0; color: #0369a1; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fa-solid fa-layer-group"></i> ë¶„ì„ ì‹¤ì  ë…„ë„ ë‹¤ì¤‘ ì„ íƒì˜ ëª©ì  (Purpose)
                                    </h4>
                                    <p style="font-size: 0.95rem; color: #334155; margin-bottom: 1rem;">
                                        ê³¼ê±° ë°ì´í„° ì¤‘ <strong>ì˜ˆì¸¡ì˜ ì‹ ë¢°ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ íŠ¹ì • ì—°ë„ë“¤ì„ ì„ ë³„í•˜ì—¬ ì¡°í•©</strong>í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.<br>
                                        ë‹¨ìˆœíˆ ì—°ì†ëœ 3ë…„ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, <strong>'ë¶„ì„ ì‹¤ì  ë…„ë„'</strong> ë©”ë‰´ì—ì„œ ì›í•˜ëŠ” ì—°ë„ë“¤ë§Œ ì²´í¬(V)í•˜ì—¬
                                        ë¶ˆí•„ìš”í•œ ë°ì´í„°(ì½”ë¡œë‚˜ ê¸°ê°„, ë°ì´í„° ëˆ„ë½ ì—°ë„ ë“± ì´ìƒì¹˜)ë¥¼ ê³¼ê°íˆ ì œì™¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    </p>
                                    <div
                                        style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e0f2fe; margin-bottom: 1rem;">
                                        <strong
                                            style="color: #0c4a6e; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">ğŸ’¡
                                            ì‚°ìˆ ì  ì˜ˆì‹œ ìƒí™©: 2024ë…„, 2022ë…„ì€ ì •ìƒì ì´ë‚˜ 2023ë…„ ë°ì´í„°ê°€ ë¹„ì •ìƒì ì¸ ê²½ìš°</strong>
                                        <ul
                                            style="margin: 0; padding-left: 1.2rem; color: #475569; font-size: 0.9rem; line-height: 1.6;">
                                            <li><strong>ì‚¬ìš©ì ì¡°ì¹˜:</strong> [ë¶„ì„ ì‹¤ì  ë…„ë„]ì—ì„œ [2024ë…„], [2022ë…„]ë§Œ ì„ íƒí•˜ê³  2023ë…„ì€ í•´ì œ
                                            </li>
                                            <li><strong>ì‹œìŠ¤í…œ ì²˜ë¦¬:</strong> ì„ íƒë˜ì§€ ì•Šì€ 2023ë…„ ë°ì´í„°ëŠ” <strong>ê³„ì‚° ëª¨ì§‘ë‹¨ì—ì„œ ì™„ì „íˆ
                                                    ì œì™¸</strong>ë©ë‹ˆë‹¤. (0ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ” ê²ƒì´ ì•„ë‹˜)</li>
                                            <li><strong>ì‚°ìˆ ì‹ (ë‹¨ìˆœí‰ê·  ì‹œ):</strong> <code>(Dataâ‚‚â‚€â‚‚â‚„ + Dataâ‚‚â‚€â‚‚â‚‚) / 2</code>
                                                <br>
                                                <span style="font-size: 0.85rem; color: #ef4444;">(ë¹„êµ: 2023ë…„ì„ í¬í•¨í•˜ë©´
                                                    (Dataâ‚‚â‚€â‚‚â‚„ + Dataâ‚‚â‚€â‚‚â‚ƒ + Dataâ‚‚â‚€â‚‚â‚‚) / 3 ì´ ë˜ì–´ í‰ê· ì´ ì™œê³¡ë¨)</span>
                                            </li>
                                        </ul>
                                    </div>

                                    <h4
                                        style="margin-top: 1.5rem; color: #0369a1; font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fa-solid fa-calculator"></i> ì„ íƒ ì˜µì…˜ë³„ ìƒì„¸ ê³„ì‚° ë¡œì§
                                    </h4>
                                    <ul
                                        style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 0.8rem;">
                                        <li
                                            style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e0f2fe;">
                                            <strong style="color: #0284c7; display: block; margin-bottom: 0.3rem;">â‘  ë‹¨ìˆœ
                                                í‰ê·  (Simple Average) ì„ íƒ ì‹œ</strong>
                                            <span style="font-size: 0.9rem; color: #64748b;">
                                                ì„ íƒëœ Nê°œ ì—°ë„ì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ í•©ì‚°í•˜ì—¬ Nìœ¼ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.<br>
                                                <code>ê²°ê³¼ê°’ = (Yâ‚ + Yâ‚‚ + ... + Yn) / N</code><br>
                                                * ëª¨ë“  ì„ íƒëœ ì—°ë„ëŠ” <strong>ë™ì¼í•œ ì¤‘ìš”ë„(ê°€ì¤‘ì¹˜ 1:1)</strong>ë¥¼ ê°€ì§‘ë‹ˆë‹¤. íŠ¹ì • ì—°ë„ì— í¸ì¤‘ë˜ì§€ ì•Šì€
                                                ì¼ë°˜ì ì¸ í‰ê· ê°’ì„ ì›í•  ë•Œ ì í•©í•©ë‹ˆë‹¤.
                                            </span>
                                        </li>
                                        <li
                                            style="background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e0f2fe;">
                                            <strong style="color: #0284c7; display: block; margin-bottom: 0.3rem;">â‘¡ ê°€ì¤‘
                                                í‰ê·  (Weighted Average) ì„ íƒ ì‹œ</strong>
                                            <span style="font-size: 0.9rem; color: #64748b;">
                                                ì„ íƒëœ ì—°ë„ë“¤ì„ <strong>ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬</strong>í•œ í›„, ì‹œìŠ¤í…œì— ì •ì˜ëœ ê°€ì¤‘ì¹˜ë¥¼ <strong>ìˆœì°¨ì ìœ¼ë¡œ
                                                    ì ìš©</strong>í•©ë‹ˆë‹¤.<br>
                                                <code>ê²°ê³¼ê°’ = (Yìµœì‹  Ã— Wâ‚) + (Yì§ì „ Ã— Wâ‚‚) + ...</code><br>
                                                * ì˜ˆ: 2023, 2025ë…„ì„ ì„ íƒí–ˆë‹¤ë©´, <strong>2025ë…„(ìµœì‹ )ì— ê°€ì¥ ë†’ì€ ê°€ì¤‘ì¹˜(50%)</strong>,
                                                2023ë…„ì— ê·¸ ë‹¤ìŒ ê°€ì¤‘ì¹˜(30%)ë¥¼ ì ìš©í•©ë‹ˆë‹¤.
                                                (ì¤‘ê°„ì— ì„ íƒí•˜ì§€ ì•Šì€ 2024ë…„ ë°ì´í„°ëŠ” ê³„ì‚°ì—ì„œ <strong>ì™„ì „íˆ ë°°ì œ</strong>ë©ë‹ˆë‹¤.)
                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- 3.4 ê³„ì‚° ì˜ˆì‹œ (Step-by-Step) -->
                            <div
                                style="background: #fffbeb; border: 1px solid #fde68a; padding: 1.5rem; border-radius: 0.75rem;">
                                <h3
                                    style="font-size: 1.25rem; font-weight: 800; color: #92400e; margin-top: 0; margin-bottom: 1rem;">
                                    3.4 êµ¬ì²´ì ì¸ ì‚°ìˆ  ì˜ˆì‹œ (Simulation)</h3>
                                <div style="font-size: 0.95rem; color: #92400e;">
                                    <p><strong>ê°€ì • ìƒí™©:</strong> ì–´ëŠ ê±´ë¬¼ì˜ ì„¸ëŒ€ë‹¹ ìˆ˜ì¥ê³µì‚¬ë¹„ê°€ ë‹¤ìŒê³¼ ê°™ì„ ë•Œ (ë¬¼ê°€ìƒìŠ¹ë¥  3% ê°€ì •)</p>
                                    <ul>
                                        <li>2023ë…„(Y-2): 10,000,000ì›</li>
                                        <li>2024ë…„(Y-1): 11,000,000ì›</li>
                                        <li>2025ë…„(Yâ‚€): 12,000,000ì›</li>
                                    </ul>
                                    <hr style="border: 0; border-top: 1px dashed #fbd38d; margin: 1rem 0;">
                                    <p><strong>Step 1. ì¸í”Œë ˆì´ì…˜ ë³´ì • ìˆ˜í–‰ (í˜„ì¬ê°€ì¹˜ í™˜ì‚°):</strong></p>
                                    <ul style="list-style: none; padding-left: 0.5rem;">
                                        <li>- 2023ë¹„ìš© â†’ 2025ê°€ì¹˜: 10,000,000 &times; (1.03)Â² = 10,609,000ì›</li>
                                        <li>- 2024ë¹„ìš© â†’ 2025ê°€ì¹˜: 11,000,000 &times; (1.03)Â¹ = 11,330,000ì›</li>
                                        <li>- 2025ë¹„ìš© â†’ 2025ê°€ì¹˜: 12,000,000ì›</li>
                                    </ul>
                                    <p><strong>Step 2. WMA(5:3:2) ê°€ì¤‘ì¹˜ ì ìš©:</strong></p>
                                    <div
                                        style="background: #fff; padding: 1rem; border-radius: 0.5rem; font-family: monospace; border: 1px solid #fde68a; font-weight: bold; text-align: center;">
                                        (12,000,000 &times; 0.5) + (11,330,000 &times; 0.3) + (10,609,000 &times; 0.2) =
                                        11,520,800ì›
                                    </div>
                                    <p style="margin-top: 1rem;"><strong>ê²°ë¡ :</strong> ì‹œìŠ¤í…œì€ ì°¨ê¸°ë…„ë„ ì˜ˆì‚° ìˆ˜ë¦½ì„ ìœ„í•œ ìµœì¢… ê¸°ì¤€ ë‹¨ê°€ë¥¼
                                        <strong>11,520,800ì›</strong>ìœ¼ë¡œ ì¶”ì²œí•©ë‹ˆë‹¤.
                                    </p>
                                </div>
                            </div>
                        </section>

                        <!-- 4. ì‚¬ìš© ë°©ë²• (Intuitive) -->
                        <section style="margin-bottom: 3rem;">
                            <h2
                                style="font-size: 1.6rem; font-weight: 800; color: #1e293b; border-left: 5px solid #ea580c; padding-left: 1rem; margin-bottom: 1.5rem;">
                                4. ì‹œìŠ¤í…œ ì‚¬ìš© ì•ˆë‚´ (Step-by-Step)</h2>
                            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                                <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                                    <div
                                        style="background: #ea580c; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        1</div>
                                    <div>
                                        <strong
                                            style="font-size: 1.1rem; color: #334155; display: block; margin-bottom: 0.3rem;">ë°ì´í„°
                                            íŒŒì¼ ì—…ë¡œë“œ ë° ì •ê·œí™”</strong>
                                        <p style="margin: 0; color: #64748b;">ì¢Œì¸¡ ìƒë‹¨ <strong>[ë°ì´í„° íŒŒì¼]</strong> ì˜ì—­ì„ í†µí•´ ì—‘ì…€
                                            íŒŒì¼ì„ ë“œë¡­í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”. ì‹œìŠ¤í…œì´ ìë™ìœ¼ë¡œ 'ê³µê°€', 'ìˆ˜ì¥ê³µì‚¬' ë“± í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì‹ë³„í•˜ì—¬ ë°ì´í„°ë¥¼ ì •ì œí•©ë‹ˆë‹¤.</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                                    <div
                                        style="background: #ea580c; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        2</div>
                                    <div>
                                        <strong
                                            style="font-size: 1.1rem; color: #334155; display: block; margin-bottom: 0.3rem;">ë°œì£¼ì²˜
                                            ë° ì‘ì—… ìœ í˜• í•„í„°ë§</strong>
                                        <p style="margin: 0; color: #64748b;"><strong>[ë°œì£¼ì²˜ ì„ íƒ]</strong> ê³¼ <strong>[ì‘ì—… ìœ í˜•
                                                ì„ íƒ]</strong> ë©”ë‰´ë¥¼ í†µí•´ ë¶„ì„ ëŒ€ìƒ ë²”ìœ„ë¥¼ ì¢íˆì„¸ìš”. ì„ íƒ ì¦‰ì‹œ í•˜ë‹¨ ëŒ€ì‹œë³´ë“œì™€ Sankey ì°¨íŠ¸ê°€ ë™ê¸°í™”ë©ë‹ˆë‹¤.
                                        </p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                                    <div
                                        style="background: #ea580c; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        3</div>
                                    <div>
                                        <strong
                                            style="font-size: 1.1rem; color: #334155; display: block; margin-bottom: 0.3rem;">ë¶„ì„
                                            ì—°ë„ ë° ì§‘ê³„ ë°©ì‹ ì œì–´</strong>
                                        <p style="margin: 0; color: #64748b;">ë¹„êµë¥¼ ì›í•˜ëŠ” <strong>[ì—°ë„ ì„ íƒ]</strong>ì„ ë©€í‹° ì²´í¬í•˜ê³ ,
                                            <strong>[ì§‘ê³„ ë°©ì‹]</strong>(í•©ê³„/í‰ê· )ì„ ì„ íƒí•˜ì—¬ í†µê³„ì  ê´€ì ì„ ê²°ì •í•˜ì„¸ìš”.
                                        </p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                                    <div
                                        style="background: #ea580c; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        4</div>
                                    <div>
                                        <strong
                                            style="font-size: 1.1rem; color: #334155; display: block; margin-bottom: 0.3rem;">ê³ ê¸‰
                                            ì‹œë®¬ë ˆì´ì…˜ í™œìš©</strong>
                                        <p style="margin: 0; color: #64748b;">ìš°ì¸¡ í•˜ë‹¨ <strong>[ìë™/ìˆ˜ë™ ë¶„ì„ ëª¨ë“œ]</strong>ë¥¼ ì „í™˜í•˜ì—¬
                                            ì‚¬ìš©ìê°€ ì§ì ‘ ì˜ˆì¸¡ì¹˜ë¥¼ ì…ë ¥í•˜ê±°ë‚˜, ì¸í”Œë ˆì´ì…˜ìœ¨(%)ì„ ìˆ˜ë™ ì¡°ì •í•˜ì—¬ ì‹¤ì‹œê°„ ì˜ˆì‚° ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                                    <div
                                        style="background: #ea580c; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">
                                        5</div>
                                    <div>
                                        <strong
                                            style="font-size: 1.1rem; color: #334155; display: block; margin-bottom: 0.3rem;">ê²°ê³¼
                                            ë¦¬í¬íŠ¸ ì €ì¥ ë° ê³µìœ </strong>
                                        <p style="margin: 0; color: #64748b;"><strong>[ì—‘ì…€ ë‹¤ìš´ë¡œë“œ]</strong> ë²„íŠ¼ì„ í†µí•´ ë¶„ì„ ê²°ê³¼ë¥¼
                                            ë¬¸ì„œí™”í•˜ê³ , <strong>[ì›ë³¸ ë°ì´í„° ë³´ê¸°]</strong>ë¥¼ í†µí•´ ë¶„ì„ì— ì‚¬ìš©ëœ ê¸°ì´ˆ ë¡œìš° ë°ì´í„°ë¥¼ ê²€ì¦í•˜ì„¸ìš”.</p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 5. ë…ì°½ì„± (Compact) -->
                        <section
                            style="background: #f8fafc; padding: 2rem; border-radius: 1rem; border: 1px solid #e2e8f0;">
                            <h2
                                style="font-size: 1.4rem; font-weight: 800; color: #1e293b; margin-top: 0; margin-bottom: 1.5rem;">
                                5. ì‹œìŠ¤í…œì˜ ì°¨ë³„í™”ëœ ì§€ëŠ¥ì„±</h2>
                            <ul
                                style="margin: 0; padding-left: 1.2rem; color: #475569; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <li>ì˜¤íƒ€ ë° ë„ì–´ì“°ê¸° ë¶ˆì¼ì¹˜ ìë™ ì •ê·œí™”</li>
                                <li>Investopedia í‘œì¤€ í†µê³„ ì—”ì§„ íƒ‘ì¬</li>
                                <li>í´ë¦° ë ˆì´ì–´ ì•„í‚¤í…ì²˜ ê¸°ë°˜ ë¬´ê²°ì„± ë³´ì¦</li>
                                <li>ì‹¤ì‹œê°„ ìŠ¤ëƒ…ìƒ· ê¸°ë°˜ì˜ ë¶„ì„ ìƒíƒœ ë³µêµ¬</li>
                            </ul>
                        </section>

                        <!-- 6. ì‹œìŠ¤í…œ ì „ìˆ˜ ì ê²€ ë° ë¬´ê²°ì„± ë³´ì¦ ë³´ê³ ì„œ -->
                        <section
                            style="margin-top: 3rem; margin-bottom: 1rem; border-top: 2px dashed #cbd5e1; padding-top: 2rem;">
                            <h2
                                style="font-size: 1.3rem; font-weight: 800; color: #0f172a; margin-top: 0; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fa-solid fa-file-signature text-emerald-600"></i> 6. ì‹œìŠ¤í…œ ë¬´ê²°ì„± ë° ì •í•©ì„± ë³´ì¦ ë³´ê³ ì„œ
                            </h2>

                            <div
                                style="background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 1.5rem;">
                                <p style="margin-bottom: 1.5rem; font-size: 0.95rem; line-height: 1.6; color: #334155;">
                                    ë³¸ ì‹œìŠ¤í…œì€ <strong>Google DeepMind Advanced Agentic Coding Auditing Protocol</strong>ì—
                                    ì˜ê±°í•˜ì—¬,
                                    ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ë…¼ë¦¬ì  ì™„ê²°ì„±, ì‚°ìˆ ì  ì •í™•ì„±, ê·¸ë¦¬ê³  ì½”ë“œ ë¬´ê²°ì„±ì— ëŒ€í•œ <strong>ì „ìˆ˜ ì ê²€(Full Inspection)</strong>ì„
                                    ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤.
                                    ë³¸ ë³´ê³ ì„œëŠ” ì‚¬ìš©ìê°€ ì‹œìŠ¤í…œì´ ì‚°ì¶œí•œ ì˜ˆì‚° ì˜ˆì¸¡ ë°ì´í„°ë¥¼ 100% ì‹ ë¢°í•  ìˆ˜ ìˆìŒì„ ë³´ì¦í•©ë‹ˆë‹¤.
                                </p>

                                <h4
                                    style="font-size: 1rem; font-weight: 700; color: #334155; margin-bottom: 0.8rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem;">
                                    âœ… ì£¼ìš” ì ê²€ í•­ëª© ë° ê²°ê³¼ (Verification Results)
                                </h4>
                                <ul
                                    style="list-style: none; padding: 0; margin: 0 0 2rem 0; display: flex; flex-direction: column; gap: 1rem;">
                                    <li style="display: flex; gap: 0.8rem; align-items: flex-start;">
                                        <div
                                            style="background: #d1fae5; color: #059669; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.2rem;">
                                            <i class="fa-solid fa-calculator" style="font-size: 0.8rem;"></i>
                                        </div>
                                        <div>
                                            <strong style="color: #0f172a; display: block; margin-bottom: 0.2rem;">ì‚°ìˆ ì 
                                                ì •í•©ì„± (Arithmetic Consistency)</strong>
                                            <span
                                                style="font-size: 0.9rem; color: #475569; line-height: 1.5; display: block;">
                                                ë‹¨ìˆœ í‰ê·  ë° ê°€ì¤‘ ì´ë™ í‰ê· (WMA 5:3:2) ì‚°ì¶œ ë¡œì§ì´ êµ­ì œ í‘œì¤€ í†µê³„ ë°©ì‹ê³¼ 100% ì¼ì¹˜í•¨ì„ ê²€ì¦í•˜ì˜€ìŠµë‹ˆë‹¤.
                                                íŠ¹íˆ ë‹¤ì¤‘ ì—°ë„ ì„ íƒ ì‹œ, ì„ íƒ í•´ì œëœ ì—°ë„ì˜ ë°ì´í„°ê°€ ëª¨ì§‘ë‹¨ì—ì„œ ì™„ë²½íˆ ë°°ì œë¨ì„ ìˆ˜ì‹ ë ˆë²¨ì—ì„œ ì¦ëª…í•˜ì˜€ìŠµë‹ˆë‹¤.
                                            </span>
                                        </div>
                                    </li>
                                    <li style="display: flex; gap: 0.8rem; align-items: flex-start;">
                                        <div
                                            style="background: #d1fae5; color: #059669; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.2rem;">
                                            <i class="fa-solid fa-server" style="font-size: 0.8rem;"></i>
                                        </div>
                                        <div>
                                            <strong style="color: #0f172a; display: block; margin-bottom: 0.2rem;">ë°ì´í„°
                                                íŒŒì´í”„ë¼ì¸ ì •í•©ì„± (Pipeline Integrity)</strong>
                                            <span
                                                style="font-size: 0.9rem; color: #475569; line-height: 1.5; display: block;">
                                                Raw Data(ì›ë³¸)ë¶€í„° Normalization(ì •ê·œí™”/Trim), Filtering, Renderingì— ì´ë¥´ëŠ” ì „ ê³¼ì •ì—ì„œ
                                                ë°ì´í„° ëˆ„ìˆ˜(Leakage) ë° ì™œê³¡ì´ '0ê±´'ì„ì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤. (GitHub ìë™ ë¡œë“œ ë° ë¡œì»¬ íŒŒì¼ ì—…ë¡œë“œ ë™ì¼ ê²€ì¦)
                                            </span>
                                        </div>
                                    </li>
                                    <li style="display: flex; gap: 0.8rem; align-items: flex-start;">
                                        <div
                                            style="background: #d1fae5; color: #059669; width: 1.5rem; height: 1.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 0.2rem;">
                                            <i class="fa-solid fa-code" style="font-size: 0.8rem;"></i>
                                        </div>
                                        <div>
                                            <strong style="color: #0f172a; display: block; margin-bottom: 0.2rem;">ë…¼ë¦¬ì 
                                                ì™„ê²°ì„± ë° ê°€ì´ë“œ ì¤€ìˆ˜ (Logical Completeness)</strong>
                                            <span
                                                style="font-size: 0.9rem; color: #475569; line-height: 1.5; display: block;">
                                                íŠ¹ì´ ì¼€ì´ìŠ¤(ì½”ë¡œë‚˜ ê¸°ê°„ ë“±) ì œì™¸ ë¡œì§ê³¼ ì¸í”Œë ˆì´ì…˜ ë³´ì • ê³„ìˆ˜ ì ìš© ë¡œì§ì´ ì„¤ê³„ ì˜ë„ëŒ€ë¡œ ì •í™•íˆ ì‘ë™í•©ë‹ˆë‹¤.
                                                ë˜í•œ, ê°€ì´ë“œë¼ì¸ì— ì˜ê±°í•˜ì—¬ ë¶ˆí•„ìš”í•œ ì‹œìŠ¤í…œ ë¡œê·¸ë¥¼ ì „ìˆ˜ ì œê±°í•˜ê³  ë¬´ê²°ì„±ì„ í™•ë³´í•˜ì˜€ìŠµë‹ˆë‹¤.
                                            </span>
                                        </div>
                                    </li>
                                </ul>

                                <!-- ì„œëª…ë€ -->
                                <div
                                    style="margin-top: 1rem; border: 2px solid #e2e8f0; padding: 2rem; background: #fff; position: relative; border-radius: 0.5rem;">
                                    <div
                                        style="position: absolute; top: -12px; left: 20px; background: #fff; padding: 0 10px; font-size: 0.85rem; font-weight: 800; color: #64748b; letter-spacing: 0.05em; text-transform: uppercase;">
                                        Final Audit Certification
                                    </div>
                                    <div
                                        style="display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 2rem;">
                                        <div style="flex: 1; min-width: 200px;">
                                            <div
                                                style="font-size: 0.9rem; color: #334155; margin-bottom: 0.8rem; border-bottom: 1px dotted #cbd5e1; padding-bottom: 0.5rem;">
                                                <strong style="width: 100px; display: inline-block;">ê²€ì¦ ì¼ì‹œ:</strong>
                                                2026.02.08 17:05:00 (KST)
                                            </div>
                                            <div
                                                style="font-size: 0.9rem; color: #334155; margin-bottom: 0.8rem; border-bottom: 1px dotted #cbd5e1; padding-bottom: 0.5rem;">
                                                <strong style="width: 100px; display: inline-block;">ê²€ì¦ ëŒ€ìƒ:</strong>
                                                v4.61 (Build 20260208)
                                            </div>
                                            <div style="font-size: 0.9rem; color: #334155;">
                                                <strong style="width: 100px; display: inline-block;">ê²€ì¦ ìƒíƒœ:</strong>
                                                <span style="color: #059669; font-weight: bold;">PASSED (100%)</span>
                                            </div>
                                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 1rem;">
                                                * ë³¸ ì‹œìŠ¤í…œì€ êµ¬ê¸€ì˜ ì‹ ë¢°ì„± ê¸°ì¤€ì— ë”°ë¼ ì£¼ê¸°ì ìœ¼ë¡œ ì¬ê²€ì¦ë©ë‹ˆë‹¤.
                                            </div>
                                        </div>
                                        <div style="text-align: right; min-width: 200px;">
                                            <div
                                                style="font-size: 2.5rem; font-family: 'Brush Script MT', cursive; color: #0f172a; margin-bottom: 0.5rem; transform: rotate(-5deg); text-shadow: 2px 2px 0px rgba(0,0,0,0.05);">
                                                Antigravity
                                            </div>
                                            <div
                                                style="border-top: 2px solid #334155; width: 100%; margin-left: auto; margin-bottom: 0.5rem;">
                                            </div>
                                            <div style="font-size: 0.9rem; color: #1e293b; font-weight: 700;">
                                                Lead AI Architect
                                            </div>
                                            <div style="font-size: 0.8rem; color: #64748b; font-weight: 500;">
                                                Google DeepMind Advanced Agentic Coding Team
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                <!-- Footer -->
                <div
                    style="background: #f8fafc; padding: 1rem 1.5rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end;">
                    <button onclick="closeManualModal()"
                        style="background: #1e293b; color: white; padding: 0.5rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600;">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        function openManualModal() {
            var m = document.getElementById('manualModal');
            if (m) {
                m.style.display = 'block';
                document.body.style.overflow = 'hidden';
            } else {
                alert('ë§¤ë‰´ì–¼ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        function closeManualModal() {
            var m = document.getElementById('manualModal');
            if (m) {
                m.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
    </script>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <i class="fa-solid fa-building-user"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800" id="mainTitle">ìš´ì˜ì„± ì‘ì—…ë¹„ ë° ì„¸ëŒ€ìˆ˜ ë¶„ì„</h1>
            </div>
            <div class="flex items-center gap-3">
                <button id="manualBtn" onclick="openManualModal()"
                    class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition shadow-sm flex items-center gap-2 text-sm font-medium">
                    <i class="fa-solid fa-book-open"></i> ì‚¬ìš©ì ë§¤ë‰´ì–¼
                </button>
                <button id="viewRawDataBtn"
                    class="bg-slate-600 text-white px-4 py-2 rounded-lg hover:bg-slate-700 transition shadow-sm flex items-center gap-2 text-sm font-medium">
                    <i class="fa-solid fa-database"></i> ì›ë³¸ ë°ì´í„° ë³´ê¸°
                </button>
                <button id="exportBtn"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-sm flex items-center gap-2 text-sm font-medium">
                    <i class="fa-solid fa-file-excel"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- Control Panel -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 items-end">
                <!-- 1. File Upload with Data Source Selection -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-slate-700 mb-2"><i
                            class="fa-solid fa-file-csv mr-1"></i> ë°ì´í„° íŒŒì¼</label>
                    <div class="relative" id="dataSourceWrapper">
                        <!-- Data Source Selection Button -->
                        <button id="dataSourceBtn" type="button"
                            class="w-full text-left p-2 text-xs text-slate-600 bg-slate-50 border border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-400 transition-colors flex justify-between items-center cursor-pointer">
                            <span class="flex items-center gap-2">
                                <i class="fa-solid fa-folder-open text-blue-500"></i>
                                <span id="dataSourceBtnText">ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ...</span>
                            </span>
                            <i class="fa-solid fa-chevron-down text-slate-400"></i>
                        </button>

                        <!-- Hidden File Input -->
                        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="hidden">

                        <!-- Data Source Dropdown -->
                        <div id="dataSourceDropdown"
                            class="hidden absolute z-30 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-lg overflow-hidden">
                            <!-- Option 1: Local File -->
                            <button id="localFileOption" type="button"
                                class="w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors flex items-center gap-3 border-b border-slate-100">
                                <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center">
                                    <i class="fa-solid fa-computer text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-slate-800">ë¡œì»¬ íŒŒì¼ ì„ íƒ</div>
                                    <div class="text-xs text-slate-500">ë‚´ ì»´í“¨í„°ì—ì„œ Excel íŒŒì¼ ì„ íƒ</div>
                                </div>
                            </button>
                            <!-- Option 2: GitHub Auto Load -->
                            <button id="githubDataOption" type="button"
                                class="w-full text-left px-4 py-3 hover:bg-emerald-50 transition-colors flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg bg-emerald-100 flex items-center justify-center">
                                    <i class="fa-brands fa-github text-emerald-600"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-slate-800">ê¹ƒí—ˆë¸Œ ìë™ ë¡œë“œ</div>
                                    <div class="text-xs text-slate-500">14ë…„-25ë…„ ë¡œìš°ë°ì´í„° ìë™ ì—…ë¡œë“œ</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- 2. Client Select -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-slate-700 mb-2"><i
                            class="fa-solid fa-building mr-1"></i> ë°œì£¼ì²˜ ì„ íƒ</label>
                    <select id="clientSelect" disabled
                        class="block w-full p-2 border-slate-300 rounded-md border bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400">
                        <option value="">íŒŒì¼ ëŒ€ê¸° ì¤‘</option>
                    </select>
                </div>
                <!-- 3. Work Type Select -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-slate-700 mb-2"><i class="fa-solid fa-filter mr-1"></i>
                        ì‘ì—… ìœ í˜• ì„ íƒ</label>
                    <!-- Custom Multi-Select with Search -->
                    <div id="workTypeWrapper" class="relative">
                        <button id="workTypeBtn" disabled
                            class="w-full text-left p-2 border border-slate-300 rounded-md bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400 flex justify-between items-center text-sm">
                            <span id="workTypeBtnText" class="truncate">íŒŒì¼ ëŒ€ê¸° ì¤‘</span>
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-magnifying-glass text-xs text-slate-400"></i>
                                <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                            </div>
                        </button>
                        <div id="workTypeDropdown"
                            class="hidden absolute z-20 w-full mt-1 bg-white border border-slate-200 rounded-md shadow-lg max-h-72 flex flex-col">
                            <!-- Search Input -->
                            <div class="sticky top-0 bg-white border-b border-slate-200 p-2 z-10">
                                <div class="relative">
                                    <i
                                        class="fa-solid fa-magnifying-glass absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                                    <input type="text" id="workTypeSearch" placeholder="ì‘ì—… ìœ í˜• ê²€ìƒ‰..."
                                        class="w-full pl-8 pr-3 py-1.5 text-sm border border-slate-200 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <!-- [New] Select All / Deselect All Buttons -->
                            <div class="flex items-center gap-2 px-3 py-2 bg-slate-100 border-b border-slate-200">
                                <button id="workTypeSelectAllBtn" type="button"
                                    class="flex-1 px-2 py-1 text-xs font-medium bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors flex items-center justify-center gap-1">
                                    <i class="fa-solid fa-check-double"></i> ì „ì²´ ì„ íƒ
                                </button>
                                <button id="workTypeDeselectAllBtn" type="button"
                                    class="flex-1 px-2 py-1 text-xs font-medium bg-slate-500 text-white rounded hover:bg-slate-600 transition-colors flex items-center justify-center gap-1">
                                    <i class="fa-solid fa-xmark"></i> ì „ì²´ í•´ì œ
                                </button>
                            </div>
                            <!-- Checkboxes Container -->
                            <div id="workTypeOptions" class="overflow-y-auto flex-1 max-h-52">
                                <!-- Checkboxes injected here -->
                            </div>
                            <!-- Selection Summary -->
                            <div id="workTypeSelectionInfo"
                                class="sticky bottom-0 bg-slate-50 border-t border-slate-200 px-3 py-1.5 text-xs text-slate-500">
                                <span id="workTypeSelectionCount">0ê°œ ì„ íƒë¨</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 4. Target Year Select (Multi-Select) -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-slate-700 mb-2">
                        <i class="fa-regular fa-calendar-check mr-1"></i> ë¶„ì„ ì‹¤ì  ë…„ë„
                        <i class="fa-solid fa-circle-question text-xs text-slate-400 ml-1 cursor-help"
                            title="ë‹¨ì¼ ë˜ëŠ” ë‹¤ì¤‘ ì—°ë„ ì„ íƒ ê°€ëŠ¥. ë‹¤ì¤‘ ì„ íƒ ì‹œ ì§‘ê³„ ë°©ì‹ ì„ íƒ"></i>
                    </label>
                    <!-- Multi-Select Year Dropdown -->
                    <div id="yearSelectWrapper" class="relative">
                        <button id="yearSelectBtn" disabled
                            class="w-full text-left p-2 border border-slate-300 rounded-md bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400 flex justify-between items-center text-sm">
                            <span id="yearSelectBtnText" class="truncate">íŒŒì¼ ëŒ€ê¸° ì¤‘</span>
                            <div class="flex items-center gap-1">
                                <i class="fa-solid fa-chevron-down text-xs text-slate-400"></i>
                            </div>
                        </button>
                        <div id="yearSelectDropdown"
                            class="hidden absolute z-20 w-full mt-1 bg-white border border-slate-200 rounded-md shadow-lg max-h-72 flex flex-col">
                            <!-- Checkboxes Container -->
                            <div id="yearSelectOptions" class="overflow-y-auto flex-1 max-h-44 p-1">
                                <!-- Checkboxes injected here -->
                            </div>
                            <!-- Aggregation Method (shown when multi selected) -->
                            <div id="yearAggregationPanel" class="hidden border-t border-slate-200 p-2 bg-violet-50">
                                <label class="block text-xs font-medium text-slate-600 mb-1">
                                    <i class="fa-solid fa-calculator text-violet-500 mr-1"></i>ë‹¤ì¤‘ì—°ë„ ì§‘ê³„ ë°©ì‹
                                </label>
                                <select id="yearAggregationMethod"
                                    class="w-full text-xs p-1.5 border border-slate-300 rounded bg-white focus:ring-1 focus:ring-violet-500">
                                    <option value="avg" selected>ë‹¨ìˆœ í‰ê· </option>
                                    <option value="sum">í•©ê³„</option>
                                    <option value="wma">ê°€ì¤‘ í‰ê·  (5:3:2)</option>
                                </select>
                            </div>
                            <!-- Selection Summary -->
                            <div id="yearSelectionInfo"
                                class="sticky bottom-0 bg-slate-50 border-t border-slate-200 px-3 py-1.5 text-xs text-slate-500">
                                <span id="yearSelectionCount">0ê°œ ì„ íƒë¨</span>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- 5. Simulation Options -->
                <div class="col-span-1">
                    <label class="block text-sm font-medium text-slate-700 mb-2"><i
                            class="fa-solid fa-chart-line mr-1"></i> í‰ê·  ì‚°ì • ê¸°ê°„</label>
                    <div class="flex items-center gap-4">
                        <input type="range" id="yearRange" min="2" max="5" value="3" step="1"
                            class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        <span id="yearRangeValue"
                            class="text-blue-700 font-bold w-12 text-center bg-blue-50 py-1 rounded">3ë…„</span>
                    </div>
                </div>
            </div>

            <!-- [PRD/IMP] Advanced Forecasting Settings Panel -->
            <div id="advancedSettingsPanel"
                class="mt-6 pt-5 border-t border-slate-200 bg-gradient-to-r from-violet-50/50 to-indigo-50/50 -mx-6 px-6 pb-4 rounded-b-lg">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-flask text-violet-600"></i>
                        <h3 class="text-sm font-bold text-slate-700">ê³ ê¸‰ ì˜ˆì¸¡ ì„¤ì •</h3>
                        <span class="text-xs text-violet-500 bg-violet-100 px-2 py-0.5 rounded-full">PRD v1.0</span>
                    </div>
                    <button id="toggleAdvancedSettings"
                        class="text-xs text-slate-500 hover:text-slate-700 transition-colors">
                        <i class="fa-solid fa-chevron-down" id="advancedSettingsIcon"></i>
                    </button>
                </div>

                <div id="advancedSettingsContent" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- 1. ì˜ˆì¸¡ ë°©ì‹ ì „í™˜ (ê°€ì¤‘í‰ê·  vs ë‹¨ìˆœí‰ê· ) -->
                    <div class="col-span-1 relative group">
                        <label class="block text-sm font-medium text-slate-700 mb-2 cursor-help">
                            <i class="fa-solid fa-weight-scale mr-1 text-violet-500"></i> ì˜ˆì¸¡ ë°©ë²•
                            <i class="fa-solid fa-circle-question text-xs text-slate-400 ml-1 tooltip-trigger"
                                data-tooltip-target="forecast-method"></i>
                        </label>
                        <!-- ìƒì„¸ íˆ´íŒ -->
                        <div class="absolute z-50 hidden click-tooltip left-0 top-full mt-1 w-80 bg-slate-900 text-white text-xs rounded-lg p-4 shadow-xl"
                            data-tooltip-panel="forecast-method">
                            <div class="font-bold text-violet-300 mb-2">ğŸ“Š ì˜ˆì¸¡ ë°©ë²•ì´ë€?</div>
                            <div class="space-y-2 leading-relaxed">
                                <p>ê³¼ê±° ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë¯¸ë˜ ì˜ˆì‚°ì„ ì˜ˆì¸¡í•˜ëŠ” ë°©ì‹ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
                                <div class="border-t border-slate-700 pt-2 mt-2">
                                    <div class="font-semibold text-blue-300">âœ“ ë‹¨ìˆœ í‰ê· </div>
                                    <p class="text-slate-300">ìµœê·¼ 3ë…„ ë°ì´í„°ì˜ ì‚°ìˆ  í‰ê· ì„ ê³„ì‚°í•©ë‹ˆë‹¤.<br>ì˜ˆ: (2023 + 2024 + 2025) Ã· 3
                                    </p>
                                </div>
                                <div class="border-t border-slate-700 pt-2">
                                    <div class="font-semibold text-violet-300">âœ“ ê°€ì¤‘í‰ê·  (5:3:2)</div>
                                    <p class="text-slate-300">ê°€ì¤‘í‰ê· : ìµœê·¼ ì—°ë„ ë°ì´í„°ì— ë” ë†’ì€ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.<br>ì˜ˆ: 2025ë…„Ã—50% +
                                        2024ë…„Ã—30% +
                                        2023ë…„Ã—20%</p>
                                </div>
                                <div class="bg-violet-800/50 rounded p-2 mt-2">
                                    <div class="font-semibold">ğŸ’¡ ì‚¬ìš© íŒ</div>
                                    <p class="text-slate-300">ìµœê·¼ ë°ì´í„°ì˜ ë¹„ì¤‘ì„ ë†’ì´ê³  ì‹¶ë‹¤ë©´ ê°€ì¤‘í‰ê· ì´ ë” ì •í™•í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="absolute -top-2 left-4 w-4 h-4 bg-slate-900 rotate-45"></div>
                        </div>
                        <div
                            class="flex items-center gap-1 bg-white p-1 rounded-lg border border-slate-200 shadow-sm h-[42px]">
                            <button id="simpleAvgBtn" title="ë‹¨ìˆœ í‰ê· : ìµœê·¼ 3ë…„ ë°ì´í„°ì˜ ì‚°ìˆ  í‰ê· "
                                class="flex-1 h-full px-2 rounded text-xs font-medium transition-all bg-violet-600 text-white shadow-sm">
                                ë‹¨ìˆœ í‰ê· 
                            </button>
                            <button id="wmaBtn" title="ê°€ì¤‘í‰ê· : ìµœê·¼ ì—°ë„ ë°ì´í„°ì— ë” ë†’ì€ ë¹„ì¤‘ ë¶€ì—¬ (5:3:2)"
                                class="flex-1 h-full px-2 rounded text-xs font-medium transition-all text-slate-600 hover:bg-slate-100">
                                ê°€ì¤‘í‰ê·  (5:3:2)
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">ê°€ì¤‘í‰ê· : ìµœê·¼ ë°ì´í„°ì— ë” ë†’ì€ ê°€ì¤‘ì¹˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ì˜ˆì¸¡</p>
                    </div>

                    <!-- 2. Inflation Rate Input -->
                    <div class="col-span-1 relative group">
                        <label class="block text-sm font-medium text-slate-700 mb-2 cursor-help">
                            <i class="fa-solid fa-percent mr-1 text-amber-500"></i> ì¸í”Œë ˆì´ì…˜ìœ¨ (%)
                            <i class="fa-solid fa-circle-question text-xs text-slate-400 ml-1 tooltip-trigger"
                                data-tooltip-target="inflation-rate"></i>
                        </label>
                        <!-- ìƒì„¸ íˆ´íŒ -->
                        <div class="absolute z-50 hidden click-tooltip left-0 top-full mt-1 w-80 bg-slate-900 text-white text-xs rounded-lg p-4 shadow-xl"
                            data-tooltip-panel="inflation-rate">
                            <div class="font-bold text-amber-300 mb-2">ğŸ“ˆ ì¸í”Œë ˆì´ì…˜ ë³´ì •ì´ë€?</div>
                            <div class="space-y-2 leading-relaxed">
                                <p>ê³¼ê±° ë¹„ìš©ì„ í˜„ì¬ ë¬¼ê°€ ìˆ˜ì¤€ìœ¼ë¡œ í™˜ì‚°í•˜ì—¬ ë³´ë‹¤ ì •í™•í•œ ì˜ˆì¸¡ì„ í•©ë‹ˆë‹¤.</p>
                                <div class="bg-amber-800/50 rounded p-2">
                                    <div class="font-semibold">ê³„ì‚° ê³µì‹</div>
                                    <p class="text-slate-300 font-mono text-xs">í˜„ì¬ê°€ì¹˜ = ê³¼ê±°ë¹„ìš© Ã— (1 + ì¸í”Œë ˆìœ¨)^ê²½ê³¼ë…„ìˆ˜</p>
                                </div>
                                <div class="border-t border-slate-700 pt-2">
                                    <div class="font-semibold text-amber-300">ì˜ˆì‹œ (5% ì„¤ì • ì‹œ)</div>
                                    <p class="text-slate-300">2023ë…„ 1ì–µì› â†’ í˜„ì¬ê°€ì¹˜ 1.1ì–µì›<br>(1ì–µ Ã— 1.05Â² = 1.1ì–µ)</p>
                                </div>
                                <div class="bg-amber-800/50 rounded p-2 mt-2">
                                    <div class="font-semibold">ğŸ’¡ ì‚¬ìš© íŒ</div>
                                    <p class="text-slate-300">ê±´ì„¤ ìì¬ë¹„ ìƒìŠ¹ë¥  ì°¸ê³ : ì—°í‰ê·  3~5%</p>
                                </div>
                            </div>
                            <div class="absolute -top-2 left-4 w-4 h-4 bg-slate-900 rotate-45"></div>
                        </div>
                        <div class="relative h-[42px]">
                            <input type="number" id="inflationRate" min="0" max="20" step="0.5" value="0"
                                title="0~20% ì‚¬ì´ ê°’ ì…ë ¥ (ê¶Œì¥: 3~5%)"
                                class="w-full h-full pl-3 pr-10 text-base border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-violet-500 focus:border-violet-500 sm:text-sm bg-white shadow-sm">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">%</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-1">ê³¼ê±° ë¹„ìš©ì„ í˜„ì¬ ê°€ì¹˜ë¡œ í™˜ì‚°</p>
                    </div>

                    <!-- 3. Simulation Mode Toggle -->
                    <div class="col-span-1 relative group">
                        <label class="block text-sm font-medium text-slate-700 mb-2 cursor-help">
                            <i class="fa-solid fa-vials mr-1 text-emerald-500"></i> ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ
                            <i class="fa-solid fa-circle-question text-xs text-slate-400 ml-1 tooltip-trigger"
                                data-tooltip-target="simulation-mode"></i>
                        </label>
                        <!-- ìƒì„¸ íˆ´íŒ -->
                        <div class="absolute z-50 hidden click-tooltip left-0 top-full mt-1 w-80 bg-slate-900 text-white text-xs rounded-lg p-4 shadow-xl"
                            data-tooltip-panel="simulation-mode">
                            <div class="font-bold text-emerald-300 mb-2">ğŸ§ª ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œë€?</div>
                            <div class="space-y-2 leading-relaxed">
                                <p>"ë§Œì•½ ~ë¼ë©´?" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                                <div class="border-t border-slate-700 pt-2 mt-2">
                                    <div class="font-semibold text-emerald-300">âœ“ ì£¼ìš” ê¸°ëŠ¥</div>
                                    <ul class="text-slate-300 list-disc pl-4 space-y-1">
                                        <li>ì „ì²´ ë‹¨ê°€ ì¼ê´„ ì¡°ì • (-20% ~ +20%)</li>
                                        <li>ì‹¤ì‹œê°„ ì˜ˆì‚° ë³€í™” í™•ì¸</li>
                                        <li>ì›í´ë¦­ ì›ìƒë³µêµ¬</li>
                                    </ul>
                                </div>
                                <div class="border-t border-slate-700 pt-2">
                                    <div class="font-semibold text-emerald-300">âœ“ ì‚¬ìš© ë°©ë²•</div>
                                    <ol class="text-slate-300 list-decimal pl-4 space-y-1">
                                        <li>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ë²„íŠ¼ í´ë¦­</li>
                                        <li>í•˜ë‹¨ì— ë‚˜íƒ€ë‚˜ëŠ” ìŠ¬ë¼ì´ë” ì¡°ì ˆ</li>
                                        <li>í…Œì´ë¸”ì—ì„œ ì‹¤ì‹œê°„ ë³€í™” í™•ì¸</li>
                                        <li>ì¢…ë£Œ ë²„íŠ¼ìœ¼ë¡œ ì›ë³µ</li>
                                    </ol>
                                </div>
                                <div class="bg-emerald-800/50 rounded p-2 mt-2">
                                    <div class="font-semibold">ğŸ’¡ í™œìš© ì˜ˆì‹œ</div>
                                    <p class="text-slate-300">ìì¬ë¹„ 10% ìƒìŠ¹ ì‹œ ì´ ì˜ˆì‚° ë³€í™” ë¯¸ë¦¬ë³´ê¸°</p>
                                </div>
                            </div>
                            <div class="absolute -top-2 left-4 w-4 h-4 bg-slate-900 rotate-45"></div>
                        </div>
                        <button id="simulationModeBtn" title="í´ë¦­í•˜ì—¬ What-if ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ ì‹œì‘"
                            class="w-full h-[42px] px-4 rounded-lg text-sm font-medium transition-all bg-white border border-slate-300 text-slate-600 hover:bg-emerald-50 hover:border-emerald-400 hover:text-emerald-700 shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-play"></i>
                            <span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>
                        </button>
                        <p class="text-xs text-slate-400 mt-1">ìŠ¬ë¼ì´ë”ë¡œ What-if ë¶„ì„</p>
                    </div>

                    <!-- 4. Sankey Chart Button -->
                    <div class="col-span-1 relative group">
                        <label class="block text-sm font-medium text-slate-700 mb-2 cursor-help">
                            <i class="fa-solid fa-diagram-project mr-1 text-blue-500"></i> ìê¸ˆ íë¦„ ì‹œê°í™”
                            <i class="fa-solid fa-circle-question text-xs text-slate-400 ml-1 tooltip-trigger"
                                data-tooltip-target="sankey-chart"></i>
                        </label>
                        <!-- ìƒì„¸ íˆ´íŒ -->
                        <div class="absolute z-50 hidden click-tooltip right-0 top-full mt-1 w-80 bg-slate-900 text-white text-xs rounded-lg p-4 shadow-xl"
                            data-tooltip-panel="sankey-chart">
                            <div class="font-bold text-blue-300 mb-2">ğŸŒŠ Sankey ë‹¤ì´ì–´ê·¸ë¨ì´ë€?</div>
                            <div class="space-y-2 leading-relaxed">
                                <p>ì˜ˆì‚°ì´ ì–´ë””ì„œ ì–´ë””ë¡œ í˜ëŸ¬ê°€ëŠ”ì§€ í•œëˆˆì— ë³´ì—¬ì£¼ëŠ” ì‹œê°í™” ë„êµ¬ì…ë‹ˆë‹¤.</p>
                                <div class="border-t border-slate-700 pt-2 mt-2">
                                    <div class="font-semibold text-blue-300">âœ“ íë¦„ ê²½ë¡œ</div>
                                    <p class="text-slate-300">ë°œì£¼ì²˜ â†’ ì‘ì—…ìœ í˜• â†’ ê±´ë¬¼ë™ â†’ ì´ ì˜ˆì¸¡ê¸ˆì•¡</p>
                                    <p class="text-slate-400 mt-1">íë¦„ì„  ë‘ê»˜ = ê¸ˆì•¡ ë¹„ì¤‘</p>
                                </div>
                                <div class="border-t border-slate-700 pt-2">
                                    <div class="font-semibold text-blue-300">âœ“ ìƒ‰ìƒ ì˜ë¯¸</div>
                                    <ul class="text-slate-300 list-disc pl-4 space-y-1">
                                        <li>ğŸ”µ íŒŒë‘: ë°œì£¼ì²˜</li>
                                        <li>ğŸŸ£ ë³´ë¼: ì‘ì—…ìœ í˜•</li>
                                        <li>ğŸŸ¢ ì´ˆë¡: ê±´ë¬¼ë™</li>
                                        <li>ğŸŸ¡ ì£¼í™©: ì´ ì˜ˆì¸¡ê¸ˆì•¡</li>
                                    </ul>
                                </div>
                                <div class="bg-blue-800/50 rounded p-2 mt-2">
                                    <div class="font-semibold">ğŸ’¡ ì‚¬ìš© íŒ</div>
                                    <p class="text-slate-300">ë…¸ë“œ ìœ„ ë§ˆìš°ìŠ¤ ì˜¤ë²„ â†’ ìƒì„¸ ê¸ˆì•¡/ë¹„ìœ¨ í™•ì¸</p>
                                </div>
                            </div>
                            <div class="absolute -top-2 right-4 w-4 h-4 bg-slate-900 rotate-45"></div>
                        </div>
                        <button id="openSankeyBtn" title="ì˜ˆì‚° íë¦„ì„ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•˜ëŠ” Sankey ë‹¤ì´ì–´ê·¸ë¨ ì—´ê¸°"
                            class="w-full h-[42px] px-4 rounded-lg text-sm font-medium transition-all bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white shadow-md flex items-center justify-center gap-2">
                            <i class="fa-solid fa-diagram-project"></i>
                            <span>Sankey ë‹¤ì´ì–´ê·¸ë¨</span>
                        </button>
                        <p class="text-xs text-slate-400 mt-1">ë°œì£¼ì²˜ â†’ ì‘ì—…ìœ í˜• â†’ ê±´ë¬¼ë™</p>
                    </div>


                </div>

                <!-- Simulation Active Indicator -->
                <div id="simulationActivePanel"
                    class="hidden mt-4 p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"></div>
                            <span class="text-sm font-medium text-emerald-800">ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ í™œì„±í™”</span>
                            <span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded">ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ì¤‘</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- Global Modifier -->
                            <div
                                class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg border border-emerald-300">
                                <label class="text-xs text-slate-600">ì „ì²´ ë‹¨ê°€ ì¡°ì •:</label>
                                <input type="range" id="globalPriceModifier" min="-20" max="20" value="0" step="1"
                                    class="w-20 accent-emerald-600">
                                <span id="globalPriceModifierValue"
                                    class="text-sm font-bold text-emerald-700 w-10 text-center">0%</span>
                            </div>
                            <button id="exitSimulationBtn"
                                class="px-3 py-1.5 text-sm bg-white border border-emerald-400 text-emerald-700 rounded-lg hover:bg-emerald-100 transition-colors">
                                <i class="fa-solid fa-stop mr-1"></i> ì¢…ë£Œ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Mode Panel -->
            <div class="mt-6 pt-6 border-t border-slate-200">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <!-- Mode Toggle -->
                    <div class="flex items-center gap-6">
                        <label class="block text-sm font-medium text-slate-700">
                            <i class="fa-solid fa-sliders mr-2"></i>ë¶„ì„ ëª¨ë“œ
                        </label>
                        <div class="flex items-center gap-3 bg-slate-100 p-1 rounded-lg">
                            <button id="autoModeBtn"
                                class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-white text-blue-700 shadow-sm">
                                <i class="fa-solid fa-calculator mr-1"></i> ìë™ ê³„ì‚°
                            </button>
                            <button id="manualModeBtn"
                                class="px-4 py-2 rounded-md text-sm font-medium transition-all text-slate-600 hover:text-slate-800">
                                <i class="fa-solid fa-pen-to-square mr-1"></i> ìˆ˜ë™ ì…ë ¥
                            </button>
                        </div>
                        <button id="compareAnalysisBtn"
                            class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white shadow-md">
                            <i class="fa-solid fa-chart-line mr-1"></i> ë¹„êµ ë¶„ì„
                        </button>
                        <!-- [New] Export All Button -->
                        <button id="exportAllBtn"
                            class="px-4 py-2 rounded-md text-sm font-medium transition-all bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-700 hover:to-teal-700 text-white shadow-md ml-2">
                            <i class="fa-solid fa-file-excel mr-1"></i> ì „ì²´ ë¶„ì„ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>

                    <!-- Manual Mode Tools (Hidden by default) -->
                    <div id="manualModeTools" class="hidden flex items-center gap-3">
                        <button id="applyAutoValuesBtn"
                            class="text-sm bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-4 py-2 rounded-lg shadow-sm transition-all">
                            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> ìë™ê°’ ì¼ê´„ ì ìš©
                        </button>
                        <button id="resetManualBtn"
                            class="text-sm bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-lg shadow-sm transition-all">
                            <i class="fa-solid fa-rotate-left mr-1"></i> ì´ˆê¸°í™”
                        </button>
                        <div class="text-xs text-slate-500 bg-amber-50 border border-amber-200 px-3 py-2 rounded-lg">
                            <i class="fa-solid fa-info-circle mr-1 text-amber-600"></i>
                            <span class="font-medium">ìˆ˜ë™ ëª¨ë“œ:</span> í…Œì´ë¸”ì˜ ì˜ˆì¸¡ê°’ì„ í´ë¦­í•˜ì—¬ ì§ì ‘ ìˆ˜ì •í•˜ì„¸ìš”
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Area -->
        <div id="dashboard" class="hidden space-y-8">
            <!-- Summary Cards -->
            <div class="space-y-6">
                <!-- Auto Calculation Statistics -->
                <div>
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <i class="fa-solid fa-calculator text-blue-600"></i>
                        <h3 class="text-sm font-bold text-slate-700">ìë™ ê³„ì‚°</h3>
                        <span class="text-xs text-slate-400" id="yearSpanLabel">(-ê°œë…„ í‰ê·  ê¸°ì¤€)</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-blue-500 cursor-pointer hover:shadow-md hover:border-blue-300 transition-all stat-card"
                            data-stat-type="execAmount" data-mode="auto">
                            <h3 class="text-xs font-medium text-slate-500 mb-1" id="headerExecAmt">2025ë…„ ì‹¤ì  (ê¸ˆì•¡)</h3>
                            <p class="text-xl font-bold text-slate-800" id="totalExecAmount">-</p>
                            <span class="text-xs text-blue-500 opacity-0 group-hover:opacity-100"><i
                                    class="fa-solid fa-arrow-up-right-from-square"></i> ìƒì„¸ ë³´ê¸°</span>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-emerald-500 cursor-pointer hover:shadow-md hover:border-emerald-300 transition-all stat-card"
                            data-stat-type="execCount" data-mode="auto">
                            <h3 class="text-xs font-medium text-slate-500 mb-1" id="headerExecCnt">2025ë…„ ì‹¤ì  (ì„¸ëŒ€ìˆ˜)</h3>
                            <p class="text-xl font-bold text-slate-800" id="totalExecCount">-</p>
                            <span class="text-xs text-slate-400" id="totalProgressRate">ì „ì²´ ëŒ€ë¹„ -%</span>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-indigo-500 cursor-pointer hover:shadow-md hover:border-indigo-300 transition-all stat-card"
                            data-stat-type="avgAmount" data-mode="auto">
                            <h3 class="text-xs font-medium text-slate-500 mb-1" id="avgLabel">-ê°œë…„ ì˜ˆì¸¡ (ê¸ˆì•¡)</h3>
                            <p class="text-xl font-bold text-slate-800" id="totalAvgAmount">-</p>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 border-l-4 border-l-purple-500 cursor-pointer hover:shadow-md hover:border-purple-300 transition-all stat-card"
                            data-stat-type="avgCount" data-mode="auto">
                            <h3 class="text-xs font-medium text-slate-500 mb-1" id="avgCountLabel">-ê°œë…„ ì˜ˆì¸¡ (ì„¸ëŒ€ìˆ˜)</h3>
                            <p class="text-xl font-bold text-slate-800" id="totalAvgCount">-</p>
                        </div>
                    </div>
                </div>

                <!-- Manual Prediction Statistics -->
                <div id="manualStatsSection" class="hidden">
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <i class="fa-solid fa-user-pen text-amber-600"></i>
                        <h3 class="text-sm font-bold text-slate-700">ìˆ˜ë™ ì˜ˆì¸¡</h3>
                        <span class="text-xs text-slate-400">(ì‚¬ìš©ì ì…ë ¥ ê¸°ì¤€)</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-amber-50 p-5 rounded-xl shadow-sm border border-amber-200 border-l-4 border-l-amber-500 cursor-pointer hover:shadow-md hover:border-amber-400 transition-all stat-card"
                            data-stat-type="execAmount" data-mode="manual">
                            <h3 class="text-xs font-medium text-amber-700 mb-1">2025ë…„ ì‹¤ì  (ê¸ˆì•¡)</h3>
                            <p class="text-xl font-bold text-amber-900" id="totalExecAmountManual">-</p>
                        </div>
                        <div class="bg-amber-50 p-5 rounded-xl shadow-sm border border-amber-200 border-l-4 border-l-amber-600 cursor-pointer hover:shadow-md hover:border-amber-400 transition-all stat-card"
                            data-stat-type="execCount" data-mode="manual">
                            <h3 class="text-xs font-medium text-amber-700 mb-1">2025ë…„ ì‹¤ì  (ì„¸ëŒ€ìˆ˜)</h3>
                            <p class="text-xl font-bold text-amber-900" id="totalExecCountManual">-</p>
                            <span class="text-xs text-amber-600" id="totalProgressRateManual">ì „ì²´ ëŒ€ë¹„ -%</span>
                        </div>
                        <div class="bg-amber-50 p-5 rounded-xl shadow-sm border border-amber-200 border-l-4 border-l-amber-500 cursor-pointer hover:shadow-md hover:border-amber-400 transition-all stat-card"
                            data-stat-type="avgAmount" data-mode="manual">
                            <h3 class="text-xs font-medium text-amber-700 mb-1">ìˆ˜ë™ ì˜ˆì¸¡ (ê¸ˆì•¡)</h3>
                            <p class="text-xl font-bold text-amber-900" id="totalAvgAmountManual">-</p>
                        </div>
                        <div class="bg-amber-50 p-5 rounded-xl shadow-sm border border-amber-200 border-l-4 border-l-amber-600 cursor-pointer hover:shadow-md hover:border-amber-400 transition-all stat-card"
                            data-stat-type="avgCount" data-mode="manual">
                            <h3 class="text-xs font-medium text-amber-700 mb-1">ìˆ˜ë™ ì˜ˆì¸¡ (ì„¸ëŒ€ìˆ˜)</h3>
                            <p class="text-xl font-bold text-amber-900" id="totalAvgCountManual">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- [New] Advanced Insights Section Removed -->

            <!-- Auto Calculation Table -->
            <div id="autoTableSection" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div
                    class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-blue-50 to-indigo-50">
                    <h2 class="font-bold text-slate-800">
                        <i class="fa-solid fa-calculator mr-2 text-blue-600"></i><span id="autoTableTitleText">ê±´ë¬¼ë™ë³„ ìƒì„¸
                            ë¹„êµ ë¶„ì„</span>
                        <span class="text-sm font-normal text-blue-600" id="autoTableModeLabel">(ìë™ ê³„ì‚° ëª¨ë“œ)</span>
                    </h2>

                    <div class="flex gap-2 relative z-40">
                        <button id="fullscreenTableBtn"
                            class="text-sm bg-white border border-blue-300 hover:bg-blue-50 text-blue-700 px-3 py-1.5 rounded shadow-sm transition-colors relative z-50 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-expand mr-1"></i> ì „ì²´ í™”ë©´
                        </button>
                        <button id="htmlDnBtn"
                            class="text-sm bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded shadow-sm transition-colors relative z-50 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-code mr-1"></i> ìŠ¤ëƒ…ìƒ· ì €ì¥
                        </button>
                        <button id="exportBtn"
                            class="text-sm bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-3 py-1.5 rounded shadow-sm transition-colors relative z-50 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-download mr-1"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar" style="max-height: 600px;">
                    <table class="w-full text-sm text-left border-collapse relative">
                        <thead
                            class="text-xs text-slate-500 uppercase bg-slate-100 border-b border-slate-200 sticky top-0 z-30">
                            <tr>
                                <th rowspan="2"
                                    class="px-4 py-3 font-bold bg-slate-100 border-r border-slate-200 sticky-col z-40 w-32 text-center shadow-sm cursor-pointer hover:bg-slate-200 sort-header"
                                    data-sort-key="building">
                                    ê±´ë¬¼ë™ <i class="fa-solid fa-sort text-slate-300 ml-1"></i></th>
                                <th colspan="6"
                                    class="px-4 py-2 font-bold bg-emerald-50 text-emerald-800 text-center border-r border-slate-200">
                                    ì„¸ëŒ€ìˆ˜ ë¶„ì„ (ê³„ì•½ ê±´ìˆ˜)</th>
                                <th colspan="6" class="px-4 py-2 font-bold bg-blue-50 text-blue-800 text-center">ìš´ì˜ì„± ì‘ì—…ë¹„
                                    ë¶„ì„
                                    (PO ê¸ˆì•¡)</th>
                            </tr>
                            </tr>
                            <tr>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="totalUnits">
                                    ì „ì²´<br>ì„¸ëŒ€ <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="avgCount">
                                    ì˜ˆì¸¡<br>(í‰ê· ) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-emerald-400 hover:text-emerald-600 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56"
                                            id="tooltip-avg-count">ì‚°ì‹ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-100 text-emerald-900 border-r border-slate-200 font-bold dynamic-year-header cursor-pointer hover:bg-emerald-200 sort-header"
                                    data-sort-key="currentCount">
                                    25ë…„<br>ì‹¤ì  <i class="fa-solid fa-sort text-emerald-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-emerald-600 hover:text-emerald-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64"
                                            id="tooltip-current-count">[ì‚°ì‹] í•´ë‹¹ ì—°ë„ ì‹¤ì  ì„¸ëŒ€ìˆ˜(ê±´ìˆ˜) í•©ê³„</span>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="diffCount">
                                    ì°¨ì´<br>(ì‹¤ì -ì˜ˆì¸¡) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="progressRate">
                                    ì§„ì²™ë¥ <br>(ì‹¤ì /ì „ì²´) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th
                                    class="px-2 py-2 text-center bg-emerald-50/50 text-xs cursor-help border-r border-slate-200">
                                    ì¶”ì„¸<br>(Trend)
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-emerald-600 hover:text-emerald-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-72 text-left">
                                            [ì¶”ì„¸ ë¶„ì„ ê¸°ì¤€: ì—°í‰ê·  ì¦ê°]<br>
                                            <span class="text-red-400 font-bold">ğŸ“ˆ ìƒìŠ¹ì„¸</span>: ì—°ê°„ +0.5ê±´ ì´ìƒ ì¦ê°€<br>
                                            <span class="text-blue-400 font-bold">â†˜ï¸ í•˜ë½ì„¸</span>: ì—°ê°„ -0.5ê±´ ì´í•˜ ê°ì†Œ<br>
                                            <span class="text-slate-400">â¡ï¸ ë³´í•©</span>: ë³€ë™í­ ë¯¸ë¯¸ (-0.5 ~ +0.5)<br><br>
                                            * ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì˜ ì„ í˜• íšŒê·€ ê¸°ìš¸ê¸°ë¡œ ì‚°ì¶œë©ë‹ˆë‹¤.
                                        </span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-50/50 border-r border-slate-200 text-xs cursor-pointer hover:bg-blue-100 sort-header"
                                    data-sort-key="avgUnitAmount">
                                    ì„¸ëŒ€ë‹¹<br>(ì˜ˆì¸¡) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-400 hover:text-blue-600 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56"
                                            id="tooltip-unit-amt">ì‚°ì‹ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-100 text-blue-900 border-r border-slate-200 font-bold text-xs dynamic-year-header cursor-pointer hover:bg-blue-200 sort-header"
                                    data-sort-key="currentUnitAmount">
                                    ì„¸ëŒ€ë‹¹<br>(ì‹¤ì ) <i class="fa-solid fa-sort text-blue-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64"
                                            id="tooltip-current-unit">[ì‚°ì‹] í•´ë‹¹ ì—°ë„ ì „ì²´ê¸ˆì•¡ Ã· ì‹¤ì  ì„¸ëŒ€ìˆ˜</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-50/50 border-r border-slate-200 text-xs cursor-pointer hover:bg-blue-100 sort-header"
                                    data-sort-key="avgAmount">
                                    ì „ì²´ê¸ˆì•¡<br>(ì˜ˆì¸¡) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-400 hover:text-blue-600 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56"
                                            id="tooltip-total-amt">ì‚°ì‹ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-100 text-blue-900 border-r border-slate-200 font-bold text-xs dynamic-year-header cursor-pointer hover:bg-blue-200 sort-header"
                                    data-sort-key="currentAmount">
                                    ì „ì²´ê¸ˆì•¡<br>(ì‹¤ì ) <i class="fa-solid fa-sort text-blue-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64"
                                            id="tooltip-current-amount">[ì‚°ì‹] í•´ë‹¹ ì—°ë„ ìš´ì˜ì„± ì‘ì—…ë¹„ ì´ì•¡ í•©ê³„</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-50/50 text-xs cursor-pointer hover:bg-blue-100 sort-header"
                                    data-sort-key="diffAmount">
                                    ì°¨ì•¡<br>(ì‹¤ì -ì˜ˆì¸¡) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-50/50 text-xs cursor-help">
                                    ì¶”ì„¸<br>(Trend)
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-72 text-left">
                                            [ì¶”ì„¸ ë¶„ì„ ê¸°ì¤€: ì—°í‰ê·  ì¦ê°]<br>
                                            <span class="text-red-400 font-bold">ğŸ“ˆ ìƒìŠ¹ì„¸</span>: ì—°ê°„ +10ë§Œì› ì´ìƒ ì¦ê°€<br>
                                            <span class="text-blue-400 font-bold">â†˜ï¸ í•˜ë½ì„¸</span>: ì—°ê°„ -10ë§Œì› ì´í•˜ ê°ì†Œ<br>
                                            <span class="text-slate-400">â¡ï¸ ë³´í•©</span>: ë³€ë™í­ ë¯¸ë¯¸ (-10ë§Œ ~ +10ë§Œ)<br><br>
                                            * ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì˜ ì„ í˜• íšŒê·€ ê¸°ìš¸ê¸°ë¡œ ì‚°ì¶œë©ë‹ˆë‹¤.
                                        </span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="autoTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>

            <!-- Manual Input Table -->
            <div id="manualTableSection"
                class="hidden bg-white rounded-xl shadow-sm border border-amber-200 overflow-hidden">
                <div
                    class="px-6 py-4 border-b border-amber-100 flex justify-between items-center bg-gradient-to-r from-amber-50 to-yellow-50">
                    <h2 class="font-bold text-slate-800">
                        <i class="fa-solid fa-user-pen mr-2 text-amber-600"></i><span id="manualTableTitleText">ê±´ë¬¼ë™ë³„ ìƒì„¸
                            ë¹„êµ ë¶„ì„</span>
                        <span class="text-sm font-normal text-amber-600" id="manualTableModeLabel">(ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ)</span>
                    </h2>

                    <div class="flex gap-2 relative z-40">
                        <button id="fullscreenTableBtnManual"
                            class="text-sm bg-white border border-amber-300 hover:bg-amber-50 text-amber-700 px-3 py-1.5 rounded shadow-sm transition-colors relative z-50 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-expand mr-1"></i> ì „ì²´ í™”ë©´
                        </button>
                        <button id="htmlDnBtnManual"
                            class="text-sm bg-white border border-amber-300 hover:bg-amber-50 text-amber-700 px-3 py-1.5 rounded shadow-sm transition-colors relative z-50 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-code mr-1"></i> ìŠ¤ëƒ…ìƒ· ì €ì¥
                        </button>
                        <button id="exportBtnManual"
                            class="text-sm bg-white border border-amber-300 hover:bg-amber-50 text-amber-700 px-3 py-1.5 rounded shadow-sm transition-colors relative z-50 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-download mr-1"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto custom-scrollbar" style="max-height: 600px;">
                    <table class="w-full text-sm text-left border-collapse relative">
                        <thead
                            class="text-xs text-slate-500 uppercase bg-amber-50 border-b border-amber-200 sticky top-0 z-30">
                            <tr>
                                <th rowspan="2"
                                    class="px-4 py-3 font-bold bg-amber-50 border-r border-amber-200 sticky-col z-40 w-32 text-center shadow-sm cursor-pointer hover:bg-amber-100 sort-header"
                                    data-sort-key="building">
                                    ê±´ë¬¼ë™ <i class="fa-solid fa-sort text-slate-300 ml-1"></i></th>
                                <th colspan="6"
                                    class="px-4 py-2 font-bold bg-emerald-50 text-emerald-800 text-center border-r border-amber-200">
                                    ì„¸ëŒ€ìˆ˜ ë¶„ì„ (ê³„ì•½ ê±´ìˆ˜)</th>
                                <th colspan="6" class="px-4 py-2 font-bold bg-blue-50 text-blue-800 text-center">ìš´ì˜ì„± ì‘ì—…ë¹„
                                    ë¶„ì„
                                    (PO ê¸ˆì•¡)</th>
                            </tr>
                            </tr>
                            <tr>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-amber-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="totalUnits">
                                    ì „ì²´<br>ì„¸ëŒ€ <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th class="px-3 py-2 text-center bg-amber-50/50 border-r border-amber-200 cursor-pointer hover:bg-amber-100 sort-header"
                                    data-sort-key="avgCount">
                                    ì˜ˆì¸¡<br><span class="text-amber-600">(ìˆ˜ë™)</span> <i
                                        class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-amber-500 hover:text-amber-700 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56"
                                            id="tooltip-avg-count-m">ì‚°ì‹ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-100 text-emerald-900 border-r border-amber-200 font-bold dynamic-year-header cursor-pointer hover:bg-emerald-200 sort-header"
                                    data-sort-key="currentCount">
                                    25ë…„<br>ì‹¤ì  <i class="fa-solid fa-sort text-emerald-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-emerald-600 hover:text-emerald-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64"
                                            id="tooltip-current-count-m">[ì‚°ì‹] í•´ë‹¹ ì—°ë„ ì‹¤ì  ì„¸ëŒ€ìˆ˜(ê±´ìˆ˜) í•©ê³„</span>
                                    </div>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-amber-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="diffCount">
                                    ì°¨ì´<br>(ì‹¤ì -ì˜ˆì¸¡) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-amber-200 cursor-pointer hover:bg-emerald-100 sort-header"
                                    data-sort-key="progressRate">
                                    ì§„ì²™ë¥ <br>(ì‹¤ì /ì „ì²´) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th
                                    class="px-2 py-2 text-center bg-emerald-50/50 text-xs cursor-help border-r border-amber-200">
                                    ì¶”ì„¸<br>(Trend)
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-emerald-600 hover:text-emerald-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-72 text-left">
                                            [ì¶”ì„¸ ë¶„ì„ ê¸°ì¤€: ì—°í‰ê·  ì¦ê°]<br>
                                            <span class="text-red-400 font-bold">ğŸ“ˆ ìƒìŠ¹ì„¸</span>: ì—°ê°„ +0.5ê±´ ì´ìƒ ì¦ê°€<br>
                                            <span class="text-blue-400 font-bold">â†˜ï¸ í•˜ë½ì„¸</span>: ì—°ê°„ -0.5ê±´ ì´í•˜ ê°ì†Œ<br>
                                            <span class="text-slate-400">â¡ï¸ ë³´í•©</span>: ë³€ë™í­ ë¯¸ë¯¸ (-0.5 ~ +0.5)<br><br>
                                            * ìˆ˜ë™ ëª¨ë“œì—ì„œë„ <span class="text-emerald-300">ê³¼ê±° ì‹¤ì  ë°ì´í„°</span>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
                                        </span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-amber-50/50 border-r border-amber-200 text-xs cursor-pointer hover:bg-amber-100 sort-header"
                                    data-sort-key="avgUnitAmount">
                                    ì„¸ëŒ€ë‹¹<br><span class="text-amber-600">(ìˆ˜ë™)</span> <i
                                        class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-amber-500 hover:text-amber-700 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56"
                                            id="tooltip-unit-amt-m">ì‚°ì‹ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-100 text-blue-900 border-r border-amber-200 font-bold text-xs dynamic-year-header cursor-pointer hover:bg-blue-200 sort-header"
                                    data-sort-key="currentUnitAmount">
                                    ì„¸ëŒ€ë‹¹<br>(ì‹¤ì ) <i class="fa-solid fa-sort text-blue-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64"
                                            id="tooltip-current-unit-m">[ì‚°ì‹] í•´ë‹¹ ì—°ë„ ì „ì²´ê¸ˆì•¡ Ã· ì‹¤ì  ì„¸ëŒ€ìˆ˜</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-amber-50/50 border-r border-amber-200 text-xs cursor-pointer hover:bg-amber-100 sort-header"
                                    data-sort-key="avgAmount">
                                    ì „ì²´ê¸ˆì•¡<br><span class="text-amber-600">(ìˆ˜ë™)</span> <i
                                        class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-amber-500 hover:text-amber-700 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56"
                                            id="tooltip-total-amt-m">ì‚°ì‹ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-100 text-blue-900 border-r border-amber-200 font-bold text-xs dynamic-year-header cursor-pointer hover:bg-blue-200 sort-header"
                                    data-sort-key="currentAmount">
                                    ì „ì²´ê¸ˆì•¡<br>(ì‹¤ì ) <i class="fa-solid fa-sort text-blue-300 ml-1"></i>
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64"
                                            id="tooltip-current-amount-m">[ì‚°ì‹] í•´ë‹¹ ì—°ë„ ìš´ì˜ì„± ì‘ì—…ë¹„ ì´ì•¡ í•©ê³„</span>
                                    </div>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-50/50 text-xs cursor-pointer hover:bg-blue-100 sort-header"
                                    data-sort-key="diffAmount">
                                    ì°¨ì•¡<br>(ì‹¤ì -ì˜ˆì¸¡) <i class="fa-solid fa-sort text-slate-300 ml-1"></i>
                                </th>
                                <th class="px-2 py-2 text-center bg-blue-50/50 text-xs cursor-help">
                                    ì¶”ì„¸<br>(Trend)
                                    <div class="tooltip-container">
                                        <i
                                            class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                        <span
                                            class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-72 text-left">
                                            [ì¶”ì„¸ ë¶„ì„ ê¸°ì¤€: ì—°í‰ê·  ì¦ê°]<br>
                                            <span class="text-red-400 font-bold">ğŸ“ˆ ìƒìŠ¹ì„¸</span>: ì—°ê°„ +10ë§Œì› ì´ìƒ ì¦ê°€<br>
                                            <span class="text-blue-400 font-bold">â†˜ï¸ í•˜ë½ì„¸</span>: ì—°ê°„ -10ë§Œì› ì´í•˜ ê°ì†Œ<br>
                                            <span class="text-slate-400">â¡ï¸ ë³´í•©</span>: ë³€ë™í­ ë¯¸ë¯¸ (-10ë§Œ ~ +10ë§Œ)<br><br>
                                            * ìˆ˜ë™ ëª¨ë“œì—ì„œë„ <span class="text-blue-300">ê³¼ê±° ì‹¤ì  ë°ì´í„°</span>ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.
                                        </span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="manualTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-20 bg-white rounded-xl border border-dashed border-slate-300">
            <div class="text-slate-300 text-6xl mb-4"><i class="fa-regular fa-file-excel"></i></div>
            <h3 class="text-lg font-medium text-slate-900 mb-1">ë°ì´í„° ë¶„ì„ ì¤€ë¹„ ì™„ë£Œ</h3>
            <p class="text-slate-500 mb-6">ìƒë‹¨ì˜ 'ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¡œìš°ë°ì´í„°(.xlsx)ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-slate-800 font-medium">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
        </div>
    </div>

    <!-- Comparison Analysis Modal -->
    <div id="comparisonModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="modal-background-overlay" aria-hidden="true" id="modalOverlay" style="pointer-events: auto;">
            </div>

            <!-- Modal panel -->
            <div class="modal-panel sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full" style="pointer-events: auto;">
                <!-- Resize Handles -->
                <div class="resize-handle resize-handle-e" data-resize="e"></div>
                <div class="resize-handle resize-handle-s" data-resize="s"></div>
                <div class="resize-handle resize-handle-se" data-resize="se"></div>

                <!-- Header -->
                <div class="modal-header-handle bg-gradient-to-r from-purple-600 to-indigo-700 px-6 py-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                <i class="fa-solid fa-chart-line text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white" id="modal-title">ìë™ vs ìˆ˜ë™ ëª¨ë“œ ì‹¬ì¸µ ë¹„êµ ë¶„ì„</h3>
                                <p class="text-purple-100 text-sm mt-1">ì˜ˆì¸¡ ì •í™•ë„ í–¥ìƒì„ ìœ„í•œ ì¸ì‚¬ì´íŠ¸</p>
                            </div>
                        </div>
                        <button id="closeModalBtn"
                            class="text-white hover:text-purple-200 transition-colors relative z-30">
                            <i class="fa-solid fa-xmark text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="px-6 py-6 max-h-[70vh] overflow-y-auto">
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-blue-700">ì˜ˆì¸¡ ê¸ˆì•¡ ì°¨ì´</span>
                                <i class="fa-solid fa-coins text-blue-600"></i>
                            </div>
                            <p class="text-2xl font-bold text-blue-900" id="totalAmountDiff">-</p>
                            <p class="text-xs text-blue-600 mt-1" id="totalAmountDiffPercent">-</p>
                        </div>
                        <div
                            class="bg-gradient-to-br from-emerald-50 to-emerald-100 p-4 rounded-xl border border-emerald-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-emerald-700">ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜ ì°¨ì´</span>
                                <i class="fa-solid fa-home text-emerald-600"></i>
                            </div>
                            <p class="text-2xl font-bold text-emerald-900" id="totalCountDiff">-</p>
                            <p class="text-xs text-emerald-600 mt-1" id="totalCountDiffPercent">-</p>
                        </div>
                        <div
                            class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-xl border border-amber-200">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-amber-700">í‰ê·  ì„¸ëŒ€ë‹¹ ê¸ˆì•¡ ì°¨ì´</span>
                                <i class="fa-solid fa-calculator text-amber-600"></i>
                            </div>
                            <p class="text-2xl font-bold text-amber-900" id="avgUnitAmountDiff">-</p>
                            <p class="text-xs text-amber-600 mt-1" id="avgUnitAmountDiffPercent">-</p>
                        </div>
                    </div>

                    <!-- Comparison Table -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Auto Mode Stats -->
                        <div class="bg-blue-50 rounded-xl p-5 border border-blue-200">
                            <div class="flex items-center gap-2 mb-4">
                                <i class="fa-solid fa-calculator text-blue-600"></i>
                                <h4 class="font-bold text-blue-900">ìë™ ê³„ì‚° ëª¨ë“œ</h4>
                                <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded"
                                    id="modalYearSpanLabel">-ê°œë…„ í‰ê· </span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-blue-700">ì´ ì˜ˆì¸¡ ê¸ˆì•¡</span>
                                    <span class="font-bold text-blue-900" id="autoTotalAmount">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-blue-700">ì´ ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜</span>
                                    <span class="font-bold text-blue-900" id="autoTotalCount">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-blue-700">í‰ê·  ì„¸ëŒ€ë‹¹ ê¸ˆì•¡</span>
                                    <span class="font-bold text-blue-900" id="autoAvgUnitAmount">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Mode Stats -->
                        <div class="bg-amber-50 rounded-xl p-5 border border-amber-200">
                            <div class="flex items-center gap-2 mb-4">
                                <i class="fa-solid fa-user-pen text-amber-600"></i>
                                <h4 class="font-bold text-amber-900">ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ</h4>
                                <span class="text-xs bg-amber-200 text-amber-800 px-2 py-1 rounded">ì‚¬ìš©ì ì¡°ì •</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-amber-700">ì´ ì˜ˆì¸¡ ê¸ˆì•¡</span>
                                    <span class="font-bold text-amber-900" id="manualTotalAmount">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-amber-700">ì´ ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜</span>
                                    <span class="font-bold text-amber-900" id="manualTotalCount">-</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-sm text-amber-700">í‰ê·  ì„¸ëŒ€ë‹¹ ê¸ˆì•¡</span>
                                    <span class="font-bold text-amber-900" id="manualAvgUnitAmount">-</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Building Differences Table -->
                    <div class="mb-6">
                        <h4 class="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-building text-purple-600"></i>
                            ê±´ë¬¼ë™ë³„ ìƒìœ„ ì°¨ì´ ë¶„ì„ (TOP 10)
                        </h4>
                        <div class="overflow-x-auto rounded-lg border border-slate-200">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-100 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold text-slate-700">ìˆœìœ„</th>
                                        <th class="px-4 py-3 text-left font-semibold text-slate-700">ê±´ë¬¼ë™</th>
                                        <th class="px-4 py-3 text-right font-semibold text-slate-700">ê¸ˆì•¡ ì°¨ì´</th>
                                        <th class="px-4 py-3 text-right font-semibold text-slate-700">ì„¸ëŒ€ìˆ˜ ì°¨ì´</th>
                                        <th class="px-4 py-3 text-right font-semibold text-slate-700">ì„¸ëŒ€ë‹¹ ê¸ˆì•¡ ì°¨ì´</th>
                                        <th class="px-4 py-3 text-center font-semibold text-slate-700">ë³€í™”ìœ¨</th>
                                    </tr>
                                </thead>
                                <tbody id="buildingDiffTableBody" class="divide-y divide-slate-100">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Insights Section -->
                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border border-purple-200">
                        <h4 class="font-bold text-purple-900 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-lightbulb text-yellow-500"></i>
                            í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ë° ê¶Œì¥ì‚¬í•­
                        </h4>
                        <div id="insightsContent" class="space-y-3 text-sm text-slate-700">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-200">
                    <button id="closeModalBtn2"
                        class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-100 transition-colors">
                        ë‹«ê¸°
                    </button>
                    <button id="exportComparisonBtn"
                        class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-700 text-white rounded-lg hover:from-purple-700 hover:to-indigo-800 transition-all shadow-sm">
                        <i class="fa-solid fa-download mr-2"></i>ë¹„êµ ë¶„ì„ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- [PRD/IMP] Sankey Diagram Modal (Fund Flow Visualization) -->
    <div id="sankeyModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="sankey-title" role="dialog"
        aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="modal-background-overlay" aria-hidden="true" id="sankeyModalOverlay"
                style="pointer-events: auto;"></div>

            <!-- Modal panel -->
            <div class="modal-panel sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full" style="pointer-events: auto;">
                <!-- Resize Handles -->
                <div class="resize-handle resize-handle-e" data-resize="e"></div>
                <div class="resize-handle resize-handle-s" data-resize="s"></div>
                <div class="resize-handle resize-handle-se" data-resize="se"></div>

                <!-- Header -->
                <div class="modal-header-handle bg-gradient-to-r from-blue-700 via-indigo-700 to-violet-800 px-6 py-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                <i class="fa-solid fa-diagram-project text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white" id="sankey-title">ìê¸ˆ íë¦„ Sankey ë‹¤ì´ì–´ê·¸ë¨</h3>
                                <p class="text-blue-200 text-sm mt-1">ë°œì£¼ì²˜ â†’ ì‘ì—…ìœ í˜• â†’ ê±´ë¬¼ë™ â†’ ì´ ì˜ˆì¸¡ê¸ˆì•¡</p>
                            </div>
                        </div>
                        <button id="closeSankeyBtn"
                            class="text-white hover:text-slate-300 transition-colors relative z-30">
                            <i class="fa-solid fa-xmark text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Sankey Controls -->
                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-4">
                            <!-- Top-N Filter -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-slate-700">í‘œì‹œ ê±´ë¬¼ìˆ˜:</label>
                                <select id="sankeyTopN"
                                    class="px-3 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                    <option value="5">ìƒìœ„ 5ê°œ</option>
                                    <option value="10" selected>ìƒìœ„ 10ê°œ</option>
                                    <option value="15">ìƒìœ„ 15ê°œ</option>
                                    <option value="all">ì „ì²´</option>
                                </select>
                            </div>
                            <!-- Data Mode -->
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium text-slate-700">ë°ì´í„°:</label>
                                <div class="flex gap-1 bg-white border border-slate-300 rounded-lg p-0.5">
                                    <button id="sankeyAutoDataBtn"
                                        class="px-3 py-1 rounded text-sm transition-all bg-blue-600 text-white">ìë™
                                        ì˜ˆì¸¡</button>
                                    <button id="sankeyManualDataBtn"
                                        class="px-3 py-1 rounded text-sm transition-all text-slate-600 hover:bg-slate-100">ìˆ˜ë™
                                        ì˜ˆì¸¡</button>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="sankeyTotalAmount"
                                class="text-sm font-bold text-indigo-700 bg-indigo-50 px-3 py-1 rounded-lg"></span>
                        </div>
                    </div>
                </div>

                <!-- Sankey Chart Container -->
                <div class="px-6 py-6 bg-white">
                    <div id="sankeyContainer" class="relative w-full"
                        style="height: 500px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0;">
                        <!-- SVG Chart will be rendered here -->
                        <svg id="sankeySvg" width="100%" height="100%" style="display: block;"></svg>

                        <!-- Tooltip -->
                        <div id="sankeyTooltip"
                            class="hidden absolute bg-slate-900 text-white text-xs rounded-lg px-3 py-2 shadow-lg z-50 pointer-events-none max-w-xs">
                            <div id="sankeyTooltipContent"></div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-4 flex items-center justify-center gap-6 text-xs text-slate-600">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-gradient-to-r from-blue-500 to-blue-600"></div>
                            <span>ë°œì£¼ì²˜</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-gradient-to-r from-violet-500 to-violet-600"></div>
                            <span>ì‘ì—…ìœ í˜•</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-gradient-to-r from-emerald-500 to-emerald-600"></div>
                            <span>ê±´ë¬¼ë™</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-gradient-to-r from-amber-500 to-amber-600"></div>
                            <span>ì´ ì˜ˆì¸¡ê¸ˆì•¡</span>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-slate-50 px-6 py-4 flex justify-between items-center border-t border-slate-200">
                    <div class="text-xs text-slate-500">
                        <i class="fa-solid fa-info-circle mr-1"></i>
                        ë…¸ë“œ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤. íë¦„ì„ ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ê²½ë¡œê°€ ê°•ì¡°ë©ë‹ˆë‹¤.
                    </div>
                    <div class="flex gap-3">
                        <button id="closeSankeyBtn2"
                            class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-100 transition-colors">
                            ë‹«ê¸°
                        </button>
                        <button id="exportSankeyBtn"
                            class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-lg hover:from-blue-700 hover:to-indigo-800 transition-all shadow-sm">
                            <i class="fa-solid fa-download mr-2"></i>ì´ë¯¸ì§€ ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Data Viewer Modal -->
    <div id="rawDataModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="raw-data-title"
        role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
            <!-- Background overlay -->
            <div class="modal-background-overlay" aria-hidden="true" id="rawDataModalOverlay"
                style="pointer-events: auto;"></div>

            <!-- Modal panel -->
            <div class="modal-panel sm:my-8 sm:align-middle sm:max-w-7xl sm:w-full" style="pointer-events: auto;">
                <!-- Resize Handles -->
                <div class="resize-handle resize-handle-e" data-resize="e"></div>
                <div class="resize-handle resize-handle-s" data-resize="s"></div>
                <div class="resize-handle resize-handle-se" data-resize="se"></div>

                <!-- Header -->
                <div class="modal-header-handle bg-gradient-to-r from-slate-700 to-slate-900 px-6 py-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                <i class="fa-solid fa-database text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white" id="raw-data-title">ì›ë³¸ ë°ì´í„° ë·°ì–´</h3>
                                <p class="text-slate-300 text-sm mt-1">ì—…ë¡œë“œëœ ë¡œìš°ë°ì´í„° ì „ì²´ ë³´ê¸°</p>
                            </div>
                        </div>
                        <button id="closeRawDataBtn"
                            class="text-white hover:text-slate-300 transition-colors relative z-30">
                            <i class="fa-solid fa-xmark text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="px-6 py-6">
                    <!-- Search and Filter -->
                    <div class="mb-4 flex gap-4 items-center">
                        <div class="flex-1">
                            <div class="relative">
                                <i
                                    class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="rawDataSearch"
                                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="ê²€ìƒ‰... (ê±´ë¬¼ë™, ì‘ì—…ìœ í˜• ë“±)">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-600">ì´ <span id="rawDataCount"
                                    class="font-bold text-blue-600">0</span>ê°œ</span>
                            <button id="exportRawDataBtn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                <i class="fa-solid fa-download"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="overflow-x-auto overflow-y-auto max-h-[60vh] border border-slate-200 rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-100 sticky top-0 z-10">
                                <tr id="rawDataTableHeader">
                                    <!-- Headers populated by JS -->
                                </tr>
                            </thead>
                            <tbody id="rawDataTableBody" class="divide-y divide-slate-200">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-4 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-slate-600">í˜ì´ì§€ë‹¹</span>
                            <select id="rawDataPageSize" class="border border-slate-300 rounded px-2 py-1 text-sm">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                            <span class="text-sm text-slate-600">ê°œì”© ë³´ê¸°</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="rawDataPrevPage"
                                class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            <span class="text-sm text-slate-700">
                                <span id="rawDataCurrentPage">1</span> / <span id="rawDataTotalPages">1</span>
                            </span>
                            <button id="rawDataNextPage"
                                class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-200">
                    <button id="closeRawDataBtn2"
                        class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-100 transition-colors">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fullscreen Table Modal -->
    <div id="fullscreenTableModal" class="hidden fixed inset-0 z-50 overflow-y-auto"
        aria-labelledby="fullscreen-table-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-2 pt-2 pb-2 text-center sm:block sm:p-2"
            style="pointer-events: none;">
            <!-- Background overlay -->
            <div class="modal-background-overlay" aria-hidden="true" id="fullscreenTableModalOverlay"
                style="pointer-events: auto;"></div>

            <!-- Modal panel - Full Screen -->
            <div class="modal-panel w-[98vw] max-w-none h-[98vh] sm:my-2 sm:align-middle" style="pointer-events: auto;">
                <!-- Resize Handles -->
                <div class="resize-handle resize-handle-e" data-resize="e"></div>
                <div class="resize-handle resize-handle-s" data-resize="s"></div>
                <div class="resize-handle resize-handle-se" data-resize="se"></div>

                <!-- Header -->
                <div class="modal-header-handle bg-gradient-to-r from-indigo-600 to-purple-700 px-6 py-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                <i class="fa-solid fa-expand text-white text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-white" id="fullscreenTableTitle">ê±´ë¬¼ë™ë³„ ìƒì„¸ ë¹„êµ ë¶„ì„ - ì „ì²´
                                </h3>
                                <p class="text-indigo-200 text-sm mt-1" id="fullscreenTableModeLabel">ìë™ ê³„ì‚° ëª¨ë“œ</p>
                            </div>
                        </div>
                        <button id="closeFullscreenTableBtn"
                            class="text-white hover:text-indigo-200 transition-colors relative z-30 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-xmark text-2xl"></i>
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <div class="px-6 py-4 flex flex-col" style="height: calc(98vh - 140px);">
                    <!-- Search and Mode Toggle -->
                    <div class="mb-3 flex gap-4 items-center justify-between flex-shrink-0">
                        <div class="flex-1">
                            <div class="relative">
                                <i
                                    class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" id="fullscreenTableSearch"
                                    class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                    placeholder="ê²€ìƒ‰... (ê±´ë¬¼ë™ëª…)">
                            </div>
                        </div>
                        <div class="flex items-center gap-2 relative z-20">
                            <button id="fullscreenAutoModeBtn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition relative z-30 cursor-pointer"
                                style="pointer-events: auto;">
                                <i class="fa-solid fa-calculator mr-1"></i> ìë™ ëª¨ë“œ
                            </button>
                            <button id="fullscreenManualModeBtn"
                                class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition relative z-30 cursor-pointer"
                                style="pointer-events: auto;">
                                <i class="fa-solid fa-user-pen mr-1"></i> ìˆ˜ë™ ëª¨ë“œ
                            </button>
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div
                        class="overflow-x-auto overflow-y-auto border border-slate-200 rounded-lg flex-1 custom-scrollbar">
                        <table class="w-full text-sm text-left border-collapse relative">
                            <thead id="fullscreenTableThead"
                                class="text-xs text-slate-500 uppercase bg-slate-100 border-b border-slate-200 sticky top-0 z-30">
                                <!-- Headers populated by JS (2 rows) -->
                            </thead>
                            <tbody id="fullscreenTableBody" class="divide-y divide-slate-100">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Footer -->
                <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-200 relative z-20">
                    <button id="exportFullscreenTableBtn"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 relative z-30 cursor-pointer"
                        style="pointer-events: auto;">
                        <i class="fa-solid fa-download"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button id="closeFullscreenTableBtn2"
                        class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-100 transition-colors relative z-30 cursor-pointer"
                        style="pointer-events: auto;">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Detail Modal -->
        <div id="statDetailModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="stat-detail-title"
            role="dialog" aria-modal="true">
            <div class="flex items-center justify-center min-h-screen px-2 pt-2 pb-2 text-center sm:block sm:p-2"
                style="pointer-events: none;">
                <!-- Background overlay -->
                <div class="modal-background-overlay" aria-hidden="true" id="statDetailModalOverlay"
                    style="pointer-events: auto;"></div>

                <!-- Modal panel - Full Screen -->
                <div class="modal-panel w-[98vw] max-w-none h-[98vh] sm:my-2 sm:align-middle"
                    style="pointer-events: auto;">
                    <!-- Resize Handles -->
                    <div class="resize-handle resize-handle-e" data-resize="e"></div>
                    <div class="resize-handle resize-handle-s" data-resize="s"></div>
                    <div class="resize-handle resize-handle-se" data-resize="se"></div>

                    <!-- Header -->
                    <div id="statDetailHeader"
                        class="modal-header-handle bg-gradient-to-r from-blue-600 to-indigo-700 px-6 py-5">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                    <i id="statDetailIcon" class="fa-solid fa-chart-bar text-white text-2xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-white" id="stat-detail-title">í†µê³„ ìƒì„¸ ë°ì´í„°</h3>
                                    <p class="text-blue-200 text-sm mt-1" id="statDetailSubtitle">ì—°ê³„ëœ ë¡œìš°ë°ì´í„°</p>
                                </div>
                            </div>
                            <button id="closeStatDetailBtn"
                                class="text-white hover:text-blue-200 transition-colors relative z-30 cursor-pointer"
                                style="pointer-events: auto;">
                                <i class="fa-solid fa-xmark text-2xl"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="px-6 py-4 flex flex-col" style="height: calc(98vh - 140px);">
                        <!-- Search and Count -->
                        <div class="mb-3 flex gap-4 items-center justify-between flex-shrink-0">
                            <div class="flex-1">
                                <div class="relative">
                                    <i
                                        class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" id="statDetailSearch"
                                        class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="ê²€ìƒ‰...">
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-sm text-slate-600">
                                    <i class="fa-solid fa-table-list mr-1"></i>
                                    ì´ <span id="statDetailCount" class="font-bold text-blue-600">0</span>ê±´
                                </span>
                            </div>
                        </div>

                        <!-- Data Table -->
                        <div
                            class="overflow-x-auto overflow-y-auto border border-slate-200 rounded-lg flex-1 custom-scrollbar">
                            <table class="w-full text-sm text-left border-collapse relative">
                                <thead id="statDetailTableHead"
                                    class="text-xs text-slate-500 uppercase bg-slate-100 border-b border-slate-200 sticky top-0 z-30">
                                    <!-- Headers populated by JS -->
                                </thead>
                                <tbody id="statDetailTableBody" class="divide-y divide-slate-100">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="bg-slate-50 px-6 py-4 flex justify-end gap-3 border-t border-slate-200 relative z-20">
                        <button id="exportStatDetailBtn"
                            class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors flex items-center gap-2 relative z-30 cursor-pointer"
                            style="pointer-events: auto;">
                            <i class="fa-solid fa-download"></i> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button id="closeStatDetailBtn2"
                            class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-100 transition-colors relative z-30 cursor-pointer"
                            style="pointer-events: auto;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logic Script -->
        <script>
            // --- [Integrity] Configuration & Logic ---
            const TOTAL_UNITS_MAP = {
                // Dormitory (Verified: 2026-02-05)
                "ì‚¬íƒ 101ë™": 16, "101ë™": 16,
                "ì‚¬íƒ 102ë™": 24, "102ë™": 24,
                "ì‚¬íƒ 103ë™": 24, "103ë™": 24,
                "ì‚¬íƒ 104ë™": 12, "104ë™": 12,

                "ì‚¬íƒ 1ë™": 32, "1ë™": 32,
                "ì‚¬íƒ 2ë™": 32, "2ë™": 32,
                "ì‚¬íƒ 5ë™": 30, "5ë™": 30,
                "ì‚¬íƒ 6ë™": 24, "6ë™": 24,
                "ì‚¬íƒ 7ë™": 40, "7ë™": 40,
                "ì‚¬íƒ 8ë™": 44, "8ë™": 44,
                "ì‚¬íƒ 9ë™": 30, "9ë™": 30,

                // Special Dormitory Buildings (No Unit Count managed, Value -1)
                "ê¸°ìˆ™ì‚¬ 3ë™": -1,
                "ê¸°ìˆ™ì‚¬ Aë™": -1,
                "ê¸°ìˆ™ì‚¬ Bë™": -1,
                "ê¸°ìˆ™ì‚¬ ABë™": -1,

                // Others -> 0 (N/A)
                "ê¸°íƒ€": 0,

                // Fallback
                "DEFAULT": 0
            };



            // [Integrity] Special Building Configuration (Client-Aware Ownership)
            const SPECIAL_BUILDING_CONFIG = {
                "ì‚¬íƒ 102ë™": {
                    total: 24,
                    defaultClient: "ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜", // Main Owner
                    exceptions: [
                        { client: "ì—˜ì§€í™”í•™", count: 1, reason: "202í˜¸ (ì—˜ì§€í™”í•™ ì†Œìœ )" }
                    ]
                }
            };

            // Helper to normalize keys for config lookup
            const getSpecialConfig = (buildingName) => {
                if (SPECIAL_BUILDING_CONFIG[buildingName]) return SPECIAL_BUILDING_CONFIG[buildingName];
                if (SPECIAL_BUILDING_CONFIG[buildingName.replace('ì‚¬íƒ ', '') + 'ë™']) return SPECIAL_BUILDING_CONFIG[buildingName.replace('ì‚¬íƒ ', '') + 'ë™']; // Try to match 102ë™ -> ì‚¬íƒ 102ë™ (Reverse not easy without map, sticking to simple keys)

                // Try simple removal of spaces
                const clean = buildingName.replace(/\s+/g, '');
                for (const key in SPECIAL_BUILDING_CONFIG) {
                    if (key.replace(/\s+/g, '') === clean) return SPECIAL_BUILDING_CONFIG[key];
                    // Check if "102ë™" matches "ì‚¬íƒ 102ë™"
                    if (key.includes(buildingName) || buildingName.includes(key)) {
                        if (Math.abs(key.length - buildingName.length) <= 3) return SPECIAL_BUILDING_CONFIG[key];
                    }
                }
                return null;
            };

            const getBuildingTotalUnits = (buildingName) => {
                // 0. Pre-normalization for Robustness
                const normalizedName = buildingName.trim();

                // 1. Exact Match
                if (TOTAL_UNITS_MAP[normalizedName] !== undefined) return TOTAL_UNITS_MAP[normalizedName];

                // 2. Remove spaces Match (e.g. "ì‚¬íƒ 1ë™" vs "ì‚¬íƒ1ë™")
                const cleanName = normalizedName.replace(/\s+/g, '');
                for (const key in TOTAL_UNITS_MAP) {
                    if (key.replace(/\s+/g, '') === cleanName) return TOTAL_UNITS_MAP[key];
                }

                // 3. Partial Match (e.g. "ì‚¬íƒ 1" matches "ì‚¬íƒ 1ë™")
                // Caution: "ì‚¬íƒ 1" matches "ì‚¬íƒ 1ë™" but "ì‚¬íƒ 10" should not match "ì‚¬íƒ 1ë™"
                for (const key in TOTAL_UNITS_MAP) {
                    // Check if the key contains the building name exactly (simplified logic)
                    if (key.includes(normalizedName) || normalizedName.includes(key)) {
                        // Simple heuristic: length difference shouldn't be too big to avoid 1 vs 10 confusion
                        if (Math.abs(key.length - normalizedName.length) <= 2) {
                            return TOTAL_UNITS_MAP[key];
                        }
                    }
                }

                return TOTAL_UNITS_MAP["DEFAULT"];
            };
            // getBuildingExclusion removed - Logic moved into analyze for context awareness

            // --- [Integrity] Utilities (Guide Compliant) ---
            const safe = (fn, fallback = null) => {
                try { return fn(); } catch (e) { console.error(e); return fallback; }
            };

            class FormatUtils {
                static currency(num) {
                    if (num === null || num === undefined || isNaN(num)) return '0';
                    return new Intl.NumberFormat('ko-KR').format(num);
                }
                static number(num) {
                    if (num === null || num === undefined || isNaN(num)) return '0';
                    return new Intl.NumberFormat('ko-KR').format(num);
                }
                static cleanString(str) { return str ? String(str).trim() : ''; }
                static parseYear(yearStr) {
                    const str = String(yearStr).replace(/[^0-9]/g, '');
                    if (str.length === 2) return parseInt('20' + str);
                    if (str.length === 4) return parseInt(str);
                    return null;
                }
            }

            // --- [Layer 1] Infrastructure ---
            class ExcelService {
                static read(file) {
                    const promise = new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const rawData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                                resolve(rawData);
                            } catch (err) {
                                reject(err);
                            }
                        };
                        reader.onerror = (err) => reject(err);
                        reader.readAsArrayBuffer(file);
                    });
                    return promise;
                }
            }

            // --- [Layer 2] Domain (Business Logic) ---
            class DomainService {

                // [Integrity] Smart Tooltip Positioning (Fixes Clipping & Occlusion)
                initSmartTooltips() {
                    // [Disabled] Use App.initSmartTooltips instead to avoid duplication and conflicts
                    return;


                }

                constructor() {
                    this.targetYear = 2025;
                    // [PRD/IMP] Advanced Forecasting Settings
                    this.forecastSettings = {
                        method: 'simple', // 'simple' | 'wma' (ê°€ì¤‘í‰ê· )
                        inflationRate: 0, // percentage (0-20)
                        wmaWeights: [0.5, 0.3, 0.2] // ê°€ì¤‘í‰ê·  ê°€ì¤‘ì¹˜ (ìµœê·¼ìˆœ 5:3:2)
                    };
                }

                // [PRD/IMP] Update Forecast Settings
                updateForecastSettings(settings) {
                    if (settings.method !== undefined) {
                        this.forecastSettings.method = settings.method;
                    }
                    if (settings.inflationRate !== undefined) {
                        this.forecastSettings.inflationRate = parseFloat(settings.inflationRate) || 0;
                    }
                    console.log('ğŸ“Š [DomainService] Forecast settings updated:', this.forecastSettings);
                }

                // [PRD/IMP] ê°€ì¤‘í‰ê· (WMA: Weighted Moving Average) ê³„ì‚°
                calculateWMA(values, weights = this.forecastSettings.wmaWeights) { // ê°€ì¤‘í‰ê·  ì‹¤ê³„ì‚° ë¡œì§
                    if (!values || values.length === 0) return 0;

                    // Sort values by year (descending) if needed - assume already sorted
                    const useValues = values.slice(0, weights.length);
                    const useWeights = weights.slice(0, useValues.length);

                    // Normalize weights if fewer years than weights
                    const totalWeight = useWeights.reduce((sum, w) => sum + w, 0);

                    let weightedSum = 0;
                    useValues.forEach((val, idx) => {
                        weightedSum += val * (useWeights[idx] / totalWeight);
                    });

                    return Math.round(weightedSum);
                }

                // [PRD/IMP] Apply Inflation Correction (Present Value)
                // Formula: Cost_adj = Cost_past Ã— (1 + Rate)^n where n = years elapsed
                applyInflationCorrection(amount, yearsElapsed, rate = this.forecastSettings.inflationRate) {
                    if (rate <= 0 || yearsElapsed <= 0) return amount;
                    const rateDecimal = rate / 100;
                    return Math.round(amount * Math.pow(1 + rateDecimal, yearsElapsed));
                }

                // [PRD/IMP] ê°€ì¤‘í‰ê·  ë° ì¸í”Œë ˆì´ì…˜ì„ ë°˜ì˜í•œ ì˜ˆì¸¡ ê³„ì‚°
                calculateForecast(yearlyData, yearsOfInterest, targetYear, key = 'amount') {
                    if (!yearlyData || yearsOfInterest.length === 0) return 0;

                    // Sort years descending (most recent first)
                    const sortedYears = [...yearsOfInterest].sort((a, b) => b - a);

                    // Get values with optional inflation correction
                    const values = sortedYears.map((year, idx) => {
                        let value = (yearlyData[year] && yearlyData[year][key]) || 0;

                        // Apply inflation correction if enabled
                        if (this.forecastSettings.inflationRate > 0 && key === 'amount') {
                            const yearsElapsed = targetYear - year;
                            value = this.applyInflationCorrection(value, yearsElapsed);
                        }

                        return value;
                    });

                    // Calculate based on method
                    // ê°€ì¤‘í‰ê· (WMA) ë°©ì‹ ì ìš©
                    if (this.forecastSettings.method === 'wma') {
                        return this.calculateWMA(values);
                    } else {
                        // Simple average
                        const sum = values.reduce((acc, val) => acc + val, 0);
                        return values.length > 0 ? Math.round(sum / values.length) : 0;
                    }
                }


                normalizeData(rawData) {
                    if (!rawData || !Array.isArray(rawData)) return [];
                    const normalized = rawData.map(row => {
                        const newRow = {};
                        Object.keys(row).forEach(key => {
                            // 1. Key Normalization: Remove all spaces
                            const cleanKey = key.replace(/\s+/g, '');
                            // 2. Value Cleaning: Auto-trim strings for data consistency
                            newRow[cleanKey] = (typeof row[key] === 'string') ? row[key].trim() : row[key];
                        });
                        return newRow;
                    });
                    return normalized;
                }

                // [Fix] extractWorkTypesì— ë°œì£¼ì²˜ í•„í„°ë§ ì˜µì…˜ ì¶”ê°€
                extractWorkTypes(normalizedData, filterByClient = null) {
                    const types = new Set();
                    normalizedData.forEach(row => {
                        // ë°œì£¼ì²˜ í•„í„°ë§ ì ìš© (ì§€ì •ëœ ê²½ìš°)
                        if (filterByClient) {
                            const rowClient = FormatUtils.cleanString(row['ë°œì£¼ì²˜']);
                            if (rowClient !== filterByClient) return; // Skip if client doesn't match
                        }

                        // Normalized keys: ì‘ì—…ìœ í˜•, ì‘ì—…êµ¬ë¶„
                        const workType = row['ì‘ì—…ìœ í˜•'] || row['ì‘ì—…êµ¬ë¶„'];
                        if (workType) types.add(FormatUtils.cleanString(workType));
                    });
                    return Array.from(types).sort();
                }

                extractClients(normalizedData) {
                    const clients = new Set();
                    normalizedData.forEach(row => {
                        const client = row['ë°œì£¼ì²˜'];
                        if (client) clients.add(FormatUtils.cleanString(client));
                    });
                    return Array.from(clients).sort();
                }

                extractYears(normalizedData) {
                    const years = new Set();
                    if (!normalizedData || normalizedData.length === 0) return [];

                    // 1. Identify Year Columns (Smart Detection on Normalized Keys)
                    const sampleRow = normalizedData[0] || {};
                    const keys = Object.keys(sampleRow);
                    // Normalized keywords: ë…„ë„, ì—°ë„, íšŒê³„, Year, Date
                    const yearKeys = keys.filter(k => /ë…„ë„|ì—°ë„|íšŒê³„|Year|Date/i.test(k));

                    normalizedData.forEach(row => {
                        let val = null;
                        // Direct Priority (Normalized keys)
                        if (row['íšŒê³„ì—°ë„']) val = row['íšŒê³„ì—°ë„']; // Covers 'íšŒê³„ ì—°ë„'
                        else if (row['ë…„ë„']) val = row['ë…„ë„'];
                        else if (row['íšŒê³„ë…„ë„']) val = row['íšŒê³„ë…„ë„'];
                        else if (row['ì‹¤ì ë…„ë„']) val = row['ì‹¤ì ë…„ë„'];

                        // Fallback to detected keys
                        if (!val && yearKeys.length > 0) {
                            for (const key of yearKeys) {
                                if (row[key]) {
                                    val = row[key];
                                    break;
                                }
                            }
                        }

                        if (val) {
                            const parsed = FormatUtils.parseYear(val);
                            // Validation: 2000 ~ 2099
                            if (parsed && parsed >= 2000 && parsed < 2100) {
                                years.add(parsed);
                            }
                        }
                    });

                    const sortedYears = Array.from(years).sort((a, b) => b - a);
                    // Fallback if no years found (e.g. use current year)
                    if (sortedYears.length === 0) return [2025];
                    return sortedYears;
                }

                calculateMaxSpan(years) {
                    if (!years || years.length === 0) return 3;
                    // years is sorted descending (b - a)
                    const maxYear = years[0];
                    const minYear = years[years.length - 1];
                    return maxYear - minYear + 1;
                }


                analyze(normalizedData, avgSpanYears, targetWorkTypes, targetClient, targetYear) {
                    // normalizedData is already cleaned
                    const startYear = targetYear - (avgSpanYears - 1);
                    const yearsOfInterest = [];
                    for (let y = startYear; y <= targetYear; y++) {
                        yearsOfInterest.push(y);
                    }

                    const buildingMap = {};

                    normalizedData.forEach(row => {
                        const rowWorkType = row['ì‘ì—…ìœ í˜•'];
                        if (!rowWorkType || !targetWorkTypes.includes(FormatUtils.cleanString(rowWorkType))) return;
                        const rowClient = row['ë°œì£¼ì²˜'];
                        if (targetClient && (!rowClient || FormatUtils.cleanString(rowClient) !== targetClient)) return;

                        const yearStr = row['íšŒê³„ì—°ë„'] || row['ë…„ë„'] || row['íšŒê³„ë…„ë„'];
                        const year = FormatUtils.parseYear(yearStr);
                        if (!yearsOfInterest.includes(year)) return;

                        const building = FormatUtils.cleanString(row['ê±´ë¬¼ë™']);
                        if (!building) return;

                        const amount = parseFloat(String(row['POê¸ˆì•¡']).replace(/,/g, '')) || 0;

                        if (!buildingMap[building]) {
                            buildingMap[building] = {};
                            yearsOfInterest.forEach(y => buildingMap[building][y] = { amount: 0, count: 0 });
                        }

                        if (buildingMap[building][year]) {
                            buildingMap[building][year].amount += amount;
                            buildingMap[building][year].count += 1;
                        }
                    });

                    const results = Object.keys(buildingMap).map(building => {
                        const yearlyData = buildingMap[building];
                        const currentData = yearlyData[targetYear] || { amount: 0, count: 0 };

                        // [PRD/IMP] ê°€ì¤‘í‰ê·  ë° ì¸í”Œë ˆì´ì…˜ ë³´ì • ê¸°ëŠ¥ ì‚¬ìš©
                        const avgAmount = this.calculateForecast(yearlyData, yearsOfInterest, targetYear, 'amount');
                        const avgCount = this.calculateForecast(yearlyData, yearsOfInterest, targetYear, 'count');

                        // [Smart Analysis] Client-Aware Unit Calculation
                        let totalUnits = getBuildingTotalUnits(building);

                        // [Feature] Special Building Flag (Unit Count Not Applicable)
                        const isSpecialBuilding = totalUnits === -1;
                        if (isSpecialBuilding) totalUnits = 0; // Normalize for calculation safety

                        let effectiveTotalUnits = totalUnits;
                        let excludedCount = 0;
                        let exclusionReason = null;
                        let isSubsetMode = false; // If true, we are analyzing a subset (e.g. LG Chem's 1 unit)

                        const specialConfig = getSpecialConfig(building);
                        if (specialConfig && !isSpecialBuilding) {
                            // 1. Check if Target Client corresponds to an Exception
                            // [Integrity] ì •í™•í•œ ë¬¸ìì—´ ì¼ì¹˜ ë¹„êµ ì‚¬ìš© (includes ë¹„êµëŠ” ë¶€ë¶„ ì¼ì¹˜ë¡œ ì˜¤ë¥˜ ê°€ëŠ¥)
                            const matchedException = specialConfig.exceptions.find(ex => ex.client === targetClient);

                            if (matchedException) {
                                // CASE A: Analyzing the Exception Client (e.g. LG Chem)
                                // Total units should be ONLY the exception count
                                totalUnits = specialConfig.total; // Display raw total
                                effectiveTotalUnits = matchedException.count; // Real denominator
                                isSubsetMode = true;
                                exclusionReason = `ì „ì²´ ${specialConfig.total}ì„¸ëŒ€ ì¤‘ ${matchedException.client} ì†Œìœ  ${matchedException.count}ì„¸ëŒ€ë§Œ ì§‘ê³„`;
                            } else {
                                // CASE B: Analyzing the Default Client (e.g. LG Energy Solution) or others
                                // Exclude the exception counts
                                let totalExcluded = 0;
                                const reasons = [];
                                specialConfig.exceptions.forEach(ex => {
                                    totalExcluded += ex.count;
                                    reasons.push(ex.reason); // "202í˜¸ (ì—˜ì§€í™”í•™ ì†Œìœ )"
                                });

                                excludedCount = totalExcluded;
                                effectiveTotalUnits = Math.max(0, specialConfig.total - totalExcluded);
                                exclusionReason = reasons.length > 0 ? reasons.join(", ") + " ì…ì£¼ë¡œ ì œì™¸" : "ìƒì„¸ ì‚¬ìœ  ë¯¸ê¸°ì¬ (ì…ì£¼ë¡œ ì¸í•œ ì œì™¸)";
                            }
                        }

                        // ì„¸ëŒ€ë‹¹ ê¸ˆì•¡ ê³„ì‚° (Handle Special Buildings)
                        let avgUnitAmount = 0;
                        let currentUnitAmount = 0;
                        let progressRate = 0;

                        if (!isSpecialBuilding && avgCount > 0) {
                            avgUnitAmount = Math.round(avgAmount / avgCount);
                        }
                        if (!isSpecialBuilding && currentData.count > 0) {
                            currentUnitAmount = Math.round(currentData.amount / currentData.count);
                        }

                        const diffUnitAmount = currentUnitAmount - avgUnitAmount;

                        // ì§„ì²™ë¥ : ìœ íš¨ ì„¸ëŒ€ìˆ˜ ê¸°ì¤€ (ì§€ëŠ¥ì  ëŒ€ì‘)
                        if (!isSpecialBuilding && effectiveTotalUnits > 0) {
                            progressRate = (currentData.count / effectiveTotalUnits) * 100;
                        }

                        // [Smart Logic] Rename 'ê¸°íƒ€' if analyzing Leased Housing
                        let displayBuildingName = building;
                        // Check if 'ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬' is in the target work types
                        if (building === 'ê¸°íƒ€' && targetWorkTypes.some(t => t.includes('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬'))) {
                            displayBuildingName = 'ê¸°íƒ€(ì™¸ë¶€ì„ì°¨)';
                        }

                        const result = {
                            building: displayBuildingName,
                            totalUnits,
                            excludedCount,
                            exclusionReason,
                            effectiveTotalUnits,
                            isSubsetMode, // New Flag
                            isSpecialBuilding, // New Flag for UI
                            yearlyData,
                            currentAmount: currentData.amount,
                            avgAmount: avgAmount,
                            diffAmount: currentData.amount - avgAmount,
                            currentCount: currentData.count,
                            avgCount: avgCount,
                            diffCount: currentData.count - avgCount,
                            progressRate,

                            // ì„¸ëŒ€ë‹¹ ê¸ˆì•¡ ì¶”ê°€
                            avgUnitAmount: avgUnitAmount,
                            currentUnitAmount: currentUnitAmount,
                            diffUnitAmount: diffUnitAmount,


                            // [Insight] ì¶”ì„¸ ë¶„ì„ (Trend Analysis) - ê°€ì¤‘í‰ê·  ë° ë‹¨ìˆœí‰ê·  ë³´ì¡° ì§€í‘œ
                            trend: this.calculateTrend(yearsOfInterest, yearlyData, 'amount'),
                            trendCount: this.calculateTrend(yearsOfInterest, yearlyData, 'count')
                        };
                        return result;
                    });

                    results.sort((a, b) => {
                        // [Sort] Priority: Normal -> Special Dorms -> Others ('ê¸°íƒ€')

                        const isAOther = a.building === 'ê¸°íƒ€' || a.building === 'ê¸°íƒ€(ì™¸ë¶€ì„ì°¨)';
                        const isBOther = b.building === 'ê¸°íƒ€' || b.building === 'ê¸°íƒ€(ì™¸ë¶€ì„ì°¨)';

                        // 1. 'ê¸°íƒ€' appears last
                        if (isAOther && !isBOther) return 1;
                        if (!isAOther && isBOther) return -1;
                        if (isAOther && isBOther) return 0;

                        // 2. Special Buildings appear after normal buildings but before 'ê¸°íƒ€'
                        const isASpecial = a.isSpecialBuilding;
                        const isBSpecial = b.isSpecialBuilding;

                        if (isASpecial && !isBSpecial) return 1;
                        if (!isASpecial && isBSpecial) return -1;

                        // 3. Alphabetical sort
                        return a.building.localeCompare(b.building);
                    });

                    const totalSummary = {
                        totalExecAmount: results.reduce((sum, item) => sum + item.currentAmount, 0),
                        totalAvgAmount: results.reduce((sum, item) => sum + item.avgAmount, 0),
                        totalExecCount: results.reduce((sum, item) => sum + item.currentCount, 0),
                        totalAvgCount: results.reduce((sum, item) => sum + item.avgCount, 0),
                        totalUnitsSum: results.reduce((sum, item) => sum + item.effectiveTotalUnits, 0)
                    };

                    // [Insight] Advanced Analysis
                    return { results, totalSummary, yearsOfInterest };
                }



                // [Insight] Calculate Linear Trend Slope (Generic)
                calculateTrend(years, yearlyData, key = 'amount') {
                    if (years.length < 2) return { slope: 0, direction: 'flat' };

                    let n = 0;
                    let sumX = 0;
                    let sumY = 0;
                    let sumXY = 0;
                    let sumXX = 0;

                    years.forEach((year, i) => {
                        const x = i; // Normalize year index (0, 1, 2...)
                        const y = (yearlyData[year] && yearlyData[year][key]) || 0;

                        n++;
                        sumX += x;
                        sumY += y;
                        sumXY += x * y;
                        sumXX += x * x;
                    });

                    if (n < 2) return { slope: 0, direction: 'flat' };

                    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);

                    let direction = 'flat';

                    // Thresholds
                    // Amount: > 100,000 won/year
                    // Count: > 0.5 count/year (e.g. 1 count increase every 2 years)
                    const threshold = key === 'count' ? 0.5 : 100000;

                    if (slope > threshold) direction = 'up';
                    else if (slope < -threshold) direction = 'down';

                    return { slope, direction };
                }
            }

            // --- [Layer 3] Presentation (UI & Lazy Rendering) ---
            class UIController {
                // [Refactor] Centralized Tooltip Generators (Integrity Assurance)

                // 1. Generic Tooltip Helper
                generateTooltipHTML(content, iconClass, colorClass, widthClass = 'w-48') {
                    if (!content || content.length === 0) return '';
                    return `
                    <div class="tooltip-container ml-1">
                        <i class="${iconClass} ${colorClass} cursor-help text-xs"></i>
                        <span class="tooltip-content ${widthClass} bg-slate-800 text-white text-xs rounded p-2 text-left z-50">
                            ${content}
                        </span>
                    </div>`;
                }

                // 2. Prediction Tooltip Helper (3-year history) - [Fix] ìë™/ìˆ˜ë™ ëª¨ë“œ êµ¬ë¶„
                generatePredictionTooltipHTML(rowData, type, yearsOfInterest, align = 'center', isManualMode = false, manualValue = null, forecastSettings = null) {
                    if (!yearsOfInterest || yearsOfInterest.length === 0) return '';

                    let tableRows = '';
                    const sortedYears = [...yearsOfInterest].sort((a, b) => b - a);
                    const isWMA = forecastSettings && forecastSettings.method === 'wma' && type !== 'unitAmount';
                    const weights = isWMA ? forecastSettings.wmaWeights || [0.5, 0.3, 0.2] : [];

                    sortedYears.forEach((year, idx) => {
                        const yData = rowData.yearlyData[year] || { count: 0, amount: 0 };
                        let value = 0;

                        if (type === 'count') value = yData.count;
                        else if (type === 'unitAmount') value = (yData.count > 0 ? Math.round(yData.amount / yData.count) : 0);
                        else if (type === 'amount') value = yData.amount;

                        const weightLabel = isWMA && weights[idx] ? `<span class="text-[9px] text-slate-400 ml-1">(x${weights[idx]})</span>` : '';

                        tableRows += `
                        <tr>
                            <td class="text-left">${year}ë…„${weightLabel}</td>
                            <td>${type === 'count' ? FormatUtils.number(value) : FormatUtils.currency(value)}</td>
                        </tr>`;
                    });

                    // Get actual value from rowData (Result of DomainService analysis)
                    let displayAvgValue = 0;
                    if (type === 'count') displayAvgValue = rowData.avgCount;
                    else if (type === 'amount') displayAvgValue = rowData.avgAmount;
                    else displayAvgValue = rowData.avgUnitAmount;

                    const displayAvg = type === 'count' ? FormatUtils.number(displayAvgValue) : FormatUtils.currency(displayAvgValue);
                    const alignClass = align === 'right' ? 'right-0' : 'left-1/2 -translate-x-1/2';

                    const hasManualValue = isManualMode && manualValue !== null && manualValue !== undefined;
                    const yearSpan = yearsOfInterest.length;

                    let headerText, manualLabel, manualDesc, footerLabel;
                    if (type === 'amount') {
                        headerText = hasManualValue ? 'ìˆ˜ë™ ê³„ì‚°ê°’ (ì‚°ì¶œ)' : `${yearSpan}ê°œë…„ ì‚°ì¶œ ê·¼ê±° (${isWMA ? 'ê°€ì¤‘' : 'ìë™'})`;
                        manualLabel = 'ìˆ˜ë™ ê³„ì‚°ê°’';
                        manualDesc = 'ìˆ˜ë™ ì„¸ëŒ€ìˆ˜ Ã— ìˆ˜ë™ ë‹¨ê°€';
                    } else {
                        headerText = hasManualValue ? 'ìˆ˜ë™ ì…ë ¥ê°’ (ì‚¬ìš©ì)' : `${yearSpan}ê°œë…„ ì‚°ì¶œ ê·¼ê±° (${isWMA ? 'ê°€ì¤‘' : 'ìë™'})`;
                        manualLabel = 'ìˆ˜ë™ ì…ë ¥ê°’';
                        manualDesc = '';
                    }

                    footerLabel = hasManualValue ? 'ìë™ê¸°ì¤€' : (isWMA ? 'ê°€ì¤‘í‰ê· ' : 'ìë™í‰ê· /ì˜ˆì¸¡');

                    const headerColor = hasManualValue ? 'text-emerald-300' : (isWMA ? 'text-blue-300' : 'text-amber-300');
                    const iconClass = hasManualValue ? 'fa-solid fa-user-pen text-emerald-400' : (isWMA ? 'fa-solid fa-calculator text-blue-400' : 'fa-solid fa-calculator text-slate-300');
                    const iconHoverColor = hasManualValue ? 'hover:text-emerald-300' : (isWMA ? 'hover:text-blue-300' : 'hover:text-amber-500');

                    const manualDisplayValue = type === 'count' ? FormatUtils.number(manualValue) : FormatUtils.currency(manualValue);
                    const manualSection = hasManualValue ? `
                    <div class="bg-emerald-900/50 rounded p-2 mb-2 border border-emerald-600">
                        <div class="text-emerald-300 font-bold text-center">
                            <i class="fa-solid fa-user-pen mr-1"></i>${manualLabel}
                        </div>
                        <div class="text-white font-bold text-lg text-center mt-1">${manualDisplayValue}</div>
                        ${manualDesc ? `<div class="text-[9px] text-emerald-400 text-center mt-1">${manualDesc}</div>` : ''}
                    </div>
                    <div class="text-[9px] text-slate-400 mb-2 text-center border-b border-slate-600 pb-2">â–¼ ìë™ ê³„ì‚° ì°¸ê³ ê°’ (${isWMA ? 'ê°€ì¤‘í‰ê· ' : 'í‰ê· '})</div>
                ` : '';

                    return `
                    <div class="tooltip-container ml-1 relative inline-block" data-tooltip-type="prediction">
                        <i class="${iconClass} ${iconHoverColor} cursor-help text-[10px]"></i>
                        <div class="tooltip-content absolute ${alignClass} top-full mt-1 w-52 bg-slate-800 text-white rounded shadow-lg p-2 z-50 pointer-events-auto" style="bottom: auto;">
                             <div class="prediction-header ${headerColor} font-bold mb-1 border-b border-slate-600 pb-1">${headerText}</div>
                             ${manualSection}
                             <table class="w-full text-xs text-right">
                                <thead class="text-slate-400"><tr><th class="text-left font-normal">ì—°ë„</th><th class="font-normal">${type === 'count' ? 'ì„¸ëŒ€ìˆ˜(ê±´)' : 'ê¸ˆì•¡'}</th></tr></thead>
                                <tbody class="text-slate-200">${tableRows}</tbody>
                                <tfoot class="border-t border-slate-600 font-bold ${isWMA ? 'text-blue-300' : 'text-amber-300'}">
                                    <tr>
                                        <td class="pt-1 text-left">${footerLabel}</td>
                                        <td class="pt-1">${displayAvg}</td>
                                    </tr>
                                </tfoot>
                             </table>
                        </div>
                    </div>`;
                }


                // [Integrity] Global Tooltip Layer System (Enhanced with Modal Containment)
                initGlobalTooltips() {
                    // 1. Create Global Tooltip Element
                    let globalTooltip = document.getElementById('global-tooltip');
                    if (!globalTooltip) {
                        globalTooltip = document.createElement('div');
                        globalTooltip.id = 'global-tooltip';
                        document.body.appendChild(globalTooltip);
                    }

                    // 2. Global Event Delegation
                    document.body.addEventListener('mouseover', (e) => {
                        if (window.app && window.app.tooltipsEnabled === false) return;
                        if (document.body.classList.contains('tooltips-hidden')) return;

                        const container = e.target.closest('.tooltip-container');
                        if (!container) return;

                        const sourceContent = container.querySelector('.tooltip-content');
                        if (!sourceContent) return;

                        // Update Global Tooltip
                        globalTooltip.innerHTML = sourceContent.innerHTML;

                        // Show temporarily for calculation
                        globalTooltip.style.display = 'block';
                        globalTooltip.style.visibility = 'hidden';

                        // Calculate Position
                        const icon = container.querySelector('i') || container;
                        const iconRect = icon.getBoundingClientRect();
                        const tooltipRect = globalTooltip.getBoundingClientRect();

                        // [Fix] Check if inside modal for containment
                        const activeModal = container.closest('.modal-panel');
                        const boundary = activeModal ? activeModal.getBoundingClientRect() : {
                            top: 0, left: 0,
                            right: window.innerWidth,
                            bottom: window.innerHeight,
                            width: window.innerWidth,
                            height: window.innerHeight
                        };

                        const gap = 8;
                        let top = iconRect.top - tooltipRect.height - gap;
                        let left = iconRect.left + (iconRect.width / 2) - (tooltipRect.width / 2);

                        // 1. Top Overflow -> Flip Bottom
                        if (top < boundary.top + 5) {
                            top = iconRect.bottom + gap;
                        }

                        // 2. Bottom Overflow Protection
                        if (top + tooltipRect.height > boundary.bottom - 5) {
                            top = iconRect.top - tooltipRect.height - gap;
                        }

                        // 3. Horizontal Correction (Keep within boundary)
                        if (left + tooltipRect.width > boundary.right - 10) {
                            left = boundary.right - tooltipRect.width - 10;
                        }
                        if (left < boundary.left + 10) {
                            left = boundary.left + 10;
                        }

                        // Apply
                        globalTooltip.style.top = `${top}px`;
                        globalTooltip.style.left = `${left}px`;
                        globalTooltip.style.visibility = 'visible';
                        globalTooltip.style.opacity = '1';
                    });

                    document.body.addEventListener('mouseout', (e) => {
                        const container = e.target.closest('.tooltip-container');
                        if (!container) return;

                        if (globalTooltip) {
                            globalTooltip.style.visibility = 'hidden';
                            globalTooltip.style.opacity = '0';
                        }
                    });

                    window.addEventListener('scroll', () => {
                        if (globalTooltip && globalTooltip.style.visibility === 'visible') {
                            globalTooltip.style.visibility = 'hidden';
                            globalTooltip.style.opacity = '0';
                        }
                    }, { capture: true });
                }

                // [Deprecated] Old method keeping for reference
                // [Integrity] Smart Tooltip Positioning (Fixes Clipping & Occlusion)
                initSmartTooltips() {
                    // Global delegation for performance
                    document.body.addEventListener('mouseover', (e) => {
                        // [New] Check if tooltips are enabled (global state on window.app)
                        if (window.app && window.app.tooltipsEnabled === false) return;

                        // Also check body class as fallback
                        if (document.body.classList.contains('tooltips-hidden')) return;

                        const container = e.target.closest('.tooltip-container');
                        if (!container) return;

                        const content = container.querySelector('.tooltip-content');
                        if (!content) return;

                        // 1. Clone to isolate from container's stacking context if needed?
                        // No, 'position: fixed' breaks out of overflow containers (div) and z-index contexts (unless transform used on parent).
                        // Luckily, sticky headers use 'position: sticky', which creates context, but 'fixed' usually wins unless transform is involved.
                        // The table rows don't have transforms.

                        // [Integrity] CSS display: none ìƒíƒœì—ì„œëŠ” í¬ê¸° ê³„ì‚° ë¶ˆê°€ -> ì ì‹œ visibility:hiddenìœ¼ë¡œ block ì²˜ë¦¬
                        const originalDisplay = content.style.display;
                        const originalVisibility = content.style.visibility;

                        content.style.position = 'fixed';
                        content.style.display = 'block';
                        content.style.visibility = 'hidden'; // ê³„ì‚° ì¤‘ ê¹œë¹¡ì„ ë°©ì§€
                        content.style.width = 'max-content'; // ë‚´ìš©ì— ë§ê²Œ ë„ˆë¹„ ìë™ ì¡°ì • (ìµœëŒ€ê°’ì€ CSS max-widthë¡œ ì œí•œ ê¶Œì¥)
                        content.style.maxWidth = '250px'; // ì•ˆì „í•œ ìµœëŒ€ ë„ˆë¹„ ì„¤ì •

                        const rect = container.getBoundingClientRect();
                        const contentRect = content.getBoundingClientRect();

                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;

                        // ê¸°ë³¸ ìœ„ì¹˜: ì•„ì´ì½˜ ìœ„ìª½ (Top Center)
                        let top = rect.top - contentRect.height - 10;
                        let left = rect.left + (rect.width / 2) - (contentRect.width / 2);
                        let isFlipped = false;

                        // 1. Top Overflow -> Flip Down (í™”ë©´ ìƒë‹¨ ì˜ë¦¼ ë°©ì§€)
                        if (top < 10) {
                            top = rect.bottom + 10;
                            isFlipped = true;
                        }

                        // 2. Horizontal Overflow Correction
                        if (left + contentRect.width > viewportWidth - 10) {
                            left = viewportWidth - contentRect.width - 10;
                        }
                        if (left < 10) {
                            left = 10;
                        }

                        // 3. Apply calculated position
                        content.style.top = `${top}px`;
                        content.style.left = `${left}px`;
                        content.style.zIndex = '99999';

                        // 4. Arrow Direction Toggle
                        if (isFlipped) {
                            content.classList.add('arrow-top'); // í™”ì‚´í‘œ ìœ„ë¡œ (íˆ´íŒì´ ì•„ë˜ì— ìˆì„ ë•Œ)
                        } else {
                            content.classList.remove('arrow-top'); // í™”ì‚´í‘œ ì•„ë˜ë¡œ (íˆ´íŒì´ ìœ„ì— ìˆì„ ë•Œ - ê¸°ë³¸)
                        }

                        // 5. Show Final Tooltip
                        content.style.visibility = 'visible';
                        content.style.opacity = '1';
                    });

                    // Cleanup on mouseleave
                    document.body.addEventListener('mouseout', (e) => {
                        const container = e.target.closest('.tooltip-container');
                        if (!container) return;

                        // Check if relatedTarget is still inside
                        if (container.contains(e.relatedTarget)) return;

                        const content = container.querySelector('.tooltip-content');
                        if (content) {
                            // Reset everything to CSS control
                            content.style.position = '';
                            content.style.top = '';
                            content.style.left = '';
                            content.style.display = '';
                            content.style.visibility = '';
                            content.style.opacity = '';
                            content.style.zIndex = '';
                            content.style.width = '';
                            content.style.maxWidth = '';
                            content.classList.remove('arrow-top');
                        }
                    });
                }

                constructor() {
                    this.els = {
                        fileInput: document.getElementById('fileInput'),
                        // [New] Data Source Selection Elements
                        dataSourceWrapper: document.getElementById('dataSourceWrapper'),
                        dataSourceBtn: document.getElementById('dataSourceBtn'),
                        dataSourceBtnText: document.getElementById('dataSourceBtnText'),
                        dataSourceDropdown: document.getElementById('dataSourceDropdown'),
                        localFileOption: document.getElementById('localFileOption'),
                        githubDataOption: document.getElementById('githubDataOption'),
                        workTypeWrapper: document.getElementById('workTypeWrapper'),
                        workTypeBtn: document.getElementById('workTypeBtn'),
                        workTypeBtnText: document.getElementById('workTypeBtnText'),
                        workTypeDropdown: document.getElementById('workTypeDropdown'),
                        // workTypeSelect removed
                        clientSelect: document.getElementById('clientSelect'),
                        // [Multi-Year Select] Year selection elements
                        yearSelectWrapper: document.getElementById('yearSelectWrapper'),
                        yearSelectBtn: document.getElementById('yearSelectBtn'),
                        yearSelectBtnText: document.getElementById('yearSelectBtnText'),
                        yearSelectDropdown: document.getElementById('yearSelectDropdown'),
                        yearSelectOptions: document.getElementById('yearSelectOptions'),
                        yearAggregationPanel: document.getElementById('yearAggregationPanel'),
                        yearAggregationMethod: document.getElementById('yearAggregationMethod'),
                        yearSelectionCount: document.getElementById('yearSelectionCount'),
                        yearRange: document.getElementById('yearRange'),

                        yearRangeValue: document.getElementById('yearRangeValue'),
                        mainTitle: document.getElementById('mainTitle'),
                        dashboard: document.getElementById('dashboard'),
                        emptyState: document.getElementById('emptyState'),
                        autoTableSection: document.getElementById('autoTableSection'),
                        manualTableSection: document.getElementById('manualTableSection'),
                        autoTableBody: document.getElementById('autoTableBody'),
                        manualTableBody: document.getElementById('manualTableBody'),
                        loadingOverlay: document.getElementById('loadingOverlay'),
                        summary: {
                            execAmt: document.getElementById('totalExecAmount'),
                            execCnt: document.getElementById('totalExecCount'),
                            avgAmt: document.getElementById('totalAvgAmount'),
                            avgCnt: document.getElementById('totalAvgCount'),
                            progress: document.getElementById('totalProgressRate'),
                            avgLabel: document.getElementById('avgLabel'),
                            avgCountLabel: document.getElementById('avgCountLabel'),
                            yearSpanLabel: document.getElementById('yearSpanLabel'),
                            headerExecAmt: document.getElementById('headerExecAmt'),
                            headerExecCnt: document.getElementById('headerExecCnt')
                        },
                        autoTableTitleText: document.getElementById('autoTableTitleText'),
                        manualTableTitleText: document.getElementById('manualTableTitleText'),
                        fullscreenTableTitle: document.getElementById('fullscreenTableTitle'),
                        fullscreenTableModeLabel: document.getElementById('fullscreenTableModeLabel'),
                        manualStatsSection: document.getElementById('manualStatsSection'),
                        manualSummary: {
                            execAmt: document.getElementById('totalExecAmountManual'),
                            execCnt: document.getElementById('totalExecCountManual'),
                            avgAmt: document.getElementById('totalAvgAmountManual'),
                            avgCnt: document.getElementById('totalAvgCountManual'),
                            progress: document.getElementById('totalProgressRateManual')
                        },
                        exportBtn: document.getElementById('exportBtn'),
                        htmlDnBtn: document.getElementById('htmlDnBtn'),
                        exportBtnManual: document.getElementById('exportBtnManual'),
                        htmlDnBtnManual: document.getElementById('htmlDnBtnManual'),
                        // Analysis Mode Elements
                        autoModeBtn: document.getElementById('autoModeBtn'),
                        manualModeBtn: document.getElementById('manualModeBtn'),
                        manualModeTools: document.getElementById('manualModeTools'),
                        applyAutoValuesBtn: document.getElementById('applyAutoValuesBtn'),
                        resetManualBtn: document.getElementById('resetManualBtn'),
                        compareAnalysisBtn: document.getElementById('compareAnalysisBtn'),
                        // Comparison Modal Elements
                        comparisonModal: document.getElementById('comparisonModal'),
                        modalOverlay: document.getElementById('modalOverlay'),
                        closeModalBtn: document.getElementById('closeModalBtn'),
                        closeModalBtn2: document.getElementById('closeModalBtn2'),
                        exportComparisonBtn: document.getElementById('exportComparisonBtn'),
                        // Raw Data Viewer Elements
                        viewRawDataBtn: document.getElementById('viewRawDataBtn'),
                        rawDataModal: document.getElementById('rawDataModal'),
                        rawDataModalOverlay: document.getElementById('rawDataModalOverlay'),
                        closeRawDataBtn: document.getElementById('closeRawDataBtn'),
                        closeRawDataBtn2: document.getElementById('closeRawDataBtn2'),
                        rawDataSearch: document.getElementById('rawDataSearch'),
                        rawDataCount: document.getElementById('rawDataCount'),
                        rawDataTableHeader: document.getElementById('rawDataTableHeader'),
                        rawDataTableBody: document.getElementById('rawDataTableBody'),
                        rawDataPageSize: document.getElementById('rawDataPageSize'),
                        rawDataPrevPage: document.getElementById('rawDataPrevPage'),
                        rawDataNextPage: document.getElementById('rawDataNextPage'),
                        rawDataCurrentPage: document.getElementById('rawDataCurrentPage'),
                        rawDataTotalPages: document.getElementById('rawDataTotalPages'),
                        exportRawDataBtn: document.getElementById('exportRawDataBtn'),
                        // Fullscreen Table Elements
                        fullscreenTableBtn: document.getElementById('fullscreenTableBtn'),
                        fullscreenTableBtnManual: document.getElementById('fullscreenTableBtnManual'),
                        fullscreenTableModal: document.getElementById('fullscreenTableModal'),
                        fullscreenTableModalOverlay: document.getElementById('fullscreenTableModalOverlay'),
                        closeFullscreenTableBtn: document.getElementById('closeFullscreenTableBtn'),
                        closeFullscreenTableBtn2: document.getElementById('closeFullscreenTableBtn2'),
                        fullscreenTableSearch: document.getElementById('fullscreenTableSearch'),
                        fullscreenTableThead: document.getElementById('fullscreenTableThead'),
                        fullscreenTableBody: document.getElementById('fullscreenTableBody'),
                        fullscreenAutoModeBtn: document.getElementById('fullscreenAutoModeBtn'),
                        fullscreenManualModeBtn: document.getElementById('fullscreenManualModeBtn'),
                        fullscreenTableModeLabel: document.getElementById('fullscreenTableModeLabel'),
                        exportFullscreenTableBtn: document.getElementById('exportFullscreenTableBtn'),
                        // Statistics Detail Modal Elements
                        statDetailModal: document.getElementById('statDetailModal'),
                        statDetailModalOverlay: document.getElementById('statDetailModalOverlay'),
                        statDetailHeader: document.getElementById('statDetailHeader'),
                        statDetailIcon: document.getElementById('statDetailIcon'),
                        statDetailTitle: document.getElementById('stat-detail-title'),
                        statDetailSubtitle: document.getElementById('statDetailSubtitle'),
                        closeStatDetailBtn: document.getElementById('closeStatDetailBtn'),
                        closeStatDetailBtn2: document.getElementById('closeStatDetailBtn2'),
                        statDetailSearch: document.getElementById('statDetailSearch'),
                        statDetailCount: document.getElementById('statDetailCount'),
                        statDetailTableHead: document.getElementById('statDetailTableHead'),
                        statDetailTableBody: document.getElementById('statDetailTableBody'),
                        exportStatDetailBtn: document.getElementById('exportStatDetailBtn'),
                        // Sankey Modal Elements
                        sankeyModal: document.getElementById('sankeyModal'),
                        sankeyModalOverlay: document.getElementById('sankeyModalOverlay'),
                        closeSankeyBtn: document.getElementById('closeSankeyBtn'),
                        openSankeyBtn: document.getElementById('openSankeyBtn')
                    };
                    // [Integrity] ì „ì—­ íˆ´íŒ ì‹œìŠ¤í…œ í™œì„±í™” (Global Tooltip Layer)
                    this.initGlobalTooltips();
                }

                setLoading(isLoading) {
                    if (isLoading) {
                        this.els.loadingOverlay.classList.remove('hidden');
                        this.els.fileInput.disabled = true;
                    } else {
                        this.els.loadingOverlay.classList.add('hidden');
                        this.els.fileInput.disabled = false;
                    }
                }

                setAnalysisMode(mode) {
                    // mode: 'auto' or 'manual'
                    if (mode === 'manual') {
                        // Manual mode active
                        this.els.manualModeBtn.classList.add('bg-white', 'text-blue-700', 'shadow-sm');
                        this.els.manualModeBtn.classList.remove('text-slate-600', 'hover:text-slate-800');
                        this.els.autoModeBtn.classList.remove('bg-white', 'text-blue-700', 'shadow-sm');
                        this.els.autoModeBtn.classList.add('text-slate-600', 'hover:text-slate-800');
                        this.els.manualModeTools.classList.remove('hidden');
                        this.els.manualModeTools.classList.add('flex');

                        // Show manual table, hide auto table
                        this.els.autoTableSection.classList.add('hidden');
                        this.els.manualTableSection.classList.remove('hidden');
                    } else {
                        // Auto mode active
                        this.els.autoModeBtn.classList.add('bg-white', 'text-blue-700', 'shadow-sm');
                        this.els.autoModeBtn.classList.remove('text-slate-600', 'hover:text-slate-800');
                        this.els.manualModeBtn.classList.remove('bg-white', 'text-blue-700', 'shadow-sm');
                        this.els.manualModeBtn.classList.add('text-slate-600', 'hover:text-slate-800');
                        this.els.manualModeTools.classList.add('hidden');
                        this.els.manualModeTools.classList.remove('flex');

                        // Show auto table, hide manual table
                        this.els.autoTableSection.classList.remove('hidden');
                        this.els.manualTableSection.classList.add('hidden');
                    }
                }

                populateSelect(element, items, defaultItem) {
                    element.innerHTML = '';
                    if (items.length === 0) {
                        element.add(new Option("ë°ì´í„° ì—†ìŒ", ""));
                        return;
                    }
                    items.forEach(item => {
                        const option = new Option(item, item);
                        if (item === defaultItem) option.selected = true;
                        element.add(option);
                    });
                    element.disabled = false;
                }


                populateMultiSelect(ids, options, defaultOptions = []) {
                    const { wrapper, btn, btnText, dropdown } = ids;

                    // [Fix] ìƒˆë¡œìš´ êµ¬ì¡°: ê²€ìƒ‰ ì…ë ¥ + ì˜µì…˜ ì»¨í…Œì´ë„ˆ + ì„ íƒ ì •ë³´
                    const optionsContainer = dropdown.querySelector('#workTypeOptions') || dropdown;
                    const searchInput = dropdown.querySelector('#workTypeSearch');
                    const selectionCount = dropdown.querySelector('#workTypeSelectionCount');

                    // Reset options container only
                    optionsContainer.innerHTML = '';

                    if (!options || options.length === 0) {
                        btn.disabled = true;
                        btnText.innerText = 'ë°ì´í„° ì—†ìŒ';
                        return;
                    }

                    btn.disabled = false;

                    // ì•„ì´í…œ ìƒì„± í•¨ìˆ˜
                    const createItem = (val, label, isChecked) => {
                        const div = document.createElement('div');
                        div.className = 'work-type-item px-3 py-2 hover:bg-slate-50 flex items-center gap-2 cursor-pointer border-b border-slate-50 last:border-0';
                        div.dataset.value = val.toLowerCase(); // ê²€ìƒ‰ìš© ë°ì´í„° ì†ì„±
                        div.onclick = (e) => {
                            e.stopPropagation();
                            const cb = div.querySelector('input');
                            cb.checked = !cb.checked;
                            dropdown.dispatchEvent(new Event('change'));
                            updateSelectionCount();
                        };

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = val;
                        checkbox.checked = isChecked;
                        checkbox.className = 'rounded text-blue-600 focus:ring-blue-500 w-4 h-4';
                        checkbox.onclick = (e) => {
                            e.stopPropagation();
                            dropdown.dispatchEvent(new Event('change'));
                            updateSelectionCount();
                        };

                        const span = document.createElement('span');
                        span.className = 'text-sm text-slate-700 work-type-label';
                        span.innerText = label;

                        div.appendChild(checkbox);
                        div.appendChild(span);
                        return { div, checkbox };
                    };

                    // ì„ íƒ ê°œìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
                    const updateSelectionCount = () => {
                        if (selectionCount) {
                            const checked = optionsContainer.querySelectorAll('input:checked').length;
                            const total = optionsContainer.querySelectorAll('input[type="checkbox"]').length;
                            selectionCount.textContent = `${checked}ê°œ ì„ íƒë¨ / ì´ ${total}ê°œ`;
                        }
                    };

                    // [UX] Sort: Selected items first, then alphabetical
                    const sortedOptions = [...options].sort((a, b) => {
                        const aSelected = defaultOptions.includes(a);
                        const bSelected = defaultOptions.includes(b);
                        if (aSelected && !bSelected) return -1;
                        if (!aSelected && bSelected) return 1;
                        return a.localeCompare(b);
                    });

                    sortedOptions.forEach(opt => {
                        const isSelected = defaultOptions.includes(opt);
                        const { div, checkbox } = createItem(opt, opt, isSelected);
                        optionsContainer.appendChild(div);
                    });

                    // [New] ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
                    if (searchInput) {
                        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì¬ë“±ë¡
                        const newSearchInput = searchInput.cloneNode(true);
                        searchInput.parentNode.replaceChild(newSearchInput, searchInput);

                        newSearchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase().trim();
                            const items = optionsContainer.querySelectorAll('.work-type-item');
                            let visibleCount = 0;

                            items.forEach(item => {
                                const value = item.dataset.value || '';
                                const label = item.querySelector('.work-type-label')?.innerText.toLowerCase() || '';
                                const matches = value.includes(searchTerm) || label.includes(searchTerm);

                                if (matches || searchTerm === '') {
                                    item.style.display = '';
                                    visibleCount++;
                                } else {
                                    item.style.display = 'none';
                                }
                            });

                            // ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ í‘œì‹œ
                            let noResults = optionsContainer.querySelector('.no-results');
                            if (visibleCount === 0 && searchTerm !== '') {
                                if (!noResults) {
                                    noResults = document.createElement('div');
                                    noResults.className = 'no-results px-3 py-4 text-center text-slate-400 text-sm';
                                    noResults.innerHTML = '<i class="fa-solid fa-search mr-1"></i>ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ';
                                    optionsContainer.appendChild(noResults);
                                }
                            } else if (noResults) {
                                noResults.remove();
                            }
                        });

                        // ë“œë¡­ë‹¤ìš´ ì—´ë¦´ ë•Œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ë° ì´ˆê¸°í™”
                        newSearchInput.value = '';
                    }

                    updateSelectionCount();
                    this.updateMultiSelectLabel(ids);
                }

                updateMultiSelectLabel(ids) {
                    const checked = Array.from(ids.dropdown.querySelectorAll('input:checked')).map(cb => cb.value);
                    if (checked.length === 0) {
                        ids.btnText.innerText = 'ì„ íƒí•­ëª© ì—†ìŒ';
                    } else if (checked.length === 1) {
                        ids.btnText.innerText = checked[0];
                    } else {
                        ids.btnText.innerText = `${checked.length}ê°œ í•­ëª© ì„ íƒë¨`;
                    }
                    return checked;
                }

                // [Multi-Year Selection] Populate year multi-select dropdown
                populateYearMultiSelect(years, defaultYears = []) {
                    const optionsContainer = this.els.yearSelectOptions;
                    const btn = this.els.yearSelectBtn;
                    const btnText = this.els.yearSelectBtnText;
                    const dropdown = this.els.yearSelectDropdown;
                    const aggregationPanel = this.els.yearAggregationPanel;
                    const selectionCountEl = this.els.yearSelectionCount;

                    // Clear existing options
                    optionsContainer.innerHTML = '';

                    if (!years || years.length === 0) {
                        btn.disabled = true;
                        btnText.innerText = 'ë°ì´í„° ì—†ìŒ';
                        return;
                    }

                    btn.disabled = false;

                    // [New] Add Select All / Deselect All Controls (Sticky)
                    const toolsDiv = document.createElement('div');
                    toolsDiv.className = 'sticky top-0 bg-white z-20 flex justify-between items-center px-3 py-2 border-b border-slate-100 shadow-sm mb-1';

                    const selectAllBtn = document.createElement('button');
                    selectAllBtn.className = 'text-xs text-blue-600 hover:text-blue-800 font-medium px-2 py-1 hover:bg-blue-50 rounded transition-colors flex items-center gap-1';
                    selectAllBtn.innerHTML = '<i class="fa-solid fa-check-double"></i> ì „ì²´ ì„ íƒ';

                    const clearAllBtn = document.createElement('button');
                    clearAllBtn.className = 'text-xs text-slate-500 hover:text-slate-700 font-medium px-2 py-1 hover:bg-slate-100 rounded transition-colors flex items-center gap-1';
                    clearAllBtn.innerHTML = '<i class="fa-regular fa-square"></i> ì „ì²´ í•´ì œ';

                    toolsDiv.appendChild(selectAllBtn);
                    toolsDiv.appendChild(clearAllBtn);
                    optionsContainer.appendChild(toolsDiv);

                    // Sort years descending (most recent first)
                    const sortedYears = [...years].sort((a, b) => b - a);

                    // Update selection count and aggregation panel visibility
                    const updateState = () => {
                        const checkedBoxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');
                        const count = checkedBoxes.length;

                        // Update count display
                        if (selectionCountEl) {
                            selectionCountEl.textContent = `${count}ê°œ ì„ íƒë¨`;
                        }

                        // Show/hide aggregation panel based on multi-selection
                        if (aggregationPanel) {
                            if (count > 1) {
                                aggregationPanel.classList.remove('hidden');
                            } else {
                                aggregationPanel.classList.add('hidden');
                            }
                        }

                        // Update button text
                        if (count === 0) {
                            btnText.innerText = 'ì„ íƒí•­ëª© ì—†ìŒ';
                        } else if (count === 1) {
                            const selectedYear = Array.from(checkedBoxes)[0].value;
                            btnText.innerText = `${selectedYear}ë…„`;
                        } else {
                            const selectedYears = Array.from(checkedBoxes).sort((a, b) => b.value - a.value).map(cb => cb.value.slice(-2)).join(', ');
                            btnText.innerText = `${count}ê°œë…„ (${selectedYears})`;
                        }

                        return Array.from(checkedBoxes).map(cb => parseInt(cb.value));
                    };

                    // [New] Tool Button Listeners
                    selectAllBtn.onclick = (e) => {
                        e.stopPropagation();
                        const cbs = optionsContainer.querySelectorAll('input[type="checkbox"]');
                        cbs.forEach(cb => cb.checked = true);
                        dropdown.dispatchEvent(new Event('change'));
                        updateState();
                    };

                    clearAllBtn.onclick = (e) => {
                        e.stopPropagation();
                        // ìµœì†Œ 1ê°œëŠ” ì„ íƒë˜ì–´ì•¼ í•˜ëŠ” ì œì•½ì´ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ ì²˜ë¦¬ (í˜„ì¬ëŠ” 0ê°œ ê°€ëŠ¥ì¸ ë“¯)
                        const cbs = optionsContainer.querySelectorAll('input[type="checkbox"]');
                        cbs.forEach(cb => cb.checked = false);
                        dropdown.dispatchEvent(new Event('change'));
                        updateState();
                    };

                    // Create checkbox items
                    sortedYears.forEach(year => {
                        const isSelected = defaultYears.includes(year);

                        const div = document.createElement('div');
                        div.className = 'year-item px-3 py-2 hover:bg-slate-50 flex items-center gap-2 cursor-pointer border-b border-slate-50 last:border-0 transition-colors';
                        div.dataset.year = year;

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = year;
                        checkbox.checked = isSelected;
                        checkbox.className = 'rounded text-blue-600 focus:ring-blue-500 w-4 h-4';

                        const label = document.createElement('span');
                        label.className = 'text-sm text-slate-700 flex-1';
                        label.innerText = `${year}ë…„`;

                        // Badge for most recent years
                        if (year === sortedYears[0]) {
                            const badge = document.createElement('span');
                            badge.className = 'text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full ml-auto';
                            badge.innerText = 'ìµœì‹ ';
                            div.appendChild(checkbox);
                            div.appendChild(label);
                            div.appendChild(badge);
                        } else {
                            div.appendChild(checkbox);
                            div.appendChild(label);
                        }

                        // Click handlers
                        div.onclick = (e) => {
                            e.stopPropagation();
                            checkbox.checked = !checkbox.checked;
                            dropdown.dispatchEvent(new Event('change'));
                            updateState();
                        };

                        checkbox.onclick = (e) => {
                            e.stopPropagation();
                            dropdown.dispatchEvent(new Event('change'));
                            updateState();
                        };

                        optionsContainer.appendChild(div);
                    });

                    // Initial state update
                    return updateState();
                }

                // [Multi-Year Selection] Get selected years from dropdown
                getSelectedYears() {
                    const checkedBoxes = this.els.yearSelectOptions?.querySelectorAll('input:checked') || [];
                    return Array.from(checkedBoxes).map(cb => parseInt(cb.value)).sort((a, b) => b - a);
                }

                // [Multi-Year Selection] Get aggregation method
                getYearAggregationMethod() {
                    return this.els.yearAggregationMethod?.value || 'avg';
                }

                updateLabels(span, workTypes, client, year, forecastMethod = 'simple') {

                    this.currentYear = year; // [Fix] Store currentYear for other methods (e.g. Fullscreen Table)
                    this.els.yearRangeValue.innerText = `${span}ë…„`;

                    const methodLabel = forecastMethod === 'wma' ? '(ê°€ì¤‘í‰ê· )' : '(ë‹¨ìˆœí‰ê· )';
                    this.els.summary.avgLabel.innerText = `${span}ê°œë…„ ì˜ˆì¸¡ ${methodLabel} (ê¸ˆì•¡)`;
                    // [Fix] ì—°ë„ ìˆ˜ ë™ì  ë°˜ì˜ - ì¶”ê°€ ë¼ë²¨ë“¤
                    if (this.els.summary.avgCountLabel) this.els.summary.avgCountLabel.innerText = `${span}ê°œë…„ ì˜ˆì¸¡ ${methodLabel} (ì„¸ëŒ€ìˆ˜)`;
                    if (this.els.summary.yearSpanLabel) this.els.summary.yearSpanLabel.innerText = `(${span}ê°œë…„ ${forecastMethod === 'wma' ? 'ê°€ì¤‘í‰ê· ' : 'í‰ê· '} ê¸°ì¤€)`;
                    if (this.els.summary.headerExecAmt) this.els.summary.headerExecAmt.innerText = `${year}ë…„ ì‹¤ì  (ê¸ˆì•¡)`;
                    if (this.els.summary.headerExecCnt) this.els.summary.headerExecCnt.innerText = `${year}ë…„ ì‹¤ì  (ì„¸ëŒ€ìˆ˜)`;

                    // [Fix] í…Œì´ë¸” ì œëª©ì— ì˜ˆì¸¡ ëª¨ë“œ ë°˜ì˜ (ì‚¬ìš©ì ìš”ì²­)
                    const methodSuffix = forecastMethod === 'wma' ? ' ìë™ ëª¨ë“œ (ê°€ì¤‘í‰ê· )' : ' ìë™ ëª¨ë“œ (ë‹¨ìˆœí‰ê· )';
                    const baseTitle = 'ê±´ë¬¼ë™ë³„ ìƒì„¸ ë¹„êµ ë¶„ì„';
                    if (this.els.autoTableTitleText) this.els.autoTableTitleText.innerText = baseTitle + methodSuffix;
                    if (this.els.manualTableTitleText) this.els.manualTableTitleText.innerText = baseTitle + methodSuffix;

                    // [Integrity] Formula Explanations
                    const startYear = year - (span - 1);
                    const formulaRange = `${startYear}~${year}`;
                    const methodText = forecastMethod === 'wma' ? `ê°€ì¤‘í‰ê· (5:3:2 ë¹„ìœ¨)` : 'ë‹¨ìˆœ í‰ê· ';
                    const formulaText = {
                        avgCount: `[ì‚°ì‹] ìµœê·¼ ${span}ê°œë…„(${formulaRange}) ì„¸ëŒ€ìˆ˜(ê±´ìˆ˜)ì˜ ${methodText}`,
                        unitAmt: `[ì‚°ì‹] ì˜ˆì¸¡ ì „ì²´ê¸ˆì•¡ Ã· ì˜ˆì¸¡ ì „ì²´ì„¸ëŒ€ìˆ˜ (í‰ê·  ë‹¨ê°€)`,
                        totalAmt: `[ì‚°ì‹] ìµœê·¼ ${span}ê°œë…„(${formulaRange}) ìš´ì˜ì„± ì‘ì—…ë¹„ ì´ì•¡ì˜ ${methodText}`
                    };

                    // Update Tooltips (Auto & Manual Tables) - [Fix] ìë™/ìˆ˜ë™ ëª¨ë“œ êµ¬ë¶„
                    // ìë™ ëª¨ë“œ íˆ´íŒ
                    const elAvgAuto = document.getElementById('tooltip-avg-count');
                    const elUnitAuto = document.getElementById('tooltip-unit-amt');
                    const elTotalAuto = document.getElementById('tooltip-total-amt');

                    if (elAvgAuto) elAvgAuto.innerText = formulaText.avgCount;
                    if (elUnitAuto) elUnitAuto.innerText = formulaText.unitAmt;
                    if (elTotalAuto) elTotalAuto.innerText = formulaText.totalAmt;

                    // ìˆ˜ë™ ëª¨ë“œ íˆ´íŒ - ì‚¬ìš©ì ì…ë ¥ ì•ˆë‚´
                    const manualFormulaText = {
                        avgCount: `[ìˆ˜ë™ ì…ë ¥] ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜ (ê¸°ë³¸ê°’: ${span}ê°œë…„ ìë™í‰ê· )`,
                        unitAmt: `[ìˆ˜ë™ ì…ë ¥] ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ì„¸ëŒ€ë‹¹ ë‹¨ê°€ (ê¸°ë³¸ê°’: ${span}ê°œë…„ ìë™í‰ê· )`,
                        totalAmt: `[ì‚°ì‹] ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜ Ã— ì„¸ëŒ€ë‹¹ ë‹¨ê°€ (ìˆ˜ë™ ì…ë ¥ ê¸°ë°˜)`
                    };

                    const elAvgManual = document.getElementById('tooltip-avg-count-m');
                    const elUnitManual = document.getElementById('tooltip-unit-amt-m');
                    const elTotalManual = document.getElementById('tooltip-total-amt-m');

                    if (elAvgManual) elAvgManual.innerText = manualFormulaText.avgCount;
                    if (elUnitManual) elUnitManual.innerText = manualFormulaText.unitAmt;
                    if (elTotalManual) elTotalManual.innerText = manualFormulaText.totalAmt;

                    // [New] ì‹¤ì  ì—´ íˆ´íŒ - ìë™/ìˆ˜ë™ ê³µí†µ (ì‹¤ì ì€ ë™ì¼)
                    const currentFormulaText = {
                        currentCount: `[ì‹¤ì  ë°ì´í„°] ${year}ë…„ í•´ë‹¹ ê±´ë¬¼ë™ì˜ ì‹¤ì œ ìˆ˜ì¥ê³µì‚¬ ê³„ì•½ ê±´ìˆ˜ í•©ê³„\n\nâ€¢ ë°ì´í„° ì¶œì²˜: ì—…ë¡œë“œëœ ë¡œìš°ë°ì´í„° ê¸°ì¤€\nâ€¢ ì§‘ê³„ ë°©ì‹: ì„ íƒëœ ì‘ì—…ìœ í˜•ì˜ ${year}ë…„ ê±´ìˆ˜ í•©ì‚°`,
                        currentUnit: `[ì‹¤ì  ë°ì´í„°] ${year}ë…„ ì„¸ëŒ€ë‹¹ í‰ê·  ì‘ì—…ë¹„\n\nâ€¢ ê³„ì‚°ì‹: ì „ì²´ê¸ˆì•¡(ì‹¤ì ) Ã· ì‹¤ì  ì„¸ëŒ€ìˆ˜\nâ€¢ ì˜ë¯¸: ì‹¤ì œ ë°œìƒí•œ ì„¸ëŒ€ë‹¹ í‰ê·  ìˆ˜ì¥ê³µì‚¬ ë¹„ìš©`,
                        currentAmount: `[ì‹¤ì  ë°ì´í„°] ${year}ë…„ í•´ë‹¹ ê±´ë¬¼ë™ì˜ ìš´ì˜ì„± ì‘ì—…ë¹„ ì´ì•¡\n\nâ€¢ ë°ì´í„° ì¶œì²˜: ì—…ë¡œë“œëœ ë¡œìš°ë°ì´í„° ê¸°ì¤€\nâ€¢ ì§‘ê³„ ë°©ì‹: ì„ íƒëœ ì‘ì—…ìœ í˜•ì˜ ${year}ë…„ ê¸ˆì•¡ í•©ì‚°`
                    };

                    // ìë™ í…Œì´ë¸” ì‹¤ì  íˆ´íŒ
                    const elCurrentCountAuto = document.getElementById('tooltip-current-count');
                    const elCurrentUnitAuto = document.getElementById('tooltip-current-unit');
                    const elCurrentAmountAuto = document.getElementById('tooltip-current-amount');

                    if (elCurrentCountAuto) elCurrentCountAuto.innerText = currentFormulaText.currentCount;
                    if (elCurrentUnitAuto) elCurrentUnitAuto.innerText = currentFormulaText.currentUnit;
                    if (elCurrentAmountAuto) elCurrentAmountAuto.innerText = currentFormulaText.currentAmount;

                    // ìˆ˜ë™ í…Œì´ë¸” ì‹¤ì  íˆ´íŒ
                    const elCurrentCountManual = document.getElementById('tooltip-current-count-m');
                    const elCurrentUnitManual = document.getElementById('tooltip-current-unit-m');
                    const elCurrentAmountManual = document.getElementById('tooltip-current-amount-m');

                    if (elCurrentCountManual) elCurrentCountManual.innerText = currentFormulaText.currentCount;
                    if (elCurrentUnitManual) elCurrentUnitManual.innerText = currentFormulaText.currentUnit;
                    if (elCurrentAmountManual) elCurrentAmountManual.innerText = currentFormulaText.currentAmount;

                    // Table Headers Update - [Fix] íˆ´íŒì´ ìˆëŠ” ê²½ìš° ë³´ì¡´
                    const tableHeaders = document.querySelectorAll('.dynamic-year-header');
                    tableHeaders.forEach(th => {
                        const tooltipContainer = th.querySelector('.tooltip-container');
                        const sortIcon = th.querySelector('.fa-sort, .fa-sort-up, .fa-sort-down');
                        const sortIconHtml = sortIcon ? sortIcon.outerHTML : '<i class="fa-solid fa-sort text-emerald-300 ml-1"></i>';

                        if (tooltipContainer) {
                            // íˆ´íŒì´ ìˆëŠ” ê²½ìš°: í…ìŠ¤íŠ¸ + ì •ë ¬ ì•„ì´ì½˜ + íˆ´íŒ ìœ ì§€
                            const tooltipHtml = tooltipContainer.outerHTML;
                            th.innerHTML = `${String(year).slice(2)}ë…„<br>ì‹¤ì  ${sortIconHtml}\n${tooltipHtml}`;
                        } else {
                            // íˆ´íŒì´ ì—†ëŠ” ê²½ìš°: ê¸°ì¡´ ë°©ì‹
                            th.innerHTML = `${String(year).slice(2)}ë…„<br>ì‹¤ì  ${sortIconHtml}`;
                        }
                    });

                    if (workTypes && workTypes.length > 0 && client) {
                        // [Refactor] Title Formatting: Client (Large) | Work Types (Small, Gray, Full List)
                        // Also replace 'ê³µì‚¬' with 'ìš´ì˜ì„± ì‘ì—…' for display
                        const displayWorkTypes = workTypes.join(', ').replace(/ê³µì‚¬/g, 'ìš´ì˜ì„± ì‘ì—…');

                        this.els.mainTitle.innerHTML = `
                        ${client} <span class="text-base font-normal text-slate-400 ml-2">/ ${displayWorkTypes} ë¶„ì„</span>
                    `;
                    }
                }

                updateYearRangeLimit(maxSpan, defaultVal = 3) {
                    const range = this.els.yearRange;
                    // If data has only 1 year, min must be 1. Otherwise keep 2 as minimum for "average".
                    const minSpan = maxSpan < 2 ? 1 : 2;

                    range.min = minSpan;
                    range.max = maxSpan;

                    // Try to set default (3), but constrain by min/max
                    let newVal = defaultVal;
                    if (newVal > maxSpan) newVal = maxSpan;
                    if (newVal < minSpan) newVal = minSpan;

                    range.value = newVal;
                    return newVal;
                }

                // [Guide Compliant] Lazy Rendering
                renderDashboard(data, isManualMode = false, onEditCallback = null, manualPredictions = {}, autoData = null, forecastSettings = null) {
                    const { results, totalSummary, yearsOfInterest } = data; // Destructure yearsOfInterest

                    // Use autoData for the "Auto Calculation" summary cards if provided. 
                    // Otherwise fallback to data (which might be manual data if not careful).
                    // In a perfect flow, autoData should always be the pristine auto calculation.
                    const summarySource = autoData ? autoData.totalSummary : totalSummary;

                    this.els.emptyState.classList.add('hidden');
                    this.els.dashboard.classList.remove('hidden');

                    // Render Summary (Safe Update)
                    // Render Summary (Safe Update) - ALWAYS uses Auto Data (summarySource)
                    safe(() => {
                        this.els.summary.execAmt.innerText = FormatUtils.currency(summarySource.totalExecAmount) + ' ì›';
                        this.els.summary.avgAmt.innerText = FormatUtils.currency(summarySource.totalAvgAmount) + ' ì›';
                        this.els.summary.execCnt.innerText = FormatUtils.number(summarySource.totalExecCount) + ' ê±´(ì„¸ëŒ€)';
                        this.els.summary.avgCnt.innerText = FormatUtils.number(summarySource.totalAvgCount) + ' ê±´(ì„¸ëŒ€)';

                        const totalProgress = summarySource.totalUnitsSum > 0
                            ? ((summarySource.totalExecCount / summarySource.totalUnitsSum) * 100).toFixed(1)
                            : 0;
                        this.els.summary.progress.innerText = `ì „ì²´ ëŒ€ìƒ ëŒ€ë¹„ ${totalProgress}% ì§„í–‰`;
                    });

                    // Render Manual Statistics (Only if in manual mode and predictions exist)
                    // [Arithmetic Consistency] Always use the pre-calculated totalSummary from runAnalysis
                    safe(() => {
                        const hasManualInputs = Object.keys(manualPredictions).length > 0;

                        if (isManualMode && hasManualInputs) {
                            this.els.manualSummary.execAmt.innerText = FormatUtils.currency(totalSummary.totalExecAmount) + ' ì›';
                            this.els.manualSummary.avgAmt.innerText = FormatUtils.currency(totalSummary.totalAvgAmount) + ' ì›';
                            this.els.manualSummary.execCnt.innerText = FormatUtils.number(totalSummary.totalExecCount) + ' ê±´(ì„¸ëŒ€)';
                            this.els.manualSummary.avgCnt.innerText = FormatUtils.number(totalSummary.totalAvgCount) + ' ê±´(ì„¸ëŒ€)';

                            const totalProgress = totalSummary.totalUnitsSum > 0
                                ? ((totalSummary.totalExecCount / totalSummary.totalUnitsSum) * 100).toFixed(1)
                                : 0;
                            this.els.manualSummary.progress.innerText = `ì „ì²´ ëŒ€ìƒ ëŒ€ë¹„ ${totalProgress}% ì§„í–‰`;

                            this.els.manualStatsSection.classList.remove('hidden');
                        } else {
                            this.els.manualStatsSection.classList.add('hidden');
                        }
                    });

                    // Render Table (Lazy Chunking)
                    // Select the correct table body based on mode
                    const targetTableBody = isManualMode ? this.els.manualTableBody : this.els.autoTableBody;
                    targetTableBody.innerHTML = '';
                    const chunkSize = 50;
                    let index = 0;

                    const renderChunk = () => {
                        const end = Math.min(index + chunkSize, results.length);
                        const fragment = document.createDocumentFragment();

                        for (let i = index; i < end; i++) {
                            const row = results[i];
                            const tr = document.createElement('tr');
                            tr.className = 'hover:bg-slate-50 transition-colors group border-b border-slate-100';

                            // [Integrity] Safe exclusion reason
                            const rawReason = (row.exclusionReason || '').trim();
                            const safeReason = rawReason.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            const hasReason = safeReason.length > 0 && safeReason !== 'ìƒì„¸ ì‚¬ìœ  ì—†ìŒ';

                            let buildingHtml = `<span class="font-medium text-slate-900 building-data-trigger hover:text-blue-600 cursor-pointer hover:underline decoration-dotted transition-colors" data-building="${row.building}">${row.building}</span>`;
                            let buildingTooltip = '';

                            // [UI] Building Tooltips (Centralized)
                            if (row.isSpecialBuilding) {
                                buildingHtml = `<span class="font-medium text-slate-700 italic">${row.building}</span>`;
                                buildingTooltip = this.generateTooltipHTML(
                                    '<div class="font-bold mb-1 text-amber-300">íŠ¹ìˆ˜ ê±´ë¬¼ë™</div>ì„¸ëŒ€ìˆ˜ X, ë¡œìš°ë°ì´í„° êµ¬ì¡°(ê²¬ì  ë¬¶ìŒ/ë¶„ë¦¬ ê¸°ì¤€ ë¶ˆëª…)',
                                    'fa-solid fa-circle-exclamation', 'text-amber-500', 'w-60'
                                );
                            } else if (row.isSubsetMode && hasReason) {
                                buildingTooltip = this.generateTooltipHTML(
                                    `<div class="font-bold mb-1 text-indigo-300">ë¶€ë¶„ ì§‘ê³„</div>${safeReason}`,
                                    'fa-solid fa-circle-check', 'text-indigo-500', 'w-60'
                                );
                            } else if (row.excludedCount > 0 && hasReason) {
                                buildingTooltip = this.generateTooltipHTML(
                                    `<div class="font-bold mb-1 text-red-300">ì„¸ëŒ€ìˆ˜ ì¡°ì •ë¨</div>${safeReason}<br>(ì‹¤ì œ ì§‘ê³„: ${row.effectiveTotalUnits}ì„¸ëŒ€)`,
                                    'fa-solid fa-circle-minus', 'text-red-500', 'w-60'
                                );
                            }

                            // Manual Inputs Check
                            const hasManualCount = manualPredictions[row.building]?.avgCount !== undefined;
                            const hasManualUnitAmount = manualPredictions[row.building]?.avgUnitAmount !== undefined;

                            // Render Cells
                            const unitCell = row.isSpecialBuilding
                                ? '<span class="text-xs text-slate-400 font-bold">N/A</span>'
                                : (row.isSubsetMode
                                    ? `<span class="line-through text-slate-400 text-xs mr-1">${row.totalUnits}</span><span class="font-bold text-indigo-600">${row.effectiveTotalUnits}</span>`
                                    : `${FormatUtils.number(row.totalUnits)}${row.excludedCount > 0 ? `<span class="text-xs text-red-500 ml-1 font-bold">(-${row.excludedCount})</span>` : ''}`);

                            const avgCountVal = isManualMode && hasManualCount ? manualPredictions[row.building].avgCount : row.avgCount;
                            const avgUnitAmtVal = isManualMode && hasManualUnitAmount ? manualPredictions[row.building].avgUnitAmount : row.avgUnitAmount;

                            const manualTooltipCount = (isManualMode && hasManualCount) ? `<span class="text-xs text-amber-600 ml-1 block">(ìˆ˜ë™)</span>` : '';
                            const manualTooltipAmt = (isManualMode && hasManualUnitAmount) ? `<span class="text-xs text-amber-600 ml-1 block">(ìˆ˜ë™)</span>` : '';

                            // Prediction Tooltips - [Fix] ìë™/ìˆ˜ë™ ëª¨ë“œ êµ¬ë¶„í•˜ì—¬ ì „ë‹¬
                            const manualCountValue = hasManualCount ? manualPredictions[row.building].avgCount : null;
                            const manualUnitAmtValue = hasManualUnitAmount ? manualPredictions[row.building].avgUnitAmount : null;

                            const tooltipCount = !row.isSpecialBuilding ? this.generatePredictionTooltipHTML(row, 'count', yearsOfInterest, 'center', isManualMode, manualCountValue, forecastSettings) : '';
                            const tooltipUnit = !row.isSpecialBuilding ? this.generatePredictionTooltipHTML(row, 'unitAmount', yearsOfInterest, 'right', isManualMode, manualUnitAmtValue, forecastSettings) : '';

                            // [Fix] ì „ì²´ê¸ˆì•¡ íˆ´íŒë„ ìˆ˜ë™ ëª¨ë“œ ë°˜ì˜ - ìˆ˜ë™ ì„¸ëŒ€ìˆ˜ Ã— ìˆ˜ë™ ë‹¨ê°€ = ìˆ˜ë™ ì „ì²´ê¸ˆì•¡
                            const hasAnyManualInput = hasManualCount || hasManualUnitAmount;
                            const manualAmountValue = hasAnyManualInput ? (avgCountVal * avgUnitAmtVal) : null;
                            const tooltipAmt = this.generatePredictionTooltipHTML(row, 'amount', yearsOfInterest, 'right', isManualMode && hasAnyManualInput, manualAmountValue, forecastSettings);

                            // Clean HTML Construction
                            tr.innerHTML = `
                            <td class="px-4 py-3 sticky-col bg-white z-10 border-r border-slate-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                <div class="flex items-center">${buildingHtml}${buildingTooltip}</div>
                            </td>
                            <td class="px-3 py-2 text-center text-slate-600 border-r border-slate-100 bg-slate-50/30">${unitCell}</td>
                            
                            <!-- Avg Count -->
                            <td class="px-3 py-2 text-center text-slate-600 border-r border-slate-100 bg-slate-50/30 ${isManualMode ? 'relative group' : ''}">
                                <div class="flex items-center justify-center">
                                    ${isManualMode && !row.isSpecialBuilding ? `
                                        <span class="editable-cell cursor-text hover:bg-blue-100 px-2 py-1 rounded transition-colors inline-block min-w-[50px] font-medium ${hasManualCount ? 'text-amber-900 bg-amber-100/50' : 'text-blue-700'}"
                                              contenteditable="true"
                                              data-building="${row.building}"
                                              data-field="avgCount"
                                              data-value="${avgCountVal}"
                                              spellcheck="false">${FormatUtils.number(avgCountVal)}</span>
                                        ${hasManualCount ? '<i class="fa-solid fa-user-pen text-xs text-amber-600 absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"></i>' : ''}
                                    ` : FormatUtils.number(row.avgCount)}
                                    ${tooltipCount}
                                </div>
                                ${manualTooltipCount}
                            </td>

                            <td class="px-3 py-2 text-center font-bold text-emerald-700 border-r border-slate-100 bg-emerald-50/10">${FormatUtils.number(row.currentCount)}</td>
                            
                            <td class="px-3 py-2 text-center ${row.diffCount > 0 ? 'text-red-600 font-bold' : (row.diffCount < 0 ? 'text-blue-600 font-bold' : 'text-slate-400')} border-r border-slate-100">
                                ${row.diffCount > 0 ? '+' : ''}${FormatUtils.number(row.diffCount)}
                            </td>
                            
                            <td class="px-3 py-2 text-center border-r border-slate-200">
                                ${row.isSpecialBuilding ? '-' : `<span class="${row.progressRate > 50 ? 'text-red-600 font-bold' : 'text-slate-600'}">${row.progressRate.toFixed(1)}%</span>`}
                            </td>

                            <td class="px-2 py-2 text-center border-r border-slate-200 bg-emerald-50/20">
                                ${row.trendCount?.direction === 'up'
                                    ? '<i class="fa-solid fa-arrow-trend-up text-red-500" title="ìƒìŠ¹ì„¸ (>0.5ê±´/ë…„)"></i>'
                                    : (row.trendCount?.direction === 'down'
                                        ? '<i class="fa-solid fa-arrow-trend-down text-blue-500" title="í•˜ë½ì„¸ (<-0.5ê±´/ë…„)"></i>'
                                        : '<i class="fa-solid fa-minus text-slate-300" title="ë³´í•©"></i>')}
                            </td>

                            <!-- Unit Price -->
                             <td class="px-2 py-2 text-right text-slate-600 border-r border-slate-100 bg-slate-50/30 text-xs ${isManualMode ? 'relative group' : ''}">
                                <div class="flex items-center justify-end">
                                    ${isManualMode && !row.isSpecialBuilding ? `
                                        <span class="editable-cell cursor-text hover:bg-blue-100 px-2 py-1 rounded transition-colors inline-block min-w-[70px] font-medium ${hasManualUnitAmount ? 'text-amber-900 bg-amber-100/50' : 'text-blue-700'}"
                                              contenteditable="true"
                                              data-building="${row.building}"
                                              data-field="avgUnitAmount"
                                              data-value="${avgUnitAmtVal}"
                                              spellcheck="false">${FormatUtils.currency(avgUnitAmtVal)}</span>
                                        ${hasManualUnitAmount ? '<i class="fa-solid fa-user-pen text-xs text-amber-600 absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"></i>' : ''}
                                    ` : (row.isSpecialBuilding ? '<span class="text-slate-300">-</span>' : FormatUtils.currency(row.avgUnitAmount))}
                                    ${tooltipUnit}
                                </div>
                                ${manualTooltipAmt}
                            </td>

                            <td class="px-2 py-2 text-right font-bold text-blue-700 border-r border-slate-100 bg-blue-50/10 text-xs">
                                ${row.isSpecialBuilding ? '-' : FormatUtils.currency(row.currentUnitAmount)}
                            </td>

                            <!-- Amounts -->
                            <td class="px-2 py-2 text-right text-slate-600 border-r border-slate-100 text-xs">
                                <div class="flex items-center justify-end">
                                    ${FormatUtils.currency(row.avgAmount)}
                                    ${tooltipAmt}
                                </div>
                            </td>
                             <td class="px-2 py-2 text-right font-bold text-blue-700 bg-blue-50/20 border-r border-slate-100 text-xs">
                                ${FormatUtils.currency(row.currentAmount)}
                            </td>
                             <td class="px-2 py-2 text-right ${row.diffAmount > 0 ? 'text-red-600' : (row.diffAmount < 0 ? 'text-blue-600' : 'text-slate-400')} text-xs">
                                ${FormatUtils.currency(row.diffAmount)}
                            </td>
                            <td class="px-2 py-2 text-center border-r border-slate-100 bg-slate-50/50">
                                ${row.trend?.direction === 'up'
                                    ? '<i class="fa-solid fa-arrow-trend-up text-red-500" title="ìƒìŠ¹ì„¸ (>10ë§Œ/ë…„)"></i>'
                                    : (row.trend?.direction === 'down'
                                        ? '<i class="fa-solid fa-arrow-trend-down text-blue-500" title="í•˜ë½ì„¸ (<-10ë§Œ/ë…„)"></i>'
                                        : '<i class="fa-solid fa-minus text-slate-300" title="ë³´í•©"></i>')}
                            </td>
                        `;
                            fragment.appendChild(tr);
                        }
                        if (isManualMode && onEditCallback) {
                            // [Performance Fix] Scope querySelectorAll to the fragment (before appendChild)
                            const editableCells = fragment.querySelectorAll('.editable-cell');
                            editableCells.forEach(cell => {
                                cell.addEventListener('focus', function () {
                                    if (this.getAttribute('contenteditable') === 'false') return;
                                    const range = document.createRange();
                                    range.selectNodeContents(this);
                                    const sel = window.getSelection();
                                    sel.removeAllRanges();
                                    sel.addRange(range);
                                });
                                cell.addEventListener('keydown', function (e) {
                                    if (this.getAttribute('contenteditable') === 'false') { e.preventDefault(); return; }
                                    if (e.key === 'Enter') { e.preventDefault(); this.blur(); }
                                    else if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Escape'].includes(e.key)) return;
                                    else if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v', 'x', 'z'].includes(e.key.toLowerCase())) return;
                                    else if (!/^[0-9]$/.test(e.key)) { e.preventDefault(); }
                                });
                                cell.addEventListener('paste', function (e) {
                                    e.preventDefault();
                                    const text = (e.clipboardData || window.clipboardData).getData('text');
                                    const cleanText = text.replace(/[^0-9]/g, '');
                                    document.execCommand('insertText', false, cleanText);
                                });
                                cell.addEventListener('blur', function () {
                                    if (this.getAttribute('contenteditable') === 'false') return;
                                    const building = this.dataset.building;
                                    const field = this.dataset.field;
                                    const oldValue = parseInt(this.dataset.value);
                                    let newValue = this.textContent.replace(/[^0-9]/g, '');
                                    newValue = newValue ? parseInt(newValue) : 0;
                                    if (newValue !== oldValue) {
                                        this.dataset.value = newValue;
                                        onEditCallback(building, field, newValue);
                                    } else {
                                        if (field === 'avgUnitAmount') { this.textContent = FormatUtils.currency(oldValue); }
                                        else { this.textContent = oldValue; }
                                    }
                                });
                            });
                        }

                        targetTableBody.appendChild(fragment);
                        index = end;

                        if (index < results.length) {
                            requestAnimationFrame(renderChunk);
                        }
                    };

                    // [Fix] Execute renderChunk to start rendering
                    renderChunk();
                }

                openComparisonModal() {
                    // [Fix] Ensure visibility and correct stacking context
                    this.els.comparisonModal.style.zIndex = '9999';
                    this.els.comparisonModal.classList.remove('hidden');
                    this.els.comparisonModal.style.display = 'block';

                    if (this.els.comparisonModal.parentNode !== document.body) {
                        document.body.appendChild(this.els.comparisonModal);
                    }

                    document.body.style.overflow = 'hidden'; // Prevent body scroll

                    // [Fix] Force reset modal panel position
                    const modalPanel = this.els.comparisonModal.querySelector('.modal-panel');
                    if (modalPanel) {
                        modalPanel.style.display = 'flex';
                        modalPanel.style.top = '50%';
                        modalPanel.style.left = '50%';
                        modalPanel.style.transform = 'translate(-50%, -50%)';
                        modalPanel.style.width = '90vw';
                        modalPanel.style.height = '90vh';
                        // [Feature] Enable Drag & Resize
                        this._makeInteractive(modalPanel);
                    }
                }

                closeComparisonModal() {
                    this.els.comparisonModal.classList.add('hidden');
                    this.els.comparisonModal.style.display = 'none'; // [Fix] ê°•ì œ ìˆ¨ê¹€
                    document.body.style.overflow = ''; // Restore body scroll
                }

                // === Sankey Modal Functions ===
                openSankeyModal() {
                    console.log('ğŸŒŠ [openSankeyModal] Opening Sankey Modal...');

                    // [Fix] Ensure visibility and correct stacking context
                    this.els.sankeyModal.style.zIndex = '9999';
                    this.els.sankeyModal.classList.remove('hidden');
                    this.els.sankeyModal.style.display = 'block';

                    if (this.els.sankeyModal.parentNode !== document.body) {
                        document.body.appendChild(this.els.sankeyModal);
                    }

                    document.body.style.overflow = 'hidden';

                    // [Fix] Force reset modal panel position
                    const modalPanel = this.els.sankeyModal.querySelector('.modal-panel');
                    if (modalPanel) {
                        modalPanel.style.display = 'flex';
                        modalPanel.style.top = '50%';
                        modalPanel.style.left = '50%';
                        modalPanel.style.transform = 'translate(-50%, -50%)';
                        modalPanel.style.width = '90vw';
                        modalPanel.style.height = '90vh';
                        // [Feature] Enable Drag & Resize
                        this._makeInteractive(modalPanel);
                    }
                }

                closeSankeyModal() {
                    this.els.sankeyModal.classList.add('hidden');
                    this.els.sankeyModal.style.display = 'none';
                    document.body.style.overflow = '';
                }

                // === Raw Data Viewer Functions ===
                openRawDataModal(rawData) {
                    if (!rawData || !Array.isArray(rawData) || rawData.length === 0) {
                        alert('í‘œì‹œí•  ì›ë³¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    this.rawDataState = {
                        allData: rawData,
                        filteredData: rawData,
                        currentPage: 1,
                        pageSize: 100,
                        sortColumn: null,
                        sortDirection: 'asc'
                    };

                    this.renderRawDataTable();

                    // [Fix] Ensure visibility and correct stacking context
                    this.els.rawDataModal.style.zIndex = '9999';
                    this.els.rawDataModal.classList.remove('hidden');
                    this.els.rawDataModal.style.display = 'block';

                    if (this.els.rawDataModal.parentNode !== document.body) {
                        document.body.appendChild(this.els.rawDataModal);
                    }

                    document.body.style.overflow = 'hidden';

                    // [Fix] Force reset modal panel position
                    const modalPanel = this.els.rawDataModal.querySelector('.modal-panel');
                    if (modalPanel) {
                        modalPanel.style.display = 'flex';
                        modalPanel.style.top = '50%';
                        modalPanel.style.left = '50%';
                        modalPanel.style.transform = 'translate(-50%, -50%)';
                        modalPanel.style.width = '95vw';
                        modalPanel.style.height = '95vh';
                        // [Feature] Enable Drag & Resize
                        this._makeInteractive(modalPanel);
                    }
                }

                closeRawDataModal() {
                    this.els.rawDataModal.classList.add('hidden');
                    this.els.rawDataModal.style.display = 'none'; // [Fix] ê°•ì œ ìˆ¨ê¹€
                    document.body.style.overflow = '';
                }

                renderRawDataTable() {
                    const { filteredData, currentPage, pageSize } = this.rawDataState;

                    // Update count
                    this.els.rawDataCount.textContent = filteredData.length;

                    // Calculate pagination
                    const totalPages = Math.ceil(filteredData.length / pageSize);
                    const startIdx = (currentPage - 1) * pageSize;
                    const endIdx = Math.min(startIdx + pageSize, filteredData.length);
                    const pageData = filteredData.slice(startIdx, endIdx);

                    // Update pagination UI
                    this.els.rawDataCurrentPage.textContent = currentPage;
                    this.els.rawDataTotalPages.textContent = totalPages;
                    this.els.rawDataPrevPage.disabled = currentPage === 1;
                    this.els.rawDataNextPage.disabled = currentPage === totalPages;

                    // Filter out empty columns (__EMPTY, __rowNum__, etc.)
                    const filterValidColumns = (columns) => {
                        return columns.filter(col => {
                            if (col === '__rowNum__') return false;
                            if (col.startsWith('__EMPTY')) return false;
                            if (col.startsWith('_')) return false;
                            if (col.trim() === '') return false;
                            return true;
                        });
                    };

                    // Render headers
                    if (filteredData.length > 0) {
                        const allHeaders = Object.keys(filteredData[0]);
                        const headers = filterValidColumns(allHeaders);

                        // Store filtered headers for row rendering
                        this.rawDataState.validHeaders = headers;

                        this.els.rawDataTableHeader.innerHTML = headers.map(header => `
                        <th class="px-4 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition whitespace-nowrap min-w-[80px]"
                            data-column="${header}">
                            ${header}
                            <i class="fa-solid fa-sort ml-1 text-slate-400"></i>
                        </th>
                    `).join('');
                    }

                    // Render rows
                    const validHeaders = this.rawDataState.validHeaders || [];
                    this.els.rawDataTableBody.innerHTML = pageData.map((row, idx) => {
                        const cells = validHeaders.map(header => {
                            const value = row[header];
                            let displayValue = value === null || value === undefined ? '-' : value;

                            // Format numbers
                            if (typeof displayValue === 'number') {
                                displayValue = displayValue.toLocaleString('ko-KR');
                            }

                            // Escape HTML to prevent XSS
                            if (typeof displayValue === 'string') {
                                displayValue = displayValue.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            }

                            return `<td class="px-4 py-2 text-sm text-slate-700 whitespace-nowrap">${displayValue}</td>`;
                        }).join('');

                        return `<tr class="hover:bg-slate-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'}">${cells}</tr>`;
                    }).join('');
                }

                searchRawData(searchTerm) {
                    const { allData } = this.rawDataState;

                    if (!searchTerm || searchTerm.trim() === '') {
                        this.rawDataState.filteredData = allData;
                    } else {
                        const term = searchTerm.toLowerCase();
                        this.rawDataState.filteredData = allData.filter(row => {
                            return Object.values(row).some(value => {
                                if (value === null || value === undefined) return false;
                                return String(value).toLowerCase().includes(term);
                            });
                        });
                    }

                    this.rawDataState.currentPage = 1;
                    this.renderRawDataTable();
                }

                sortRawData(column) {
                    const { filteredData, sortColumn, sortDirection } = this.rawDataState;

                    // Toggle direction if same column
                    let newDirection = 'asc';
                    if (sortColumn === column) {
                        newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    }

                    // Sort data
                    const sorted = [...filteredData].sort((a, b) => {
                        const aVal = a[column];
                        const bVal = b[column];

                        // Handle null/undefined
                        if (aVal === null || aVal === undefined) return 1;
                        if (bVal === null || bVal === undefined) return -1;

                        // Numeric comparison
                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                            return newDirection === 'asc' ? aVal - bVal : bVal - aVal;
                        }

                        // String comparison
                        const comparison = String(aVal).localeCompare(String(bVal));
                        return newDirection === 'asc' ? comparison : -comparison;
                    });

                    this.rawDataState.filteredData = sorted;
                    this.rawDataState.sortColumn = column;
                    this.rawDataState.sortDirection = newDirection;
                    this.renderRawDataTable();
                }

                exportRawDataToExcel(rawData) {
                    if (!rawData || rawData.length === 0) {
                        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // Filter out empty columns
                    const allHeaders = Object.keys(rawData[0]);
                    const headers = allHeaders.filter(col => {
                        if (col === '__rowNum__') return false;
                        if (col.startsWith('__EMPTY')) return false;
                        if (col.startsWith('_')) return false;
                        if (col.trim() === '') return false;
                        return true;
                    });

                    const wb = XLSX.utils.book_new();
                    const data = [headers, ...rawData.map(row => headers.map(h => row[h]))];
                    const ws = XLSX.utils.aoa_to_sheet(data);

                    XLSX.utils.book_append_sheet(wb, ws, "ì›ë³¸ë°ì´í„°");
                    XLSX.writeFile(wb, `ì›ë³¸ë°ì´í„°_${new Date().toISOString().slice(0, 10)}.xlsx`);

                    // Success toast
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    toast.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>ì›ë³¸ ë°ì´í„°ê°€ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);
                }

                // === Fullscreen Table Functions ===
                openFullscreenTable(mode, data) {
                    console.log('ğŸš€ [openFullscreenTable] ì „ì²´í™”ë©´ ì—´ê¸°', {
                        mode,
                        hasData: !!data,
                        hasResults: !!data?.results,
                        resultsCount: data?.results?.length || 0,
                        sampleRow: data?.results?.[0]
                    });

                    if (!data || !data.results || data.results.length === 0) {
                        console.error('âŒ ë°ì´í„° ì—†ìŒ');
                        alert('í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    this.fullscreenTableState = {
                        allData: data.results,
                        filteredData: data.results,
                        mode: mode, // 'auto' or 'manual'
                        isManualMode: mode === 'manual',
                        yearsOfInterest: data.yearsOfInterest || [], // [Fix] íˆ´íŒìš© ì—°ë„ ë°ì´í„° ì¶”ê°€
                        forecastSettings: window.app?.domainService?.forecastSettings || null // [Fix] ê°€ì¤‘í‰ê·  ì„¤ì •ê°’ ì €ì¥
                    };

                    console.log('âœ… [openFullscreenTable] ìƒíƒœ ì„¤ì • ì™„ë£Œ', this.fullscreenTableState);

                    // Update mode label
                    this.els.fullscreenTableModeLabel.textContent = mode === 'manual' ? 'ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ' : 'ìë™ ê³„ì‚° ëª¨ë“œ';

                    // Update mode buttons
                    if (mode === 'manual') {
                        this.els.fullscreenManualModeBtn.classList.add('bg-amber-600', 'text-white');
                        this.els.fullscreenManualModeBtn.classList.remove('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                        this.els.fullscreenAutoModeBtn.classList.remove('bg-blue-600', 'text-white');
                        this.els.fullscreenAutoModeBtn.classList.add('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                    } else {
                        this.els.fullscreenAutoModeBtn.classList.add('bg-blue-600', 'text-white');
                        this.els.fullscreenAutoModeBtn.classList.remove('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                        this.els.fullscreenManualModeBtn.classList.remove('bg-amber-600', 'text-white');
                        this.els.fullscreenManualModeBtn.classList.add('bg-white', 'border', 'border-slate-300', 'text-slate-700');
                    }

                    this.renderFullscreenTable();

                    // [Fix] Ensure visibility and correct stacking context
                    this.els.fullscreenTableModal.style.zIndex = '9999';
                    this.els.fullscreenTableModal.classList.remove('hidden');
                    this.els.fullscreenTableModal.style.display = 'block';

                    if (this.els.fullscreenTableModal.parentNode !== document.body) {
                        document.body.appendChild(this.els.fullscreenTableModal);
                    }

                    document.body.style.overflow = 'hidden';

                    // [Fix] Force reset modal panel position
                    const modalPanel = this.els.fullscreenTableModal.querySelector('.modal-panel');
                    if (modalPanel) {
                        modalPanel.style.display = 'flex';
                        modalPanel.style.top = '50%';
                        modalPanel.style.left = '50%';
                        modalPanel.style.transform = 'translate(-50%, -50%)';
                        modalPanel.style.width = '98vw';
                        modalPanel.style.height = '98vh';
                        // [Feature] Enable Drag & Resize
                        this._makeInteractive(modalPanel);
                    }
                }

                closeFullscreenTable() {
                    this.els.fullscreenTableModal.classList.add('hidden');
                    this.els.fullscreenTableModal.style.display = 'none'; // [Fix] ê°•ì œ ìˆ¨ê¹€
                    document.body.style.overflow = '';
                }

                // === Statistics Detail Modal Functions ===
                statDetailState = {
                    rawData: [],
                    filteredData: [],
                    statType: '',
                    mode: '',
                    sortKey: null,
                    sortDir: 'asc',
                    columns: []
                };

                openStatDetail(statType, mode, rawData) {
                    console.log('ğŸ”µ [openStatDetail] Opening stat detail modal', { statType, mode, rawDataCount: rawData?.length });

                    // [Debug] Check if modal element exists
                    console.log('ğŸ” [Debug] statDetailModal element:', this.els.statDetailModal);
                    console.log('ğŸ” [Debug] statDetailTitle element:', this.els.statDetailTitle);
                    console.log('ğŸ” [Debug] statDetailHeader element:', this.els.statDetailHeader);

                    if (!this.els.statDetailModal) {
                        console.error('âŒ [Error] statDetailModal element is NULL! Modal cannot be opened.');
                        alert('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    // Configure modal based on stat type and mode
                    const configs = {
                        execAmount: {
                            title: `${this.currentYear || 2025}ë…„ ì‹¤ì  (ê¸ˆì•¡) ìƒì„¸`,
                            subtitle: mode === 'manual' ? 'ìˆ˜ë™ ì˜ˆì¸¡ ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°' : 'ìë™ ê³„ì‚° ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°',
                            icon: 'fa-coins',
                            headerClass: mode === 'manual' ? 'from-amber-500 to-orange-600' : 'from-blue-600 to-indigo-700'
                        },
                        execCount: {
                            title: `${this.currentYear || 2025}ë…„ ì‹¤ì  (ì„¸ëŒ€ìˆ˜) ìƒì„¸`,
                            subtitle: mode === 'manual' ? 'ìˆ˜ë™ ì˜ˆì¸¡ ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°' : 'ìë™ ê³„ì‚° ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°',
                            icon: 'fa-house-user',
                            headerClass: mode === 'manual' ? 'from-amber-500 to-orange-600' : 'from-emerald-600 to-teal-700'
                        },
                        avgAmount: {
                            title: `ì˜ˆì¸¡ (ê¸ˆì•¡) ìƒì„¸`,
                            subtitle: mode === 'manual' ? 'ìˆ˜ë™ ì˜ˆì¸¡ ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°' : 'ìë™ ê³„ì‚° ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°',
                            icon: 'fa-chart-line',
                            headerClass: mode === 'manual' ? 'from-amber-500 to-orange-600' : 'from-indigo-600 to-purple-700'
                        },
                        avgCount: {
                            title: `ì˜ˆì¸¡ (ì„¸ëŒ€ìˆ˜) ìƒì„¸`,
                            subtitle: mode === 'manual' ? 'ìˆ˜ë™ ì˜ˆì¸¡ ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°' : 'ìë™ ê³„ì‚° ëª¨ë“œ - ì—°ê³„ ë¡œìš°ë°ì´í„°',
                            icon: 'fa-calculator',
                            headerClass: mode === 'manual' ? 'from-amber-500 to-orange-600' : 'from-purple-600 to-pink-700'
                        }
                    };

                    const config = configs[statType] || configs.execAmount;

                    // Update modal header (with null checks)
                    if (this.els.statDetailTitle) this.els.statDetailTitle.textContent = config.title;
                    if (this.els.statDetailSubtitle) this.els.statDetailSubtitle.textContent = config.subtitle;
                    if (this.els.statDetailIcon) this.els.statDetailIcon.className = `fa-solid ${config.icon} text-white text-2xl`;
                    if (this.els.statDetailHeader) this.els.statDetailHeader.className = `bg-gradient-to-r ${config.headerClass} px-6 py-5`;

                    // Store state
                    this.statDetailState = {
                        rawData: rawData || [],
                        filteredData: rawData || [],
                        statType,
                        mode,
                        sortKey: null,
                        sortDir: 'asc',
                        columns: this.getStatDetailColumns(rawData)
                    };

                    // Render table
                    console.log('ğŸ” [Debug] Rendering stat detail table...');
                    this.renderStatDetailTable();
                    console.log('ğŸ” [Debug] Table rendered successfully.');

                    // Reset search
                    if (this.els.statDetailSearch) this.els.statDetailSearch.value = '';

                    // Show modal
                    console.log('ğŸ” [Debug] Removing hidden class from modal...');
                    console.log('ğŸ” [Debug] Modal classes before:', this.els.statDetailModal.className);

                    // [Fix] DOM ì¡°ì‘ ìˆœì„œ ë³€ê²½ ë° ê°•ì œ ìŠ¤íƒ€ì¼ ì ìš©
                    // 1. z-index ìµœìƒìœ„ ë³´ì¥
                    this.els.statDetailModal.style.zIndex = '9999';

                    // 2. Stacking Context ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ body ì§ê³„ ìì‹ìœ¼ë¡œ ì´ë™
                    if (this.els.statDetailModal.parentNode !== document.body) {
                        console.log('ğŸ” [Debug] Moving modal to body tag to fix stacking context...');
                        document.body.appendChild(this.els.statDetailModal);
                    }

                    // 3. Hidden í´ë˜ìŠ¤ ì œê±° ë° display ì†ì„± ê°•ì œ
                    this.els.statDetailModal.classList.remove('hidden');
                    this.els.statDetailModal.style.display = 'block'; // ê°•ì œ í‘œì‹œ

                    console.log('ğŸ” [Debug] Modal classes after:', this.els.statDetailModal.className);
                    document.body.style.overflow = 'hidden';

                    // [Fix] Force reset modal panel position to center
                    const modalPanel = this.els.statDetailModal.querySelector('.modal-panel');
                    if (modalPanel) {
                        console.log('ğŸ” [Debug] Resetting modal panel position...');
                        // ì´ˆê¸°í™” ì „ display í™•ì¸
                        modalPanel.style.display = 'flex';

                        modalPanel.style.top = '50%';
                        modalPanel.style.left = '50%';
                        modalPanel.style.transform = 'translate(-50%, -50%)';
                        modalPanel.style.width = '98vw';
                        modalPanel.style.height = '98vh';
                        console.log('ğŸ” [Debug] Modal panel style:', modalPanel.style.cssText);
                    }

                    console.log('âœ… [openStatDetail] Modal should now be visible with z-index 9999!');

                    // [Feature] Enable Drag & Resize
                    this._makeInteractive(this.els.statDetailModal.querySelector('.modal-panel'));
                }

                // ============================================================
                // [Core] Modal Interaction System (Draggable & Resizable)
                // ============================================================

                _injectModalStyles() {
                    if (document.getElementById('modal-interaction-styles')) return;

                    const style = document.createElement('style');
                    style.id = 'modal-interaction-styles';
                    style.innerHTML = `
                        .modal-panel {
                            position: absolute; /* Essential for drag/resize */
                            min-width: 300px;
                            min-height: 200px;
                            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
                        }
                        /* Resize Handles */
                        .resize-handle { position: absolute; z-index: 100; opacity: 0; }
                        /* Show handles slightly on hover for affordance (optional, keeping hidden for clean look) */
                        /* .resize-handle:hover { opacity: 0.3; background: rgba(0,0,0,0.1); } */
                        
                        .resize-handle.n { top: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; }
                        .resize-handle.s { bottom: 0; left: 0; right: 0; height: 8px; cursor: ns-resize; }
                        .resize-handle.e { top: 0; right: 0; bottom: 0; width: 8px; cursor: ew-resize; }
                        .resize-handle.w { top: 0; left: 0; bottom: 0; width: 8px; cursor: ew-resize; }
                        
                        .resize-handle.ne { top: 0; right: 0; width: 16px; height: 16px; cursor: nesw-resize; z-index: 101; }
                        .resize-handle.nw { top: 0; left: 0; width: 16px; height: 16px; cursor: nwse-resize; z-index: 101; }
                        .resize-handle.se { bottom: 0; right: 0; width: 16px; height: 16px; cursor: nwse-resize; z-index: 101; }
                        .resize-handle.sw { bottom: 0; left: 0; width: 16px; height: 16px; cursor: nesw-resize; z-index: 101; }
                        
                        /* Header defaults */
                        .modal-header-drag { cursor: move; user-select: none; }
                        
                        /* Dragging State */
                        .is-dragging { user-select: none; opacity: 0.95; transition: none !important; }
                        .is-resizing { user-select: none; transition: none !important; }
                        .is-resizing iframe { pointer-events: none; } /* Fix iframe stealing events */
                    `;
                    document.head.appendChild(style);
                }

                _makeInteractive(panel) {
                    if (!panel) return;
                    this._injectModalStyles();

                    // Mark as initialized to prevent duplicates
                    if (panel.dataset.interactive) return;
                    panel.dataset.interactive = 'true';

                    // 1. Identify Header (Handle)
                    // Try to find a header-like element (usually the first child or class contains header/title)
                    let header = panel.querySelector('h2')?.parentElement || panel.querySelector('.flex.justify-between') || panel.firstElementChild;

                    // Specific fix for some modal structures
                    if (panel.querySelector('.sticky.top-0')) {
                        header = panel.querySelector('.sticky.top-0');
                    }

                    if (header) {
                        header.classList.add('modal-header-drag');

                        // Drag Logic
                        header.addEventListener('mousedown', (e) => {
                            // Ignore if clicking on buttons/inputs inside header
                            if (['BUTTON', 'INPUT', 'A', 'I'].includes(e.target.tagName)) return;

                            e.preventDefault(); // Prevent text selection

                            // [Critical] Freeze Position (Convert translate-center to absolute-px)
                            this._freezePosition(panel);

                            const startX = e.clientX;
                            const startY = e.clientY;
                            const startLeft = panel.offsetLeft;
                            const startTop = panel.offsetTop;

                            panel.classList.add('is-dragging');

                            const onMouseMove = (ev) => {
                                const dx = ev.clientX - startX;
                                const dy = ev.clientY - startY;

                                panel.style.left = `${startLeft + dx}px`;
                                panel.style.top = `${startTop + dy}px`;
                            };

                            const onMouseUp = () => {
                                document.removeEventListener('mousemove', onMouseMove);
                                document.removeEventListener('mouseup', onMouseUp);
                                panel.classList.remove('is-dragging');
                            };

                            document.addEventListener('mousemove', onMouseMove);
                            document.addEventListener('mouseup', onMouseUp);
                        });
                    }

                    // 2. Add Resize Handles
                    const directions = ['n', 's', 'e', 'w', 'ne', 'nw', 'se', 'sw'];
                    directions.forEach(dir => {
                        const handle = document.createElement('div');
                        handle.className = `resize-handle ${dir}`;
                        panel.appendChild(handle);

                        handle.addEventListener('mousedown', (e) => {
                            e.stopPropagation();
                            e.preventDefault();

                            // [Critical] Freeze Position first
                            this._freezePosition(panel);

                            const startX = e.clientX;
                            const startY = e.clientY;
                            const startW = panel.offsetWidth;
                            const startH = panel.offsetHeight;
                            const startL = panel.offsetLeft;
                            const startT = panel.offsetTop;

                            panel.classList.add('is-resizing');

                            const onMouseMove = (ev) => {
                                const dx = ev.clientX - startX;
                                const dy = ev.clientY - startY;

                                let newW = startW;
                                let newH = startH;
                                let newL = startL;
                                let newT = startT;

                                // Calculate new dimensions/position based on direction
                                if (dir.includes('e')) newW = startW + dx;
                                if (dir.includes('w')) {
                                    newW = startW - dx;
                                    newL = startL + dx;
                                }
                                if (dir.includes('s')) newH = startH + dy;
                                if (dir.includes('n')) {
                                    newH = startH - dy;
                                    newT = startT + dy;
                                }

                                // Apply Limits (Min Size)
                                if (newW < 400) {
                                    if (dir.includes('w')) newL = startL + (startW - 400); // Correct left shift limit
                                    newW = 400;
                                }
                                if (newH < 300) {
                                    if (dir.includes('n')) newT = startT + (startH - 300);
                                    newH = 300;
                                }

                                // Apply updates
                                panel.style.width = `${newW}px`;
                                panel.style.height = `${newH}px`;
                                if (dir.includes('w')) panel.style.left = `${newL}px`;
                                if (dir.includes('n')) panel.style.top = `${newT}px`;
                            };

                            const onMouseUp = () => {
                                document.removeEventListener('mousemove', onMouseMove);
                                document.removeEventListener('mouseup', onMouseUp);
                                panel.classList.remove('is-resizing');
                            };

                            document.addEventListener('mousemove', onMouseMove);
                            document.addEventListener('mouseup', onMouseUp);
                        });
                    });
                }

                _freezePosition(panel) {
                    // Converts CSS transform centering to explicit pixel-based top/left positioning
                    const computedStyle = window.getComputedStyle(panel);
                    const transform = computedStyle.transform;

                    // Only run if currently centered via transform/percentage
                    // Or check if 'transform' is not 'none'
                    if (transform !== 'none' || panel.style.transform.includes('translate')) {
                        const rect = panel.getBoundingClientRect();

                        // Disable transition/transform
                        panel.style.transform = 'none';
                        panel.style.transition = 'none';

                        // Set explicit pixels relative to parent (modal container, which is fixed top-0 left-0)
                        panel.style.left = `${rect.left}px`;
                        panel.style.top = `${rect.top}px`;
                        panel.style.width = `${rect.width}px`;
                        panel.style.height = `${rect.height}px`;
                        panel.style.margin = '0';
                    }
                }

                // [New Feature] Open Building Detail Modal (Reusing Stat Detail Modal)
                openBuildingDetail(buildingName, rawData, dateRangeText) {
                    console.log('ğŸ–¥ï¸ [UI] Opening Building Detail Modal for:', buildingName);
                    // Config for Building Detail
                    const config = {
                        title: `${buildingName} ìƒì„¸ ë‚´ì—­`,
                        subtitle: `ê±´ë¬¼ë³„ ìƒì„¸ ê³µê°€/ìˆ˜ì¥ê³µì‚¬ ë‚´ì—­ (${dateRangeText} ë‚´ì—­)`,
                        icon: 'fa-building',
                        headerClass: 'from-blue-600 to-cyan-700'
                    };

                    // Update modal header
                    this.els.statDetailTitle.textContent = config.title;
                    this.els.statDetailSubtitle.textContent = config.subtitle;
                    this.els.statDetailIcon.className = `fa-solid ${config.icon} text-white text-2xl`;
                    this.els.statDetailHeader.className = `bg-gradient-to-r ${config.headerClass} px-6 py-5`;

                    // Store state
                    this.statDetailState = {
                        rawData: rawData || [],
                        filteredData: rawData || [],
                        statType: 'buildingDetail',
                        mode: 'auto', // Not strictly used for display but good for context
                        sortKey: null,
                        sortDir: 'asc',
                        columns: this.getStatDetailColumns(rawData)
                    };

                    // Render table
                    this.renderStatDetailTable();

                    // Reset search
                    this.els.statDetailSearch.value = '';

                    // Show modal
                    // [Fix] Ensure visibility and correct stacking context
                    this.els.statDetailModal.style.zIndex = '9999';
                    this.els.statDetailModal.classList.remove('hidden');
                    this.els.statDetailModal.style.display = 'block';

                    if (this.els.statDetailModal.parentNode !== document.body) {
                        document.body.appendChild(this.els.statDetailModal);
                    }

                    document.body.style.overflow = 'hidden';

                    // [Fix] Force reset modal panel position to center
                    const modalPanel = this.els.statDetailModal.querySelector('.modal-panel');
                    if (modalPanel) {
                        modalPanel.style.display = 'flex';
                        modalPanel.style.top = '50%';
                        modalPanel.style.left = '50%';
                        modalPanel.style.transform = 'translate(-50%, -50%)';
                        modalPanel.style.width = '98vw';
                        modalPanel.style.height = '98vh';
                    }
                }

                closeStatDetail() {
                    this.els.statDetailModal.classList.add('hidden');
                    this.els.statDetailModal.style.display = 'none'; // [Fix] ê°•ì œ ìˆ¨ê¹€
                    document.body.style.overflow = '';
                }

                getStatDetailColumns(data) {
                    if (!data || data.length === 0) return [];
                    const sample = data[0];
                    return Object.keys(sample).filter(key => {
                        // Filter out internal columns and empty columns
                        if (key === '__rowNum__') return false;
                        if (key.startsWith('__EMPTY')) return false;
                        if (key.startsWith('_')) return false; // Filter other internal columns
                        if (key.trim() === '') return false; // Filter empty string keys
                        return true;
                    });
                }

                renderStatDetailTable() {
                    const { filteredData, columns, sortKey, sortDir } = this.statDetailState;

                    // Update count
                    this.els.statDetailCount.textContent = filteredData.length;

                    // Render headers with sort icons
                    let headerHtml = '<tr>';
                    headerHtml += `<th class="px-3 py-3 text-center bg-slate-100 border-r border-slate-200 font-bold w-16 whitespace-nowrap sticky left-0 z-10">No.</th>`;

                    columns.forEach(col => {
                        const isActive = col === sortKey;
                        const iconClass = isActive ? (sortDir === 'asc' ? 'fa-sort-up text-blue-600' : 'fa-sort-down text-blue-600') : 'fa-sort text-slate-400';
                        headerHtml += `
                        <th class="px-3 py-3 text-left bg-slate-100 border-r border-slate-200 cursor-pointer hover:bg-slate-200 transition-colors stat-detail-sort-header whitespace-nowrap min-w-[80px]"
                            data-column="${col}">
                            ${col}
                            <i class="fa-solid ${iconClass} ml-1"></i>
                        </th>
                    `;
                    });
                    headerHtml += '</tr>';
                    this.els.statDetailTableHead.innerHTML = headerHtml;

                    // Add click handlers for sorting
                    this.els.statDetailTableHead.querySelectorAll('.stat-detail-sort-header').forEach(th => {
                        th.addEventListener('click', () => {
                            this.sortStatDetail(th.dataset.column);
                        });
                    });

                    // Render body with auto-numbering
                    let bodyHtml = '';

                    // [Performance] Limit render to 500 rows to prevent freeze
                    const renderLimit = 500;
                    const displayData = filteredData.slice(0, renderLimit);

                    displayData.forEach((row, idx) => {
                        bodyHtml += `<tr class="hover:bg-slate-50 transition-colors">`;
                        bodyHtml += `<td class="px-3 py-2 text-center text-slate-500 font-medium border-r border-slate-100 whitespace-nowrap sticky left-0 bg-white z-10">${idx + 1}</td>`;
                        columns.forEach(col => {
                            const val = row[col];
                            let displayVal = val;

                            // Format numbers
                            if (typeof val === 'number') {
                                displayVal = val.toLocaleString('ko-KR');
                            } else if (val === null || val === undefined) {
                                displayVal = '-';
                            }

                            // Escape HTML to prevent XSS
                            if (typeof displayVal === 'string') {
                                displayVal = displayVal.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            }

                            bodyHtml += `<td class="px-3 py-2 text-slate-700 border-r border-slate-100 whitespace-nowrap">${displayVal}</td>`;
                        });
                        bodyHtml += '</tr>';
                    });

                    if (filteredData.length > renderLimit) {
                        bodyHtml += `<tr><td colspan="${columns.length + 1}" class="px-4 py-3 text-center bg-amber-50 text-amber-700 font-medium border-t border-amber-200">âš ï¸ ë°ì´í„°ê°€ ë„ˆë¬´ ë§ì•„ ìƒìœ„ ${renderLimit}ê°œ í–‰ë§Œ í‘œì‹œë©ë‹ˆë‹¤. (ì „ì²´: ${filteredData.length}ê°œ) - ì—‘ì…€ ë‹¤ìš´ë¡œë“œë¥¼ ì´ìš©í•˜ì„¸ìš”.</td></tr>`;
                    }

                    if (filteredData.length === 0) {
                        bodyHtml = `<tr><td colspan="${columns.length + 1}" class="px-4 py-8 text-center text-slate-400">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                    }

                    this.els.statDetailTableBody.innerHTML = bodyHtml;
                }

                searchStatDetail(query) {
                    const { rawData, columns } = this.statDetailState;
                    const lowerQuery = query.toLowerCase().trim();

                    if (!lowerQuery) {
                        this.statDetailState.filteredData = rawData;
                    } else {
                        this.statDetailState.filteredData = rawData.filter(row => {
                            return columns.some(col => {
                                const val = row[col];
                                if (val == null) return false;
                                return String(val).toLowerCase().includes(lowerQuery);
                            });
                        });
                    }

                    this.renderStatDetailTable();
                }

                sortStatDetail(column) {
                    const { filteredData, sortKey, sortDir } = this.statDetailState;

                    // Toggle direction if same column
                    let newDir = 'asc';
                    if (column === sortKey) {
                        newDir = sortDir === 'asc' ? 'desc' : 'asc';
                    }

                    this.statDetailState.sortKey = column;
                    this.statDetailState.sortDir = newDir;

                    const mult = newDir === 'asc' ? 1 : -1;
                    filteredData.sort((a, b) => {
                        const valA = a[column];
                        const valB = b[column];

                        if (valA == null && valB == null) return 0;
                        if (valA == null) return 1 * mult;
                        if (valB == null) return -1 * mult;

                        if (typeof valA === 'string' && typeof valB === 'string') {
                            return valA.localeCompare(valB) * mult;
                        }
                        return (valA - valB) * mult;
                    });

                    this.renderStatDetailTable();
                }

                exportStatDetail() {
                    const { filteredData, columns, statType, mode } = this.statDetailState;

                    if (filteredData.length === 0) {
                        alert('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    // Prepare data with row numbers
                    const exportData = filteredData.map((row, idx) => {
                        const newRow = { 'No.': idx + 1 };
                        columns.forEach(col => {
                            newRow[col] = row[col];
                        });
                        return newRow;
                    });

                    // Create workbook
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    const modeLabel = mode === 'manual' ? 'ìˆ˜ë™ì˜ˆì¸¡' : 'ìë™ê³„ì‚°';
                    const typeLabels = {
                        execAmount: 'ì‹¤ì ê¸ˆì•¡',
                        execCount: 'ì‹¤ì ì„¸ëŒ€ìˆ˜',
                        avgAmount: 'ì˜ˆì¸¡ê¸ˆì•¡',
                        avgCount: 'ì˜ˆì¸¡ì„¸ëŒ€ìˆ˜'
                    };
                    const sheetName = `${modeLabel}_${typeLabels[statType] || 'ìƒì„¸'}`;
                    XLSX.utils.book_append_sheet(wb, ws, sheetName.substring(0, 31));

                    // Download
                    const fileName = `í†µê³„ìƒì„¸_${modeLabel}_${typeLabels[statType] || statType}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);
                }


                renderFullscreenTable() {
                    const { filteredData, isManualMode, mode, yearsOfInterest, forecastSettings } = this.fullscreenTableState;

                    console.log('ğŸ” [renderFullscreenTable] ë Œë”ë§ ì‹œì‘', {
                        mode,
                        isManualMode,
                        dataCount: filteredData?.length || 0,
                        sampleData: filteredData?.[0]
                    });

                    // Update titles and modes
                    const methodSuffix = forecastSettings?.method === 'wma' ? ' ìë™ ëª¨ë“œ (ê°€ì¤‘í‰ê· )' : ' ìë™ ëª¨ë“œ (ë‹¨ìˆœí‰ê· )';
                    if (this.els.fullscreenTableTitle) {
                        this.els.fullscreenTableTitle.innerText = `ê±´ë¬¼ë™ë³„ ìƒì„¸ ë¹„êµ ë¶„ì„${methodSuffix} - ì „ì²´`;
                    }

                    // Render headers - [Fix] ìë™/ìˆ˜ë™ ëª¨ë“œì— ë”°ë¥¸ í—¤ë” êµ¬ë¶„ + íˆ´íŒ ì¶”ê°€
                    const predBgClass = isManualMode ? 'bg-amber-50/50' : 'bg-emerald-50/50';
                    const predBgClassBlue = isManualMode ? 'bg-amber-50/50' : 'bg-blue-50/50';
                    const tooltipIconColor = isManualMode ? 'text-amber-500 hover:text-amber-700' : 'text-emerald-400 hover:text-emerald-600';
                    const tooltipIconColorBlue = isManualMode ? 'text-amber-500 hover:text-amber-700' : 'text-blue-400 hover:text-blue-600';

                    // ì—°ë„ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    const yearSpan = yearsOfInterest ? yearsOfInterest.length : 3;

                    // íˆ´íŒ í…ìŠ¤íŠ¸ - ìë™/ìˆ˜ë™ ëª¨ë“œ êµ¬ë¶„
                    const tooltipAvgCount = isManualMode
                        ? `[ìˆ˜ë™ ì…ë ¥] ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜ (ê¸°ë³¸ê°’: ${yearSpan}ê°œë…„ ìë™í‰ê· )`
                        : `[ì‚°ì‹] ìµœê·¼ ${yearSpan}ê°œë…„ ì„¸ëŒ€ìˆ˜(ê±´ìˆ˜)ì˜ ë‹¨ìˆœ í‰ê· `;
                    const tooltipUnitAmt = isManualMode
                        ? `[ìˆ˜ë™ ì…ë ¥] ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ì„¸ëŒ€ë‹¹ ë‹¨ê°€ (ê¸°ë³¸ê°’: ${yearSpan}ê°œë…„ ìë™í‰ê· )`
                        : `[ì‚°ì‹] ì˜ˆì¸¡ ì „ì²´ê¸ˆì•¡ Ã· ì˜ˆì¸¡ ì „ì²´ì„¸ëŒ€ìˆ˜ (í‰ê·  ë‹¨ê°€)`;
                    const tooltipTotalAmt = isManualMode
                        ? `[ì‚°ì‹] ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜ Ã— ì„¸ëŒ€ë‹¹ ë‹¨ê°€ (ìˆ˜ë™ ì…ë ¥ ê¸°ë°˜)`
                        : `[ì‚°ì‹] ìµœê·¼ ${yearSpan}ê°œë…„ ìš´ì˜ì„± ì‘ì—…ë¹„ ì´ì•¡ì˜ ë‹¨ìˆœ í‰ê· `;

                    // [New] ì‹¤ì  ì—´ íˆ´íŒ - ìë™/ìˆ˜ë™ ê³µí†µ
                    const tooltipCurrentCount = `[ì‹¤ì  ë°ì´í„°] ${this.currentYear}ë…„ í•´ë‹¹ ê±´ë¬¼ë™ì˜ ì‹¤ì œ ìˆ˜ì¥ê³µì‚¬ ê³„ì•½ ê±´ìˆ˜ í•©ê³„<br><br><span class="text-emerald-300">â€¢ ë°ì´í„° ì¶œì²˜:</span> ì—…ë¡œë“œëœ ë¡œìš°ë°ì´í„° ê¸°ì¤€<br><span class="text-emerald-300">â€¢ ì§‘ê³„ ë°©ì‹:</span> ì„ íƒëœ ì‘ì—…ìœ í˜•ì˜ ${this.currentYear}ë…„ ê±´ìˆ˜ í•©ì‚°`;
                    const tooltipCurrentUnit = `[ì‹¤ì  ë°ì´í„°] ${this.currentYear}ë…„ ì„¸ëŒ€ë‹¹ í‰ê·  ì‘ì—…ë¹„<br><br><span class="text-blue-300">â€¢ ê³„ì‚°ì‹:</span> ì „ì²´ê¸ˆì•¡(ì‹¤ì ) Ã· ì‹¤ì  ì„¸ëŒ€ìˆ˜<br><span class="text-blue-300">â€¢ ì˜ë¯¸:</span> ì‹¤ì œ ë°œìƒí•œ ì„¸ëŒ€ë‹¹ í‰ê·  ìˆ˜ì¥ê³µì‚¬ ë¹„ìš©`;
                    const tooltipCurrentAmount = `[ì‹¤ì  ë°ì´í„°] ${this.currentYear}ë…„ í•´ë‹¹ ê±´ë¬¼ë™ì˜ ìš´ì˜ì„± ì‘ì—…ë¹„ ì´ì•¡<br><br><span class="text-blue-300">â€¢ ë°ì´í„° ì¶œì²˜:</span> ì—…ë¡œë“œëœ ë¡œìš°ë°ì´í„° ê¸°ì¤€<br><span class="text-blue-300">â€¢ ì§‘ê³„ ë°©ì‹:</span> ì„ íƒëœ ì‘ì—…ìœ í˜•ì˜ ${this.currentYear}ë…„ ê¸ˆì•¡ í•©ì‚°`;

                    this.els.fullscreenTableThead.innerHTML = `
                    <tr>
                        <th rowspan="2" class="px-4 py-3 font-bold bg-slate-100 border-r border-slate-200 sticky-col z-40 w-32 text-center shadow-sm">
                            ê±´ë¬¼ë™
                        </th>
                        <th colspan="6" class="px-4 py-2 font-bold bg-emerald-50 text-emerald-800 text-center border-r border-slate-200">
                            ì„¸ëŒ€ìˆ˜ ë¶„ì„ (ê³„ì•½ ê±´ìˆ˜) ${isManualMode ? '<span class="text-xs text-amber-600">(ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ)</span>' : ''}
                        </th>
                        <th colspan="6" class="px-4 py-2 font-bold bg-blue-50 text-blue-800 text-center">
                            ìš´ì˜ì„± ì‘ì—…ë¹„ ë¶„ì„ (PO ê¸ˆì•¡) ${isManualMode ? '<span class="text-xs text-amber-600">(ìˆ˜ë™ ì…ë ¥ ëª¨ë“œ)</span>' : ''}
                        </th>
                    </tr>
                    <tr>
                        <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200">
                            ì „ì²´<br>ì„¸ëŒ€
                        </th>
                        <th class="px-3 py-2 text-center ${predBgClass} border-r border-slate-200">
                            ${isManualMode ? '<span class="text-amber-600">ì˜ˆì¸¡</span>' : 'ì˜ˆì¸¡'}<br>${isManualMode ? '<span class="text-amber-600">(ìˆ˜ë™)</span>' : '(í‰ê· )'}
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question ${tooltipIconColor} cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56">${tooltipAvgCount}</span>
                            </div>
                        </th>
                        <th class="px-3 py-2 text-center bg-emerald-100 text-emerald-900 border-r border-slate-200 font-bold">
                            ${this.currentYear}ë…„<br>ì‹¤ì 
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question text-emerald-600 hover:text-emerald-800 cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64">${tooltipCurrentCount}</span>
                            </div>
                        </th>
                        <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200">
                            ì°¨ì´<br>(ì‹¤ì -ì˜ˆì¸¡)
                        </th>
                        <th class="px-3 py-2 text-center bg-emerald-50/50 border-r border-slate-200">
                            ì§„ì²™ë¥ <br>(ì‹¤ì /ì „ì²´)
                        </th>
                        <th class="px-2 py-2 text-center bg-emerald-50/50 text-xs cursor-help border-r border-slate-200">
                            ì¶”ì„¸<br>(Trend)
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question text-emerald-600 hover:text-emerald-800 cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-72 text-left">
                                    [ì¶”ì„¸ ë¶„ì„ ê¸°ì¤€: ì—°í‰ê·  ì¦ê°]<br>
                                    <span class="text-red-400 font-bold">ğŸ“ˆ ìƒìŠ¹ì„¸</span>: ì—°ê°„ +0.5ê±´ ì´ìƒ ì¦ê°€<br>
                                    <span class="text-blue-400 font-bold">â†˜ï¸ í•˜ë½ì„¸</span>: ì—°ê°„ -0.5ê±´ ì´í•˜ ê°ì†Œ<br>
                                    <span class="text-slate-400">â¡ï¸ ë³´í•©</span>: ë³€ë™í­ ë¯¸ë¯¸ (-0.5 ~ +0.5)<br><br>
                                    * ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì˜ ì„ í˜• íšŒê·€ ê¸°ìš¸ê¸°ë¡œ ì‚°ì¶œë©ë‹ˆë‹¤.
                                </span>
                            </div>
                        </th>
                        <th class="px-2 py-2 text-center ${predBgClassBlue} border-r border-slate-200 text-xs">
                            ì„¸ëŒ€ë‹¹<br>${isManualMode ? '<span class="text-amber-600">(ìˆ˜ë™)</span>' : '(ì˜ˆì¸¡)'}
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question ${tooltipIconColorBlue} cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56">${tooltipUnitAmt}</span>
                            </div>
                        </th>
                        <th class="px-2 py-2 text-center bg-blue-100 text-blue-900 border-r border-slate-200 font-bold text-xs">
                            ì„¸ëŒ€ë‹¹<br>(ì‹¤ì )
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64">${tooltipCurrentUnit}</span>
                            </div>
                        </th>
                        <th class="px-2 py-2 text-center ${predBgClassBlue} border-r border-slate-200 text-xs">
                            ì „ì²´ê¸ˆì•¡<br>${isManualMode ? '<span class="text-amber-600">(ìˆ˜ë™)</span>' : '(ì˜ˆì¸¡)'}
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question ${tooltipIconColorBlue} cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-56">${tooltipTotalAmt}</span>
                            </div>
                        </th>
                        <th class="px-2 py-2 text-center bg-blue-100 text-blue-900 border-r border-slate-200 font-bold text-xs">
                            ì „ì²´ê¸ˆì•¡<br>(ì‹¤ì )
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-64">${tooltipCurrentAmount}</span>
                            </div>
                        </th>
                        <th class="px-2 py-2 text-center bg-blue-50/50 text-xs border-r border-slate-200">
                            ì°¨ì•¡<br>(ì‹¤ì -ì˜ˆì¸¡)
                        </th>
                        <th class="px-2 py-2 text-center bg-blue-50/50 text-xs cursor-help">
                            ì¶”ì„¸<br>(Trend)
                            <div class="tooltip-container">
                                <i class="fa-regular fa-circle-question text-blue-600 hover:text-blue-800 cursor-help"></i>
                                <span class="tooltip-content bg-slate-800 text-white p-2 rounded-md shadow-lg text-xs w-72 text-left">
                                    [ì¶”ì„¸ ë¶„ì„ ê¸°ì¤€: ì—°í‰ê·  ì¦ê°]<br>
                                    <span class="text-red-400 font-bold">ğŸ“ˆ ìƒìŠ¹ì„¸</span>: ì—°ê°„ +10ë§Œì› ì´ìƒ ì¦ê°€<br>
                                    <span class="text-blue-400 font-bold">â†˜ï¸ í•˜ë½ì„¸</span>: ì—°ê°„ -10ë§Œì› ì´í•˜ ê°ì†Œ<br>
                                    <span class="text-slate-400">â¡ï¸ ë³´í•©</span>: ë³€ë™í­ ë¯¸ë¯¸ (-10ë§Œ ~ +10ë§Œ)<br><br>
                                    * ê³¼ê±° ë°ì´í„° ê¸°ë°˜ì˜ ì„ í˜• íšŒê·€ ê¸°ìš¸ê¸°ë¡œ ì‚°ì¶œë©ë‹ˆë‹¤.
                                </span>
                            </div>
                        </th>
                    </tr>
                `;

                    // Get manualPredictions from parent App
                    const manualPredictions = window.app?.manualPredictions || {};

                    // [Fix] Render rows - ì¼ë°˜ í…Œì´ë¸”ê³¼ ì™„ë²½í•˜ê²Œ ë™ì¼í•œ ë¡œì§
                    this.els.fullscreenTableBody.innerHTML = filteredData.map((row, idx) => {
                        // [Integrity] Safe exclusion reason
                        const rawReason = (row.exclusionReason || '').trim();
                        const safeReason = rawReason.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const hasReason = safeReason.length > 0 && safeReason !== 'ìƒì„¸ ì‚¬ìœ  ì—†ìŒ';

                        // ê±´ë¬¼ë™ ì»¬ëŸ¼ - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼
                        let buildingHtml = `<span class="font-medium text-slate-900 building-data-trigger hover:text-blue-600 cursor-pointer hover:underline decoration-dotted transition-colors" data-building="${row.building}">${row.building}</span>`;
                        let buildingTooltip = '';

                        if (row.isSpecialBuilding) {
                            buildingHtml = `<span class="font-medium text-slate-700 italic">${row.building}</span>`;
                            buildingTooltip = this.generateTooltipHTML(
                                '<div class="font-bold mb-1 text-amber-300">íŠ¹ìˆ˜ ê±´ë¬¼ë™</div>ì„¸ëŒ€ìˆ˜ X, ë¡œìš°ë°ì´í„° êµ¬ì¡°(ê²¬ì  ë¬¶ìŒ/ë¶„ë¦¬ ê¸°ì¤€ ë¶ˆëª…)',
                                'fa-solid fa-circle-exclamation', 'text-amber-500', 'w-60'
                            );
                        } else if (row.isSubsetMode && hasReason) {
                            buildingTooltip = this.generateTooltipHTML(
                                `<div class="font-bold mb-1 text-indigo-300">ë¶€ë¶„ ì§‘ê³„</div>${safeReason}`,
                                'fa-solid fa-circle-check', 'text-indigo-500', 'w-60'
                            );
                        } else if (row.excludedCount > 0 && hasReason) {
                            buildingTooltip = this.generateTooltipHTML(
                                `<div class="font-bold mb-1 text-red-300">ì„¸ëŒ€ìˆ˜ ì¡°ì •ë¨</div>${safeReason}<br>(ì‹¤ì œ ì§‘ê³„: ${row.effectiveTotalUnits}ì„¸ëŒ€)`,
                                'fa-solid fa-circle-minus', 'text-red-500', 'w-60'
                            );
                        }

                        // ì „ì²´ ì„¸ëŒ€ìˆ˜ í‘œì‹œ - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼
                        const unitCell = row.isSpecialBuilding
                            ? '<span class="text-xs text-slate-400 font-bold">N/A</span>'
                            : (row.isSubsetMode
                                ? `<span class="line-through text-slate-400 text-xs mr-1">${row.totalUnits}</span><span class="font-bold text-indigo-600">${row.effectiveTotalUnits}</span>`
                                : `${FormatUtils.number(row.totalUnits)}${row.excludedCount > 0 ? `<span class="text-xs text-red-500 ml-1 font-bold">(-${row.excludedCount})</span>` : ''}`);

                        // Manual Check
                        const hasManualCount = manualPredictions[row.building]?.avgCount !== undefined;
                        const hasManualUnitAmount = manualPredictions[row.building]?.avgUnitAmount !== undefined;

                        // ê°’ ê³„ì‚° - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼
                        const avgCountVal = isManualMode && hasManualCount ? manualPredictions[row.building].avgCount : row.avgCount;
                        const avgUnitAmtVal = isManualMode && hasManualUnitAmount ? manualPredictions[row.building].avgUnitAmount : row.avgUnitAmount;

                        // ìˆ˜ë™ ì…ë ¥ ë¼ë²¨ - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼
                        const manualTooltipCount = (isManualMode && hasManualCount) ? `<span class="text-xs text-amber-600 ml-1 block">(ìˆ˜ë™)</span>` : '';
                        const manualTooltipAmt = (isManualMode && hasManualUnitAmount) ? `<span class="text-xs text-amber-600 ml-1 block">(ìˆ˜ë™)</span>` : '';

                        // íˆ´íŒ ìƒì„± - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼
                        const manualCountValue = hasManualCount ? manualPredictions[row.building].avgCount : null;
                        const manualUnitAmtValue = hasManualUnitAmount ? manualPredictions[row.building].avgUnitAmount : null;
                        const hasAnyManualInput = hasManualCount || hasManualUnitAmount;
                        const manualAmountValue = hasAnyManualInput ? (avgCountVal * avgUnitAmtVal) : null;

                        const tooltipCount = !row.isSpecialBuilding ? this.generatePredictionTooltipHTML(row, 'count', yearsOfInterest, 'center', isManualMode, manualCountValue, forecastSettings) : '';
                        const tooltipUnit = !row.isSpecialBuilding ? this.generatePredictionTooltipHTML(row, 'unitAmount', yearsOfInterest, 'right', isManualMode, manualUnitAmtValue, forecastSettings) : '';
                        const tooltipAmt = this.generatePredictionTooltipHTML(row, 'amount', yearsOfInterest, 'right', isManualMode && hasAnyManualInput, manualAmountValue, forecastSettings);

                        // ì°¨ì´ê°’ ìŠ¤íƒ€ì¼ - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼
                        const diffCntClass = row.diffCount > 0 ? 'text-red-600 font-bold' : (row.diffCount < 0 ? 'text-blue-600 font-bold' : 'text-slate-400');
                        const diffAmtClass = row.diffAmount > 0 ? 'text-red-600' : (row.diffAmount < 0 ? 'text-blue-600' : 'text-slate-400');

                        return `
                        <tr class="hover:bg-slate-50 transition-colors group border-b border-slate-100">
                            <td class="px-4 py-3 sticky-col bg-white z-10 border-r border-slate-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.05)]">
                                <div class="flex items-center">${buildingHtml}${buildingTooltip}</div>
                            </td>
                            <td class="px-3 py-2 text-center text-slate-600 border-r border-slate-100 bg-slate-50/30">${unitCell}</td>

                            <!-- Avg Count -->
                            <td class="px-3 py-2 text-center text-slate-600 border-r border-slate-100 bg-slate-50/30 ${isManualMode ? 'relative group' : ''}">
                                <div class="flex items-center justify-center">
                                    ${isManualMode && !row.isSpecialBuilding ? `
                                        <span class="editable-cell cursor-text hover:bg-blue-100 px-2 py-1 rounded transition-colors inline-block min-w-[50px] font-medium ${hasManualCount ? 'text-amber-900 bg-amber-100/50' : 'text-blue-700'}"
                                              contenteditable="true"
                                              data-building="${row.building}"
                                              data-field="avgCount"
                                              data-value="${avgCountVal}"
                                              spellcheck="false">${FormatUtils.number(avgCountVal)}</span>
                                        ${hasManualCount ? '<i class="fa-solid fa-user-pen text-xs text-amber-600 absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"></i>' : ''}
                                    ` : FormatUtils.number(row.avgCount)}
                                    ${tooltipCount}
                                </div>
                                ${manualTooltipCount}
                            </td>

                            <td class="px-3 py-2 text-center font-bold text-emerald-700 border-r border-slate-100 bg-emerald-50/10">${FormatUtils.number(row.currentCount)}</td>

                            <td class="px-3 py-2 text-center ${diffCntClass} border-r border-slate-100">
                                ${row.diffCount > 0 ? '+' : ''}${FormatUtils.number(row.diffCount)}
                            </td>

                            <td class="px-3 py-2 text-center border-r border-slate-200">
                                ${row.isSpecialBuilding ? '-' : `<span class="${row.progressRate > 50 ? 'text-red-600 font-bold' : 'text-slate-600'}">${row.progressRate.toFixed(1)}%</span>`}
                            </td>

                            <td class="px-2 py-2 text-center border-r border-slate-200 bg-emerald-50/20">
                                ${row.trendCount?.direction === 'up'
                                ? '<i class="fa-solid fa-arrow-trend-up text-red-500" title="ìƒìŠ¹ì„¸ (>0.5ê±´/ë…„)"></i>'
                                : (row.trendCount?.direction === 'down'
                                    ? '<i class="fa-solid fa-arrow-trend-down text-blue-500" title="í•˜ë½ì„¸ (<-0.5ê±´/ë…„)"></i>'
                                    : '<i class="fa-solid fa-minus text-slate-300" title="ë³´í•©"></i>')}
                            </td>

                            <!-- Unit Price -->
                            <td class="px-2 py-2 text-right text-slate-600 border-r border-slate-100 bg-slate-50/30 text-xs ${isManualMode ? 'relative group' : ''}">
                                <div class="flex items-center justify-end">
                                    ${isManualMode && !row.isSpecialBuilding ? `
                                        <span class="editable-cell cursor-text hover:bg-blue-100 px-2 py-1 rounded transition-colors inline-block min-w-[70px] font-medium ${hasManualUnitAmount ? 'text-amber-900 bg-amber-100/50' : 'text-blue-700'}"
                                              contenteditable="true"
                                              data-building="${row.building}"
                                              data-field="avgUnitAmount"
                                              data-value="${avgUnitAmtVal}"
                                              spellcheck="false">${FormatUtils.currency(avgUnitAmtVal)}</span>
                                        ${hasManualUnitAmount ? '<i class="fa-solid fa-user-pen text-xs text-amber-600 absolute left-0 top-1/2 -translate-y-1/2 pointer-events-none opacity-50"></i>' : ''}
                                    ` : (row.isSpecialBuilding ? '<span class="text-slate-300">-</span>' : FormatUtils.currency(row.avgUnitAmount))}
                                    ${tooltipUnit}
                                </div>
                                ${manualTooltipAmt}
                            </td>

                            <td class="px-2 py-2 text-right font-bold text-blue-700 border-r border-slate-100 bg-blue-50/10 text-xs">
                                ${row.isSpecialBuilding ? '-' : FormatUtils.currency(row.currentUnitAmount)}
                            </td>

                            <!-- Amounts -->
                            <td class="px-2 py-2 text-right text-slate-600 border-r border-slate-100 text-xs">
                                <div class="flex items-center justify-end">
                                    ${FormatUtils.currency(row.avgAmount)}
                                    ${tooltipAmt}
                                </div>
                            </td>
                            <td class="px-2 py-2 text-right font-bold text-blue-700 bg-blue-50/20 border-r border-slate-100 text-xs">
                                ${FormatUtils.currency(row.currentAmount)}
                            </td>
                            <td class="px-2 py-2 text-right ${diffAmtClass} text-xs border-r border-slate-200">
                                ${FormatUtils.currency(row.diffAmount)}
                            </td>
                            <td class="px-2 py-2 text-center bg-blue-50/20 text-xs">
                                ${row.trend?.direction === 'up'
                                ? '<i class="fa-solid fa-arrow-trend-up text-red-500" title="ìƒìŠ¹ì„¸ (>10ë§Œ/ë…„)"></i>'
                                : (row.trend?.direction === 'down'
                                    ? '<i class="fa-solid fa-arrow-trend-down text-blue-500" title="í•˜ë½ì„¸ (<-10ë§Œ/ë…„)"></i>'
                                    : '<i class="fa-solid fa-minus text-slate-300" title="ë³´í•©"></i>')}
                            </td>
                        </tr>
                    `;
                    }).join('');

                    // [FIX] Add click listeners for building detail modal in Fullscreen Table
                    // Since this table is rendered dynamically, we need to attach listeners to the new elements.
                    const triggers = this.els.fullscreenTableBody.querySelectorAll('.building-data-trigger');
                    triggers.forEach(trigger => {
                        trigger.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (window.app && typeof window.app.handleBuildingClick === 'function') {
                                console.log('ğŸ—ï¸ [Fullscreen] Building clicked:', trigger.dataset.building);
                                window.app.handleBuildingClick(trigger);
                            }
                        });
                    });

                }

                searchFullscreenTable(searchTerm) {
                    const { allData } = this.fullscreenTableState;

                    if (!searchTerm || searchTerm.trim() === '') {
                        this.fullscreenTableState.filteredData = allData;
                    } else {
                        const term = searchTerm.toLowerCase();
                        this.fullscreenTableState.filteredData = allData.filter(row => {
                            return row.building.toLowerCase().includes(term);
                        });
                    }

                    this.renderFullscreenTable();
                }

                // [New Feature] Export All Data to Excel
                exportToExcel(activeData, client, workTypes, year, manualData, manualPredictions, rawData = null) {
                    if (!activeData || !activeData.results) return;

                    const wb = XLSX.utils.book_new();

                    // 1. Summary Sheet
                    const summaryData = [
                        ["ë³´ê³ ì„œ ëª…", `${client} ${workTypes.join(', ')} ë¶„ì„ ë³´ê³ ì„œ`],
                        ["ê¸°ì¤€ ë…„ë„", `${year}ë…„`],
                        ["ìƒì„± ì¼ì‹œ", new Date().toLocaleString()],
                        [""],
                        ["[ì¢…í•© ìš”ì•½]"],
                        ["êµ¬ë¶„", "ì´ ìš´ì˜ì„± ì‘ì—…ë¹„", "ì´ ê±´ìˆ˜", "ì´ ì„¸ëŒ€ìˆ˜", "ì„¸ëŒ€ë‹¹ í‰ê·  ë‹¨ê°€"],
                        ["í•©ê³„", activeData.totalSummary.totalAvgAmount, activeData.totalSummary.totalAvgCount, activeData.totalSummary.totalUnitsSum,
                            Math.round(activeData.totalSummary.totalAvgAmount / activeData.totalSummary.totalAvgCount || 0)]
                    ];
                    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, wsSummary, "ì¢…í•©ìš”ì•½");

                    // 2. Detailed Analysis Sheet
                    const detailOps = [
                        ["ê±´ë¬¼ë™", "ì „ì²´ ì„¸ëŒ€ìˆ˜", "ì œì™¸ ì„¸ëŒ€ìˆ˜", "ìœ íš¨ ì„¸ëŒ€ìˆ˜", "ì œì™¸ ì‚¬ìœ ",
                            "í‰ê·  ì˜ˆì¸¡ê¸ˆì•¡", "í‰ê·  ì˜ˆì¸¡ê±´ìˆ˜", "ì„¸ëŒ€ë‹¹ ì˜ˆì¸¡ë‹¨ê°€",
                            `${year}ë…„ ì‹¤ì ê¸ˆì•¡`, `${year}ë…„ ì‹¤ì ê±´ìˆ˜`, "ê¸ˆì•¡ ì°¨ì´", "ê±´ìˆ˜ ì°¨ì´", "ì§„ì²™ë¥ (%)"]
                    ];

                    activeData.results.forEach(row => {
                        detailOps.push([
                            row.building,
                            row.totalUnits,
                            row.excludedCount,
                            row.effectiveTotalUnits,
                            row.exclusionReason || "-",
                            row.avgAmount,
                            row.avgCount,
                            row.avgUnitAmount,
                            row.currentAmount,
                            row.currentCount,
                            row.diffAmount,
                            row.diffCount,
                            row.progressRate.toFixed(1)
                        ]);
                    });
                    const wsDetail = XLSX.utils.aoa_to_sheet(detailOps);
                    XLSX.utils.book_append_sheet(wb, wsDetail, "ìƒì„¸ë¶„ì„");

                    // 3. Comparison Sheet (if manual data exists)
                    if (manualData && manualData.results) {
                        const compOps = [
                            ["[ìë™ vs ìˆ˜ë™ ë¹„êµ ë¶„ì„]"],
                            ["ê±´ë¬¼ë™", "ìë™ ì˜ˆì¸¡ê¸ˆì•¡", "ìˆ˜ë™ ì˜ˆì¸¡ê¸ˆì•¡", "ê¸ˆì•¡ ì°¨ì´", "ìë™ ì˜ˆì¸¡ê±´ìˆ˜", "ìˆ˜ë™ ì˜ˆì¸¡ê±´ìˆ˜", "ê±´ìˆ˜ ì°¨ì´"]
                        ];

                        activeData.results.forEach((autoRow, idx) => {
                            const manualRow = manualData.results[idx];
                            if (manualRow) {
                                compOps.push([
                                    autoRow.building,
                                    autoRow.avgAmount,
                                    manualRow.avgAmount,
                                    manualRow.avgAmount - autoRow.avgAmount,
                                    autoRow.avgCount,
                                    manualRow.avgCount,
                                    manualRow.avgCount - autoRow.avgCount
                                ]);
                            }
                        });
                        const wsComp = XLSX.utils.aoa_to_sheet(compOps);
                        XLSX.utils.book_append_sheet(wb, wsComp, "ë¹„êµë¶„ì„");
                    }

                    // Insights Sheet
                    const insights = document.getElementById('insightsContent')?.innerText.split('\n').filter(l => l.trim().length > 0).map(l => [l]);
                    if (insights && insights.length > 0) {
                        const wsInsight = XLSX.utils.aoa_to_sheet([["[í•µì‹¬ ì¸ì‚¬ì´íŠ¸]"], ...insights]);
                        XLSX.utils.book_append_sheet(wb, wsInsight, "ì¸ì‚¬ì´íŠ¸");
                    }

                    // Raw Data Sheet (if available)
                    if (rawData && Array.isArray(rawData) && rawData.length > 0) {
                        try {
                            const rawDataOps = [];

                            // Get headers from first row
                            const headers = Object.keys(rawData[0]);
                            rawDataOps.push(headers);

                            // Add all rows
                            rawData.forEach(row => {
                                const rowData = headers.map(header => row[header] || '');
                                rawDataOps.push(rowData);
                            });

                            const wsRawData = XLSX.utils.aoa_to_sheet(rawDataOps);
                            XLSX.utils.book_append_sheet(wb, wsRawData, "ì›ë³¸ë°ì´í„°");

                            console.log('âœ… Raw data sheet added:', rawData.length, 'rows');
                        } catch (error) {
                            console.error('âš ï¸ Failed to add raw data sheet:', error);
                        }
                    }

                    const safeName = `${client}_${workTypes.length > 1 ? 'ë‹¤ì¤‘ìœ í˜•' : workTypes[0]}_ì¢…í•©ë¶„ì„`.replace(/[\/\?%*:|"<>]/g, '_');
                    XLSX.writeFile(wb, `${safeName}_${new Date().toISOString().slice(0, 10)}.xlsx`);
                }

                renderComparisonAnalysis(autoData, manualData, manualPredictions) {
                    // Safe data validation (warnings only, continue execution)
                    if (!autoData || !autoData.results || !Array.isArray(autoData.results)) {
                        console.error('âš ï¸ Invalid autoData:', autoData);
                    }
                    if (!manualData || !manualData.results || !Array.isArray(manualData.results)) {
                        console.error('âš ï¸ Invalid manualData:', manualData);
                    }

                    // [Fix] ì—°ë„ ìˆ˜ ë™ì  ë°˜ì˜ - ëª¨ë‹¬ ë‚´ ë¼ë²¨ ì—…ë°ì´íŠ¸
                    const yearSpan = autoData.yearsOfInterest ? autoData.yearsOfInterest.length : 3;
                    const modalYearSpanLabel = document.getElementById('modalYearSpanLabel');
                    if (modalYearSpanLabel) modalYearSpanLabel.textContent = `${yearSpan}ê°œë…„ í‰ê· `;

                    // Calculate auto totals
                    const autoTotalAmount = autoData.results.reduce((sum, item) => sum + item.avgAmount, 0);
                    const autoTotalCount = autoData.results.reduce((sum, item) => sum + item.avgCount, 0);
                    const autoAvgUnitAmount = autoTotalCount > 0 ? Math.round(autoTotalAmount / autoTotalCount) : 0;

                    // Calculate manual totals
                    let manualTotalAmount = 0;
                    let manualTotalCount = 0;

                    manualData.results.forEach(row => {
                        manualTotalAmount += row.avgAmount;
                        manualTotalCount += row.avgCount;
                    });
                    const manualAvgUnitAmount = manualTotalCount > 0 ? Math.round(manualTotalAmount / manualTotalCount) : 0;

                    // Calculate differences
                    const amountDiff = manualTotalAmount - autoTotalAmount;
                    const countDiff = manualTotalCount - autoTotalCount;
                    const unitAmountDiff = manualAvgUnitAmount - autoAvgUnitAmount;

                    const amountDiffPercent = autoTotalAmount > 0 ? ((amountDiff / autoTotalAmount) * 100).toFixed(1) : 0;
                    const countDiffPercent = autoTotalCount > 0 ? ((countDiff / autoTotalCount) * 100).toFixed(1) : 0;
                    const unitAmountDiffPercent = autoAvgUnitAmount > 0 ? ((unitAmountDiff / autoAvgUnitAmount) * 100).toFixed(1) : 0;

                    // Update summary cards
                    document.getElementById('totalAmountDiff').textContent = FormatUtils.currency(Math.abs(amountDiff)) + ' ì›';
                    document.getElementById('totalAmountDiffPercent').textContent = `${amountDiff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(amountDiffPercent)}% (${amountDiff >= 0 ? 'ì¦ê°€' : 'ê°ì†Œ'})`;

                    document.getElementById('totalCountDiff').textContent = FormatUtils.number(Math.abs(countDiff)) + ' ì„¸ëŒ€';
                    document.getElementById('totalCountDiffPercent').textContent = `${countDiff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(countDiffPercent)}% (${countDiff >= 0 ? 'ì¦ê°€' : 'ê°ì†Œ'})`;

                    document.getElementById('avgUnitAmountDiff').textContent = FormatUtils.currency(Math.abs(unitAmountDiff)) + ' ì›';
                    document.getElementById('avgUnitAmountDiffPercent').textContent = `${unitAmountDiff >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(unitAmountDiffPercent)}% (${unitAmountDiff >= 0 ? 'ì¦ê°€' : 'ê°ì†Œ'})`;

                    // Update mode stats
                    document.getElementById('autoTotalAmount').textContent = FormatUtils.currency(autoTotalAmount) + ' ì›';
                    document.getElementById('autoTotalCount').textContent = FormatUtils.number(autoTotalCount) + ' ì„¸ëŒ€';
                    document.getElementById('autoAvgUnitAmount').textContent = FormatUtils.currency(autoAvgUnitAmount) + ' ì›';

                    document.getElementById('manualTotalAmount').textContent = FormatUtils.currency(manualTotalAmount) + ' ì›';
                    document.getElementById('manualTotalCount').textContent = FormatUtils.number(manualTotalCount) + ' ì„¸ëŒ€';
                    document.getElementById('manualAvgUnitAmount').textContent = FormatUtils.currency(manualAvgUnitAmount) + ' ì›';

                    // Building-level differences
                    const buildingDiffs = [];
                    autoData.results.forEach((autoRow, idx) => {
                        const manualRow = manualData.results[idx];

                        // Safe check for manualRow
                        if (!manualRow) {
                            console.warn(`âš ï¸ Manual data missing for index ${idx}, building: ${autoRow.building}`);
                            return; // Skip this building, continue with others
                        }

                        const amtDiff = manualRow.avgAmount - autoRow.avgAmount;
                        const cntDiff = manualRow.avgCount - autoRow.avgCount;
                        const unitAmtDiff = manualRow.avgUnitAmount - autoRow.avgUnitAmount;
                        const changeRate = autoRow.avgAmount > 0 ? ((amtDiff / autoRow.avgAmount) * 100) : 0;

                        buildingDiffs.push({
                            building: autoRow.building,
                            amountDiff: amtDiff,
                            countDiff: cntDiff,
                            unitAmountDiff: unitAmtDiff,
                            changeRate: changeRate,
                            absChangeRate: Math.abs(changeRate)
                        });
                    });

                    // Sort by absolute change rate and get top 10
                    buildingDiffs.sort((a, b) => b.absChangeRate - a.absChangeRate);
                    const top10 = buildingDiffs.slice(0, 10);

                    // Render building differences table
                    const tbody = document.getElementById('buildingDiffTableBody');
                    tbody.innerHTML = '';
                    top10.forEach((diff, index) => {
                        const tr = document.createElement('tr');
                        tr.className = 'hover:bg-slate-50';

                        const changeRateClass = diff.amountDiff > 0 ? 'text-red-600' : (diff.amountDiff < 0 ? 'text-blue-600' : 'text-slate-400');
                        const changeIcon = diff.amountDiff > 0 ? 'â–²' : (diff.amountDiff < 0 ? 'â–¼' : 'âˆ’');

                        tr.innerHTML = `
                        <td class="px-4 py-3 text-slate-600">${index + 1}</td>
                        <td class="px-4 py-3 font-medium text-slate-800">${diff.building}</td>
                        <td class="px-4 py-3 text-right ${changeRateClass} font-medium">${FormatUtils.currency(Math.abs(diff.amountDiff))} ì›</td>
                        <td class="px-4 py-3 text-right ${diff.countDiff >= 0 ? 'text-red-600' : 'text-blue-600'}">${diff.countDiff > 0 ? '+' : ''}${diff.countDiff} ì„¸ëŒ€</td>
                        <td class="px-4 py-3 text-right ${diff.unitAmountDiff >= 0 ? 'text-red-600' : 'text-blue-600'}">${FormatUtils.currency(Math.abs(diff.unitAmountDiff))} ì›</td>
                        <td class="px-4 py-3 text-center ${changeRateClass} font-bold">${changeIcon} ${Math.abs(diff.changeRate).toFixed(1)}%</td>
                    `;
                        tbody.appendChild(tr);
                    });

                    // Generate insights
                    const insightsContent = document.getElementById('insightsContent');
                    insightsContent.innerHTML = '';

                    const insights = [];

                    // Insight 1: Overall trend
                    if (Math.abs(amountDiffPercent) < 5) {
                        insights.push({
                            icon: 'fa-check-circle',
                            color: 'text-green-600',
                            text: `ìˆ˜ë™ ì˜ˆì¸¡ì´ ìë™ ê³„ì‚° ëŒ€ë¹„ <strong>${Math.abs(amountDiffPercent)}%</strong> ì°¨ì´ë¡œ ë§¤ìš° ìœ ì‚¬í•©ë‹ˆë‹¤. ìë™ ê³„ì‚° ëª¨ë¸ì´ ì˜ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
                        });
                    } else if (amountDiff > 0) {
                        insights.push({
                            icon: 'fa-arrow-trend-up',
                            color: 'text-red-600',
                            text: `ìˆ˜ë™ ì˜ˆì¸¡ì´ ìë™ ëŒ€ë¹„ <strong>${amountDiffPercent}% (${FormatUtils.currency(Math.abs(amountDiff))}ì›)</strong> ë†’ìŠµë‹ˆë‹¤. ë” ë‚™ê´€ì ì¸ ì˜ˆì¸¡ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
                        });
                    } else {
                        insights.push({
                            icon: 'fa-arrow-trend-down',
                            color: 'text-blue-600',
                            text: `ìˆ˜ë™ ì˜ˆì¸¡ì´ ìë™ ëŒ€ë¹„ <strong>${Math.abs(amountDiffPercent)}% (${FormatUtils.currency(Math.abs(amountDiff))}ì›)</strong> ë‚®ìŠµë‹ˆë‹¤. ë” ë³´ìˆ˜ì ì¸ ì˜ˆì¸¡ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.`
                        });
                    }

                    // Insight 2: Manual inputs count
                    const manualInputCount = Object.keys(manualPredictions).length;
                    const totalBuildings = autoData.results.length;
                    const manualInputRate = ((manualInputCount / totalBuildings) * 100).toFixed(1);

                    if (manualInputCount > 0) {
                        insights.push({
                            icon: 'fa-pen-to-square',
                            color: 'text-amber-600',
                            text: `ì´ <strong>${totalBuildings}ê°œ ê±´ë¬¼ë™</strong> ì¤‘ <strong>${manualInputCount}ê°œ (${manualInputRate}%)</strong>ì— ìˆ˜ë™ ì¡°ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`
                        });
                    } else {
                        insights.push({
                            icon: 'fa-info-circle',
                            color: 'text-slate-600',
                            text: `ìˆ˜ë™ ì…ë ¥ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ê°’ì´ ìë™ ê³„ì‚°ê°’ê³¼ ë™ì¼í•©ë‹ˆë‹¤.`
                        });
                    }

                    // Insight 3: Top difference buildings
                    if (top10.length > 0 && top10[0].absChangeRate > 10) {
                        const topBuilding = top10[0];
                        insights.push({
                            icon: 'fa-building',
                            color: 'text-purple-600',
                            text: `<strong>${topBuilding.building}</strong>ì˜ ë³€í™”ìœ¨ì´ <strong>${topBuilding.changeRate.toFixed(1)}%</strong>ë¡œ ê°€ì¥ í½ë‹ˆë‹¤. íŠ¹ë³„í•œ ê³ ë ¤ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`
                        });
                    }

                    // Insight 4: Recommendation
                    if (manualInputCount > 0) {
                        insights.push({
                            icon: 'fa-lightbulb',
                            color: 'text-yellow-600',
                            text: `ìˆ˜ë™ ì¡°ì • ê·¼ê±°ë¥¼ ë¬¸ì„œí™”í•˜ê³ , ì‹¤ì  ë°œìƒ í›„ ì˜ˆì¸¡ ì •í™•ë„ë¥¼ ê²€ì¦í•˜ì—¬ í–¥í›„ ìë™ ëª¨ë¸ ê°œì„ ì— í™œìš©í•˜ì„¸ìš”.`
                        });
                    }

                    // Render insights
                    insights.forEach(insight => {
                        const div = document.createElement('div');
                        div.className = 'flex items-start gap-3 bg-white p-3 rounded-lg border border-slate-200';
                        div.innerHTML = `
                        <i class="fa-solid ${insight.icon} ${insight.color} mt-0.5"></i>
                        <p class="flex-1 text-slate-700">${insight.text}</p>
                    `;
                        insightsContent.appendChild(div);
                    });
                }


            }

            // --- [Layer 4] App (Dependency Injection) ---
            class App {

                // [Integrity] Smart Tooltip Positioning (Fixes Clipping & Occlusion)
                initSmartTooltips() {
                    // [Note] Building Raw Data Click Listeners are defined via event delegation
                    // in initAdvancedSettingsListeners using autoTableBody and manualTableBody

                    // [Global] Click Listener for Tooltips (Toggle Mode)
                    document.body.addEventListener('click', (e) => {
                        // 1. Check Global Off State
                        if (this.tooltipsEnabled === false ||
                            (window.app && window.app.tooltipsEnabled === false) ||
                            document.body.classList.contains('tooltips-hidden')) {
                            return;
                        }

                        // 2. Check Input/Select clicks inside tooltip (Prevent closing)
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
                            return;
                        }

                        // 3. Icon Click Handling
                        const icon = e.target.closest('.fa-circle-question, .fa-calculator, .fa-user-pen, .cursor-help');

                        // Case A: Clicked on an Icon
                        if (icon) {
                            e.stopPropagation(); // Stop bubbling to prevent unwanted side effects

                            const container = icon.closest('.tooltip-container');
                            if (!container) return;

                            const content = container.querySelector('.tooltip-content');
                            if (!content) return;

                            // Check if THIS tooltip is currently open
                            const isCurrentlyOpen = content.style.display === 'block';

                            // First, close ALL tooltips (One at a time policy)
                            document.querySelectorAll('.tooltip-content').forEach(el => {
                                el.style.display = 'none';
                                el.style.opacity = '0';
                                el.style.visibility = 'hidden';
                            });

                            // If it was closed, open it now (Toggle)
                            if (!isCurrentlyOpen) {
                                content.style.position = 'fixed';
                                content.style.display = 'block';
                                content.style.zIndex = '9999';

                                // Positioning Logic (Relative to Icon)
                                const iconRect = icon.getBoundingClientRect();
                                const contentRect = content.getBoundingClientRect();

                                // Default: Bottom Center of Icon
                                let top = iconRect.bottom + 8;
                                let left = iconRect.left + (iconRect.width / 2) - (contentRect.width / 2);

                                // Boundary Checks
                                const viewportWidth = window.innerWidth;
                                const viewportHeight = window.innerHeight;

                                // Bottom Overflow -> Flip Up
                                if (top + contentRect.height > viewportHeight - 10) {
                                    top = iconRect.top - contentRect.height - 8;
                                }

                                // Right Overflow -> Shift Left
                                if (left + contentRect.width > viewportWidth - 10) {
                                    left = viewportWidth - contentRect.width - 10;
                                }

                                // Left Overflow -> Shift Right
                                if (left < 10) left = 10;

                                content.style.top = `${top}px`;
                                content.style.left = `${left}px`;

                                // Fade In
                                void content.offsetWidth;
                                content.style.opacity = '1';
                                content.style.visibility = 'visible';
                            }

                            return;
                        }

                        // Case B: Clicked inside Tooltip Content (Do nothing, keep open)
                        if (e.target.closest('.tooltip-content')) {
                            return;
                        }

                        // Case C: Clicked Outside (Close All)
                        document.querySelectorAll('.tooltip-content').forEach(el => {
                            el.style.display = 'none';
                            el.style.opacity = '0';
                            el.style.visibility = 'hidden';
                        });
                    });

                }

                handleBuildingClick(trigger) {
                    try {
                        if (!this.rawData) {
                            console.warn('âš ï¸ [App] No raw data available for building click');
                            return;
                        }

                        const buildingName = trigger.dataset.building;
                        console.log('ğŸ—ï¸ [App] Handling building click for:', buildingName);

                        if (!buildingName) {
                            console.error('âš ï¸ [App] Building name is missing in dataset');
                            return;
                        }

                        // 1. Filter Data (Robust Filtering)
                        const filtered = this.rawData.filter(row => {
                            try {
                                if (FormatUtils.cleanString(row['ê±´ë¬¼ë™']) !== FormatUtils.cleanString(buildingName)) return false;

                                if (this.currentClient && FormatUtils.cleanString(row['ë°œì£¼ì²˜']) !== this.currentClient) return false;

                                if (this.currentWorkTypes && this.currentWorkTypes.length > 0) {
                                    const wType = FormatUtils.cleanString(row['ì‘ì—…ìœ í˜•']);
                                    if (!this.currentWorkTypes.includes(wType)) return false;
                                }

                                // [Fix] Filter by Analysis Period (Logical Consistency)
                                const yearStr = row['íšŒê³„ì—°ë„'] || row['ë…„ë„'] || row['íšŒê³„ë…„ë„'];
                                const rowYear = FormatUtils.parseYear(yearStr);
                                const startYear = this.currentYear - this.currentSpan + 1;

                                if (!rowYear || rowYear < startYear || rowYear > this.currentYear) return false;

                                return true;
                            } catch (e) {
                                console.warn('Row filtering error:', e, row);
                                return false;
                            }
                        });

                        console.log(`ğŸ“Š [App] Filtered ${filtered.length} rows for ${buildingName}`);

                        // 2. Sort by Date (Descending)
                        filtered.sort((a, b) => {
                            const dateA = a['ì‘ì—…ì¼'] || a['ì™„ë£Œì¼'] || '';
                            const dateB = b['ì‘ì—…ì¼'] || b['ì™„ë£Œì¼'] || '';
                            return dateB.localeCompare(dateA); // Descending
                        });

                        // 3. Open Modal
                        const startYear = this.currentYear - this.currentSpan + 1;
                        const rangeText = `${startYear}ë…„ ~ ${this.currentYear}ë…„`;
                        this.ui.openBuildingDetail(buildingName, filtered, rangeText);

                    } catch (err) {
                        console.error('âŒ [App] Error handling building click:', err);
                        alert('ê±´ë¬¼ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                }

                constructor() {
                    this.domainService = new DomainService();
                    this.ui = new UIController();
                    this.rawData = null;
                    this.currentSpan = 3;
                    this.currentYear = 2025;
                    this.analysisMode = 'auto'; // 'auto' or 'manual'
                    this.manualPredictions = {}; // { building: { avgCount, avgAmount } }
                    this.autoCalculatedData = null; // ìë™ ê³„ì‚°ëœ ì›ë³¸ ë°ì´í„° ì €ì¥
                    this.sortState = { key: null, direction: 'asc' }; // [New] Sort State

                    // [PRD/IMP] Advanced Forecasting State
                    this.simulationMode = false;
                    this.globalPriceModifier = 0; // -20% to +20%
                    this.sankeyDataMode = 'auto'; // 'auto' or 'manual'

                    // [Multi-Year Selection] New properties
                    this.allYears = []; // All available years from data
                    this.currentSelectedYears = []; // User-selected years (can be multiple)
                    this.yearAggregationMethod = 'avg'; // 'sum', 'avg', 'wma'

                    this.initEventListeners();
                    this.initAdvancedSettingsListeners(); // [PRD/IMP]
                }

                // [New Feature] Sort Table Data
                handleSort(key) {
                    if (!this.autoCalculatedData) return;

                    // Toggle direction or set default
                    if (this.sortState.key === key) {
                        this.sortState.direction = this.sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortState.key = key;
                        this.sortState.direction = 'asc'; // Default new sort is ascending
                    }

                    // Update UI Icons
                    this.updateSortIcons();

                    // Perform Sort
                    const mult = this.sortState.direction === 'asc' ? 1 : -1;
                    this.autoCalculatedData.results.sort((a, b) => {
                        let valA = a[key];
                        let valB = b[key];

                        if (typeof valA === 'string') return valA.localeCompare(valB) * mult;
                        return (valA - valB) * mult;
                    });

                    // Re-render
                    this.ui.renderDashboard(
                        this.autoCalculatedData,
                        this.analysisMode === 'manual',
                        this.analysisMode === 'manual' ? (building, field, value) => this.updateManualPrediction(building, field, value) : null,
                        this.manualPredictions,
                        this.autoCalculatedData // Pass autoData
                    );
                }

                updateSortIcons() {
                    const headers = document.querySelectorAll('.sort-header');
                    headers.forEach(th => {
                        const icon = th.querySelector('i.fa-sort, i.fa-sort-up, i.fa-sort-down');
                        const key = th.dataset.sortKey;

                        if (icon) {
                            icon.className = 'fa-solid ml-1'; // Reset
                            if (key === this.sortState.key) {
                                icon.classList.add(this.sortState.direction === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
                                icon.classList.add('text-blue-600');
                            } else {
                                icon.classList.add('fa-sort');
                                icon.classList.add('text-slate-300');
                            }
                        }
                    });
                }

                // [Fix] ìˆ˜ë™ ëª¨ë“œ ë°ì´í„° ìƒì„± - ìë™ ê³„ì‚° ë°ì´í„°ì— ìˆ˜ë™ ì˜ˆì¸¡ê°’ ì ìš©
                getManualAnalysisData() {
                    if (!this.autoCalculatedData || !this.autoCalculatedData.results) {
                        return null;
                    }

                    // Deep copy the auto calculated data and apply manual predictions
                    const manualResults = this.autoCalculatedData.results.map(row => {
                        const manualInput = this.manualPredictions[row.building];
                        if (manualInput) {
                            const newAvgCount = manualInput.avgCount !== undefined ? manualInput.avgCount : row.avgCount;
                            const newAvgUnitAmount = manualInput.avgUnitAmount !== undefined ? manualInput.avgUnitAmount : row.avgUnitAmount;
                            const newAvgAmount = newAvgUnitAmount * newAvgCount;

                            return {
                                ...row,
                                avgCount: newAvgCount,
                                avgUnitAmount: newAvgUnitAmount,
                                // Always recalculate derived values for consistency
                                avgAmount: newAvgAmount,
                                diffCount: row.currentCount - newAvgCount,
                                diffAmount: row.currentAmount - newAvgAmount,
                                diffUnitAmount: row.currentUnitAmount - newAvgUnitAmount
                            };
                        }
                        return { ...row };
                    });

                    // [Integrity] ìˆ˜ë™ ì…ë ¥ê°’ ê¸°ë°˜ìœ¼ë¡œ totalSummary ì¬ê³„ì‚°
                    const manualTotalSummary = {
                        totalExecAmount: manualResults.reduce((sum, item) => sum + item.currentAmount, 0),
                        totalAvgAmount: manualResults.reduce((sum, item) => sum + item.avgAmount, 0),
                        totalExecCount: manualResults.reduce((sum, item) => sum + item.currentCount, 0),
                        totalAvgCount: manualResults.reduce((sum, item) => sum + item.avgCount, 0),
                        totalUnitsSum: manualResults.reduce((sum, item) => sum + item.totalUnits, 0)
                    };

                    return {
                        results: manualResults,
                        totalSummary: manualTotalSummary,
                        yearsOfInterest: this.autoCalculatedData.yearsOfInterest
                    };
                }

                // [Feature] í†µê³„ ìœ í˜•ë³„ ì—°ê³„ ë¡œìš°ë°ì´í„° í•„í„°ë§
                getFilteredRawDataForStat(statType, mode) {
                    console.log('ğŸ“Š [getFilteredRawDataForStat]', {
                        statType, mode,
                        rawDataLength: this.rawData?.length,
                        currentClient: this.currentClient,
                        currentWorkTypes: this.currentWorkTypes,
                        currentYear: this.currentYear,
                        currentSpan: this.currentSpan
                    });

                    if (!this.rawData || this.rawData.length === 0) {
                        console.warn('âš ï¸ No raw data available');
                        return [];
                    }

                    // Start with raw data filtered by current settings
                    let filtered = this.rawData.filter(row => {
                        // Filter by client (using 'ë°œì£¼ì²˜' column as in DomainService)
                        if (this.currentClient) {
                            const rowClient = FormatUtils.cleanString(row['ë°œì£¼ì²˜']);
                            if (rowClient !== this.currentClient) {
                                return false;
                            }
                        }

                        // Filter by work types (using 'ì‘ì—…ìœ í˜•' column as in DomainService)
                        if (this.currentWorkTypes && this.currentWorkTypes.length > 0) {
                            const rowWorkType = FormatUtils.cleanString(row['ì‘ì—…ìœ í˜•']);
                            if (!this.currentWorkTypes.includes(rowWorkType)) {
                                return false;
                            }
                        }

                        return true;
                    });

                    console.log('ğŸ“Š After client/workType filter:', filtered.length);

                    // Further filter based on stat type
                    if (statType === 'execAmount' || statType === 'execCount') {
                        // ì‹¤ì  ë°ì´í„°: í˜„ì¬ ë…„ë„ ë°ì´í„°
                        filtered = filtered.filter(row => {
                            const yearStr = row['íšŒê³„ì—°ë„'] || row['ë…„ë„'] || row['íšŒê³„ë…„ë„'];
                            const rowYear = FormatUtils.parseYear(yearStr);
                            return rowYear === this.currentYear;
                        });
                        console.log('ğŸ“Š After year filter (exec):', filtered.length, 'for year', this.currentYear);
                    } else if (statType === 'avgAmount' || statType === 'avgCount') {
                        // ì˜ˆì¸¡ ë°ì´í„°: í‰ê·  ì‚°ì • ê¸°ê°„ ë‚´ ë°ì´í„° (íƒ€ê²Ÿ ì—°ë„ í¬í•¨ - analyze í•¨ìˆ˜ì˜ yearsOfInterestì™€ ì¼ì¹˜)
                        const startYear = this.currentYear - this.currentSpan + 1;
                        filtered = filtered.filter(row => {
                            const yearStr = row['íšŒê³„ì—°ë„'] || row['ë…„ë„'] || row['íšŒê³„ë…„ë„'];
                            const rowYear = FormatUtils.parseYear(yearStr);
                            return rowYear >= startYear && rowYear <= this.currentYear;
                        });
                        console.log('ğŸ“Š After year filter (avg):', filtered.length, 'for years', startYear, 'to', this.currentYear);
                    }

                    console.log('ğŸ“Š [getFilteredRawDataForStat] Final result:', filtered.length, 'rows');

                    // [Integrity] í•„í„°ë§ ê²°ê³¼ê°€ ì—†ì–´ë„ ë¹ˆ ë°°ì—´ ë°˜í™˜ - ì „ì²´ ë°ì´í„° ë°˜í™˜ì€ ë°œì£¼ì²˜ í•„í„°ë§ì„ ë¬´ì‹œí•˜ë¯€ë¡œ ì œê±°
                    // UIì—ì„œ "ë°ì´í„° ì—†ìŒ" ë©”ì‹œì§€ê°€ í‘œì‹œë¨
                    if (filtered.length === 0) {
                        console.warn('âš ï¸ No data after filtering. Returning empty array to preserve filter integrity.');
                    }

                    return filtered;
                }


                initEventListeners() {
                    // [Fix] Ensure Smart Tooltips (and Building Click Listeners) are initialized
                    this.initSmartTooltips();

                    // [New] Data Source Selection Events
                    const dataSourceBtn = this.ui.els.dataSourceBtn;
                    const dataSourceDropdown = this.ui.els.dataSourceDropdown;
                    const localFileOption = this.ui.els.localFileOption;
                    const githubDataOption = this.ui.els.githubDataOption;
                    const dataSourceBtnText = this.ui.els.dataSourceBtnText;

                    if (dataSourceBtn && dataSourceDropdown) {
                        // Toggle dropdown on button click
                        dataSourceBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            dataSourceDropdown.classList.toggle('hidden');
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', (e) => {
                            if (!this.ui.els.dataSourceWrapper?.contains(e.target)) {
                                dataSourceDropdown.classList.add('hidden');
                            }
                        });

                        // Option 1: Local file selection
                        if (localFileOption) {
                            localFileOption.addEventListener('click', () => {
                                dataSourceDropdown.classList.add('hidden');
                                this.ui.els.fileInput.click();
                            });
                        }

                        // Option 2: GitHub auto-load
                        if (githubDataOption) {
                            githubDataOption.addEventListener('click', async () => {
                                dataSourceDropdown.classList.add('hidden');
                                await this.loadGitHubData();
                            });
                        }
                    }

                    this.ui.els.fileInput.addEventListener('change', async (e) => this.handleFileUpload(e));

                    ['clientSelect', 'yearRange'].forEach(id => {
                        const el = this.ui.els[id];
                        if (el) el.addEventListener(id === 'yearRange' ? 'input' : 'change', (e) => {
                            if (id === 'clientSelect') {
                                this.currentClient = e.target.value;

                                // [Fix] ë°œì£¼ì²˜ ë³€ê²½ ì‹œ í•´ë‹¹ ë°œì£¼ì²˜ì— ë§ëŠ” ì‘ì—… ìœ í˜•ë§Œ í•„í„°ë§
                                const filteredWorkTypes = this.domainService.extractWorkTypes(this.rawData, this.currentClient);
                                this.allWorkTypes = filteredWorkTypes;

                                // í˜„ì¬ ì„ íƒëœ ì‘ì—… ìœ í˜• ì¤‘ í•´ë‹¹ ë°œì£¼ì²˜ì— ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ ìœ ì§€
                                const validWorkTypes = this.currentWorkTypes.filter(wt => filteredWorkTypes.includes(wt));

                                // ìœ íš¨í•œ ì‘ì—… ìœ í˜•ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
                                if (validWorkTypes.length === 0 && filteredWorkTypes.length > 0) {
                                    // ê¸°ë³¸ ì„ íƒ: 'ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬' ë˜ëŠ” 'ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬' ìš°ì„ 
                                    if (filteredWorkTypes.includes('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) {
                                        validWorkTypes.push('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                                    }
                                    if (filteredWorkTypes.includes('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) {
                                        validWorkTypes.push('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                                    }
                                    // ì—¬ì „íˆ ë¹„ì–´ìˆìœ¼ë©´ ì²« ë²ˆì§¸ í•­ëª© ì„ íƒ
                                    if (validWorkTypes.length === 0) {
                                        validWorkTypes.push(filteredWorkTypes[0]);
                                    }
                                }

                                this.currentWorkTypes = validWorkTypes;

                                // UI ì—…ë°ì´íŠ¸ - ì‘ì—… ìœ í˜• ë“œë¡­ë‹¤ìš´ ì¬ë Œë”ë§
                                this.ui.populateMultiSelect({
                                    wrapper: this.ui.els.workTypeWrapper,
                                    btn: this.ui.els.workTypeBtn,
                                    btnText: this.ui.els.workTypeBtnText,
                                    dropdown: this.ui.els.workTypeDropdown
                                }, filteredWorkTypes, this.currentWorkTypes);

                                console.log('ğŸ“ [ë°œì£¼ì²˜ ì—°ë™] ë°œì£¼ì²˜ ë³€ê²½:', this.currentClient, '/ í•„í„°ë§ëœ ì‘ì—…ìœ í˜•:', filteredWorkTypes, '/ ì„ íƒëœ ì‘ì—…ìœ í˜•:', this.currentWorkTypes);
                            }
                            if (id === 'yearRange') this.currentSpan = parseInt(e.target.value);
                            this.runAnalysis();
                        });
                    });

                    // [Multi-Year Selection] Year Select Button Click
                    this.ui.els.yearSelectBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const dropdown = this.ui.els.yearSelectDropdown;
                        const isOpening = dropdown.classList.contains('hidden');

                        if (isOpening && this.allYears && this.allYears.length > 0) {
                            this.ui.populateYearMultiSelect(this.allYears, this.currentSelectedYears);
                        }
                        dropdown.classList.toggle('hidden');
                    });

                    // [Multi-Year Selection] Click outside to close dropdown
                    document.addEventListener('click', (e) => {
                        if (!this.ui.els.yearSelectWrapper.contains(e.target)) {
                            this.ui.els.yearSelectDropdown.classList.add('hidden');
                        }
                    });

                    // [Multi-Year Selection] Selection change
                    this.ui.els.yearSelectDropdown.addEventListener('change', () => {
                        const selectedYears = this.ui.getSelectedYears();
                        this.currentSelectedYears = selectedYears;

                        // If single year selected, use it as currentYear for backwards compatibility
                        if (selectedYears.length === 1) {
                            this.currentYear = selectedYears[0];
                        } else if (selectedYears.length > 0) {
                            // Use most recent year as reference
                            this.currentYear = Math.max(...selectedYears);
                        }

                        console.log('ğŸ“… [Multi-Year] ì„ íƒëœ ì—°ë„:', this.currentSelectedYears, '/ ê¸°ì¤€ì—°ë„:', this.currentYear);
                        this.runAnalysis();
                    });

                    // [Multi-Year Selection] Aggregation method change
                    this.ui.els.yearAggregationMethod.addEventListener('change', (e) => {
                        this.yearAggregationMethod = e.target.value;
                        console.log('ğŸ“Š [Multi-Year] ì§‘ê³„ ë°©ì‹ ë³€ê²½:', this.yearAggregationMethod);
                        this.runAnalysis();
                    });



                    // [Note] Stat Card Click Listeners are defined in initAdvancedSettingsListeners
                    // to ensure proper data validation before opening the modal

                    // Toggle Dropdown with Auto-Sorting
                    this.ui.els.workTypeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // ... existing logic ...
                        const dropdown = this.ui.els.workTypeDropdown;
                        const isOpening = dropdown.classList.contains('hidden');

                        if (isOpening && this.allWorkTypes && this.allWorkTypes.length > 0) {
                            this.ui.populateMultiSelect({
                                wrapper: this.ui.els.workTypeWrapper,
                                btn: this.ui.els.workTypeBtn,
                                btnText: this.ui.els.workTypeBtnText,
                                dropdown: this.ui.els.workTypeDropdown
                            }, this.allWorkTypes, this.currentWorkTypes);
                        }
                        dropdown.classList.toggle('hidden');

                        // [New] ë“œë¡­ë‹¤ìš´ ì—´ë¦´ ë•Œ ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ë° ì´ˆê¸°í™”
                        if (isOpening) {
                            const searchInput = dropdown.querySelector('#workTypeSearch');
                            if (searchInput) {
                                searchInput.value = '';
                                // ëª¨ë“  í•­ëª© ë‹¤ì‹œ í‘œì‹œ
                                const items = dropdown.querySelectorAll('.work-type-item');
                                items.forEach(item => item.style.display = '');
                                const noResults = dropdown.querySelector('.no-results');
                                if (noResults) noResults.remove();
                                // í¬ì»¤ìŠ¤ ì„¤ì •
                                setTimeout(() => searchInput.focus(), 50);
                            }
                        }
                    });

                    document.addEventListener('click', (e) => {
                        if (!this.ui.els.workTypeWrapper.contains(e.target)) {
                            this.ui.els.workTypeDropdown.classList.add('hidden');
                        }
                    });

                    this.ui.els.workTypeDropdown.addEventListener('change', () => {
                        const selected = this.ui.updateMultiSelectLabel({
                            btn: this.ui.els.workTypeBtn,
                            btnText: this.ui.els.workTypeBtnText,
                            dropdown: this.ui.els.workTypeDropdown
                        });
                        this.currentWorkTypes = selected;
                        this.runAnalysis();
                    });

                    this.ui.els.exportBtn.addEventListener('click', () => {
                        if (this.lastAnalysisData) {
                            this.ui.exportToExcel(
                                this.lastAnalysisData,
                                this.currentClient,
                                this.currentWorkTypes,
                                this.currentYear,
                                null,
                                this.manualPredictions,
                                this.rawData
                            );
                        }
                    });

                    this.ui.els.htmlDnBtn.addEventListener('click', () => {
                        this.downloadSnapshot();
                    });

                    this.ui.els.exportBtnManual.addEventListener('click', () => {
                        if (this.lastAnalysisData) {
                            this.ui.exportToExcel(
                                this.lastAnalysisData,
                                this.currentClient,
                                this.currentWorkTypes,
                                this.currentYear,
                                null,
                                this.manualPredictions,
                                this.rawData
                            );
                        }
                    });

                    this.ui.els.htmlDnBtnManual.addEventListener('click', () => {
                        this.downloadSnapshot();
                    });

                    this.ui.els.autoModeBtn.addEventListener('click', () => {
                        this.setAnalysisMode('auto');
                    });

                    this.ui.els.manualModeBtn.addEventListener('click', () => {
                        this.setAnalysisMode('manual');
                    });

                    this.ui.els.applyAutoValuesBtn.addEventListener('click', () => {
                        this.applyAutoValues();
                    });

                    this.ui.els.resetManualBtn.addEventListener('click', () => {
                        if (confirm('ìˆ˜ë™ìœ¼ë¡œ ì…ë ¥í•œ ëª¨ë“  ê°’ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nìë™ ê³„ì‚°ê°’ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.')) {
                            this.manualPredictions = {};
                            this.runAnalysis();
                        }
                    });

                    this.ui.els.compareAnalysisBtn.addEventListener('click', () => {
                        this.openComparisonModal();
                    });

                    this.ui.els.closeModalBtn.addEventListener('click', () => {
                        this.ui.closeComparisonModal();
                    });

                    this.ui.els.closeModalBtn2.addEventListener('click', () => {
                        this.ui.closeComparisonModal();
                    });

                    // [User Request] Disable Close on Overlay Click
                    // this.ui.els.modalOverlay.addEventListener('click', () => {
                    //     this.ui.closeComparisonModal();
                    // });

                    // Excel Export Buttons
                    const exportComparisonBtn = document.getElementById('exportComparisonBtn');
                    if (exportComparisonBtn) {
                        exportComparisonBtn.addEventListener('click', () => {
                            this.exportComparisonAnalysis();
                        });
                    }



                    const exportComparisonModalBtn = document.getElementById('exportComparisonModalBtn');
                    if (exportComparisonModalBtn) {
                        exportComparisonModalBtn.addEventListener('click', () => {
                            this.exportComparisonAnalysis();
                        });
                    }

                    const exportAllBtn = document.getElementById('exportAllBtn');
                    if (exportAllBtn) {
                        exportAllBtn.addEventListener('click', () => {
                            if (!this.autoCalculatedData) {
                                alert('ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                                return;
                            }

                            let manualData = null;
                            if (Object.keys(this.manualPredictions).length > 0) {
                                manualData = this.getManualAnalysisData();
                            }
                            this.ui.exportToExcel(this.autoCalculatedData, this.currentClient, this.currentWorkTypes, this.currentYear, manualData, this.manualPredictions, this.rawData);
                        });
                    }

                    // [UI] Floating Tooltip Logic (Global Delegation)
                    // Create floating tooltip container if not exists
                    if (!document.getElementById('floating-tooltip')) {
                        const ft = document.createElement('div');
                        ft.id = 'floating-tooltip';
                        ft.className = 'fixed hidden z-[9999] pointer-events-none transition-opacity duration-200';
                        document.body.appendChild(ft);
                    }

                    const floatingTooltip = document.getElementById('floating-tooltip');
                    let tooltipTarget = null;

                    // [Disabled] Floating Tooltip System - Use App.initSmartTooltips instead

                    // === Raw Data Viewer Event Listeners ===
                    if (this.ui.els.viewRawDataBtn) {
                        this.ui.els.viewRawDataBtn.addEventListener('click', () => {
                            if (this.rawData && this.rawData.length > 0) {
                                this.ui.openRawDataModal(this.rawData);
                            } else {
                                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                            }
                        });
                    }

                    if (this.ui.els.closeRawDataBtn) {
                        this.ui.els.closeRawDataBtn.addEventListener('click', () => {
                            this.ui.closeRawDataModal();
                        });
                    }

                    if (this.ui.els.closeRawDataBtn2) {
                        this.ui.els.closeRawDataBtn2.addEventListener('click', () => {
                            this.ui.closeRawDataModal();
                        });
                    }

                    // [User Request] Disable Close on Overlay Click
                    // if (this.ui.els.rawDataModalOverlay) {
                    //     this.ui.els.rawDataModalOverlay.addEventListener('click', () => {
                    //         this.ui.closeRawDataModal();
                    //     });
                    // }

                    if (this.ui.els.rawDataSearch) {
                        this.ui.els.rawDataSearch.addEventListener('input', (e) => {
                            this.ui.searchRawData(e.target.value);
                        });
                    }

                    if (this.ui.els.rawDataPageSize) {
                        this.ui.els.rawDataPageSize.addEventListener('change', (e) => {
                            this.ui.rawDataState.pageSize = parseInt(e.target.value);
                            this.ui.rawDataState.currentPage = 1;
                            this.ui.renderRawDataTable();
                        });
                    }

                    if (this.ui.els.rawDataPrevPage) {
                        this.ui.els.rawDataPrevPage.addEventListener('click', () => {
                            if (this.ui.rawDataState.currentPage > 1) {
                                this.ui.rawDataState.currentPage--;
                                this.ui.renderRawDataTable();
                            }
                        });
                    }

                    if (this.ui.els.rawDataNextPage) {
                        this.ui.els.rawDataNextPage.addEventListener('click', () => {
                            const totalPages = Math.ceil(this.ui.rawDataState.filteredData.length / this.ui.rawDataState.pageSize);
                            if (this.ui.rawDataState.currentPage < totalPages) {
                                this.ui.rawDataState.currentPage++;
                                this.ui.renderRawDataTable();
                            }
                        });
                    }

                    if (this.ui.els.exportRawDataBtn) {
                        this.ui.els.exportRawDataBtn.addEventListener('click', () => {
                            if (this.ui.rawDataState && this.ui.rawDataState.filteredData) {
                                this.ui.exportRawDataToExcel(this.ui.rawDataState.filteredData);
                            }
                        });
                    }

                    // Sort raw data table
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('#rawDataTableHeader th[data-column]')) {
                            const column = e.target.closest('th').dataset.column;
                            this.ui.sortRawData(column);
                        }
                    });

                    // === Fullscreen Table Event Listeners ===
                    console.log('ğŸ”§ [setupEventListeners] ì „ì²´í™”ë©´ ë²„íŠ¼ ë“±ë¡ í™•ì¸', {
                        fullscreenTableBtn: !!this.ui.els.fullscreenTableBtn,
                        fullscreenTableBtnManual: !!this.ui.els.fullscreenTableBtnManual,
                        fullscreenAutoModeBtn: !!this.ui.els.fullscreenAutoModeBtn,
                        fullscreenManualModeBtn: !!this.ui.els.fullscreenManualModeBtn
                    });

                    if (this.ui.els.fullscreenTableBtn) {
                        this.ui.els.fullscreenTableBtn.addEventListener('click', () => {
                            console.log('ğŸŸ¢ [fullscreenTableBtn] ìë™ ëª¨ë“œ ì „ì²´í™”ë©´ ë²„íŠ¼ í´ë¦­');
                            if (this.autoCalculatedData && this.autoCalculatedData.results) {
                                this.ui.openFullscreenTable('auto', this.autoCalculatedData);
                            } else {
                                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                            }
                        });
                    }

                    if (this.ui.els.fullscreenTableBtnManual) {
                        this.ui.els.fullscreenTableBtnManual.addEventListener('click', () => {
                            console.log('ğŸŸ¡ [fullscreenTableBtnManual] ìˆ˜ë™ ëª¨ë“œ ì „ì²´í™”ë©´ ë²„íŠ¼ í´ë¦­');
                            const manualData = this.getManualAnalysisData();
                            if (manualData && manualData.results) {
                                this.ui.openFullscreenTable('manual', manualData);
                            } else {
                                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                            }
                        });
                    }

                    if (this.ui.els.closeFullscreenTableBtn) {
                        this.ui.els.closeFullscreenTableBtn.addEventListener('click', () => {
                            this.ui.closeFullscreenTable();
                        });
                    }

                    if (this.ui.els.closeFullscreenTableBtn2) {
                        this.ui.els.closeFullscreenTableBtn2.addEventListener('click', () => {
                            this.ui.closeFullscreenTable();
                        });
                    }

                    // [User Request] Disable Close on Overlay Click
                    // if (this.ui.els.fullscreenTableModalOverlay) {
                    //     this.ui.els.fullscreenTableModalOverlay.addEventListener('click', () => {
                    //         this.ui.closeFullscreenTable();
                    //     });
                    // }

                    if (this.ui.els.fullscreenTableSearch) {
                        this.ui.els.fullscreenTableSearch.addEventListener('input', (e) => {
                            this.ui.searchFullscreenTable(e.target.value);
                        });
                    }

                    if (this.ui.els.fullscreenAutoModeBtn) {
                        this.ui.els.fullscreenAutoModeBtn.addEventListener('click', () => {
                            console.log('ğŸ”µ [fullscreenAutoModeBtn] ìë™ ëª¨ë“œ ë²„íŠ¼ í´ë¦­', {
                                hasData: !!this.autoCalculatedData,
                                hasResults: !!this.autoCalculatedData?.results
                            });
                            if (this.autoCalculatedData && this.autoCalculatedData.results) {
                                this.ui.closeFullscreenTable();
                                setTimeout(() => {
                                    this.ui.openFullscreenTable('auto', this.autoCalculatedData);
                                }, 100);
                            } else {
                                console.warn('âš ï¸ ìë™ ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        });
                    }

                    if (this.ui.els.fullscreenManualModeBtn) {
                        this.ui.els.fullscreenManualModeBtn.addEventListener('click', () => {
                            const manualData = this.getManualAnalysisData();
                            console.log('ğŸŸ¡ [fullscreenManualModeBtn] ìˆ˜ë™ ëª¨ë“œ ë²„íŠ¼ í´ë¦­', {
                                hasData: !!manualData,
                                hasResults: !!manualData?.results
                            });
                            if (manualData && manualData.results) {
                                this.ui.closeFullscreenTable();
                                setTimeout(() => {
                                    this.ui.openFullscreenTable('manual', manualData);
                                }, 100);
                            } else {
                                console.warn('âš ï¸ ìˆ˜ë™ ëª¨ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        });
                    }

                    if (this.ui.els.exportFullscreenTableBtn) {
                        this.ui.els.exportFullscreenTableBtn.addEventListener('click', () => {
                            if (this.ui.fullscreenTableState) {
                                const mode = this.ui.fullscreenTableState.mode;
                                if (mode === 'manual') {
                                    const manualData = this.getManualAnalysisData();
                                    this.ui.exportToExcel(
                                        manualData,
                                        this.currentClient,
                                        this.currentWorkTypes,
                                        this.currentYear,
                                        null,
                                        this.manualPredictions,
                                        this.rawData
                                    );
                                } else {
                                    this.ui.exportToExcel(
                                        this.autoCalculatedData,
                                        this.currentClient,
                                        this.currentWorkTypes,
                                        this.currentYear,
                                        null,
                                        null,
                                        this.rawData
                                    );
                                }
                            }
                        });
                    }

                    // === Sankey Diagram Event Listeners ===
                    if (this.ui.els.openSankeyBtn) {
                        this.ui.els.openSankeyBtn.addEventListener('click', () => {
                            console.log('ğŸŒŠ [Event] Sankey Diagram Button Clicked');

                            // Check if data available
                            if (!this.autoCalculatedData || !this.autoCalculatedData.results) {
                                alert('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
                                return;
                            }

                            // Prepare data
                            const data = this.analysisMode === 'manual'
                                ? this.getManualAnalysisData()
                                : this.autoCalculatedData;

                            this.ui.openSankeyModal();

                            // Try to render (Function check)
                            if (this.renderSankeyDiagramV4 && typeof this.renderSankeyDiagramV4 === 'function') {
                                console.log('ğŸŒŠ Rendering Sankey Diagram (Logic V4 - Unclassified Restore)...');
                                this.renderSankeyDiagramV4(data);
                            } else if (this.renderSankeyDiagramV3 && typeof this.renderSankeyDiagramV3 === 'function') {
                                console.log('ğŸŒŠ Rendering Sankey Diagram (Logic V3)...');
                                this.renderSankeyDiagramV3(data);
                            } else if (this.renderSankeyDiagram && typeof this.renderSankeyDiagram === 'function') {
                                console.log('ğŸŒŠ Rendering Sankey Diagram (Legacy)...');
                                this.renderSankeyDiagram(data);
                            } else {
                                console.error('âŒ Sankey Rendering í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                alert('Sankey ë‹¤ì´ì–´ê·¸ë¨ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        });
                    }

                    if (this.ui.els.closeSankeyBtn) {
                        this.ui.els.closeSankeyBtn.addEventListener('click', () => {
                            this.ui.closeSankeyModal();
                        });
                    }

                    // [User Request] Disable Close on Overlay Click
                    // if (this.ui.els.sankeyModalOverlay) {
                    //     this.ui.els.sankeyModalOverlay.addEventListener('click', () => {
                    //         this.ui.closeSankeyModal();
                    //     });
                    // }

                    // === Statistics Detail Modal Event Listeners ===
                    // Stat card click handlers
                    document.querySelectorAll('.stat-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const statType = card.dataset.statType;
                            const mode = card.dataset.mode;

                            console.log('ğŸ“Š [stat-card click]', { statType, mode });

                            if (!this.rawData || this.rawData.length === 0) {
                                alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                                return;
                            }

                            // Filter raw data based on stat type and current settings
                            const filteredRawData = this.getFilteredRawDataForStat(statType, mode);
                            this.ui.currentYear = this.currentYear;
                            this.ui.openStatDetail(statType, mode, filteredRawData);
                        });
                    });

                    // Stat Detail Modal close buttons
                    if (this.ui.els.closeStatDetailBtn) {
                        this.ui.els.closeStatDetailBtn.addEventListener('click', () => {
                            this.ui.closeStatDetail();
                        });
                    }

                    if (this.ui.els.closeStatDetailBtn2) {
                        this.ui.els.closeStatDetailBtn2.addEventListener('click', () => {
                            this.ui.closeStatDetail();
                        });
                    }

                    // [User Request] Disable Close on Overlay Click
                    // if (this.ui.els.statDetailModalOverlay) {
                    //     this.ui.els.statDetailModalOverlay.addEventListener('click', () => {
                    //         this.ui.closeStatDetail();
                    //     });
                    // }

                    // [Fix] Building Click Delegation (Event Handling for Dynamically Created Elements)
                    // Auto Table Body
                    if (this.ui.els.autoTableBody) {
                        this.ui.els.autoTableBody.addEventListener('click', (e) => {
                            const trigger = e.target.closest('.building-data-trigger');
                            if (trigger) {
                                console.log('ğŸ—ï¸ [App] Building clicked (auto):', trigger.dataset.building);
                                e.stopPropagation();
                                this.handleBuildingClick(trigger);
                            }
                        });
                    }

                    // Manual Table Body
                    if (this.ui.els.manualTableBody) {
                        this.ui.els.manualTableBody.addEventListener('click', (e) => {
                            const trigger = e.target.closest('.building-data-trigger');
                            if (trigger) {
                                console.log('ğŸ—ï¸ [App] Building clicked (manual):', trigger.dataset.building);
                                e.stopPropagation();
                                this.handleBuildingClick(trigger);
                            }
                        });
                    }

                    if (this.ui.els.statDetailSearch) {
                        this.ui.els.statDetailSearch.addEventListener('input', (e) => {
                            this.ui.searchStatDetail(e.target.value);
                        });
                    }

                    if (this.ui.els.exportStatDetailBtn) {
                        this.ui.els.exportStatDetailBtn.addEventListener('click', () => {
                            this.ui.exportStatDetail();
                        });
                    }


                    // Handle editable cells in fullscreen table (manual mode)
                    // [Fix] Focus ì´ë²¤íŠ¸ - ì…€ í´ë¦­ ì‹œ ì „ì²´ í…ìŠ¤íŠ¸ ì„ íƒ (ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼)
                    document.addEventListener('focus', (e) => {
                        const target = e.target;
                        if (target.hasAttribute('contenteditable') &&
                            target.closest('#fullscreenTableBody') &&
                            this.ui.fullscreenTableState &&
                            this.ui.fullscreenTableState.isManualMode) {
                            // ì „ì²´ í…ìŠ¤íŠ¸ ì„ íƒ
                            setTimeout(() => {
                                const range = document.createRange();
                                range.selectNodeContents(target);
                                const sel = window.getSelection();
                                sel.removeAllRanges();
                                sel.addRange(range);
                            }, 0);
                        }
                    }, true);

                    // Use delegation for paste and keydown to ensure consistency
                    document.addEventListener('keydown', (e) => {
                        const target = e.target;
                        if (target.hasAttribute('contenteditable') &&
                            target.closest('#fullscreenTableBody') &&
                            this.ui.fullscreenTableState &&
                            this.ui.fullscreenTableState.isManualMode) {

                            if (e.key === 'Enter') {
                                e.preventDefault();
                                target.blur();
                            }
                            // Allow nav keys
                            else if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Escape'].includes(e.key)) {
                                return;
                            }
                            // Allow Ctrl+A, C, V, X, Z
                            else if ((e.ctrlKey || e.metaKey) && ['a', 'c', 'v', 'x', 'z'].includes(e.key.toLowerCase())) {
                                return;
                            }
                            // Block non-numbers
                            else if (!/^[0-9]$/.test(e.key)) {
                                e.preventDefault();
                            }
                        }
                    }, true);

                    document.addEventListener('paste', (e) => {
                        const target = e.target;
                        if (target.hasAttribute('contenteditable') &&
                            target.closest('#fullscreenTableBody') &&
                            this.ui.fullscreenTableState &&
                            this.ui.fullscreenTableState.isManualMode) {
                            e.preventDefault();
                            const text = (e.clipboardData || window.clipboardData).getData('text');
                            // Remove commas and non-numeric chars
                            const cleanText = text.replace(/[^0-9]/g, '');
                            if (cleanText) {
                                document.execCommand('insertText', false, cleanText);
                            }
                        }
                    }, true);

                    document.addEventListener('blur', (e) => {
                        if (e.target.hasAttribute('contenteditable') &&
                            e.target.closest('#fullscreenTableBody') &&
                            this.ui.fullscreenTableState &&
                            this.ui.fullscreenTableState.isManualMode) {
                            const building = e.target.dataset.building;
                            const field = e.target.dataset.field;
                            const oldValue = parseInt(e.target.dataset.value) || 0;
                            let value = e.target.textContent.trim().replace(/,/g, '');

                            if (field === 'avgCount' || field === 'avgUnitAmount') {
                                value = parseInt(value) || 0;

                                // [Fix] ì¦‰ì‹œ ì…€ í¬ë§·íŒ… ì ìš© - ì¼ë°˜ í…Œì´ë¸”ê³¼ ë™ì¼í•˜ê²Œ
                                if (field === 'avgUnitAmount') {
                                    e.target.textContent = FormatUtils.currency(value);
                                } else {
                                    e.target.textContent = FormatUtils.number(value);
                                }
                                e.target.dataset.value = value;

                                // ê°’ì´ ë³€ê²½ëœ ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
                                if (value !== oldValue) {
                                    // [Fix] updateManualPrediction í˜¸ì¶œë¡œ ì¼ë°˜ í…Œì´ë¸”ê³¼ ì „ì²´ í™”ë©´ í…Œì´ë¸” ëª¨ë‘ ë™ê¸°í™”
                                    // (updateManualPrediction ë‚´ë¶€ì—ì„œ ì „ì²´ í™”ë©´ í…Œì´ë¸”ë„ ê°±ì‹ í•¨)
                                    this.updateManualPrediction(building, field, value);
                                }
                            }
                        }
                    }, true);

                    // ESC key to close fullscreen table
                    document.addEventListener('keydown', (e) => {
                        /* [User Request] Disable ESC Close
                        if (e.key === 'Escape' && this.ui.els.fullscreenTableModal && !this.ui.els.fullscreenTableModal.classList.contains('hidden')) {
                            this.ui.closeFullscreenTable();
                        }
                        */
                    });

                    document.addEventListener('click', (e) => {
                        const sortHeader = e.target.closest('.sort-header');
                        if (sortHeader) {
                            const key = sortHeader.dataset.sortKey;
                            if (key) this.handleSort(key);
                        }
                    });
                }

                // [New] Load data from GitHub automatically
                async loadGitHubData() {
                    const GITHUB_DATA_URL = 'https://jonggunelee.github.io/wyggkr04/RawData/14ë…„-25ë…„_ë¡œìš°ë°ì´í„°.xlsx';

                    try {
                        this.ui.setLoading(true);

                        // Update button text to show loading
                        if (this.ui.els.dataSourceBtnText) {
                            this.ui.els.dataSourceBtnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> ë¡œë”© ì¤‘...';
                        }

                        const response = await fetch(GITHUB_DATA_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const arrayBuffer = await response.arrayBuffer();
                        const data = new Uint8Array(arrayBuffer);

                        // Parse Excel file using SheetJS
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const rawJson = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        // Update button text to show success
                        if (this.ui.els.dataSourceBtnText) {
                            this.ui.els.dataSourceBtnText.innerHTML = '<i class="fa-brands fa-github text-emerald-500 mr-1"></i> 14ë…„-25ë…„ ë¡œìš°ë°ì´í„°';
                        }

                        // [Fix] Normalize data same as handleFileUpload
                        this.rawData = this.domainService.normalizeData(rawJson);

                        // [PRD/IMP] 1. Extract Unique Values from Raw Data
                        const clients = this.domainService.extractClients(this.rawData);
                        const years = this.domainService.extractYears(this.rawData);

                        // Default client: 'ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜' ìš°ì„  ì‚¬ìš©
                        const defaultClient = clients.includes('ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜') ? 'ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜' : (clients[0] || '');
                        this.currentClient = defaultClient;

                        // [PRD/IMP] 2. Filter Work Types by Selected Client
                        const workTypes = this.domainService.extractWorkTypes(this.rawData, defaultClient);
                        this.allWorkTypes = workTypes;

                        const maxSpan = this.domainService.calculateMaxSpan(years);
                        this.currentSpan = this.ui.updateYearRangeLimit(maxSpan, 3);
                        const defaultYear = years.includes(2025) ? 2025 : (years[0] || 2025);

                        // [PRD/IMP] 3. Determine Default Work Types
                        const defaultWorkTypes = [];
                        if (workTypes.includes('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) defaultWorkTypes.push('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                        if (workTypes.includes('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) defaultWorkTypes.push('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                        if (defaultWorkTypes.length === 0 && workTypes.length > 0) defaultWorkTypes.push(workTypes[0]);
                        this.currentWorkTypes = defaultWorkTypes;

                        // [PRD/IMP] 4. Update UI Dropdowns
                        this.ui.populateSelect(this.ui.els.clientSelect, clients, defaultClient);

                        this.allYears = years;
                        this.currentYear = defaultYear;
                        this.currentSelectedYears = [defaultYear];
                        this.ui.populateYearMultiSelect(years, [defaultYear]);

                        this.ui.populateMultiSelect({
                            wrapper: this.ui.els.workTypeWrapper,
                            btn: this.ui.els.workTypeBtn,
                            btnText: this.ui.els.workTypeBtnText,
                            dropdown: this.ui.els.workTypeDropdown
                        }, workTypes, defaultWorkTypes);

                        // [PRD/IMP] 5. Execute Initial Analysis
                        if (this.currentWorkTypes.length > 0 && this.currentClient) {
                            // setTimeout to allow UI update before heavy analysis
                            setTimeout(() => {
                                this.runAnalysis();
                            }, 50);
                        }

                    } catch (err) {
                        alert('ê¹ƒí—ˆë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + err.message + '\n\në¡œì»¬ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');

                        // Reset button text
                        if (this.ui.els.dataSourceBtnText) {
                            this.ui.els.dataSourceBtnText.textContent = 'ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ...';
                        }
                    } finally {
                        this.ui.setLoading(false);
                    }
                }

                async handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    this.ui.setLoading(true);
                    try {
                        // Use setTimeout to allow UI to update loading state
                        await new Promise(resolve => setTimeout(resolve, 50));

                        // [New] Update data source button text with file name
                        if (this.ui.els.dataSourceBtnText) {
                            const fileName = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
                            this.ui.els.dataSourceBtnText.innerHTML = '<i class="fa-solid fa-file-excel text-blue-500 mr-1"></i> ' + fileName;
                        }

                        const rawJson = await ExcelService.read(file);
                        // [Safety] Clean Normalize Data Immediately
                        this.rawData = this.domainService.normalizeData(rawJson);

                        // [PRD/IMP] 1. Extract Clients & Determine Default
                        const clients = this.domainService.extractClients(this.rawData);
                        const defaultClient = clients.includes('ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜') ? 'ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜' : (clients[0] || '');
                        this.currentClient = defaultClient;

                        // [PRD/IMP] 2. Extract Work Types FILTERED by Default Client (Logic Coupling Fix)
                        const workTypes = this.domainService.extractWorkTypes(this.rawData, defaultClient);
                        this.allWorkTypes = workTypes;

                        const years = this.domainService.extractYears(this.rawData);
                        const maxSpan = this.domainService.calculateMaxSpan(years);
                        this.currentSpan = this.ui.updateYearRangeLimit(maxSpan, 3);
                        const defaultYear = years.includes(2025) ? 2025 : (years[0] || 2025);

                        // [PRD/IMP] 3. Determine Default Work Types from Filtered List
                        const defaultWorkTypes = [];
                        if (workTypes.includes('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) defaultWorkTypes.push('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                        if (workTypes.includes('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) defaultWorkTypes.push('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                        if (defaultWorkTypes.length === 0 && workTypes.length > 0) defaultWorkTypes.push(workTypes[0]);
                        this.currentWorkTypes = defaultWorkTypes;

                        // [PRD/IMP] 4. Update UI Dropdowns
                        this.ui.populateSelect(this.ui.els.clientSelect, clients, defaultClient);

                        // [Multi-Year Selection] Populate year multi-select
                        this.allYears = years;
                        this.currentYear = defaultYear;
                        this.currentSelectedYears = [defaultYear]; // Default: single year selection
                        this.ui.populateYearMultiSelect(years, [defaultYear]);

                        this.ui.populateMultiSelect({
                            wrapper: this.ui.els.workTypeWrapper,
                            btn: this.ui.els.workTypeBtn,
                            btnText: this.ui.els.workTypeBtnText,
                            dropdown: this.ui.els.workTypeDropdown
                        }, workTypes, defaultWorkTypes);

                        // [PRD/IMP] 5. Execute Initial Analysis
                        if (this.currentWorkTypes.length > 0 && this.currentClient) {
                            this.runAnalysis();
                        }

                    } catch (err) {
                        alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                    } finally {
                        this.ui.setLoading(false);
                    }
                }

                // [New] Load data from GitHub automatically
                async loadGitHubData() {
                    const GITHUB_DATA_URL = 'https://jonggunelee.github.io/wyggkr04/RawData/14ë…„-25ë…„_ë¡œìš°ë°ì´í„°.xlsx';

                    try {
                        this.ui.setLoading(true);

                        // Update button text to show loading
                        if (this.ui.els.dataSourceBtnText) {
                            this.ui.els.dataSourceBtnText.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> ë¡œë”© ì¤‘...';
                        }

                        console.log('ğŸ“¥ [GitHub] Fetching data from:', GITHUB_DATA_URL);

                        const response = await fetch(GITHUB_DATA_URL);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const arrayBuffer = await response.arrayBuffer();
                        const data = new Uint8Array(arrayBuffer);

                        // Parse Excel file using SheetJS
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const rawJson = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        console.log('âœ… [GitHub] Data loaded successfully:', rawJson.length, 'rows');

                        // Update button text to show success
                        if (this.ui.els.dataSourceBtnText) {
                            this.ui.els.dataSourceBtnText.innerHTML = '<i class="fa-brands fa-github text-emerald-500 mr-1"></i> 14ë…„-25ë…„ ë¡œìš°ë°ì´í„°';
                        }

                        // [Fix] Normalize data same as handleFileUpload
                        this.rawData = this.domainService.normalizeData(rawJson);

                        // [PRD/IMP] 1. Extract Unique Values from Raw Data
                        const clients = this.domainService.extractClients(this.rawData);
                        const years = this.domainService.extractYears(this.rawData);

                        // Default client: 'ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜' ìš°ì„  ì‚¬ìš©
                        const defaultClient = clients.includes('ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜') ? 'ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜' : (clients[0] || '');
                        this.currentClient = defaultClient;

                        // [PRD/IMP] 2. Filter Work Types by Selected Client
                        const workTypes = this.domainService.extractWorkTypes(this.rawData, defaultClient);
                        this.allWorkTypes = workTypes;

                        const maxSpan = this.domainService.calculateMaxSpan(years);
                        this.currentSpan = this.ui.updateYearRangeLimit(maxSpan, 3);
                        const defaultYear = years.includes(2025) ? 2025 : (years[0] || 2025);

                        // [PRD/IMP] 3. Determine Default Work Types
                        const defaultWorkTypes = [];
                        if (workTypes.includes('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) defaultWorkTypes.push('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                        if (workTypes.includes('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬')) defaultWorkTypes.push('ì„ì°¨ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬');
                        if (defaultWorkTypes.length === 0 && workTypes.length > 0) defaultWorkTypes.push(workTypes[0]);
                        this.currentWorkTypes = defaultWorkTypes;

                        // [PRD/IMP] 4. Update UI Dropdowns
                        this.ui.populateSelect(this.ui.els.clientSelect, clients, defaultClient);

                        this.allYears = years;
                        this.currentYear = defaultYear;
                        this.currentSelectedYears = [defaultYear];
                        this.ui.populateYearMultiSelect(years, [defaultYear]);

                        this.ui.populateMultiSelect({
                            wrapper: this.ui.els.workTypeWrapper,
                            btn: this.ui.els.workTypeBtn,
                            btnText: this.ui.els.workTypeBtnText,
                            dropdown: this.ui.els.workTypeDropdown
                        }, workTypes, defaultWorkTypes);

                        // [PRD/IMP] 5. Execute Initial Analysis
                        console.log('ğŸ [GitHub] Ready to analyze:', { client: this.currentClient, workTypes: this.currentWorkTypes });

                        if (this.currentWorkTypes.length > 0 && this.currentClient) {
                            // setTimeout to allow UI update before heavy analysis
                            setTimeout(() => {
                                this.runAnalysis();
                            }, 50);
                        } else {
                            console.warn('âš ï¸ [GitHub] Analysis skipped. No work types or client selected.');
                        }

                    } catch (err) {
                        console.error('âŒ [GitHub] Error loading data:', err);
                        alert('ê¹ƒí—ˆë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + err.message + '\n\në¡œì»¬ íŒŒì¼ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');

                        // Reset button text
                        if (this.ui.els.dataSourceBtnText) {
                            this.ui.els.dataSourceBtnText.textContent = 'ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ...';
                        }
                    } finally {
                        this.ui.setLoading(false);
                    }
                }

                runAnalysis() {
                    if (!this.rawData || (!this.currentWorkTypes || this.currentWorkTypes.length === 0) || !this.currentClient) return;
                    this.ui.updateLabels(this.currentSpan, this.currentWorkTypes, this.currentClient, this.currentYear, this.domainService.forecastSettings.method);

                    // Use setTimeout for non-blocking UI
                    setTimeout(() => {
                        safe(() => {
                            // ìë™ ê³„ì‚° ìˆ˜í–‰
                            const analysisData = this.domainService.analyze(this.rawData, this.currentSpan, this.currentWorkTypes, this.currentClient, this.currentYear);

                            // [Fix] Analysis Validity Check
                            if (!analysisData || !analysisData.results) {
                                console.error('Analysis failed or returned empty results');
                                alert('ë°ì´í„° ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì…ë ¥ ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                                this.ui.setLoading(false);
                                return;
                            }

                            this.autoCalculatedData = JSON.parse(JSON.stringify(analysisData)); // Deep copy

                            // ìˆ˜ë™ ëª¨ë“œì¼ ë•Œ ìˆ˜ë™ ì˜ˆì¸¡ê°’ ì ìš©
                            if (this.analysisMode === 'manual') {
                                analysisData.results = analysisData.results.map(row => {
                                    const manual = this.manualPredictions[row.building];
                                    if (manual) {
                                        const newRow = { ...row };

                                        // 1. Apply overrides
                                        if (manual.avgCount !== undefined) {
                                            newRow.avgCount = manual.avgCount;
                                        }
                                        if (manual.avgUnitAmount !== undefined) {
                                            newRow.avgUnitAmount = manual.avgUnitAmount;
                                        }

                                        // 2. Always recalculate dependent values (Total Amount = Unit Amount * Count)
                                        // This ensures logical consistency even if only one field is manually set.
                                        newRow.avgAmount = newRow.avgUnitAmount * newRow.avgCount;

                                        // 3. Recalculate differentials
                                        newRow.diffCount = newRow.currentCount - newRow.avgCount;
                                        newRow.diffAmount = newRow.currentAmount - newRow.avgAmount;
                                        newRow.diffUnitAmount = newRow.currentUnitAmount - newRow.avgUnitAmount;

                                        return newRow;
                                    }
                                    return row;
                                });

                                // ì´ê³„ ì¬ê³„ì‚°
                                analysisData.totalSummary.totalAvgAmount = analysisData.results.reduce((sum, item) => sum + item.avgAmount, 0);
                                analysisData.totalSummary.totalAvgCount = analysisData.results.reduce((sum, item) => sum + item.avgCount, 0);
                            }

                            this.lastAnalysisData = analysisData;

                            // ìˆ˜ë™ ëª¨ë“œì¼ ë•Œ í¸ì§‘ ì½œë°± ì „ë‹¬
                            const editCallback = this.analysisMode === 'manual'
                                ? (building, field, value) => this.updateManualPrediction(building, field, value)
                                : null;

                            this.ui.renderDashboard(
                                analysisData,
                                this.analysisMode === 'manual',
                                editCallback,
                                this.manualPredictions,
                                this.autoCalculatedData, // Pass pristine Auto Data
                                this.domainService.forecastSettings // [Fix] WMA ì„¤ì •ì„ ë Œë”ëŸ¬ì— ì „ë‹¬
                            );
                        });
                    }, 0);
                }

                setAnalysisMode(mode) {
                    this.analysisMode = mode;
                    this.ui.setAnalysisMode(mode);

                    // ëª¨ë“œ ë³€ê²½ ì‹œ ì¬ë¶„ì„
                    if (this.rawData) {
                        this.runAnalysis();
                    }
                }

                updateManualPrediction(building, field, value) {
                    if (!this.manualPredictions[building]) {
                        this.manualPredictions[building] = {};
                    }
                    this.manualPredictions[building][field] = value;

                    // ì‹¤ì‹œê°„ ì¬ë¶„ì„
                    this.runAnalysis();

                    // [Fix] ì „ì²´ í™”ë©´ í…Œì´ë¸”ì´ ì—´ë ¤ìˆìœ¼ë©´ ë™ê¸°í™” - ì–‘ë°©í–¥ ë™ê¸°í™”
                    setTimeout(() => {
                        if (this.ui.fullscreenTableState &&
                            this.ui.fullscreenTableState.mode === 'manual' &&
                            this.ui.els.fullscreenTableModal &&
                            !this.ui.els.fullscreenTableModal.classList.contains('hidden')) {
                            const manualData = this.getManualAnalysisData();
                            if (manualData) {
                                this.ui.fullscreenTableState.allData = manualData.results;
                                this.ui.fullscreenTableState.filteredData = manualData.results;
                                this.ui.renderFullscreenTable();
                            }
                        }
                    }, 10);
                }

                applyAutoValues() {
                    if (!this.autoCalculatedData) return;

                    // ìë™ ê³„ì‚°ê°’ì„ ìˆ˜ë™ ì˜ˆì¸¡ì— ë³µì‚¬
                    this.manualPredictions = {};
                    this.autoCalculatedData.results.forEach(row => {
                        this.manualPredictions[row.building] = {
                            avgCount: row.avgCount,
                            avgUnitAmount: row.avgUnitAmount
                        };
                    });

                    // ì¬ë Œë”ë§
                    this.runAnalysis();

                    // ì‚¬ìš©ì ì•Œë¦¼
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
                    toast.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>ìë™ ê³„ì‚°ê°’ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'transition-opacity');
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                }

                openComparisonModal() {
                    try {
                        console.log('Opening comparison modal...');

                        if (!this.rawData || !this.autoCalculatedData) {
                            alert('ë°ì´í„°ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.');
                            return;
                        }

                        console.log('Auto calculated data:', this.autoCalculatedData);
                        console.log('Manual predictions:', this.manualPredictions);

                        // Calculate manual data
                        const manualData = this.getManualAnalysisData();
                        console.log('Manual data calculated:', manualData);

                        // Render comparison analysis
                        this.ui.renderComparisonAnalysis(this.autoCalculatedData, manualData, this.manualPredictions || {});
                        console.log('Comparison analysis rendered');

                        // Open modal
                        this.ui.openComparisonModal();
                        console.log('Modal opened successfully');
                    } catch (e) {
                        console.error('Modal Error:', e);
                        console.error('Error stack:', e.stack);
                        alert('ë¹„êµ ë¶„ì„ ì°½ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                    }
                }

                exportComparisonAnalysis() {
                    if (!this.autoCalculatedData) {
                        alert('ë¹„êµí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    const manualData = this.getManualAnalysisData();
                    const autoData = this.autoCalculatedData;

                    const wsData = [
                        ['ìë™ vs ìˆ˜ë™ ëª¨ë“œ ë¹„êµ ë¶„ì„ ë³´ê³ ì„œ'],
                        ['ìƒì„±ì¼ì‹œ:', new Date().toLocaleString('ko-KR')],
                        ['ë°œì£¼ì²˜:', this.currentClient],
                        ['ì‘ì—…ìœ í˜•:', this.currentWorkTypes.join(', ')],
                        [''],
                        ['êµ¬ë¶„', 'ìë™ ê³„ì‚°', 'ìˆ˜ë™ ì˜ˆì¸¡', 'ì°¨ì´', 'ë³€í™”ìœ¨(%)'],
                        ['ì´ ì˜ˆì¸¡ ê¸ˆì•¡',
                            autoData.results.reduce((s, i) => s + i.avgAmount, 0),
                            manualData.results.reduce((s, i) => s + i.avgAmount, 0),
                            manualData.results.reduce((s, i) => s + i.avgAmount, 0) - autoData.results.reduce((s, i) => s + i.avgAmount, 0),
                            ((manualData.results.reduce((s, i) => s + i.avgAmount, 0) - autoData.results.reduce((s, i) => s + i.avgAmount, 0)) / autoData.results.reduce((s, i) => s + i.avgAmount, 0) * 100).toFixed(2) + '%'
                        ],
                        ['ì´ ì˜ˆì¸¡ ì„¸ëŒ€ìˆ˜',
                            autoData.results.reduce((s, i) => s + i.avgCount, 0),
                            manualData.results.reduce((s, i) => s + i.avgCount, 0),
                            manualData.results.reduce((s, i) => s + i.avgCount, 0) - autoData.results.reduce((s, i) => s + i.avgCount, 0),
                            ((manualData.results.reduce((s, i) => s + i.avgCount, 0) - autoData.results.reduce((s, i) => s + i.avgCount, 0)) / autoData.results.reduce((s, i) => s + i.avgCount, 0) * 100).toFixed(2) + '%'
                        ],
                        [''],
                        ['ê±´ë¬¼ë™ë³„ ìƒì„¸ ë¹„êµ'],
                        ['ê±´ë¬¼ë™', 'ìë™-ê¸ˆì•¡', 'ìˆ˜ë™-ê¸ˆì•¡', 'ì°¨ì´-ê¸ˆì•¡', 'ìë™-ì„¸ëŒ€ìˆ˜', 'ìˆ˜ë™-ì„¸ëŒ€ìˆ˜', 'ì°¨ì´-ì„¸ëŒ€ìˆ˜', 'ë³€í™”ìœ¨(%)']
                    ];

                    autoData.results.forEach((autoRow, idx) => {
                        const manualRow = manualData.results[idx];
                        const amtDiff = manualRow.avgAmount - autoRow.avgAmount;
                        const cntDiff = manualRow.avgCount - autoRow.avgCount;
                        const changeRate = autoRow.avgAmount > 0 ? ((amtDiff / autoRow.avgAmount) * 100).toFixed(2) : 0;

                        wsData.push([
                            autoRow.building,
                            autoRow.avgAmount,
                            manualRow.avgAmount,
                            amtDiff,
                            autoRow.avgCount,
                            manualRow.avgCount,
                            cntDiff,
                            changeRate + '%'
                        ]);
                    });

                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "ë¹„êµë¶„ì„");

                    // [New] Add Chart Data Sheet
                    // SheetJS Free does not support native charts, so we provide a clean data sheet for easy charting
                    const chartData = [
                        ['ê±´ë¬¼ë™', 'ìë™ ì˜ˆì¸¡ê¸ˆì•¡', 'ìˆ˜ë™ ì˜ˆì¸¡ê¸ˆì•¡', 'ìë™ ì˜ˆì¸¡ê±´ìˆ˜', 'ìˆ˜ë™ ì˜ˆì¸¡ê±´ìˆ˜'],
                        ...autoData.results.map((autoRow, idx) => {
                            const manualRow = manualData.results[idx];
                            return [
                                autoRow.building,
                                autoRow.avgAmount,
                                manualRow.avgAmount,
                                autoRow.avgCount,
                                manualRow.avgCount
                            ];
                        })
                    ];
                    const wsChart = XLSX.utils.aoa_to_sheet(chartData);
                    XLSX.utils.book_append_sheet(wb, wsChart, "ì°¨íŠ¸ë°ì´í„°");

                    // Add Raw Data Sheet
                    if (this.rawData && Array.isArray(this.rawData) && this.rawData.length > 0) {
                        try {
                            const rawDataOps = [];
                            const headers = Object.keys(this.rawData[0]);
                            rawDataOps.push(headers);
                            this.rawData.forEach(row => {
                                const rowData = headers.map(header => row[header] || '');
                                rawDataOps.push(rowData);
                            });
                            const wsRawData = XLSX.utils.aoa_to_sheet(rawDataOps);
                            XLSX.utils.book_append_sheet(wb, wsRawData, "ì›ë³¸ë°ì´í„°");
                            console.log('âœ… Raw data sheet added to comparison export');
                        } catch (error) {
                            console.error('âš ï¸ Failed to add raw data sheet:', error);
                        }
                    }

                    const safeName = `${this.currentClient}_ë¹„êµë¶„ì„`.replace(/[\/\?%*:|"<>]/g, '_');
                    XLSX.writeFile(wb, `${safeName}_${new Date().toISOString().slice(0, 10)}.xlsx`);

                    // Show success toast
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
                    toast.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>ë¹„êµ ë¶„ì„ì´ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤';
                    document.body.appendChild(toast);
                    setTimeout(() => {
                        toast.classList.add('opacity-0', 'transition-opacity');
                        setTimeout(() => toast.remove(), 300);
                    }, 2000);
                }

                loadSnapshot() {
                    const data = window.__SNAPSHOT__;
                    if (!data || !data.rawData) return;

                    // [Fix] ëª¨ë“  ìƒíƒœ ë³€ìˆ˜ë¥¼ ì™„ë²½í•˜ê²Œ ë³µì›í•˜ì—¬ ì›ë³¸ê³¼ ë™ì¼í•œ ìƒíƒœ ë³´ì¥
                    // í•µì‹¬ ë°ì´í„°
                    this.rawData = data.rawData;

                    // í•„í„° ì„¤ì •
                    this.currentSpan = data.span || 3;
                    this.currentYear = data.year || 2025;
                    this.currentClient = data.client || '';
                    this.currentWorkTypes = data.workTypes || [];
                    this.allWorkTypes = data.allWorkTypes || [];

                    // ì—°ë„ ì„¤ì • (Multi-Year Selection í¬í•¨)
                    this.allYears = data.allYears || [];
                    this.currentSelectedYears = data.currentSelectedYears || [];
                    this.yearAggregationMethod = data.yearAggregationMethod || 'avg';

                    // ë¶„ì„ ëª¨ë“œ ë° ì˜ˆì¸¡ ë°ì´í„°
                    this.analysisMode = data.analysisMode || 'auto';
                    this.manualPredictions = data.manualPredictions || {};
                    this.autoCalculatedData = data.autoCalculatedData || null;

                    // ì •ë ¬ ìƒíƒœ
                    this.sortState = data.sortState || { key: null, direction: 'asc' };

                    // ê³ ê¸‰ ì„¤ì • ë³µì›
                    if (data.forecastSettings) {
                        this.domainService.updateForecastSettings(data.forecastSettings);
                    }
                    this.simulationMode = data.simulationMode || false;
                    this.globalPriceModifier = data.globalPriceModifier || 0;
                    this.sankeyDataMode = data.sankeyDataMode || 'auto';

                    // UI Restoration
                    this.ui.setLoading(true);

                    setTimeout(() => {
                        safe(() => {
                            const clients = this.domainService.extractClients(this.rawData);
                            const years = this.domainService.extractYears(this.rawData);

                            // [Fix] allYears ìƒíƒœ ì—…ë°ì´íŠ¸ (ìŠ¤ëƒ…ìƒ· ë³µì› ì‹œì—ë„ ìµœì‹  ìƒíƒœ ìœ ì§€)
                            this.allYears = years;

                            // [Fix] ë°œì£¼ì²˜ ìœ íš¨ì„± ê²€ì‚¬ ë° ì„¤ì • (ìˆœì„œ ì¡°ì •: ë°œì£¼ì²˜ë¥¼ ë¨¼ì € ì•Œì•„ì•¼ í•„í„°ë§ëœ ì‘ì—… ìœ í˜• ì¶”ì¶œ ê°€ëŠ¥)
                            if (!clients.includes(this.currentClient) && clients.length > 0) {
                                this.currentClient = clients.includes('ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜') ? 'ì—˜ì§€ì—ë„ˆì§€ì†”ë£¨ì…˜' : clients[0];
                            }

                            // [Fix] í˜„ì¬ ë°œì£¼ì²˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ëœ ì‘ì—… ìœ í˜• ì¶”ì¶œ (Logical Coupling Fix)
                            const workTypes = this.domainService.extractWorkTypes(this.rawData, this.currentClient);
                            this.allWorkTypes = workTypes; // ìƒíƒœ ìµœì‹ í™”

                            // Populate MultiSelect
                            let validWorkTypes = this.currentWorkTypes.filter(wt => workTypes.includes(wt));

                            // ìœ íš¨í•œ ì‘ì—… ìœ í˜•ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„ íƒ (Filtered list ê¸°ì¤€)
                            if (validWorkTypes.length === 0 && workTypes.length > 0) {
                                const defaultWorkType = workTypes.includes('ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬') ? 'ì‚¬íƒ ê³µê°€ ìˆ˜ì¥ê³µì‚¬' : workTypes[0];
                                validWorkTypes = [defaultWorkType];
                            }

                            this.currentWorkTypes = validWorkTypes;

                            // ë…„ë„ ìœ íš¨ì„± ê²€ì‚¬
                            if (!years.includes(this.currentYear) && years.length > 0) {
                                this.currentYear = years.includes(2025) ? 2025 : years[0];
                            }

                            this.ui.populateMultiSelect({
                                wrapper: this.ui.els.workTypeWrapper,
                                btn: this.ui.els.workTypeBtn,
                                btnText: this.ui.els.workTypeBtnText,
                                dropdown: this.ui.els.workTypeDropdown
                            }, workTypes, validWorkTypes);

                            this.ui.populateSelect(this.ui.els.clientSelect, clients, this.currentClient);
                            this.ui.populateYearMultiSelect(years, this.currentSelectedYears || [this.currentYear]);

                            // Set Range
                            this.ui.els.yearRange.value = this.currentSpan;
                            this.ui.els.yearRangeValue.innerText = this.currentSpan + 'ë…„';

                            // Ensure button text is updated
                            this.ui.updateMultiSelectLabel({
                                btn: this.ui.els.workTypeBtn,
                                btnText: this.ui.els.workTypeBtnText,
                                dropdown: this.ui.els.workTypeDropdown
                            });

                            // ë¶„ì„ ëª¨ë“œ UI ë³µì›
                            this.ui.setAnalysisMode(this.analysisMode);

                            // ê°€ì¤‘ì¹˜/ë‹¨ìˆœ í‰ê·  ë²„íŠ¼ UI ë³µì›
                            const method = this.domainService.forecastSettings.method;
                            const simpleBtn = document.getElementById('simpleAvgBtn');
                            const wmaBtn = document.getElementById('wmaBtn');
                            if (simpleBtn && wmaBtn) {
                                if (method === 'wma') {
                                    wmaBtn.classList.add('bg-violet-600', 'text-white', 'shadow-sm');
                                    wmaBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                                    simpleBtn.classList.remove('bg-violet-600', 'text-white', 'shadow-sm');
                                    simpleBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
                                } else {
                                    simpleBtn.classList.add('bg-violet-600', 'text-white', 'shadow-sm');
                                    simpleBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                                    wmaBtn.classList.remove('bg-violet-600', 'text-white', 'shadow-sm');
                                    wmaBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
                                }
                            }

                            // ì¸í”Œë ˆì´ì…˜ ì…ë ¥ UI ë³µì›
                            const inflationInput = document.getElementById('inflationRate');
                            if (inflationInput) {
                                inflationInput.value = this.domainService.forecastSettings.inflationRate || 0;
                            }

                            // ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ UI ë³µì›
                            const simModeBtn = document.getElementById('simulationModeBtn');
                            const simActivePanel = document.getElementById('simulationActivePanel');
                            const globalModifier = document.getElementById('globalPriceModifier');
                            const globalModifierValue = document.getElementById('globalPriceModifierValue');

                            if (this.simulationMode && simModeBtn && simActivePanel) {
                                simActivePanel.classList.remove('hidden');
                                simModeBtn.innerHTML = '<i class="fa-solid fa-check"></i><span>í™œì„±í™”ë¨</span>';
                                simModeBtn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-400');
                                if (globalModifier) globalModifier.value = this.globalPriceModifier;
                                if (globalModifierValue) globalModifierValue.textContent = (this.globalPriceModifier >= 0 ? '+' : '') + this.globalPriceModifier + '%';
                            }

                            // Run Analysis
                            this.runAnalysis();
                        });
                        this.ui.setLoading(false);

                        // [Fix] ìŠ¤ëƒ…ìƒ· ëª¨ë“œì—ì„œë„ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥í•˜ë„ë¡ ë¹„í™œì„±í™” ì œê±°
                        // ì‚¬ìš©ìê°€ ìŠ¤ëƒ…ìƒ· íŒŒì¼ì—ì„œ ìƒˆ ë°ì´í„°ë¡œ êµì²´í•  ìˆ˜ ìˆì–´ì•¼ í•¨
                        // this.ui.els.fileInput.disabled = true;
                        // this.ui.els.fileInput.title = 'ìŠ¤ëƒ…ìƒ· ëª¨ë“œ - íŒŒì¼ ì—…ë¡œë“œ ë¶ˆê°€';
                    }, 200);
                }


                downloadSnapshot() {
                    if (!this.rawData) {
                        alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }

                    // [Fix] ëª¨ë“  ìƒíƒœ ë³€ìˆ˜ë¥¼ ì™„ë²½í•˜ê²Œ ì €ì¥í•˜ì—¬ ì›ë³¸ê³¼ ë™ì¼í•œ ë³µì› ë³´ì¥
                    const snapshot = {
                        // í•µì‹¬ ë°ì´í„°
                        rawData: this.rawData,

                        // í•„í„° ì„¤ì •
                        workTypes: this.currentWorkTypes || [],
                        allWorkTypes: this.allWorkTypes || [],
                        client: this.currentClient || '',

                        // ì—°ë„ ì„¤ì • (Multi-Year Selection í¬í•¨)
                        year: this.currentYear || 2025,
                        span: this.currentSpan || 3,
                        allYears: this.allYears || [],
                        currentSelectedYears: this.currentSelectedYears || [],
                        yearAggregationMethod: this.yearAggregationMethod || 'avg',

                        // ë¶„ì„ ëª¨ë“œ ë° ì˜ˆì¸¡ ë°ì´í„°
                        analysisMode: this.analysisMode || 'auto',
                        manualPredictions: this.manualPredictions || {},
                        autoCalculatedData: this.autoCalculatedData || null,

                        // ì •ë ¬ ìƒíƒœ
                        sortState: this.sortState || { key: null, direction: 'asc' },

                        // ê³ ê¸‰ ì„¤ì •
                        forecastSettings: this.domainService.forecastSettings,
                        simulationMode: this.simulationMode,
                        globalPriceModifier: this.globalPriceModifier,
                        sankeyDataMode: this.sankeyDataMode,

                        // ë©”íƒ€ë°ì´í„°
                        generatedAt: new Date().toISOString(),
                        version: '2.0' // ìŠ¤ëƒ…ìƒ· í˜¸í™˜ì„± ë²„ì „
                    };

                    let html = document.documentElement.outerHTML;

                    const scriptId = 'snapshot-data-script';
                    // Safe JSON stringify for script injection (prevent script tag in string)
                    const jsonStr = JSON.stringify(snapshot).replace(/<\/script>/gi, '<\\/script>');

                    // Construct the script tag safely (split to avoid browser interpretation)
                    const snapshotScript = '<script id="' + scriptId + '">window.__SNAPSHOT__ = ' + jsonStr + ';<' + '/script>';

                    // Remove existing snapshot script if any
                    const existingRegex = new RegExp('<script id="' + scriptId + '">[\\s\\S]*?<\\/script>');
                    html = html.replace(existingRegex, '');

                    // Inject after <head>
                    html = html.replace('<head>', '<head>' + snapshotScript);

                    const blob = new Blob([html], { type: 'text/html' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);

                    const clientSafe = this.currentClient ? this.currentClient.replace(/[\/\?%*:|"<>]/g, '_') : 'Result';
                    link.download = `${clientSafe}_Snapshot_${new Date().toISOString().slice(0, 10)}.html`;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

            }

            // [PRD/IMP] Advanced Settings Event Listeners - Separate initialization
            App.prototype.initAdvancedSettingsListeners = function () {
                // Toggle Advanced Settings Panel
                const toggleBtn = document.getElementById('toggleAdvancedSettings');
                const content = document.getElementById('advancedSettingsContent');
                const icon = document.getElementById('advancedSettingsIcon');
                if (toggleBtn && content && icon) {
                    toggleBtn.addEventListener('click', () => {
                        content.classList.toggle('hidden');
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                    });
                }

                // Forecasting Method Toggle
                const simpleBtn = document.getElementById('simpleAvgBtn');
                const wmaBtn = document.getElementById('wmaBtn');
                if (simpleBtn && wmaBtn) {
                    simpleBtn.addEventListener('click', () => {
                        this.domainService.updateForecastSettings({ method: 'simple' });
                        simpleBtn.classList.add('bg-violet-600', 'text-white', 'shadow-sm');
                        simpleBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                        wmaBtn.classList.remove('bg-violet-600', 'text-white', 'shadow-sm');
                        wmaBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
                        if (this.rawData) this.runAnalysis();
                    });
                    wmaBtn.addEventListener('click', () => {
                        this.domainService.updateForecastSettings({ method: 'wma' }); // ê°€ì¤‘í‰ê·  ë°©ì‹ ì ìš©
                        wmaBtn.classList.add('bg-violet-600', 'text-white', 'shadow-sm');
                        wmaBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                        simpleBtn.classList.remove('bg-violet-600', 'text-white', 'shadow-sm');
                        simpleBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
                        if (this.rawData) this.runAnalysis();
                    });
                }

                // Inflation Rate Input
                const inflationInput = document.getElementById('inflationRate');
                if (inflationInput) {
                    let debounceTimer;
                    inflationInput.addEventListener('input', (e) => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            this.domainService.updateForecastSettings({ inflationRate: e.target.value });
                            if (this.rawData) this.runAnalysis();
                        }, 300); // Debounce for performance
                    });
                }

                // Simulation Mode
                const simModeBtn = document.getElementById('simulationModeBtn');
                const simActivePanel = document.getElementById('simulationActivePanel');
                const exitSimBtn = document.getElementById('exitSimulationBtn');
                const globalModifier = document.getElementById('globalPriceModifier');
                const globalModifierValue = document.getElementById('globalPriceModifierValue');

                if (simModeBtn && simActivePanel) {
                    simModeBtn.addEventListener('click', () => {
                        this.simulationMode = true;
                        simActivePanel.classList.remove('hidden');
                        simModeBtn.innerHTML = '<i class="fa-solid fa-check"></i><span>í™œì„±í™”ë¨</span>';
                        simModeBtn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-400');
                        // Enable inline sliders in manual mode
                        this.setAnalysisMode('manual');
                    });
                }

                if (exitSimBtn && simActivePanel && simModeBtn) {
                    exitSimBtn.addEventListener('click', () => {
                        this.simulationMode = false;
                        this.globalPriceModifier = 0;
                        simActivePanel.classList.add('hidden');
                        simModeBtn.innerHTML = '<i class="fa-solid fa-play"></i><span>ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</span>';
                        simModeBtn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-400');
                        if (globalModifier) globalModifier.value = 0;
                        if (globalModifierValue) globalModifierValue.textContent = '0%';
                        if (this.rawData) this.runAnalysis();
                    });
                }

                if (globalModifier && globalModifierValue) {
                    globalModifier.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value);
                        this.globalPriceModifier = val;
                        globalModifierValue.textContent = (val >= 0 ? '+' : '') + val + '%';
                        // Apply global price modifier immediately
                        this.applyGlobalPriceModifier(val);
                    });
                }

                // Sankey Modal
                const openSankeyBtn = document.getElementById('openSankeyBtn');
                const closeSankeyBtn = document.getElementById('closeSankeyBtn');
                const closeSankeyBtn2 = document.getElementById('closeSankeyBtn2');
                const sankeyModal = document.getElementById('sankeyModal');
                const sankeyOverlay = document.getElementById('sankeyModalOverlay');

                if (openSankeyBtn && sankeyModal) {
                    openSankeyBtn.addEventListener('click', () => {
                        if (!this.autoCalculatedData) {
                            alert('ë¨¼ì € ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                            return;
                        }
                        sankeyModal.classList.remove('hidden');
                        this.renderSankeyDiagram();
                    });
                }

                const closeSankey = () => {
                    if (sankeyModal) sankeyModal.classList.add('hidden');
                };
                if (closeSankeyBtn) closeSankeyBtn.addEventListener('click', closeSankey);
                if (closeSankeyBtn2) closeSankeyBtn2.addEventListener('click', closeSankey);
                if (sankeyOverlay) sankeyOverlay.addEventListener('click', closeSankey);

                // Sankey Top-N Filter
                const sankeyTopN = document.getElementById('sankeyTopN');
                if (sankeyTopN) {
                    sankeyTopN.addEventListener('change', () => this.renderSankeyDiagram());
                }

                // Sankey Data Mode Toggle
                const sankeyAutoBtn = document.getElementById('sankeyAutoDataBtn');
                const sankeyManualBtn = document.getElementById('sankeyManualDataBtn');
                if (sankeyAutoBtn && sankeyManualBtn) {
                    sankeyAutoBtn.addEventListener('click', () => {
                        this.sankeyDataMode = 'auto';
                        sankeyAutoBtn.classList.add('bg-blue-600', 'text-white');
                        sankeyAutoBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                        sankeyManualBtn.classList.remove('bg-blue-600', 'text-white');
                        sankeyManualBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
                        this.renderSankeyDiagram();
                    });
                    sankeyManualBtn.addEventListener('click', () => {
                        this.sankeyDataMode = 'manual';
                        sankeyManualBtn.classList.add('bg-blue-600', 'text-white');
                        sankeyManualBtn.classList.remove('text-slate-600', 'hover:bg-slate-100');
                        sankeyAutoBtn.classList.remove('bg-blue-600', 'text-white');
                        sankeyAutoBtn.classList.add('text-slate-600', 'hover:bg-slate-100');
                        this.renderSankeyDiagram();
                    });
                }

                // Export Sankey as Image
                const exportSankeyBtn = document.getElementById('exportSankeyBtn');
                if (exportSankeyBtn) {
                    exportSankeyBtn.addEventListener('click', () => this.exportSankeyAsImage());
                }

                // [New] Work Type Select All / Deselect All Buttons
                const workTypeSelectAllBtn = document.getElementById('workTypeSelectAllBtn');
                const workTypeDeselectAllBtn = document.getElementById('workTypeDeselectAllBtn');
                const workTypeOptionsContainer = document.getElementById('workTypeOptions');
                const workTypeSelectionCount = document.getElementById('workTypeSelectionCount');

                const updateWorkTypeSelectionCount = () => {
                    if (workTypeOptionsContainer && workTypeSelectionCount) {
                        const checked = workTypeOptionsContainer.querySelectorAll('input:checked').length;
                        const total = workTypeOptionsContainer.querySelectorAll('input[type="checkbox"]').length;
                        workTypeSelectionCount.textContent = `${checked}ê°œ ì„ íƒë¨ / ì´ ${total}ê°œ`;
                    }
                };

                if (workTypeSelectAllBtn && workTypeOptionsContainer) {
                    workTypeSelectAllBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkboxes = workTypeOptionsContainer.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = true);
                        updateWorkTypeSelectionCount();
                        // Trigger change event to update analysis
                        this.ui.els.workTypeDropdown.dispatchEvent(new Event('change'));
                        this.ui.updateMultiSelectLabel({
                            wrapper: this.ui.els.workTypeWrapper,
                            btn: this.ui.els.workTypeBtn,
                            btnText: this.ui.els.workTypeBtnText,
                            dropdown: this.ui.els.workTypeDropdown
                        });
                    });
                }

                if (workTypeDeselectAllBtn && workTypeOptionsContainer) {
                    workTypeDeselectAllBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const checkboxes = workTypeOptionsContainer.querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => cb.checked = false);
                        updateWorkTypeSelectionCount();
                        // Trigger change event
                        this.ui.els.workTypeDropdown.dispatchEvent(new Event('change'));
                        this.ui.updateMultiSelectLabel({
                            wrapper: this.ui.els.workTypeWrapper,
                            btn: this.ui.els.workTypeBtn,
                            btnText: this.ui.els.workTypeBtnText,
                            dropdown: this.ui.els.workTypeDropdown
                        });
                    });
                }



                // [Fix] í´ë¦­ ê¸°ë°˜ íˆ´íŒ í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
                this.initClickTooltips();

                // [New] ëª¨ë‹¬ ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ì´ˆê¸°í™”
                this.initModalControls('comparisonModal');
                this.initModalControls('sankeyModal');
                this.initModalControls('rawDataModal');
                this.initModalControls('fullscreenTableModal');
                this.initModalControls('statDetailModal');
            };

            // [PRD/IMP] Draggable & Resizable Modal Controls (ç„¡ç¼ºæ€§ ä¿è­‰)
            App.prototype.initModalControls = function (modalWrapperId) {
                const wrapper = document.getElementById(modalWrapperId);
                if (!wrapper) return;

                const panel = wrapper.querySelector('.modal-panel');
                const header = panel ? panel.querySelector('.modal-header-handle') : null;
                if (!panel || !header) return;

                // Create observer to handle initial positioning when modal becomes visible
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.attributeName === 'class' && !wrapper.classList.contains('hidden')) {
                            // Reset Position when opening
                            this.resetModalPosition(panel);
                        }
                    });
                });
                observer.observe(wrapper, { attributes: true, attributeFilter: ['class'] });

                // Dragging logic
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;

                header.addEventListener('mousedown', (e) => {
                    if (e.target.closest('button')) return; // Ignore if clicking buttons in header
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialLeft = panel.offsetLeft;
                    initialTop = panel.offsetTop;
                    header.style.cursor = 'grabbing';
                    e.preventDefault();
                });

                // Resizing logic
                let isResizing = false;
                let resizeType = null;
                let startW, startH;

                panel.querySelectorAll('.resize-handle').forEach(handle => {
                    handle.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        resizeType = handle.dataset.resize;
                        startX = e.clientX;
                        startY = e.clientY;
                        startW = panel.offsetWidth;
                        startH = panel.offsetHeight;
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

                const onMouseMove = (e) => {
                    if (isDragging) {
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        panel.style.left = (initialLeft + dx) + 'px';
                        panel.style.top = (initialTop + dy) + 'px';
                        panel.style.transform = 'none'; // Clear translate while dragging
                    } else if (isResizing) {
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;

                        if (resizeType === 'e' || resizeType === 'se') {
                            panel.style.width = Math.max(400, startW + dx) + 'px';
                        }
                        if (resizeType === 's' || resizeType === 'se') {
                            panel.style.height = Math.max(200, startH + dy) + 'px';
                        }
                    }
                };

                const onMouseUp = () => {
                    isDragging = false;
                    isResizing = false;
                    if (header) header.style.cursor = 'grab';
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            // Reset modal to center (Safe & Stable Layout)
            App.prototype.resetModalPosition = function (panel) {
                if (!panel) return;

                // [Fix] ë¸Œë¼ìš°ì € ë Œë”ë§ ì‚¬ì´í´ ëŒ€ê¸° (í™”ë©´ ì •ì§€ ë°©ì§€)
                requestAnimationFrame(() => {
                    // íŒ¨ë„ì´ ì‹¤ì œ í™”ë©´ì— ë Œë”ë§ë˜ì—ˆëŠ”ì§€ í™•ì¸
                    if (panel.offsetParent === null) return;

                    // 1. ì„ì‹œ ì¤‘ì•™ ì •ë ¬ (CSS Transform í™œìš©)
                    panel.style.top = '50%';
                    panel.style.left = '50%';
                    panel.style.transform = 'translate(-50%, -50%)';

                    // 2. ë ˆì´ì•„ì›ƒì´ ì•ˆì •í™”ëœ í›„ ì ˆëŒ€ ì¢Œí‘œë¡œ ë³€í™˜ (ë“œë˜ê·¸ ì§€ì›)
                    requestAnimationFrame(() => {
                        const rect = panel.getBoundingClientRect();

                        // ë³€í™˜
                        panel.style.transform = 'none';
                        panel.style.left = rect.left + 'px';
                        panel.style.top = rect.top + 'px';
                        // í¬ê¸° ê³ ì • (ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì°Œê·¸ëŸ¬ì§ ë°©ì§€)
                        panel.style.width = rect.width + 'px';
                        panel.style.height = rect.height + 'px';
                    });
                });
            };

            // [Fix] í´ë¦­ ê¸°ë°˜ íˆ´íŒ ì‹œìŠ¤í…œ - ë¬¼ìŒí‘œë¥¼ ì •í™•íˆ í´ë¦­í•´ì•¼ë§Œ íˆ´íŒ í‘œì‹œ
            App.prototype.initClickTooltips = function () {
                const tooltipTriggers = document.querySelectorAll('.tooltip-trigger[data-tooltip-target]');

                // í˜„ì¬ ì—´ë¦° íˆ´íŒ ì¶”ì 
                let currentOpenTooltip = null;
                let currentActiveTrigger = null;

                // ë‹¤ë¥¸ ê³³ í´ë¦­ ì‹œ íˆ´íŒ ë‹«ê¸°
                const closeAllTooltips = (e) => {
                    // í´ë¦­ ëŒ€ìƒì´ íˆ´íŒ íŒ¨ë„ì´ë‚˜ íŠ¸ë¦¬ê±°ê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë‹«ê¸°
                    if (currentOpenTooltip && !currentOpenTooltip.contains(e.target) && e.target !== currentActiveTrigger) {
                        currentOpenTooltip.classList.remove('show');
                        if (currentActiveTrigger) {
                            currentActiveTrigger.classList.remove('active');
                        }
                        currentOpenTooltip = null;
                        currentActiveTrigger = null;
                    }
                };

                // ë¬¸ì„œ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.addEventListener('click', closeAllTooltips);

                // ê° ë¬¼ìŒí‘œ ì•„ì´ì½˜ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                tooltipTriggers.forEach(trigger => {
                    trigger.addEventListener('click', (e) => {
                        e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€

                        const targetId = trigger.dataset.tooltipTarget;
                        const tooltipPanel = document.querySelector(`[data-tooltip-panel="${targetId}"]`);

                        if (!tooltipPanel) return;

                        // ê°™ì€ íˆ´íŒì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ í† ê¸€ (ë‹«ê¸°)
                        if (currentOpenTooltip === tooltipPanel) {
                            tooltipPanel.classList.remove('show');
                            trigger.classList.remove('active');
                            currentOpenTooltip = null;
                            currentActiveTrigger = null;
                            console.log('ğŸ“ [Tooltip] ë‹«í˜:', targetId);
                            return;
                        }

                        // ë‹¤ë¥¸ íˆ´íŒì´ ì—´ë ¤ ìˆìœ¼ë©´ ë¨¼ì € ë‹«ê¸°
                        if (currentOpenTooltip) {
                            currentOpenTooltip.classList.remove('show');
                            if (currentActiveTrigger) {
                                currentActiveTrigger.classList.remove('active');
                            }
                        }

                        // ìƒˆ íˆ´íŒ ì—´ê¸°
                        tooltipPanel.classList.add('show');
                        trigger.classList.add('active');
                        currentOpenTooltip = tooltipPanel;
                        currentActiveTrigger = trigger;
                        console.log('ğŸ“ [Tooltip] ì—´ë¦¼:', targetId);
                    });
                });

                // ESC í‚¤ë¡œ íˆ´íŒ ë‹«ê¸°
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && currentOpenTooltip) {
                        currentOpenTooltip.classList.remove('show');
                        if (currentActiveTrigger) {
                            currentActiveTrigger.classList.remove('active');
                        }
                        currentOpenTooltip = null;
                        currentActiveTrigger = null;
                    }
                });

                console.log('ğŸ“ [Tooltip] í´ë¦­ ê¸°ë°˜ íˆ´íŒ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ, íŠ¸ë¦¬ê±° ìˆ˜:', tooltipTriggers.length);
            };

            // [PRD/IMP] Apply Global Price Modifier
            App.prototype.applyGlobalPriceModifier = function (percentage) {
                if (!this.autoCalculatedData || !this.autoCalculatedData.results) return;

                const factor = 1 + (percentage / 100);

                // Apply to all buildings as simulation
                this.autoCalculatedData.results.forEach(row => {
                    if (!this.manualPredictions[row.building]) {
                        this.manualPredictions[row.building] = {};
                    }
                    // Apply modifier to unit amount
                    const originalAvgUnitAmount = this.autoCalculatedData.results.find(r => r.building === row.building)?.avgUnitAmount || 0;
                    this.manualPredictions[row.building].avgUnitAmount = Math.round(originalAvgUnitAmount * factor);
                });

                this.runAnalysis();
            };

            // [PRD/IMP] Sankey Diagram Renderer (Pure SVG) - Enhanced
            App.prototype.renderSankeyDiagram = function () {
                const svg = document.getElementById('sankeySvg');
                const container = document.getElementById('sankeyContainer');
                const totalAmountEl = document.getElementById('sankeyTotalAmount');
                const topNSelect = document.getElementById('sankeyTopN');
                const tooltip = document.getElementById('sankeyTooltip');
                const tooltipContent = document.getElementById('sankeyTooltipContent');

                if (!svg || !container || !this.autoCalculatedData) return;

                const topN = topNSelect?.value === 'all' ? 999 : parseInt(topNSelect?.value || 10);
                const data = this.sankeyDataMode === 'manual' && Object.keys(this.manualPredictions).length > 0
                    ? this.getManualAnalysisData()
                    : this.autoCalculatedData;

                if (!data || !data.results) return;

                // Clear existing
                svg.innerHTML = '';

                const width = container.clientWidth - 40;
                const height = 500;
                const nodeWidth = 24;
                const nodePadding = 12;
                const labelOffset = 130; // ë ˆì´ë¸” ê³µê°„ í™•ë³´

                // Prepare data structure
                const client = this.currentClient || 'ì „ì²´';
                const workTypes = this.currentWorkTypes || ['ì „ì²´'];

                // Sort buildings by avgAmount and take Top-N
                const sortedBuildings = [...data.results]
                    .sort((a, b) => b.avgAmount - a.avgAmount)
                    .slice(0, topN);

                const othersAmount = data.results
                    .filter((_, i) => i >= topN)
                    .reduce((sum, b) => sum + b.avgAmount, 0);

                const totalAmount = data.results.reduce((sum, b) => sum + b.avgAmount, 0);
                if (totalAmountEl) {
                    totalAmountEl.textContent = `ì´ ì˜ˆì¸¡ê¸ˆì•¡: ${FormatUtils.currency(totalAmount)}ì›`;
                }

                // Calculate min/max for color gradient
                const amounts = sortedBuildings.map(b => b.avgAmount);
                const maxAmount = Math.max(...amounts);
                const minAmount = Math.min(...amounts);
                const amountRange = maxAmount - minAmount || 1;

                // Color function: gradient from blue (low) to red (high)
                const getAmountColor = (amount) => {
                    const ratio = (amount - minAmount) / amountRange;
                    // Blue (low) -> Yellow (mid) -> Red (high)
                    if (ratio < 0.5) {
                        const r = Math.round(ratio * 2 * 255);
                        const g = Math.round(ratio * 2 * 200);
                        const b = Math.round(255 - ratio * 2 * 200);
                        return `rgb(${r}, ${g}, ${b})`;
                    } else {
                        const r = 255;
                        const g = Math.round(200 - (ratio - 0.5) * 2 * 200);
                        const b = Math.round(55 - (ratio - 0.5) * 2 * 55);
                        return `rgb(${r}, ${g}, ${b})`;
                    }
                };

                // Color palettes
                const colors = {
                    client: '#3b82f6',
                    workType: ['#8b5cf6', '#a855f7', '#c084fc', '#d8b4fe'],
                    building: '#10b981',
                    total: '#f59e0b'
                };

                // Calculate node positions with more spacing for labels
                const levelX = [20, width * 0.28 + labelOffset, width * 0.62, width - nodeWidth - 20];

                // Nodes data
                const nodes = [];
                const links = [];

                // Client node (Level 0)
                nodes.push({
                    id: 'client',
                    label: client,
                    level: 0,
                    value: totalAmount,
                    color: colors.client,
                    x: levelX[0],
                    y: height / 2 - 50,
                    height: 100
                });

                // Work Type nodes (Level 1)
                const workTypeNodeHeight = Math.max(35, (height - 80) / workTypes.length - nodePadding);
                workTypes.forEach((wt, i) => {
                    const wtAmount = totalAmount / workTypes.length;
                    nodes.push({
                        id: `wt_${i}`,
                        label: wt.length > 10 ? wt.substring(0, 10) + '...' : wt,
                        fullLabel: wt,
                        level: 1,
                        value: wtAmount,
                        color: colors.workType[i % colors.workType.length],
                        x: levelX[1],
                        y: 40 + i * (workTypeNodeHeight + nodePadding),
                        height: workTypeNodeHeight
                    });

                    links.push({
                        source: 'client',
                        target: `wt_${i}`,
                        value: wtAmount,
                        color: colors.workType[i % colors.workType.length]
                    });
                });

                // Building nodes (Level 2) with color gradient
                const buildingList = othersAmount > 0
                    ? [...sortedBuildings, { building: 'ê¸°íƒ€', avgAmount: othersAmount }]
                    : sortedBuildings;

                const buildingNodeHeight = Math.max(22, (height - 60) / buildingList.length - 6);
                buildingList.forEach((b, i) => {
                    const buildingColor = getAmountColor(b.avgAmount);
                    nodes.push({
                        id: `bld_${i}`,
                        label: b.building.length > 8 ? b.building.substring(0, 8) + '..' : b.building,
                        fullLabel: b.building,
                        level: 2,
                        value: b.avgAmount,
                        color: buildingColor,
                        isBuilding: true,
                        rank: i + 1,
                        x: levelX[2],
                        y: 20 + i * (buildingNodeHeight + 5),
                        height: buildingNodeHeight
                    });

                    workTypes.forEach((_, wtIdx) => {
                        links.push({
                            source: `wt_${wtIdx}`,
                            target: `bld_${i}`,
                            value: b.avgAmount / workTypes.length,
                            color: buildingColor
                        });
                    });
                });

                // Total node (Level 3)
                nodes.push({
                    id: 'total',
                    label: 'ì´ ì˜ˆì¸¡',
                    level: 3,
                    value: totalAmount,
                    color: colors.total,
                    x: levelX[3],
                    y: height / 2 - 50,
                    height: 100
                });

                // Links from buildings to total
                buildingList.forEach((b, i) => {
                    links.push({
                        source: `bld_${i}`,
                        target: 'total',
                        value: b.avgAmount,
                        color: getAmountColor(b.avgAmount)
                    });
                });

                // Render SVG
                const svgNS = 'http://www.w3.org/2000/svg';

                // Create gradient definitions
                const defs = document.createElementNS(svgNS, 'defs');

                // Building icon pattern
                const buildingIconPath = 'M3 21h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18V7H3v2zm0-6v2h18V3H3z';

                nodes.forEach(n => {
                    const grad = document.createElementNS(svgNS, 'linearGradient');
                    grad.id = `grad_${n.id}`;
                    grad.setAttribute('x1', '0%');
                    grad.setAttribute('y1', '0%');
                    grad.setAttribute('x2', '100%');
                    grad.setAttribute('y2', '100%');
                    grad.innerHTML = `
                    <stop offset="0%" style="stop-color:${n.color};stop-opacity:1"/>
                    <stop offset="100%" style="stop-color:${this.adjustColor(n.color, -40)};stop-opacity:1"/>
                `;
                    defs.appendChild(grad);
                });
                svg.appendChild(defs);

                // Draw links (bezier curves) - behind nodes
                const linksGroup = document.createElementNS(svgNS, 'g');
                linksGroup.setAttribute('class', 'sankey-links');

                links.forEach(link => {
                    const source = nodes.find(n => n.id === link.source);
                    const target = nodes.find(n => n.id === link.target);
                    if (!source || !target) return;

                    const x0 = source.x + nodeWidth;
                    const y0 = source.y + source.height / 2;
                    const x1 = target.x;
                    const y1 = target.y + target.height / 2;

                    const thickness = Math.max(1.5, Math.min(18, (link.value / totalAmount) * 50));

                    const path = document.createElementNS(svgNS, 'path');
                    const cp = (x1 - x0) * 0.5;
                    path.setAttribute('d', `M${x0},${y0} C${x0 + cp},${y0} ${x1 - cp},${y1} ${x1},${y1}`);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('stroke', link.color);
                    path.setAttribute('stroke-width', thickness);
                    path.setAttribute('stroke-opacity', '0.35');
                    path.setAttribute('class', 'sankey-link cursor-pointer transition-all duration-200');

                    path.addEventListener('mouseenter', () => {
                        path.setAttribute('stroke-opacity', '0.75');
                        path.setAttribute('stroke-width', thickness + 2);
                    });
                    path.addEventListener('mouseleave', () => {
                        path.setAttribute('stroke-opacity', '0.35');
                        path.setAttribute('stroke-width', thickness);
                    });

                    linksGroup.appendChild(path);
                });
                svg.appendChild(linksGroup);

                // Draw nodes on top of links
                const nodesGroup = document.createElementNS(svgNS, 'g');
                nodesGroup.setAttribute('class', 'sankey-nodes');

                nodes.forEach(node => {
                    const g = document.createElementNS(svgNS, 'g');
                    g.setAttribute('class', 'sankey-node cursor-pointer');

                    // Node rectangle with rounded corners
                    const rect = document.createElementNS(svgNS, 'rect');
                    rect.setAttribute('x', node.x);
                    rect.setAttribute('y', node.y);
                    rect.setAttribute('width', nodeWidth);
                    rect.setAttribute('height', node.height);
                    rect.setAttribute('rx', 5);
                    rect.setAttribute('fill', `url(#grad_${node.id})`);
                    rect.setAttribute('stroke', this.adjustColor(node.color, -60));
                    rect.setAttribute('stroke-width', '1');
                    rect.setAttribute('class', 'transition-all duration-200');
                    g.appendChild(rect);

                    // Building icon for building nodes
                    if (node.isBuilding) {
                        const iconSize = Math.min(12, node.height - 4);
                        const iconY = node.y + (node.height - iconSize) / 2;

                        // Building icon (simple house shape)
                        const icon = document.createElementNS(svgNS, 'path');
                        const ix = node.x + 3;
                        const iy = iconY;
                        const s = iconSize / 16;
                        // Simple building icon path
                        icon.setAttribute('d', `M${ix + 2 * s},${iy + 14 * s} L${ix + 2 * s},${iy + 8 * s} L${ix + 8 * s},${iy + 4 * s} L${ix + 14 * s},${iy + 8 * s} L${ix + 14 * s},${iy + 14 * s} Z M${ix + 6 * s},${iy + 14 * s} L${ix + 6 * s},${iy + 10 * s} L${ix + 10 * s},${iy + 10 * s} L${ix + 10 * s},${iy + 14 * s}`);
                        icon.setAttribute('fill', 'rgba(255,255,255,0.8)');
                        icon.setAttribute('stroke', 'none');
                        g.appendChild(icon);
                    }

                    // Calculate percentage
                    const percentage = ((node.value / totalAmount) * 100).toFixed(1);

                    // Label with amount and percentage (positioned to avoid overlap)
                    if (node.level === 0) {
                        // Client: label on right side
                        const text = document.createElementNS(svgNS, 'text');
                        text.setAttribute('x', node.x + nodeWidth + 10);
                        text.setAttribute('y', node.y + node.height / 2 - 6);
                        text.setAttribute('text-anchor', 'start');
                        text.setAttribute('font-size', '12');
                        text.setAttribute('fill', '#1e293b');
                        text.setAttribute('font-weight', '600');
                        text.textContent = node.label;
                        g.appendChild(text);

                        // Amount below
                        const amountText = document.createElementNS(svgNS, 'text');
                        amountText.setAttribute('x', node.x + nodeWidth + 10);
                        amountText.setAttribute('y', node.y + node.height / 2 + 10);
                        amountText.setAttribute('text-anchor', 'start');
                        amountText.setAttribute('font-size', '10');
                        amountText.setAttribute('fill', '#64748b');
                        amountText.textContent = FormatUtils.currency(node.value) + 'ì›';
                        g.appendChild(amountText);

                    } else if (node.level === 1) {
                        // Work Type: label on right side
                        const text = document.createElementNS(svgNS, 'text');
                        text.setAttribute('x', node.x + nodeWidth + 8);
                        text.setAttribute('y', node.y + node.height / 2 - 4);
                        text.setAttribute('text-anchor', 'start');
                        text.setAttribute('font-size', '11');
                        text.setAttribute('fill', '#334155');
                        text.setAttribute('font-weight', '500');
                        text.textContent = node.label;
                        g.appendChild(text);

                        // Percentage below
                        const pctText = document.createElementNS(svgNS, 'text');
                        pctText.setAttribute('x', node.x + nodeWidth + 8);
                        pctText.setAttribute('y', node.y + node.height / 2 + 9);
                        pctText.setAttribute('text-anchor', 'start');
                        pctText.setAttribute('font-size', '9');
                        pctText.setAttribute('fill', '#94a3b8');
                        pctText.textContent = `${percentage}%`;
                        g.appendChild(pctText);

                    } else if (node.level === 2) {
                        // Building: label on LEFT side to avoid link overlap
                        const text = document.createElementNS(svgNS, 'text');
                        text.setAttribute('x', node.x - 8);
                        text.setAttribute('y', node.y + node.height / 2 - 3);
                        text.setAttribute('text-anchor', 'end');
                        text.setAttribute('font-size', '10');
                        text.setAttribute('fill', '#334155');
                        text.setAttribute('font-weight', '500');

                        // Building icon character + name
                        const rankBadge = node.rank <= 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][node.rank - 1] : `${node.rank}.`;
                        text.textContent = `ğŸ¢${node.label}`;
                        g.appendChild(text);

                        // Amount and percentage below
                        const detailText = document.createElementNS(svgNS, 'text');
                        detailText.setAttribute('x', node.x - 8);
                        detailText.setAttribute('y', node.y + node.height / 2 + 8);
                        detailText.setAttribute('text-anchor', 'end');
                        detailText.setAttribute('font-size', '9');
                        detailText.setAttribute('fill', '#64748b');

                        // Compact amount format
                        const compactAmount = node.value >= 100000000
                            ? (node.value / 100000000).toFixed(1) + 'ì–µ'
                            : node.value >= 10000
                                ? (node.value / 10000).toFixed(0) + 'ë§Œ'
                                : FormatUtils.currency(node.value);
                        detailText.textContent = `${compactAmount} (${percentage}%)`;
                        g.appendChild(detailText);

                    } else {
                        // Total: label on left side
                        const text = document.createElementNS(svgNS, 'text');
                        text.setAttribute('x', node.x - 10);
                        text.setAttribute('y', node.y + node.height / 2 - 6);
                        text.setAttribute('text-anchor', 'end');
                        text.setAttribute('font-size', '12');
                        text.setAttribute('fill', '#1e293b');
                        text.setAttribute('font-weight', '700');
                        text.textContent = 'ğŸ“Š ' + node.label;
                        g.appendChild(text);

                        // Total amount below
                        const amountText = document.createElementNS(svgNS, 'text');
                        amountText.setAttribute('x', node.x - 10);
                        amountText.setAttribute('y', node.y + node.height / 2 + 10);
                        amountText.setAttribute('text-anchor', 'end');
                        amountText.setAttribute('font-size', '11');
                        amountText.setAttribute('fill', '#f59e0b');
                        amountText.setAttribute('font-weight', '600');
                        amountText.textContent = FormatUtils.currency(node.value) + 'ì›';
                        g.appendChild(amountText);
                    }

                    // Tooltip interaction
                    g.addEventListener('mouseenter', (e) => {
                        rect.setAttribute('stroke-width', '2');
                        rect.setAttribute('filter', 'drop-shadow(0 4px 6px rgba(0,0,0,0.2))');

                        const rankInfo = node.isBuilding ? `<div class="text-xs text-slate-400">ìˆœìœ„: ${node.rank}ìœ„</div>` : '';
                        tooltipContent.innerHTML = `
                        <div class="font-bold mb-1 text-sm">${node.isBuilding ? 'ğŸ¢ ' : ''}${node.fullLabel || node.label}</div>
                        <div class="text-slate-300">ê¸ˆì•¡: <span class="font-semibold text-white">${FormatUtils.currency(node.value)}ì›</span></div>
                        <div class="text-slate-300">ë¹„ìœ¨: <span class="font-semibold text-white">${percentage}%</span></div>
                        ${rankInfo}
                    `;
                        tooltip.classList.remove('hidden');
                        tooltip.style.left = (e.clientX - container.getBoundingClientRect().left + 15) + 'px';
                        tooltip.style.top = (e.clientY - container.getBoundingClientRect().top + 15) + 'px';
                    });

                    g.addEventListener('mouseleave', () => {
                        rect.setAttribute('stroke-width', '1');
                        rect.setAttribute('filter', '');
                        tooltip.classList.add('hidden');
                    });

                    g.addEventListener('mousemove', (e) => {
                        tooltip.style.left = (e.clientX - container.getBoundingClientRect().left + 15) + 'px';
                        tooltip.style.top = (e.clientY - container.getBoundingClientRect().top + 15) + 'px';
                    });

                    nodesGroup.appendChild(g);
                });
                svg.appendChild(nodesGroup);

                // Legend for color scale
                const legendGroup = document.createElementNS(svgNS, 'g');
                // [Design] Move Legend to Bottom-Left to avoid overlap with Top-Right nodes
                legendGroup.setAttribute('transform', `translate(20, ${height - 50})`);

                // Gradient legend bar
                const legendGrad = document.createElementNS(svgNS, 'linearGradient');
                legendGrad.id = 'legendGradient';
                legendGrad.setAttribute('x1', '0%');
                legendGrad.setAttribute('y1', '0%');
                legendGrad.setAttribute('x2', '100%');
                legendGrad.setAttribute('y2', '0%');
                legendGrad.innerHTML = `
                <stop offset="0%" style="stop-color:rgb(45,212,191);stop-opacity:1"/>
                <stop offset="50%" style="stop-color:rgb(129,140,248);stop-opacity:1"/>
                <stop offset="100%" style="stop-color:rgb(251,113,133);stop-opacity:1"/>
            `; // Matches the new pastel gradient (Teal -> Indigo -> Rose)
                defs.appendChild(legendGrad);

                const legendTitle = document.createElementNS(svgNS, 'text');
                legendTitle.setAttribute('x', 0);
                legendTitle.setAttribute('y', -5);
                legendTitle.setAttribute('font-size', '10');
                legendTitle.setAttribute('fill', '#64748b');
                legendTitle.textContent = 'ê¸ˆì•¡ ê·œëª¨ (Pastel Scale)';
                legendGroup.appendChild(legendTitle);

                const legendRect = document.createElementNS(svgNS, 'rect');
                legendRect.setAttribute('x', 0);
                legendRect.setAttribute('y', 0);
                legendRect.setAttribute('width', 120);
                legendRect.setAttribute('height', 10);
                legendRect.setAttribute('rx', 3);
                legendRect.setAttribute('fill', 'url(#legendGradient)');
                legendGroup.appendChild(legendRect);

                const legendMin = document.createElementNS(svgNS, 'text');
                legendMin.setAttribute('x', 0);
                legendMin.setAttribute('y', 22);
                legendMin.setAttribute('font-size', '9');
                legendMin.setAttribute('fill', '#94a3b8');
                legendMin.textContent = 'Low';
                legendGroup.appendChild(legendMin);

                const legendMax = document.createElementNS(svgNS, 'text');
                legendMax.setAttribute('x', 120);
                legendMax.setAttribute('y', 22);
                legendMax.setAttribute('text-anchor', 'end');
                legendMax.setAttribute('font-size', '9');
                legendMax.setAttribute('fill', '#94a3b8');
                legendMax.textContent = 'High';
                legendGroup.appendChild(legendMax);

                svg.appendChild(legendGroup);
            };


            // [Utility] Adjust color brightness
            App.prototype.adjustColor = function (color, amount) {
                const clamp = (num) => Math.min(255, Math.max(0, num));
                const hex = color.replace('#', '');
                const r = clamp(parseInt(hex.substring(0, 2), 16) + amount);
                const g = clamp(parseInt(hex.substring(2, 4), 16) + amount);
                const b = clamp(parseInt(hex.substring(4, 6), 16) + amount);
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            };

            // [FIX] Sankey Diagram Logic Fixed (V4 - Simple Unclassified Restore)
            // User Request: "Restore Unclassified view."
            App.prototype.renderSankeyDiagramV4 = function (inputData = null) {
                console.log('ğŸŒŠ [Sankey] Rendering started (V4 Simple Unclassified)...');
                const svg = document.getElementById('sankeySvg');

                // [Debug] Visual Indicator
                const title = document.querySelector('.sankey-modal-title');
                if (title) title.textContent = 'ìê¸ˆ íë¦„ Sankey ë‹¤ì´ì–´ê·¸ë¨ (v4)';
                const container = document.getElementById('sankeyContainer');
                const totalAmountEl = document.getElementById('sankeyTotalAmount');
                const topNSelect = document.getElementById('sankeyTopN');
                const tooltip = document.getElementById('sankeyTooltip');
                const tooltipContent = document.getElementById('sankeyTooltipContent');

                let data = inputData;
                if (!data && this.sankeyDataMode === 'auto') data = this.autoCalculatedData;
                else if (!data && this.sankeyDataMode === 'manual') data = this.getManualAnalysisData();

                if (!svg || !container || !data || !data.results) {
                    console.warn('âš ï¸ [Sankey] Missing required elements or data');
                    return;
                }

                if (tooltip) tooltip.style.zIndex = '10000';

                // [Helper] Smart Amount Formatter
                const formatSmartAmount = (val) => {
                    if (val >= 100000000) { // 1ì–µ ì´ìƒ
                        return (val / 100000000).toFixed(2) + 'ì–µì›'; // ì†Œìˆ˜ì  2ìë¦¬ë¡œ ì •ë°€ë„ í–¥ìƒ
                    } else if (val >= 1000000) { // 1ë°±ë§Œ ì´ìƒ
                        return (val / 1000000).toFixed(1) + 'ë°±ë§Œì›'; // 1.5ë°±ë§Œì›
                    } else if (val >= 10000) { // 1ë§Œ ì´ìƒ
                        return (val / 10000).toFixed(0) + 'ë§Œì›';
                    } else {
                        return FormatUtils.currency(val) + 'ì›';
                    }
                };

                // 1. Data Prep
                const topN = topNSelect && topNSelect.value !== 'all' ? parseInt(topNSelect.value) : (topNSelect?.value === 'all' ? 999 : 10);
                const sortedBuildings = [...data.results].sort((a, b) => b.avgAmount - a.avgAmount);
                const topBuildings = sortedBuildings.slice(0, topN);

                // [FIX] Sort: Force 'Others/External' to Bottom of the list
                topBuildings.sort((a, b) => {
                    const isA_Other = a.building.includes('ê¸°íƒ€') || a.building.includes('ì™¸ë¶€');
                    const isB_Other = b.building.includes('ê¸°íƒ€') || b.building.includes('ì™¸ë¶€');
                    if (isA_Other && !isB_Other) return 1;
                    if (!isA_Other && isB_Other) return -1;
                    return b.avgAmount - a.avgAmount;
                });



                const totalAmount = data.results.reduce((sum, b) => sum + b.avgAmount, 0);
                const othersAmount = data.results.slice(topN).reduce((sum, b) => sum + b.avgAmount, 0);

                if (totalAmountEl) totalAmountEl.textContent = `ì´ ì˜ˆì¸¡ê¸ˆì•¡: ${formatSmartAmount(totalAmount)}`; // Smart Format Applied

                // 2. Logic: WorkType Ratios from RawData
                const buildingWorkTypeRatios = {};
                const activeWorkTypes = this.currentWorkTypes || (this.allWorkTypes ? this.allWorkTypes : []);

                if (this.rawData && this.rawData.length > 0) {
                    const relevantData = this.rawData.filter(row => {
                        if (this.currentClient && FormatUtils.cleanString(row['ë°œì£¼ì²˜']) !== this.currentClient) return false;
                        if (this.currentWorkTypes && this.currentWorkTypes.length > 0) {
                            if (!this.currentWorkTypes.includes(FormatUtils.cleanString(row['ì‘ì—…ìœ í˜•']))) return false;
                        }
                        return true;
                    });

                    const bAgg = {};
                    relevantData.forEach(row => {
                        const b = FormatUtils.cleanString(row['ê±´ë¬¼ë™']);
                        const wt = FormatUtils.cleanString(row['ì‘ì—…ìœ í˜•']);
                        const amt = parseFloat(String(row['POê¸ˆì•¡']).replace(/,/g, '')) || 0;
                        if (!bAgg[b]) bAgg[b] = { total: 0, wts: {} };
                        if (!bAgg[b].wts[wt]) bAgg[b].wts[wt] = 0;
                        bAgg[b].wts[wt] += amt;
                        bAgg[b].total += amt;
                    });

                    Object.keys(bAgg).forEach(b => {
                        const total = bAgg[b].total;
                        if (total > 0) {
                            buildingWorkTypeRatios[b] = {};
                            Object.keys(bAgg[b].wts).forEach(wt => {
                                buildingWorkTypeRatios[b][wt] = bAgg[b].wts[wt] / total;
                            });
                        }
                    });
                }

                // [FIX] Apply Dominant WorkType Strategy & Logical Filters
                // User Feedback: "Diagram is not improved." -> Need stricter rules.
                if (buildingWorkTypeRatios && Object.keys(buildingWorkTypeRatios).length > 0) {
                    Object.keys(buildingWorkTypeRatios).forEach(b => {
                        const ratios = buildingWorkTypeRatios[b];

                        // Rule 0: 'Others/External' (ê¸°íƒ€, ì™¸ë¶€) -> Force Unclassified
                        // User Feedback: "'ê¸°íƒ€(ì™¸ë¶€ì„ì°¨)' should be linked to 'Unclassified', not 'Rent'."
                        if (b.includes('ê¸°íƒ€') || b.includes('ì™¸ë¶€')) {
                            // Assign 'Unclassified' (ë¯¸ë¶„ë¥˜) as the ONLY linked work type
                            buildingWorkTypeRatios[b] = { 'ë¯¸ë¶„ë¥˜': 1.0 };
                            return; // Skip other rules for this building
                        }

                        // Rule 1: 'ì„ì°¨' (Rent) work type should NOT connect to specific 'Dormitory' buildings (ì‚¬íƒ, ë™)
                        // This fixes the "Rent Housing connected to Dormitory 8" error.
                        Object.keys(ratios).forEach(wt => {
                            if (wt.includes('ì„ì°¨') && (b.includes('ì‚¬íƒ') || b.includes('ë™'))) {
                                delete ratios[wt]; // Force remove invalid link
                            }
                        });

                        // Rule 2: Winner-Take-All Strategy (No Threshold)
                        // Ensure each building connects to ONLY ONE dominant work type.
                        let maxWt = null;
                        let maxRat = -1;
                        Object.keys(ratios).forEach(wt => {
                            if (ratios[wt] > maxRat) {
                                maxRat = ratios[wt];
                                maxWt = wt;
                            }
                        });

                        if (maxWt) {
                            // Assign 100% to the winner
                            buildingWorkTypeRatios[b] = { [maxWt]: 1.0 };
                        } else {
                            // If all ratios were filtered out, treat as no data (will fall back to 'Unclassified')
                            delete buildingWorkTypeRatios[b];
                        }
                    });
                }

                const distributeAmount = (buildingName, amount) => {
                    // [FIX] Runtime Logical Validation (Final Safety Net)
                    const cleanB = buildingName.replace(/\s+/g, '');

                    // [Override] Force 'Others/External' to Unclassified directly
                    // This is the absolute failsafe rule.
                    if (buildingName.includes('ê¸°íƒ€') || buildingName.includes('ì™¸ë¶€') || cleanB.includes('ê¸°íƒ€') || cleanB.includes('ì™¸ë¶€')) {
                        return { 'ë¯¸ë¶„ë¥˜': amount };
                    }

                    const isDorm = cleanB.includes('ì‚¬íƒ') || cleanB.includes('ë™') || cleanB.includes('í˜¸');

                    // Check ratios
                    const ratios = buildingWorkTypeRatios[buildingName];
                    const dist = {};
                    let hasValidLink = false;

                    if (ratios && Object.keys(ratios).length > 0) {
                        Object.keys(ratios).forEach(wt => {
                            const cleanWt = wt.replace(/\s+/g, '');
                            // Rule: 'Rent'(ì„ì°¨) work CANNOT go to 'Dorm'(ì‚¬íƒ/ë™) buildings
                            if (cleanWt.includes('ì„ì°¨') && isDorm) {
                                return; // Block invalid link
                            }

                            dist[wt] = amount * ratios[wt];
                            hasValidLink = true;
                        });
                    }

                    // Fallback to 'Unclassified' if no valid links remain (or no data)
                    if (!hasValidLink) {
                        dist['ë¯¸ë¶„ë¥˜'] = amount;
                    }
                    return dist;
                };

                // 3. Build Nodes/Links
                const nodes = [];
                const links = [];
                const colors = {
                    client: '#3b82f6', workType: ['#8b5cf6', '#a855f7', '#c084fc', '#d8b4fe', '#c4b5fd'], total: '#f59e0b'
                };

                const amountsList = sortedBuildings.map(b => b.avgAmount);
                const maxAmt = Math.max(...amountsList) || 1;
                const minAmt = Math.min(...amountsList) || 0;

                const getAmountColor = (val) => {
                    const ratio = (val - minAmt) / (maxAmt - minAmt || 1);
                    // Aesthetic Pastel Gradient: Teal (Small) -> Indigo (Mid) -> Rose (Large)
                    // Much softer and modern than the previous Blue->Red
                    if (ratio < 0.5) {
                        // Teal (#2dd4bf) to Indigo (#818cf8)
                        const r = Math.round(45 + ratio * 2 * (129 - 45));
                        const g = Math.round(212 + ratio * 2 * (140 - 212));
                        const b = Math.round(191 + ratio * 2 * (248 - 191));
                        return `rgb(${r}, ${g}, ${b})`;
                    } else {
                        // Indigo (#818cf8) to Rose (#fb7185)
                        const r = Math.round(129 + (ratio - 0.5) * 2 * (251 - 129));
                        const g = Math.round(140 + (ratio - 0.5) * 2 * (113 - 140));
                        const b = Math.round(248 + (ratio - 0.5) * 2 * (133 - 248));
                        return `rgb(${r}, ${g}, ${b})`;
                    }
                };

                // [FIX] Layout: Scroll + Zoom Controls
                // User Request: "Scrollbars were missing. Add Zoom if possible."
                container.style.overflow = 'auto'; // Enable scrolling
                container.style.display = 'block'; // Block layout for scrolling
                container.style.height = '100%';

                // 1. Logical Canvas Size
                // Enough width for nodes, enough height for list
                const logicalWidth = 1200;
                // Initial canvas size - optimized for modal viewing
                let logicalHeight = 600; // Compact height for readability

                // [FIX] Restore missing variable definitions for layout logic (ReferenceError Fix)
                const width = logicalWidth;
                const height = logicalHeight;
                const nodeWidth = 20;

                let currentScale = 1.0;

                // Zoom Control Toolbar
                let zoomToolbar = document.getElementById('sankeyZoomToolbar');
                if (!zoomToolbar) {
                    zoomToolbar = document.createElement('div');
                    zoomToolbar.id = 'sankeyZoomToolbar';
                    zoomToolbar.className = 'absolute top-16 right-8 flex gap-2 z-10';
                    zoomToolbar.innerHTML = `
                        <button id="btnZoomIn" class="bg-white border shadow-sm px-3 py-1 rounded hover:bg-gray-50 text-sm font-medium"><i class="fa-solid fa-plus"></i></button>
                        <button id="btnZoomOut" class="bg-white border shadow-sm px-3 py-1 rounded hover:bg-gray-50 text-sm font-medium"><i class="fa-solid fa-minus"></i></button>
                        <button id="btnZoomFit" class="bg-white border shadow-sm px-3 py-1 rounded hover:bg-gray-50 text-sm font-medium">í™”ë©´ ë§ì¶¤</button>
                    `;
                    container.parentElement.appendChild(zoomToolbar); // Append to modal body, outside scroll container if possible? Or inside?
                    // Ideally inside modal body, absolute positioned. 
                    // container is relative? No. Let's make sure container parent is relative.
                    container.parentElement.style.position = 'relative';
                }

                // Zoom Functions (Correct Vector Scaling via viewBox)
                const updateZoom = () => {
                    // Set physical size based on scale
                    const newW = logicalWidth * currentScale;
                    const newH = logicalHeight * currentScale;

                    svg.style.width = `${newW}px`;
                    svg.style.height = `${newH}px`;
                    svg.setAttribute('width', newW);
                    svg.setAttribute('height', newH);
                };

                // Remove old event listeners to prevent duplicates (Conceptually)
                const newZoomToolbar = zoomToolbar.cloneNode(true);
                zoomToolbar.parentNode.replaceChild(newZoomToolbar, zoomToolbar);

                newZoomToolbar.querySelector('#btnZoomIn').addEventListener('click', () => {
                    currentScale *= 1.2; // 20% zoom
                    updateZoom();
                });
                newZoomToolbar.querySelector('#btnZoomOut').addEventListener('click', () => {
                    currentScale /= 1.2;
                    updateZoom();
                });
                newZoomToolbar.querySelector('#btnZoomFit').addEventListener('click', () => {
                    // Fit to Container Width
                    const containerW = container.clientWidth || 1000;
                    // Calculate scale to fit width (with some padding)
                    currentScale = (containerW - 40) / logicalWidth;
                    updateZoom();
                });

                // 2. Setup SVG (Restore viewBox for scaling)
                // This is CRITICAL: viewBox defines the coordinate system.
                // Changing width/height without changing viewBox = Zoom.
                svg.setAttribute('viewBox', `0 0 ${logicalWidth} ${logicalHeight}`);
                svg.setAttribute('preserveAspectRatio', 'xMidYMin meet'); // Align top-center

                updateZoom(); // Apply initial scale (1.0)

                // Level 0
                nodes.push({ id: 'client', level: 0, label: this.currentClient || 'ì „ì²´', value: totalAmount, color: colors.client, x: 20 });

                // Level 1
                const wtSums = {};
                data.results.forEach(b => {
                    const dist = distributeAmount(b.building, b.avgAmount);
                    Object.keys(dist).forEach(wt => { wtSums[wt] = (wtSums[wt] || 0) + dist[wt]; });
                });

                // [FIX] Sort: Force 'Unclassified' (ë¯¸ë¶„ë¥˜) WorkType to Bottom
                const sortedWTs = Object.keys(wtSums).sort((a, b) => {
                    if (a.includes('ë¯¸ë¶„ë¥˜')) return 1;
                    if (b.includes('ë¯¸ë¶„ë¥˜')) return -1;
                    return wtSums[b] - wtSums[a];
                });

                // [FIX] Use Index for ID to avoid SVG 'url(#...)' invalid character errors (Black Box Issue)
                sortedWTs.forEach((wt, i) => {
                    if (wtSums[wt] > 0) {
                        nodes.push({ id: `wt_${i}`, level: 1, label: wt, value: wtSums[wt], color: colors.workType[i % colors.workType.length] || '#ccc' });
                        links.push({ source: 'client', target: `wt_${i}`, value: wtSums[wt], color: colors.workType[i % colors.workType.length] || '#ccc' });
                    }
                });

                // Level 2
                topBuildings.forEach((b, i) => {
                    const color = getAmountColor(b.avgAmount);
                    nodes.push({ id: `bld_${i}`, level: 2, label: b.building, value: b.avgAmount, isBuilding: true, rank: i + 1, color: color });

                    const dist = distributeAmount(b.building, b.avgAmount);
                    Object.keys(dist).forEach(wt => {
                        const wtIdx = sortedWTs.indexOf(wt);
                        if (dist[wt] > 1 && wtIdx !== -1) {
                            links.push({ source: `wt_${wtIdx}`, target: `bld_${i}`, value: dist[wt], color: colors.workType[wtIdx % colors.workType.length] || '#ccc' });
                        }
                    });
                    links.push({ source: `bld_${i}`, target: 'total', value: b.avgAmount, color: color });
                });

                if (othersAmount > 0) {
                    nodes.push({ id: 'others', level: 2, label: `ê¸°íƒ€ (${data.results.length - topN}ê°œ)`, value: othersAmount, color: '#94a3b8' });
                    links.push({ source: 'others', target: 'total', value: othersAmount, color: '#94a3b8' });
                    const otherDistSum = {};
                    data.results.slice(topN).forEach(b => {
                        const dist = distributeAmount(b.building, b.avgAmount);
                        Object.keys(dist).forEach(wt => { otherDistSum[wt] = (otherDistSum[wt] || 0) + dist[wt]; });
                    });
                    Object.keys(otherDistSum).forEach(wt => {
                        const wtIdx = sortedWTs.indexOf(wt);
                        if (otherDistSum[wt] > 1 && wtIdx !== -1) {
                            links.push({ source: `wt_${wtIdx}`, target: 'others', value: otherDistSum[wt], color: '#ccc' });
                        }
                    });
                }

                // Level 3
                nodes.push({ id: 'total', level: 3, label: 'ì´ ì˜ˆì¸¡ê¸ˆì•¡', value: totalAmount, color: colors.total });

                // Layout - Compact & Readable
                // Fixed canvas size optimized for modal viewing
                const canvasHeight = 550; // Fits well in modal
                const nodeGap = 8; // Compact spacing
                const minNodeH = 20;
                const maxNodeH = 80;

                const levelX = [30, width * 0.28, width * 0.58, width - 30 - nodeWidth];
                const levelNodes = [[], [], [], []];
                nodes.forEach(n => { if (levelNodes[n.level]) levelNodes[n.level].push(n); });

                // Calculate layout for each level with proportional but bounded heights
                levelNodes.forEach((levelParams, lvlIdx) => {
                    const x = levelX[lvlIdx];
                    const nodeCount = levelParams.length;
                    if (nodeCount === 0) return;

                    // Calculate available height for nodes (minus gaps)
                    const availableHeight = canvasHeight - 40 - (nodeCount - 1) * nodeGap;
                    const levelTotal = levelParams.reduce((sum, n) => sum + n.value, 0);

                    // First pass: calculate proportional heights with bounds
                    levelParams.forEach(node => {
                        let h = (node.value / levelTotal) * availableHeight;
                        h = Math.max(minNodeH, Math.min(maxNodeH, h));
                        node.height = h;
                    });

                    // Second pass: position nodes vertically centered
                    const totalUsedHeight = levelParams.reduce((sum, n) => sum + n.height, 0) + (nodeCount - 1) * nodeGap;
                    let currentY = (canvasHeight - totalUsedHeight) / 2;
                    currentY = Math.max(20, currentY); // Ensure some top padding

                    levelParams.forEach(node => {
                        node.x = x;
                        node.y = currentY;
                        currentY += node.height + nodeGap;
                    });
                });

                // [FIX] Dynamic Height: Recalculate viewBox based on actual content extent
                let actualContentHeight = 100;
                nodes.forEach(n => {
                    if (n.y !== undefined && n.height !== undefined) {
                        actualContentHeight = Math.max(actualContentHeight, n.y + n.height + 50); // 50px padding
                    }
                });
                logicalHeight = Math.max(logicalHeight, actualContentHeight);

                // Update viewBox with actual height
                svg.setAttribute('viewBox', `0 0 ${logicalWidth} ${logicalHeight}`);

                // [Feature] Auto Fit-to-Screen on Modal Open
                // Calculate scale to fit entire diagram in visible container area
                const containerW = container.clientWidth || 1000;
                const containerH = container.clientHeight || 600;
                const scaleW = (containerW - 40) / logicalWidth;  // Fit width
                const scaleH = (containerH - 40) / logicalHeight; // Fit height
                currentScale = Math.min(scaleW, scaleH, 1.0); // Use smaller scale, max 100%

                // Apply auto-fit scale
                const newW = logicalWidth * currentScale;
                const newH = logicalHeight * currentScale;
                svg.style.width = `${newW}px`;
                svg.style.height = `${newH}px`;
                svg.setAttribute('width', newW);
                svg.setAttribute('height', newH);

                // Draw
                svg.innerHTML = '';
                const svgNS = 'http://www.w3.org/2000/svg';
                const defs = document.createElementNS(svgNS, 'defs');
                nodes.forEach(n => {
                    const grad = document.createElementNS(svgNS, 'linearGradient');
                    grad.id = `grad_${n.id}`; grad.setAttribute('x1', '0%'); grad.setAttribute('y1', '0%'); grad.setAttribute('x2', '100%'); grad.setAttribute('y2', '100%');
                    // [Design] Softer Gradient: -10 instead of -20 to prevent blackish bottom
                    grad.innerHTML = `<stop offset="0%" style="stop-color:${n.color};stop-opacity:1"/><stop offset="100%" style="stop-color:${this.adjustColor(n.color, -10)};stop-opacity:1"/>`;
                    defs.appendChild(grad);
                });
                svg.appendChild(defs);

                const showTooltip = (e, content) => {
                    tooltipContent.innerHTML = content; tooltip.classList.remove('hidden');
                    const rect = container.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 15) + 'px'; tooltip.style.top = (e.clientY - rect.top + 15) + 'px';
                };
                const moveTooltip = (e) => {
                    const rect = container.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 15) + 'px'; tooltip.style.top = (e.clientY - rect.top + 15) + 'px';
                };
                const hideTooltip = () => tooltip.classList.add('hidden');

                const linksGroup = document.createElementNS(svgNS, 'g');
                links.forEach(link => {
                    const s = nodes.find(n => n.id === link.source); const t = nodes.find(n => n.id === link.target);
                    if (!s || !t) return;
                    const x0 = s.x + nodeWidth; const y0 = s.y + s.height / 2; const x1 = t.x; const y1 = t.y + t.height / 2;
                    const thickness = Math.max(2, (link.value / totalAmount) * 50);
                    const path = document.createElementNS(svgNS, 'path');
                    path.setAttribute('d', `M${x0},${y0} C${x0 + (x1 - x0) / 2},${y0} ${x1 - (x1 - x0) / 2},${y1} ${x1},${y1}`);
                    path.setAttribute('fill', 'none'); path.setAttribute('stroke', link.color); path.setAttribute('stroke-width', thickness); path.setAttribute('stroke-opacity', '0.3');
                    path.setAttribute('class', 'transition-all duration-200 cursor-pointer');
                    path.addEventListener('mouseenter', (e) => {
                        path.setAttribute('stroke-opacity', '0.8');
                        showTooltip(e, `<div class="font-bold mb-1">ì—°ê²° ì •ë³´</div><div class="text-slate-300 text-[10px]">${s.label} â†’ ${t.label}</div><div class="text-white font-mono mt-1">${formatSmartAmount(link.value)}</div><div class="text-slate-400 text-[10px]">ë¹„ì¤‘: ${((link.value / totalAmount) * 100).toFixed(1)}%</div>`);
                    });
                    path.addEventListener('mousemove', moveTooltip); path.addEventListener('mouseleave', () => { path.setAttribute('stroke-opacity', '0.3'); hideTooltip(); });
                    linksGroup.appendChild(path);
                });
                svg.appendChild(linksGroup);

                const nodesGroup = document.createElementNS(svgNS, 'g');
                nodes.forEach(node => {
                    const g = document.createElementNS(svgNS, 'g');
                    const rect = document.createElementNS(svgNS, 'rect');
                    rect.setAttribute('x', node.x); rect.setAttribute('y', node.y); rect.setAttribute('width', nodeWidth); rect.setAttribute('height', node.height);
                    rect.setAttribute('rx', 4); rect.setAttribute('fill', `url(#grad_${node.id})`); rect.setAttribute('class', 'cursor-pointer hover:opacity-80 transition-opacity');
                    g.appendChild(rect);

                    if (node.height > 10) {
                        const text = document.createElementNS(svgNS, 'text');
                        const isLeft = node.level < 2;
                        text.setAttribute('x', isLeft ? node.x + nodeWidth + 5 : node.x - 5); text.setAttribute('y', node.y + node.height / 2 + 4);
                        text.setAttribute('text-anchor', isLeft ? 'start' : 'end'); text.setAttribute('font-size', '11'); text.setAttribute('fill', '#334155'); text.setAttribute('font-weight', '500');
                        let labelText = node.label.length > 8 ? node.label.substring(0, 8) + '..' : node.label;
                        if (node.isBuilding && node.rank) labelText = `${node.rank}. ${labelText}`;
                        text.textContent = labelText;
                        g.appendChild(text);

                        // Smart Amount Label
                        const amountText = document.createElementNS(svgNS, 'text');
                        amountText.setAttribute('x', isLeft ? node.x + nodeWidth + 5 : node.x - 5);
                        amountText.setAttribute('y', node.y + node.height / 2 + 16);
                        amountText.setAttribute('text-anchor', isLeft ? 'start' : 'end');
                        amountText.setAttribute('font-size', '10');
                        amountText.setAttribute('fill', '#64748b');
                        amountText.textContent = formatSmartAmount(node.value);
                        g.appendChild(amountText);
                    }
                    g.addEventListener('mouseenter', (e) => {
                        rect.setAttribute('stroke-width', '2'); rect.setAttribute('filter', 'brightness(1.1)');
                        const rankInfo = node.rank ? `<div class="text-blue-200 mt-1">ìˆœìœ„: ${node.rank}ìœ„</div>` : '';
                        showTooltip(e, `<div class="font-bold mb-1">${node.label}</div><div class="text-white font-mono">${formatSmartAmount(node.value)}</div><div class="text-slate-300">ë¹„ìœ¨: <span class="font-semibold text-white">${((node.value / totalAmount) * 100).toFixed(1)}%</span></div>${rankInfo}`);
                    });
                    g.addEventListener('mousemove', moveTooltip); g.addEventListener('mouseleave', hideTooltip);
                    nodesGroup.appendChild(g);
                });
                svg.appendChild(nodesGroup);
            };

            // [CRITICAL PATCH] Force Legacy 'renderSankeyDiagram' to use V4 Logic
            // This ensures ANY call to renderSankeyDiagram uses the V4 Unclassified Failsafe logic.
            // Also adds an alias for 'renderSankey' just in case.
            App.prototype.renderSankeyDiagram = App.prototype.renderSankeyDiagramV4;
            App.prototype.renderSankey = App.prototype.renderSankeyDiagramV4;

            // [PRD/IMP] Export Sankey as Image
            App.prototype.exportSankeyAsImage = function () {
                const svg = document.getElementById('sankeySvg');
                if (!svg) return;

                const svgData = new XMLSerializer().serializeToString(svg);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `Sankey_${this.currentClient || 'Analysis'}_${new Date().toISOString().slice(0, 10)}.svg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                // Toast
                const toast = document.createElement('div');
                toast.className = 'fixed top-20 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
                toast.innerHTML = '<i class="fa-solid fa-check-circle mr-2"></i>Sankey ë‹¤ì´ì–´ê·¸ë¨ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤';
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            };

            document.addEventListener('DOMContentLoaded', () => {
                window.app = new App();
                // ìŠ¤ëƒ…ìƒ· ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë³µì›
                if (window.__SNAPSHOT__) {
                    window.app.loadSnapshot();
                }
            });
        </script>

</body>

</html>