<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ìˆ™ì‚¬ ë° ì‚¬íƒ ë°ì´í„° ì¶”ì¶œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { position: relative; width: 95%; max-width: 1400px; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { color: #005a9c; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        .container > h1 + p { font-size: 0.8em; color: #555; line-height: 1.5; }
        .usage-highlight-pink { font-size: 1.2em; color: #FF33CC; font-weight: bold; }
        .usage-highlight-bold { font-size: 1.2em; font-weight: bold; }
        h2.view-title { color: #28a745; }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; margin-bottom: 20px; padding: 20px; background-color: #eef5ff; border-radius: 8px; }
        .control-item { display: flex; flex-direction: column; }
        .control-item label { font-size: 14px; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="file"], input[type="text"], button, textarea { padding: 10px 15px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; font-family: 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif; box-sizing: border-box; }
        input[type="text"] { flex-grow: 1; min-width: 250px; }
        textarea { width: 100%; resize: vertical; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; transition: background-color: 0.3s; }
        .prpo-input-group, .bldg-unit-input-group { display: flex; align-items: center; gap: 10px; }
        .prpo-input-group input[type="text"], .bldg-unit-input-group input[type="text"] { flex-grow: 1; }
        .bldg-unit-input-group input[type="text"] { min-width: 115px; } /* ë™/í˜¸ì‹¤ ì…ë ¥ì°½ ë„ˆë¹„ ì¡°ì • */
        
        #prpo-input::placeholder {
            font-size: 12px;
        }
        
        .input-tooltip {
            display: none;
            font-size: 12px;
            color: #005a9c;
            background-color: #eef5ff;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 5px;
            max-width: 380px;
            border: 1px solid #cce0ff;
        }

        #settings-button { position: absolute; top: 25px; right: 25px; font-size: 24px; background: none; border: none; color: #555; cursor: pointer; padding: 5px 10px; }
        .settings-panel-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        
        .settings-panel { 
            background: #fff; 
            padding: 0;
            border-radius: 8px; 
            width: 90%; 
            max-width: 600px; 
            min-width: 400px;
            max-height: 90vh;
            min-height: 300px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
            position: absolute;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .settings-panel-header {
            padding: 15px 25px;
            cursor: move;
            background-color: #f7f7f7;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }
        .settings-panel-header h2 {
            margin: 0;
            padding: 0;
            border-bottom: none;
            font-size: 1.2em;
        }
        .settings-panel .close-button { 
            position: absolute; 
            top: 50%;
            right: 15px; 
            font-size: 28px; 
            background: none; 
            border: none; 
            color: #888;
            transform: translateY(-50%);
            padding: 0 10px;
            cursor: pointer;
        }
        .settings-panel-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 25px;
        }
        .resizer-handle {
            width: 20px;
            height: 20px;
            background: transparent;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: se-resize;
            z-index: 10;
        }
        
        .settings-section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h3 { margin-top: 0; color: #005a9c; }
        .settings-section p.description { font-size: 13px; color: #666; margin: -5px 0 10px 0; }

        .collapsible-toggle {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .collapsible-content {
            display: none; 
            margin-top: 15px;
        }
        .settings-section.active .collapsible-content {
            display: block;
        }

        .collapsible-content h4 { margin-top: 20px; margin-bottom: 10px; color: #005a9c; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .collapsible-content h5 { margin-top: 15px; margin-bottom: 5px; color: #333; }
        .collapsible-content ul { padding-left: 20px; list-style-type: disc; }
        .collapsible-content li { margin-bottom: 8px; line-height: 1.6; }
        .collapsible-content code {
            background-color: #eef5ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Courier New', monospace;
            color: #d63384;
            font-size: 0.95em;
        }
        .collapsible-content .plan-section { margin-bottom: 15px; }
        
        .data-source-option { margin-bottom: 10px; }
        .data-source-option label { font-weight: normal; margin-left: 5px; }
        .data-source-inputs > div { display: none; margin-top: 10px; }
        .data-source-inputs > div.active { display: block; }
        .data-source-inputs input[type="text"] { width: calc(100% - 34px); }
        
        .result-header { position: relative; display: flex; align-items: center; gap: 10px; }
        #column-select-button { font-size: 1.7em; background: none; border: 1px solid #ccc; border-radius: 5px; color: #555; cursor: pointer; padding: 0px 8px; line-height: 1; }
        
        .column-select-panel { display: none; position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 100; padding: 10px; }
        .column-select-controls { padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; }
        .column-select-controls input[type="text"] { width: calc(100% - 22px); padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; }
        .column-select-controls div { margin-top: 10px; display:flex; gap: 15px; align-items: center; }
        .column-select-list { max-height: 250px; overflow-y: auto; }
        .column-select-list ul { list-style: none; margin: 0; padding: 0; }
        .column-select-list li { padding: 5px; white-space: nowrap; }
        .column-select-list label { font-weight: normal; margin-left: 5px; cursor: pointer; }

        #initial-columns-container { max-height: 250px; overflow-y: auto; }
        #initial-columns-container p { font-size: 14px; color: #888; margin: 0; }
        #initial-columns-container ul { list-style: none; margin: 10px 0 0 0; padding: 0; column-count: 3; column-gap: 20px; }
        #initial-columns-container li { padding: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #initial-columns-container label { font-weight: normal; margin-left: 5px; cursor: pointer; }
        .settings-column-controls { padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .settings-column-controls input[type="text"] { width: 100%; padding: 5px 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; margin-bottom: 10px; }
        .settings-column-controls div { margin-top: 5px; display:flex; gap: 15px; align-items: center; }
        .restore-button { background: none; border: none; color: #007bff; cursor: pointer; text-decoration: underline; padding: 0; font-size: 0.972em; } 

        .loader { display: none; border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid #3498db; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .results-area { display: none; margin-top: 20px; }
        .table-container { position: relative; max-height: 400px; overflow: auto; border: 1px solid #ddd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        thead th { background-color: #f2f2f2; font-weight: bold; text-align: center; position: sticky; top: 0; z-index: 10; user-select: none; }
        
        .focus-overlay { 
            position: absolute; 
            display: none; 
            pointer-events: none; 
            z-index: 5; 
            box-sizing: border-box; 
        }
        .focus-overlay:first-of-type { border-top: 4px solid #ccc; border-bottom: 4px solid #ccc; }
        .focus-overlay:nth-of-type(2) { border-left: 4px solid #ccc; border-right: 4px solid #ccc; }

        .resizer { position: absolute; top: 0; right: -3px; width: 6px; height: 100%; cursor: col-resize; z-index: 20; }
        #summary-container td { text-align: right; }
        #summary-container td:first-child { text-align: left; font-weight: bold; }
        .header-content { display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer; }
        
        .sort-arrows {
            display: flex;
            flex-direction: column;
            line-height: 0.8; 
            margin-left: 5px;
        }
        .sort-arrow {
            color: #ccc; 
            font-size: 0.96em;
            transition: color 0.2s ease-in-out;
        }
        .sort-arrow.active {
            color: #007bff; 
        }

        .filter-icon { cursor: pointer; margin-left: 5px; font-style: normal; color: #007bff; font-size: 1.5em; vertical-align: middle; } 
        .filter-icon.active { color: #dc3545; font-weight: bold; }
        .summary-legend { font-size: 0.7em; color: #555; font-weight: normal; margin-left: 10px; vertical-align: middle; }
        .summary-legend .filter-icon { font-size: 1.2em; }

        #custom-confirm-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        #custom-confirm-box { background: white; padding: 25px; border-radius: 8px; text-align: center; width: 90%; max-width: 500px; box-shadow: 0 5px 20px rgba(0,0,0,0.25); }
        #custom-confirm-message { margin: 0 0 20px 0; font-size: 16px; line-height: 1.6; }
        .highlight-text { font-size: 1.3em; color: red; font-weight: bold; display: block; margin: 10px 0; }
        #custom-confirm-buttons { display: flex; justify-content: center; gap: 15px; }
        #custom-confirm-buttons button { padding: 10px 25px; font-size: 16px; border-radius: 5px; cursor: pointer; border: 1px solid #ccc; }
        #custom-confirm-ok { background-color: #007bff; color: white; border-color: #007bff; }
        #custom-confirm-cancel { background-color: #f8f9fa; color: #333; }
        
        #custom-tooltip {
            display: none;
            position: absolute;
            border: 1px solid #333;
            background-color: #fffde7;
            padding: 10px;
            padding-top: 30px; 
            z-index: 9999;
            max-width: 400px;
            min-width: 150px;
            text-align: left;
            word-wrap: break-word;
            overflow-wrap: break-word;
            resize: both;
            overflow: auto;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            cursor: move;
        }
        #tooltip-close-btn {
            position: absolute;
            top: 2px;
            right: 5px;
            background: none;
            border: none;
            font-size: 20px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .tooltip-source-cell {
            cursor: help;
            background-color: #e8f4ff !important;
        }
        
        .label-note {
            font-size: 0.85em;
            color: #666;
            font-weight: normal;
            margin-left: 10px;
        }
        .summary-term {
            font-size: 1.15em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="settings-button" title="ì„¤ì •">âš™ï¸</button>
        <h1>ê¸°ìˆ™ì‚¬ ë° ì‚¬íƒ ë°ì´í„° ì¶”ì¶œ</h1>
        <p>
            <span class="usage-highlight-pink">âŒ›URL ìë™ ë¡œë”©â³</span>
            <span> ë³„ë„ ì„¤ì • ì—†ì´ ê²€ìƒ‰ê°’ ì…ë ¥í›„ ì¶”ì¶œ ì‹¤í–‰ ë©”ë‰´ë¥¼ í´ë¦­ í•˜ì„¸ìš”. </span>
            <span class="usage-highlight-bold">ğŸ§¾ë¡œìš°ë°ì´í„° ë³€ê²½ í•„ìš”ì‹œğŸ§¾</span>
            <span> ìš°ì¸¡ ìƒë‹¨ ì„¤ì •(âš™ï¸)ì—ì„œ ë³€ê²½í•  ë¡œìš°ë°ì´í„°ë¥¼ ì„ íƒí•œ í›„, ê²€ìƒ‰ê°’ì„ ì…ë ¥í•˜ê³  ì¶”ì¶œ ì‹¤í–‰ ë©”ë‰´ë¥¼ í´ë¦­ í•˜ì„¸ìš”.</span>
        </p>
        <div class="controls">
            <div class="control-item"><label for="search-input">1. ê²€ìƒ‰ì–´ ì…ë ¥</label><input type="text" id="search-input" placeholder="ëˆ„ìˆ˜,êµì²´,í™ê¸¸ë™ (ì‰¼í‘œë¡œ êµ¬ë¶„)" oninput="adjustPlaceholderSize(this)"></div>
            <div class="control-item"><label for="prpo-input">2. PR/PO ë²ˆí˜¸ ì…ë ¥</label><div class="prpo-input-group"><input type="text" id="prpo-input" oninput="adjustPlaceholderSize(this)" placeholder="ì˜ˆ: PR,POë²ˆí˜¸(ì‰¼í‘œë¡œ êµ¬ë¶„),ë‹¨ë…/ë‹¤ì¤‘"></div></div>
            <div class="control-item">
                <label for="building-input">3. ê±´ë¬¼ ë™ ë° ì„¸ëŒ€ í˜¸ì‹¤ ì…ë ¥<span class="label-note">ğŸ“ğŸ¨1ë²ˆ + 2ë²ˆ + 3ë²ˆ í˜¼í•© ì¶”ì¶œ ê°€ëŠ¥</span></label>
                <div class="bldg-unit-input-group">
                    <input type="text" id="building-input" placeholder="ê±´ë¬¼ë™ (ì˜ˆ: 101)" oninput="adjustPlaceholderSize(this)">
                    <input type="text" id="unit-input" placeholder="í˜¸ì‹¤ (ì˜ˆ: 1504)" oninput="adjustPlaceholderSize(this)">
                </div>
                <div id="bldg-unit-tooltip" class="input-tooltip">
                    <strong>ì•ˆë‚´:</strong> ê±´ë¬¼/í˜¸ì‹¤ ê²€ìƒ‰ì€ ë…ë¦½ í•„í„°ë¡œ, ë³„ë„ì˜ ìƒ‰ìƒ ê·¸ë£¹ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê²°ê³¼ëŠ” ê¸°ì¡´ ìƒ‰ìƒ ê·¸ë£¹ ë‚´ì—ì„œ í•„í„°ë§ë©ë‹ˆë‹¤.
                </div>
            </div>
            <button id="run-button">ì¶”ì¶œ ì‹¤í–‰</button>
        </div>
        <div id="loader" class="loader"></div>
        <div id="results-area" class="results-area">
            <div class="result-actions"><button id="reset-button">í•„í„° ì´ˆê¸°í™”</button></div>
            <h2>ìš”ì•½<span class="summary-legend">(ë²”ë¡€: <i class="filter-icon" style="color:#007bff;">â§±</i> í•„í„°ë§(í´ë¦­ ì‹œ ê²°ê³¼ í‘œì‹œ) | <i class="filter-icon" style="color:#dc3545;">â§±</i> í•„í„° í•´ì œ(ê²°ê³¼ í‘œì‹œ ì¤‘))</span></h2>
            <div id="summary-container" class="table-container"></div>
            <div class="result-header">
                <h2>ì¶”ì¶œ ê²°ê³¼</h2>
                <button id="column-select-button" title="ì—´ ì„ íƒ íŒ¨ë„ ì—´ê¸°">âŠ</button>
                <div id="column-select-panel" class="column-select-panel"></div>
            </div>
            <div id="result-container" class="table-container"></div>
        </div>
    </div>
    <div id="settings-panel-overlay" class="settings-panel-overlay">
        <div id="settings-panel" class="settings-panel">
            <div class="settings-panel-header">
                <h2>ì„¤ì •</h2>
                <button id="settings-close-button" class="close-button">Ã—</button>
            </div>
            <div class="settings-panel-content">
                <div class="settings-section">
                    <h3>ë°ì´í„° ì†ŒìŠ¤</h3>
                    <div class="data-source-option"><input type="radio" id="source-url" name="dataSource" value="url" checked><label for="source-url">URL (ëª¨ë°”ì¼)</label></div>
                    <div class="data-source-option"><input type="radio" id="source-desktop" name="dataSource" value="desktop"><label for="source-desktop">ë°ìŠ¤í¬íƒ‘ íŒŒì¼ ì„ íƒ</label></div>
                    <div class="data-source-inputs">
                        <div id="url-input-section" class="active"><input type="text" id="url-input" placeholder="ì—‘ì…€ íŒŒì¼ URL ì£¼ì†Œ"></div>
                        <div id="desktop-input-section"><input type="file" id="file-input" accept=".xlsx, .xls"></div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="collapsible-toggle">ì‚¬ìš©ë°©ë²• (ë¶„ì„ ë©”ë‰´ì–¼) <span class="toggle-icon">â–¶</span></h3>
                    <div class="collapsible-content">
                        <p>ì´ ë„êµ¬ëŠ” ë‹¨ìˆœ ê²€ìƒ‰ì„ ë„˜ì–´, ë°ì´í„° ì† ìˆ¨ê²¨ì§„ ì˜ë¯¸(í†µì°°ë ¥)ë¥¼ ë°œê²¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë˜ì˜ ë°©ë²•ì„ í™œìš©í•´ ë³´ì„¸ìš”.</p>
                        
                        <h4>ê¸°ë³¸ ê²€ìƒ‰ ì›ë¦¬</h4>
                        <ul>
                            <li><strong>OR ê²€ìƒ‰ (ë˜ëŠ”)</strong>: í•œ ì…ë ¥ì°½ì— ì‰¼í‘œ(<code>,</code>)ë¡œ ì—¬ëŸ¬ ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ë©´, ê° ë‹¨ì–´ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ëœ ëª¨ë“  ê²°ê³¼ë¥¼ ì°¾ì•„ì˜µë‹ˆë‹¤. ì˜ˆ: <code>ëˆ„ìˆ˜,ê²°ë¡œ</code></li>
                            <li><strong>AND ê²€ìƒ‰ (ê·¸ë¦¬ê³ )</strong>: ì—¬ëŸ¬ ì…ë ¥ì°½ì— ê°ê° ë‹¤ë¥¸ ì¡°ê±´ì„ ì…ë ¥í•˜ë©´, ëª¨ë“  ì¡°ê±´ì„ ë™ì‹œì— ë§Œì¡±í•˜ëŠ” ê²°ê³¼ë§Œ ì°¾ì•„ì˜µë‹ˆë‹¤. ì˜ˆ: <code>1. ê²€ìƒ‰ì–´: ëˆ„ìˆ˜</code> + <code>3. ê±´ë¬¼ë™: 101</code></li>
                        </ul>

                        <h4>ì „ëµì  ê²€ìƒ‰ ë° ë¶„ì„ ë°©ë²•</h4>
                        
                        <h5>1. ë¹„ìš© ë° ì›ì¸ ë¶„ì„ (ë¬¸ì œì  íŒŒì•…)</h5>
                        <p><strong>ëª©í‘œ:</strong> ì–´ë–¤ ë¬¸ì œì— ê°€ì¥ ë§ì€ ë¹„ìš©ì´ ë°œìƒí•˜ëŠ”ì§€ íŒŒì•…í•©ë‹ˆë‹¤.</p>
                        <p><strong>ì‚¬ìš©ë²•:</strong></p>
                        <ul>
                            <li><b>'1. ê²€ìƒ‰ì–´ ì…ë ¥'</b> ì°½ì— ë¬¸ì œ ì›ì¸ì„ ë‚˜íƒ€ë‚´ëŠ” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆ: <code>ëˆ„ìˆ˜,ê²°ë¡œ,íŒŒì†,êµì²´</code></li>
                            <li><b>'ìš”ì•½'</b> í…Œì´ë¸”ì—ì„œ ê° ì›ì¸ë³„ <strong>ì´ ë°œìƒ ê±´ìˆ˜</strong>ì™€ <strong>ê¸ˆì•¡ í•©ê³„</strong>ë¥¼ ì¦‰ì‹œ ë¹„êµ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: 'ëˆ„ìˆ˜'ì— ì—°ê°„ ì–¼ë§ˆê°€ ì“°ì˜€ë‚˜?)</li>
                        </ul>

                        <h5>2. íŠ¹ì • ê±´ë¬¼/ì„¸ëŒ€ ì§‘ì¤‘ ë¶„ì„ (ì´ë ¥ ì¶”ì )</h5>
                        <p><strong>ëª©í‘œ:</strong> íŠ¹ì • ì¥ì†Œì—ì„œ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ë¬¸ì œë¥¼ ì°¾ì•„ëƒ…ë‹ˆë‹¤.</p>
                        <p><strong>ì‚¬ìš©ë²•:</strong></p>
                        <ul>
                            <li><b>'3. ê±´ë¬¼ ë™ ë° ì„¸ëŒ€ í˜¸ì‹¤ ì…ë ¥'</b> ì°½ì— íŠ¹ì • ê±´ë¬¼ ë˜ëŠ” ì„¸ëŒ€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆ: ê±´ë¬¼ë™ <code>203</code>, í˜¸ì‹¤ <code>1001</code></li>
                            <li><b>'ì¶”ì¶œ ê²°ê³¼'</b>ë¥¼ í†µí•´ í•´ë‹¹ ì„¸ëŒ€ì˜ ëª¨ë“  ìœ ì§€ë³´ìˆ˜ ì´ë ¥ì„ í™•ì¸í•˜ê³ , ë°˜ë³µì ì¸ ë¬¸ì œë¥¼ ì‹ë³„í•˜ì—¬ ê·¼ë³¸ì ì¸ í•´ê²°ì±…ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        </ul>
                        
                        <h5>3. ì—…ì²´(ë°œì£¼ì²˜) ì„±ê³¼ ë¶„ì„</h5>
                        <p><strong>ëª©í‘œ:</strong> íŠ¹ì • ì—…ì²´ì˜ ì‘ì—… ë‚´ì—­ê³¼ ì´ ê³„ì•½ ê¸ˆì•¡ì„ ë¶„ì„í•˜ì—¬ ì„±ê³¼ë¥¼ í‰ê°€í•©ë‹ˆë‹¤.</p>
                        <p><strong>ì‚¬ìš©ë²•:</strong></p>
                        <ul>
                            <li><b>'1. ê²€ìƒ‰ì–´ ì…ë ¥'</b> ì°½ì— ë¶„ì„í•˜ê³  ì‹¶ì€ ì—…ì²´ëª…ì„ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆ: <code>ì‚¼ì„±ë¬¼ì‚°</code></li>
                            <li><b>'ìš”ì•½'</b> í…Œì´ë¸”ì—ì„œ í•´ë‹¹ ì—…ì²´ì˜ <strong>ì´ ì‘ì—… ê±´ìˆ˜</strong>ì™€ <strong>ì´ ê³„ì•½ ê¸ˆì•¡</strong>ì„ í™•ì¸í•˜ê³ , <b>'ì¶”ì¶œ ê²°ê³¼'</b>ì—ì„œ ìƒì„¸ ì‘ì—… ë‚´ì—­ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        </ul>

                        <h5>4. í”„ë¡œì íŠ¸ ë° ë‹´ë‹¹ì ì´ë ¥ ì¶”ì </h5>
                        <p><strong>ëª©í‘œ:</strong> íŠ¹ì • PR/PO ê±´ì˜ ì§„í–‰ ìƒí™©ì„ ì¶”ì í•˜ê±°ë‚˜, ë‹´ë‹¹ìë³„ ì—…ë¬´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                        <p><strong>ì‚¬ìš©ë²•:</strong></p>
                        <ul>
                            <li><b>'2. PR/PO ë²ˆí˜¸ ì…ë ¥'</b> ì°½ì— ì¶”ì í•˜ê³  ì‹¶ì€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</li>
                            <li>ë˜ëŠ” <b>'1. ê²€ìƒ‰ì–´ ì…ë ¥'</b> ì°½ì— <b>'íŠ¹ì´ì‚¬í•­'</b>ì— ê¸°ì¬ëœ ë‹´ë‹¹ì ì´ë¦„ì„ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆ: <code>í™ê¸¸ë™</code></li>
                        </ul>

                        <h4>ê³ ê¸‰ ë¶„ì„ íŒ</h4>
                        <ul>
                            <li><strong>ê¸°ê°„ë³„ ë¶„ì„:</strong> <b>'1. ê²€ìƒ‰ì–´ ì…ë ¥'</b> ì°½ì— <code>2023</code>ê³¼ ê°™ì€ ì—°ë„ë¥¼ ì…ë ¥í•˜ë©´, 'íšŒê³„ ì—°ë„'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•´ë‹¹ ì—°ë„ì˜ ë°ì´í„°ë§Œ í•„í„°ë§í•˜ì—¬ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                            <li><strong>ë³µí•© ì¡°ê±´ ì‹¬ì¸µ ë¶„ì„:</strong> ëª¨ë“  ì…ë ¥ì°½ì„ í™œìš©í•˜ì—¬ ë§¤ìš° êµ¬ì²´ì ì¸ ë°ì´í„°ë¥¼ ì¶”ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br> (ì˜ˆ: <b>ê²€ìƒ‰ì–´:</b> <code>ëˆ„ìˆ˜</code> + <b>PR/PO:</b> <code>P2023</code> + <b>ê±´ë¬¼ë™:</b> <code>101</code> â†’ 101ë™ì—ì„œ 2023ë…„ì— ë°œì£¼ëœ ëˆ„ìˆ˜ ê´€ë ¨ ëª¨ë“  ê±´)</li>
                            <li><strong>'íŠ¹ì´ì‚¬í•­' í™œìš©:</strong> 'íŠ¹ì´ì‚¬í•­' ì—´ì€ ìˆ¨ê²¨ì§„ ì •ë³´ì˜ ë³´ê³ ì…ë‹ˆë‹¤. ë‹´ë‹¹ì ì´ë¦„, íŠ¹ì • ìì¬ëª…, ì‘ì—… ê´€ë ¨ ë©”ëª¨ ë“± ììœ ë¡œìš´ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ì—¬ ì˜ˆìƒì¹˜ ëª»í•œ ì—°ê´€ì„±ì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                </div>

                <!-- === ê°œì„  ì‚¬í•­: ê¸°ëŠ¥ í™•ì¥ ê³„íš ë©”ë‰´ ì¶”ê°€ === -->
                <div class="settings-section">
                    <h3 class="collapsible-toggle">ê²€ìƒ‰ ì…ë ¥ë¶€ ë¶„ì„ ë° ê¸°ëŠ¥ í™•ì¥ ê³„íš <span class="toggle-icon">â–¶</span></h3>
                    <div class="collapsible-content">
                        <p>í˜„ì¬ ê²€ìƒ‰ ì‹œìŠ¤í…œì€ <strong>[ë²”ìš© í‚¤ì›Œë“œ], [PR/PO ID], [ìœ„ì¹˜]</strong>ë¼ëŠ” 3ëŒ€ í•µì‹¬ ì¶•ì„ ì¤‘ì‹¬ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë°ì´í„° ë¶„ì„ ì—­ëŸ‰ì„ ê·¹ëŒ€í™”í•˜ê¸° ìœ„í•´ ë‹¤ìŒê³¼ ê°™ì€ ê¸°ëŠ¥ í™•ì¥ì„ ê³„íší•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        
                        <div class="plan-section">
                            <h4>ê³„íš 1: 'ë‚ ì§œ ë²”ìœ„(Date Range)' ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€</h4>
                            <ul>
                                <li><strong>í˜„í™© ë¶„ì„:</strong> í˜„ì¬ëŠ” ì—°ë„(<code>2023</code>) ë“± ë¬¸ìì—´ ê¸°ë°˜ì˜ ê¸°ê°„ ê²€ìƒ‰ë§Œ ê°€ëŠ¥í•˜ì—¬, "ì˜¬í•´ 2ë¶„ê¸°", "ì§€ë‚œ 30ì¼ê°„" ë“± íŠ¹ì • ê¸°ê°„ì— ëŒ€í•œ ë™í–¥ ë¶„ì„ì´ ì œí•œë©ë‹ˆë‹¤.</li>
                                <li><strong>ê¸°ëŠ¥ ê³„íš:</strong> `4. ë‚ ì§œ ë²”ìœ„ ì§€ì •` ì˜ì—­ì„ ì‹ ì„¤í•˜ì—¬, ë‹¬ë ¥ì—ì„œ [ì‹œì‘ì¼]ê³¼ [ì¢…ë£Œì¼]ì„ ì„ íƒí•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
                                <li><strong>ê¸°ëŒ€ íš¨ê³¼:</strong> ê³„ì ˆë³„/ë¶„ê¸°ë³„ ë¬¸ì œ ë°œìƒ íŒ¨í„´ ë¶„ì„, íŠ¹ì • ê¸°ê°„ ë‚´ ë™í–¥ ë¶„ì„, ì •ê¸° ì—…ë¬´ ë³´ê³  ìë£Œì˜ ì‹ ì†í•œ ì¶”ì¶œì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.</li>
                            </ul>
                        </div>
                        
                        <div class="plan-section">
                            <h4>ê³„íš 2: 'ê¸ˆì•¡ ë²”ìœ„(Numerical Range)' ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€</h4>
                            <ul>
                                <li><strong>í˜„í™© ë¶„ì„:</strong> í˜„ì¬ëŠ” íŠ¹ì • ê¸ˆì•¡ ì´ìƒì˜ ê³ ë¹„ìš© ì‘ì—…ì´ë‚˜ íŠ¹ì • ê¸ˆì•¡ ì´í•˜ì˜ ì €ë¹„ìš© ì‘ì—…ì„ ì§ì ‘ í•„í„°ë§í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
                                <li><strong>ê¸°ëŠ¥ ê³„íš:</strong> `5. ê¸ˆì•¡ ë²”ìœ„ ì§€ì •` ì˜ì—­ì„ ì‹ ì„¤í•˜ì—¬, [ëŒ€ìƒ ê¸ˆì•¡ ì„ íƒ(PO/PRê¸ˆì•¡ ë“±)], [ìµœì†Œ ê¸ˆì•¡], [ìµœëŒ€ ê¸ˆì•¡]ì„ ì…ë ¥í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
                                <li><strong>ê¸°ëŒ€ íš¨ê³¼:</strong> ê³ ë¹„ìš© ì‘ì—… ì§‘ì¤‘ ê´€ë¦¬, ì˜ˆì‚° ëŒ€ë¹„ ì‹¤ì  ë¶„ì„, ì†Œì•¡/ë‹¨ìˆœ ì‘ì—…ì˜ ë¹ˆë„ ë¶„ì„ì„ í†µí•œ ì—…ë¬´ íš¨ìœ¨í™” ë°©ì•ˆ ëª¨ìƒ‰ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.</li>
                            </ul>
                        </div>

                        <div class="plan-section">
                            <h4>ê³„íš 3: 'íŠ¹ì • ì—´(Column) ëŒ€ìƒ' í‚¤ì›Œë“œ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€</h4>
                            <ul>
                                <li><strong>í˜„í™© ë¶„ì„:</strong> í˜„ì¬ ë²”ìš© í‚¤ì›Œë“œ ê²€ìƒ‰ì€ ëª¨ë“  ì—´ì„ ëŒ€ìƒìœ¼ë¡œ í•˜ì—¬ í¸ë¦¬í•˜ì§€ë§Œ, ë•Œë¡œëŠ” ì›ì¹˜ ì•ŠëŠ” ê²°ê³¼ê°€ í¬í•¨ë  ìˆ˜ ìˆì–´ ë¶„ì„ì˜ ì •í™•ì„±ì„ ì €í•´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                                <li><strong>ê¸°ëŠ¥ ê³„íš:</strong> `1. ê²€ìƒ‰ì–´ ì…ë ¥` ì°½ ì˜†ì— ê²€ìƒ‰ ëŒ€ìƒì„ `ì „ì²´`, `ë°œì£¼ì²˜`, `ê³„ì•½ëª…`, `íŠ¹ì´ì‚¬í•­` ë“±ìœ¼ë¡œ í•œì •í•  ìˆ˜ ìˆëŠ” ë“œë¡­ë‹¤ìš´ ë©”ë‰´ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.</li>
                                <li><strong>ê¸°ëŒ€ íš¨ê³¼:</strong> ê²€ìƒ‰ì˜ ì •í™•ì„±ì„ ë¹„ì•½ì ìœ¼ë¡œ í–¥ìƒì‹œì¼œ ë¶„ì„ì˜ ë…¸ì´ì¦ˆë¥¼ ì œê±°í•˜ê³ , `íŠ¹ì´ì‚¬í•­` ë“± íŠ¹ì • ì—´ì— ìˆ¨ê²¨ì§„ ì •ë³´ë¥¼ ë”ìš± íš¨ê³¼ì ìœ¼ë¡œ íƒìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                            </ul>
                        </div>

                        <h4>ì¢…í•© ê²°ë¡ </h4>
                        <p>ìœ„ ê¸°ëŠ¥ë“¤ì´ ì¶”ê°€ë˜ë©´, í˜„ì¬ì˜ <strong>"ë¬´ì—‡ì„(What), ëˆ„ê°€(Who), ì–´ë””ì„œ(Where)"</strong> ì¤‘ì‹¬ì˜ ê²€ìƒ‰ì—ì„œ ë‚˜ì•„ê°€, **"ì–¸ì œ(When)", "ì–¼ë§ˆë‚˜(How much)", "ì •í™•íˆ ì–´ë–¤ ë§¥ë½ì—ì„œ(Context)"**ë¥¼ í¬í•¨í•˜ëŠ” ê³ ì°¨ì›ì ì¸ ë°ì´í„° ë¶„ì„ì´ ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.</p>

                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="collapsible-toggle">í™”ë©´ í‘œì‹œ í—¤ë” <span class="toggle-icon">â–¶</span></h3>
                    <div class="collapsible-content">
                        <div id="initial-columns-container">
                            <p>ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì¶”ì¶œí•˜ë©´ ì „ì²´ í—¤ë” ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <h3 class="collapsible-toggle">í•µì‹¬ ê¸°ëŠ¥ í—¤ë” ë§¤í•‘ <span class="toggle-icon">â–¶</span></h3>
                    <div class="collapsible-content">
                        <p class="description">ì—‘ì…€ í—¤ë”ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ, ì´ ê³³ì˜ ê°’ì„ ìˆ˜ì •í•˜ì—¬ ê¸°ëŠ¥ì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <div class="control-item" style="margin-bottom: 10px;">
                            <label for="pr-header-input">PR ë²ˆí˜¸ í—¤ë”</label>
                            <input type="text" id="pr-header-input" value="PRë²ˆí˜¸">
                        </div>
                        <div class="control-item" style="margin-bottom: 10px;">
                            <label for="po-header-input">PO ë²ˆí˜¸ í—¤ë”</label>
                            <input type="text" id="po-header-input" value="POë²ˆí˜¸">
                        </div>
                        <div class="control-item" style="margin-bottom: 10px;">
                            <label for="building-header-input">ê±´ë¬¼ ë™ í—¤ë”</label>
                            <input type="text" id="building-header-input" value="ê±´ë¬¼ë™">
                        </div>
                        <div class="control-item" style="margin-bottom: 10px;">
                            <label for="unit-header-input">í˜¸ì‹¤ í—¤ë”</label>
                            <input type="text" id="unit-header-input" value="í˜¸ì‹¤">
                        </div>
                        <div class="control-item">
                            <label for="amount-keyword-input">ê¸ˆì•¡ ì‹ë³„ í‚¤ì›Œë“œ</label>
                            <input type="text" id="amount-keyword-input" value="ê¸ˆì•¡">
                        </div>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>ì¶”ì¶œ ê²°ê³¼ ì €ì¥</h3>
                    <button id="download-button">ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œ</button>
                </div>
                <div class="settings-section">
                    <h3>ì„¤ì • í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥</h3>
                    <p class="description">í˜„ì¬ì˜ 'í™”ë©´ í‘œì‹œ í—¤ë”'ì™€ 'í—¤ë” ë§¤í•‘' ì„¤ì •ì„ í¬í•¨í•œ ìƒˆ HTML íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤. íŠ¹ì • ì—‘ì…€ í¬ë§· ì „ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
                    <button id="save-html-button">í˜„ì¬ ì„¤ì •ìœ¼ë¡œ HTML ì €ì¥</button>
                </div>
            </div>
            <div id="resizer-handle" class="resizer-handle"></div>
        </div>
    </div>
    <div id="custom-confirm-overlay"><div id="custom-confirm-box"><p id="custom-confirm-message"></p><div id="custom-confirm-buttons"><button id="custom-confirm-cancel">ì·¨ì†Œ</button><button id="custom-confirm-ok">í™•ì¸</button></div></div></div>
    
    <div id="custom-tooltip">
        <button id="tooltip-close-btn">Ã—</button>
        <span id="tooltip-content"></span>
    </div>

<script>
let finalResults = { originalRows: [], displayRows: [], summaryGroups: new Map() };
let viewState = { colorFilter: null, sortedViewSort: { key: null, direction: 'none' }, visibleColumns: [] };

const DEFAULT_INITIAL_HEADERS = ["íšŒê³„ ì—°ë„", "íšŒê³„ ë§ˆê°", "ë°œì£¼ì²˜", "ì‘ì—…ìœ í˜•", "ë¹„ìš©ë°°ë¶„", "ê³„ì•½ëª…", "ë‚™ì°°ê¸ˆì•¡", "POê¸ˆì•¡", "PRê¸ˆì•¡", "POë²ˆí˜¸", "PRë²ˆí˜¸", "ê±´ë¬¼ë™", "í˜¸ì‹¤", "íŠ¹ì´ì‚¬í•­"];

const MIN_COLUMN_WIDTH = 120; 
const MAX_COLUMN_WIDTH = 600; 

const searchInput = document.getElementById('search-input');
const prpoInput = document.getElementById('prpo-input');
const buildingInput = document.getElementById('building-input');
const unitInput = document.getElementById('unit-input');
const runButton = document.getElementById('run-button');
const loader = document.getElementById('loader');
const resultsArea = document.getElementById('results-area');
const summaryContainer = document.getElementById('summary-container');
const resultContainer = document.getElementById('result-container');
const settingsButton = document.getElementById('settings-button');
const settingsPanelOverlay = document.getElementById('settings-panel-overlay');
const settingsCloseButton = document.getElementById('settings-close-button');
const dataSourceRadios = document.querySelectorAll('input[name="dataSource"]');
const urlInputSection = document.getElementById('url-input-section');
const desktopInputSection = document.getElementById('desktop-input-section');
const urlInput = document.getElementById('url-input');
const fileInput = document.getElementById('file-input');
const downloadButton = document.getElementById('download-button');
const columnSelectButton = document.getElementById('column-select-button');
const columnSelectPanel = document.getElementById('column-select-panel');
const saveHtmlButton = document.getElementById('save-html-button');
const bldgUnitTooltip = document.getElementById('bldg-unit-tooltip');

runButton.addEventListener('click', handleRun);
downloadButton.addEventListener('click', handleDownload);
saveHtmlButton.addEventListener('click', handleSaveAsHTML);
document.getElementById('reset-button').addEventListener('click', handleReset);
summaryContainer.addEventListener('click', handleSummaryInteraction);
resultContainer.addEventListener('click', handleSortInteraction);
resultContainer.addEventListener('click', handleCellFocus);
settingsButton.addEventListener('click', () => { settingsPanelOverlay.style.display = 'flex'; });
settingsCloseButton.addEventListener('click', () => { settingsPanelOverlay.style.display = 'none'; });
settingsPanelOverlay.addEventListener('click', (e) => { if (e.target === settingsPanelOverlay) { settingsPanelOverlay.style.display = 'none'; } });
dataSourceRadios.forEach(radio => { radio.addEventListener('change', (e) => { urlInputSection.classList.toggle('active', e.target.value === 'url'); desktopInputSection.classList.toggle('active', e.target.value === 'desktop'); }); });
columnSelectButton.addEventListener('click', (e) => { e.stopPropagation(); const isDisplayed = columnSelectPanel.style.display === 'block'; columnSelectPanel.style.display = isDisplayed ? 'none' : 'block'; e.currentTarget.title = isDisplayed ? 'ì—´ ì„ íƒ íŒ¨ë„ ì—´ê¸°' : 'ì—´ ì„ íƒ íŒ¨ë„ ë‹«ê¸°'; });
document.addEventListener('click', (e) => { if (!columnSelectPanel.contains(e.target) && e.target !== columnSelectButton) { if (columnSelectPanel.style.display === 'block') { columnSelectPanel.style.display = 'none'; columnSelectButton.title = 'ì—´ ì„ íƒ íŒ¨ë„ ì—´ê¸°'; } } });

buildingInput.addEventListener('focus', () => { bldgUnitTooltip.style.display = 'block'; });
buildingInput.addEventListener('blur', () => { bldgUnitTooltip.style.display = 'none'; });
unitInput.addEventListener('focus', () => { bldgUnitTooltip.style.display = 'block'; });
unitInput.addEventListener('blur', () => { bldgUnitTooltip.style.display = 'none'; });

function initialize() { 
    urlInput.value = "https://jonggunelee.github.io/wyggkr04/RawData/RawData_(ê¸°ìˆ™ì‚¬%20ë°%20ì‚¬íƒ%20í˜„í™©).xlsx"; 
    document.getElementById('source-url').checked = true; 
    urlInputSection.classList.add('active'); 
    desktopInputSection.classList.remove('active'); 
    columnSelectButton.title = 'ì—´ ì„ íƒ íŒ¨ë„ ì—´ê¸°'; 
    populateHeaderSettings();
    makePanelInteractive();
    setupCollapsibleSections();
    setupCustomTooltips();
}

initialize();


function adjustPlaceholderSize(inputElement) {
    const minFontSize = 8; 
    const maxFontSize = 16; 
    const textLength = inputElement.value.length;
    
    if (textLength > 0) {
        let newSize = maxFontSize - (textLength / 5);
        if (newSize < minFontSize) {
            newSize = minFontSize;
        }
        inputElement.style.setProperty('--placeholder-font-size', `${newSize}px`);
    } else {
        inputElement.style.setProperty('--placeholder-font-size', `${maxFontSize}px`);
    }
}

document.head.insertAdjacentHTML('beforeend', `<style>
    #search-input, #prpo-input, #building-input, #unit-input {
        font-size: var(--placeholder-font-size, 16px);
        transition: font-size 0.2s;
    }
</style>`);

function makePanelInteractive() {
    const panel = document.getElementById('settings-panel');
    const header = document.querySelector('.settings-panel-header');
    const resizer = document.getElementById('resizer-handle');

    let isDragging = false;
    let isResizing = false;
    let offsetX, offsetY, startX, startY, startWidth, startHeight;

    header.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'BUTTON') return;
        e.preventDefault();
        isDragging = true;
        offsetX = e.clientX - panel.offsetLeft;
        offsetY = e.clientY - panel.offsetTop;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
    
    resizer.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = panel.offsetWidth;
        startHeight = panel.offsetHeight;
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });

    function onMouseMove(e) {
        if (isDragging) {
            panel.style.left = (e.clientX - offsetX) + 'px';
            panel.style.top = (e.clientY - offsetY) + 'px';
        }
        if (isResizing) {
            const newWidth = startWidth + (e.clientX - startX);
            const newHeight = startHeight + (e.clientY - startY);
            panel.style.width = newWidth + 'px';
            panel.style.height = newHeight + 'px';
        }
    }

    function onMouseUp() {
        isDragging = false;
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }
}

function setupCollapsibleSections() {
    document.querySelectorAll('.collapsible-toggle').forEach(toggle => {
        toggle.addEventListener('click', () => {
            const section = toggle.closest('.settings-section');
            section.classList.toggle('active');
            const icon = toggle.querySelector('.toggle-icon');
            icon.textContent = section.classList.contains('active') ? 'â–¼' : 'â–¶';
        });
    });
}


async function handleRun() { 
    const searchTerms = searchInput.value.split(',').map(term => term.trim()).filter(term => term); 
    const prpoTerms = prpoInput.value.split(',').map(term => term.trim()).filter(term => term); 
    const buildingTerm = buildingInput.value.trim();
    const unitTerm = unitInput.value.trim();

    if (searchTerms.length === 0 && prpoTerms.length === 0 && !buildingTerm && !unitTerm) { 
        alert('í•˜ë‚˜ ì´ìƒì˜ ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); 
        return; 
    } 
    
    loader.style.display = 'block'; 
    resultsArea.style.display = 'none'; 
    try { 
        let arrayBuffer; 
        const selectedSource = document.querySelector('input[name="dataSource"]:checked').value; 
        if (selectedSource === 'url') { 
            const url = urlInput.value; 
            if (!url) { throw new Error("ì—‘ì…€ íŒŒì¼ URL ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); } 
            const response = await fetch(url); 
            if (!response.ok) { throw new Error(`URLì—ì„œ íŒŒì¼ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ: ${response.status})`); } 
            arrayBuffer = await response.arrayBuffer(); 
        } else { 
            const file = fileInput.files[0]; 
            if (!file) { throw new Error("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); } 
            arrayBuffer = await file.arrayBuffer(); 
        } 
        const data = new Uint8Array(arrayBuffer); 
        const workbook = XLSX.read(data, { type: 'array', cellDates: true }); 
        const userConfirmed = await getAndConfirmDateRange(workbook); 
        if (userConfirmed) { 
            processWorkbook(workbook, searchTerms, prpoTerms, buildingTerm, unitTerm); 
        } else { 
            console.log("ì‚¬ìš©ìê°€ ì¶”ì¶œì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤."); 
        } 
    } catch (error) { 
        console.error("ì˜¤ë¥˜:", error); 
        alert(`ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n${error.message}`); 
    } finally { 
        loader.style.display = 'none'; 
    } 
}
function showCustomConfirm(messageParts) { return new Promise(resolve => { const overlay = document.getElementById('custom-confirm-overlay'); const messageBox = document.getElementById('custom-confirm-message'); const okButton = document.getElementById('custom-confirm-ok'); const cancelButton = document.getElementById('custom-confirm-cancel'); messageBox.innerHTML = `<span>${messageParts.part1}</span><span class="highlight-text">${messageParts.highlight}</span><span>${messageParts.part2}</span>`; overlay.style.display = 'flex'; const close = (result) => { overlay.style.display = 'none'; okButton.onclick = null; cancelButton.onclick = null; resolve(result); }; okButton.onclick = () => close(true); cancelButton.onclick = () => close(false); }); }
async function getAndConfirmDateRange(workbook) { try { const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' }); if (jsonData.length < 2) return true; const header = jsonData[0]; const dateColumnIndex = header.indexOf('íšŒê³„ ë§ˆê°'); if (dateColumnIndex === -1) { console.warn("'íšŒê³„ ë§ˆê°' ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ë²”ìœ„ í™•ì¸ì„ ê±´ë„ˆëœë‹ˆë‹¤."); return true; } let minDate = null, maxDate = null; for (let i = 1; i < jsonData.length; i++) { const cellValue = jsonData[i][dateColumnIndex]; let currentDate = null; if (cellValue instanceof Date) { currentDate = cellValue; } else if (typeof cellValue === 'number' && cellValue > 25569) { currentDate = new Date((cellValue - 25569) * 86400 * 1000); } if (currentDate && !isNaN(currentDate.getTime())) { if (!minDate || currentDate < minDate) minDate = currentDate; if (!maxDate || currentDate > maxDate) maxDate = currentDate; } } if (minDate && maxDate) { const formatYearMonthKorean = (date) => `${date.getFullYear()}ë…„ ${String(date.getMonth() + 1).padStart(2, '0')}ì›”`; const startRange = formatYearMonthKorean(minDate); const endRange = formatYearMonthKorean(maxDate); const messageParts = { part1: `ê²€ìƒ‰ ë²”ìœ„ëŠ” ${startRange} ë§ë¶€í„° ${endRange} ë§ê¹Œì§€ ë°œí–‰ì´ ì™„ë£Œëœ ì„¸ê¸ˆê³„ì‚°ì„œ ê¸°ì¤€ ì´ë©°,`, highlight: "í˜„ì¬ ì‘ì—… ì¤‘ì¸ ê±´ì€ ì œì™¸ë©ë‹ˆë‹¤.", part2: "ê³„ì† ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" }; return await showCustomConfirm(messageParts); } else { console.warn("'íšŒê³„ ë§ˆê°' ì—´ì—ì„œ ìœ íš¨í•œ ë‚ ì§œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ë²”ìœ„ í™•ì¸ì„ ê±´ë„ˆëœë‹ˆë‹¤."); return true; } } catch (e) { console.error("ë‚ ì§œ ë²”ìœ„ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e); return true; } }

function processWorkbook(workbook, searchTerms, prpoTerms, buildingTerm, unitTerm) {
    let header = [];
    let amountColumnIndices = [];
    let prColumnIndex = -1;
    let poColumnIndex = -1;
    let buildingColumnIndex = -1;
    let unitColumnIndex = -1;
    let specialNotesColumnIndex = -1;
    let processedRows = [];

    const prHeader = document.getElementById('pr-header-input').value.trim();
    const poHeader = document.getElementById('po-header-input').value.trim();
    const buildingHeader = document.getElementById('building-header-input').value.trim();
    const unitHeader = document.getElementById('unit-header-input').value.trim();
    const amountKeyword = document.getElementById('amount-keyword-input').value.trim();

    const allSearchItems = [...searchTerms.map(term => ({ term, type: 'main' })), ...prpoTerms.map(term => ({ term, type: 'prpo' }))];
    const suffixRegex = /-[0-9]{2}$/;

    workbook.SheetNames.forEach((sheetName, index) => {
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
        if (index === 0) {
            header = jsonData[0];
            
            const isFirstRun = !finalResults.header || finalResults.header.length === 0;
            if (isFirstRun) {
                viewState.visibleColumns = header.map(h => DEFAULT_INITIAL_HEADERS.includes(h));
            } else {
                const oldVisibleHeaders = finalResults.header.filter((h, i) => viewState.visibleColumns[i]);
                viewState.visibleColumns = header.map(h => oldVisibleHeaders.includes(h));
            }

            header.forEach((h, i) => {
                const headerText = String(h);
                if (amountKeyword && headerText.includes(amountKeyword)) amountColumnIndices.push(i);
                if (prHeader && headerText === prHeader) prColumnIndex = i;
                if (poHeader && headerText === poHeader) poColumnIndex = i;
                if (buildingHeader && headerText === buildingHeader) buildingColumnIndex = i;
                if (unitHeader && headerText === unitHeader) unitColumnIndex = i;
                if (headerText === 'íŠ¹ì´ì‚¬í•­') specialNotesColumnIndex = i;
            });
        }
        jsonData.slice(1).forEach(row => {
            const hasKeywordInput = allSearchItems.length > 0;
            const matchingTerms = [];
            
            if (hasKeywordInput) {
                allSearchItems.forEach(item => {
                    let isMatch = false;
                    if (item.type === 'main') { isMatch = row.some(cell => cellContains(cell, item.term)); } 
                    else if (item.type === 'prpo') {
                        if (prColumnIndex > -1 || poColumnIndex > -1) {
                            const prValue = String(row[prColumnIndex] || ''), poValue = String(row[poColumnIndex] || '');
                            const searchTermHasSuffix = suffixRegex.test(item.term);
                            const prCellToCompare = searchTermHasSuffix ? prValue : prValue.replace(suffixRegex, '').trim();
                            const poCellToCompare = searchTermHasSuffix ? poValue : poValue.replace(suffixRegex, '').trim();
                            if ((prColumnIndex > -1 && prCellToCompare.includes(item.term)) || (poColumnIndex > -1 && poCellToCompare.includes(item.term))) {
                                isMatch = true;
                            }
                        }
                    }
                    if (isMatch) { matchingTerms.push(item.term); }
                });
            }
            const keywordCriteriaMet = !hasKeywordInput || matchingTerms.length > 0;

            const buildingValue = buildingColumnIndex > -1 ? String(row[buildingColumnIndex] || '') : '';
            const unitValue = unitColumnIndex > -1 ? String(row[unitColumnIndex] || '') : '';
            const buildingCriteriaMet = !buildingTerm || cellContains(buildingValue, buildingTerm);
            const unitCriteriaMet = !unitTerm || cellContains(unitValue, unitTerm);

            if (keywordCriteriaMet && buildingCriteriaMet && unitCriteriaMet) {
                const uniqueTerms = [...new Set(matchingTerms)].sort();
                const groupKey = uniqueTerms.length > 0 ? uniqueTerms.join(' + ') : 'ê¸°íƒ€ ì¡°ê±´ ê²€ìƒ‰';
                processedRows.push({ data: row, groupKey: groupKey, matchingTerms: uniqueTerms });
            }
        });
    });

    const summaryGroups = new Map();
    processedRows.forEach(row => {
        if (!summaryGroups.has(row.groupKey)) {
            summaryGroups.set(row.groupKey, { term: row.groupKey, color: generatePaleColor(), rows: [] });
        }
        summaryGroups.get(row.groupKey).rows.push(row);
    });

    finalResults = { header, amountColumnIndices, specialNotesColumnIndex, originalRows: processedRows, summaryGroups };
    populateColumnSelector();
    populateHeaderSettings();
    handleReset();
}

function handleColumnVisibilityChange(index, isChecked) {
    viewState.visibleColumns[index] = isChecked;
    const mainPanelCheckbox = document.getElementById(`col-check-${index}`);
    if (mainPanelCheckbox) mainPanelCheckbox.checked = isChecked;
    const settingsPanelCheckbox = document.getElementById(`setting-col-check-${index}`);
    if (settingsPanelCheckbox) settingsPanelCheckbox.checked = isChecked;
    [document.getElementById('select-all-columns'), document.getElementById('setting-select-all-columns')].forEach(selectAllCb => {
        if(selectAllCb) {
             const parent = selectAllCb.closest('.column-select-panel, #initial-columns-container');
             if(parent) {
                const allCheckboxes = parent.querySelectorAll('ul input[type="checkbox"]');
                selectAllCb.checked = [...allCheckboxes].every(c => c.checked);
             }
        }
    });
    renderResultTable();
}

function handleRestoreDefaultColumns() {
    if (!finalResults.header) return;
    viewState.visibleColumns = finalResults.header.map(h => DEFAULT_INITIAL_HEADERS.includes(h));
    
    populateColumnSelector();
    populateHeaderSettings();
    renderResultTable();
}

function populateHeaderSettings() {
    const container = document.getElementById('initial-columns-container');
    if (!finalResults || !finalResults.header || finalResults.header.length === 0) {
        container.innerHTML = '<p>ì—‘ì…€ íŒŒì¼ì„ ë¨¼ì € ì¶”ì¶œí•˜ë©´ ì „ì²´ í—¤ë” ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
        return;
    }
    const controlsHtml = `<div class="settings-column-controls"><input type="text" id="setting-search-column-input" placeholder="ì—´ ì´ë¦„ ê²€ìƒ‰..."><div><label><input type="checkbox" id="setting-select-all-columns"> ì „ì²´ ì„ íƒ/í•´ì œ</label><button class="restore-button" id="setting-restore-defaults">ì´ˆê¸° ë³µì›</button></div></div>`;
    const listHtml = finalResults.header.map((h, i) => { const isChecked = viewState.visibleColumns[i] ? 'checked' : ''; return `<li><input type="checkbox" id="setting-col-check-${i}" data-index="${i}" ${isChecked}><label for="setting-col-check-${i}">${h}</label></li>`; }).join('');
    container.innerHTML = `${controlsHtml}<ul>${listHtml}</ul>`;
    
    const searchInput = document.getElementById('setting-search-column-input');
    const selectAllCheckbox = document.getElementById('setting-select-all-columns');
    const restoreButton = document.getElementById('setting-restore-defaults');
    const allCheckboxes = container.querySelectorAll('ul input[type="checkbox"]');

    searchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); container.querySelectorAll('ul li').forEach(li => { const label = li.querySelector('label').textContent.toLowerCase(); li.style.display = label.includes(searchTerm) ? '' : 'none'; }); });
    selectAllCheckbox.addEventListener('change', (e) => { const isChecked = e.target.checked; allCheckboxes.forEach(checkbox => { const index = parseInt(checkbox.dataset.index, 10); if(viewState.visibleColumns[index] !== isChecked) { handleColumnVisibilityChange(index, isChecked); } }); });
    allCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', (e) => { const index = parseInt(e.target.dataset.index, 10); handleColumnVisibilityChange(index, e.target.checked); }); });
    
    restoreButton.addEventListener('click', handleRestoreDefaultColumns);
    selectAllCheckbox.checked = [...allCheckboxes].every(c => c.checked);
}

function populateColumnSelector() { 
    if (!finalResults || !finalResults.header) return;
    const listHtml = finalResults.header.map((h, i) => { const isChecked = viewState.visibleColumns[i] ? 'checked' : ''; return `<li><input type="checkbox" id="col-check-${i}" data-index="${i}" ${isChecked}><label for="col-check-${i}">${h}</label></li>`; }).join(''); 
    columnSelectPanel.innerHTML = `<div class="column-select-controls"><input type="text" id="search-column-input" placeholder="ì—´ ì´ë¦„ ê²€ìƒ‰..."><div><label><input type="checkbox" id="select-all-columns"> ì „ì²´ ì„ íƒ/í•´ì œ</label><button class="restore-button" id="panel-restore-defaults">ì´ˆê¸° ë³µì›</button></div></div><div class="column-select-list"><ul>${listHtml}</ul></div>`; 
    
    const searchInput = document.getElementById('search-column-input'); 
    const selectAllCheckbox = document.getElementById('select-all-columns'); 
    const restoreButton = document.getElementById('panel-restore-defaults');
    const columnCheckboxes = columnSelectPanel.querySelectorAll('.column-select-list input[type="checkbox"]'); 
    
    searchInput.addEventListener('input', (e) => { const searchTerm = e.target.value.toLowerCase(); columnSelectPanel.querySelectorAll('.column-select-list li').forEach(li => { const label = li.querySelector('label').textContent.toLowerCase(); li.style.display = label.includes(searchTerm) ? '' : 'none'; }); }); 
    selectAllCheckbox.addEventListener('change', (e) => { const isChecked = e.target.checked; columnCheckboxes.forEach(checkbox => { const index = parseInt(checkbox.dataset.index, 10); if (viewState.visibleColumns[index] !== isChecked) { handleColumnVisibilityChange(index, isChecked); } }); }); 
    columnCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', (e) => { const index = parseInt(e.target.dataset.index, 10); handleColumnVisibilityChange(index, e.target.checked); }); }); 
    
    restoreButton.addEventListener('click', handleRestoreDefaultColumns);
    selectAllCheckbox.checked = [...columnCheckboxes].every(c => c.checked); 
}

function updateAndRender() { 
    let filteredRows = finalResults.originalRows; 
    if (viewState.colorFilter) { 
        filteredRows = finalResults.originalRows.filter(row => row.groupKey === viewState.colorFilter);
    } 
    finalResults.displayRows = filteredRows; 
    renderSummary(); 
    renderResultTable(); 
    resultsArea.style.display = 'block'; 
}

function renderSummary() {
    const { header, amountColumnIndices, summaryGroups } = finalResults;
    if (!header) return;
    const summaryHeader = ['ê²€ìƒ‰ê°’', 'ì°¾ì€ í–‰'];
    amountColumnIndices.forEach(idx => summaryHeader.push(`${header[idx]} í•©ê³„`));
    let html = `<table><colgroup>`;
    summaryHeader.forEach(() => html += '<col>');
    html += '</colgroup><thead><tr>';
    summaryHeader.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    const sortedGroups = [...summaryGroups.values()].sort((a, b) => b.rows.length - a.rows.length);

    sortedGroups.forEach(group => {
        if (viewState.colorFilter && group.term !== viewState.colorFilter) {
            return;
        }

        const count = group.rows.length;
        if (count === 0) return;

        const totals = Array(header.length).fill(0);
        amountColumnIndices.forEach(idx => {
            totals[idx] = group.rows.reduce((sum, row) => sum + (typeof row.data[idx] === 'number' ? row.data[idx] : 0), 0);
        });
        
        const isActive = viewState.colorFilter === group.term;
        const filterTooltip = isActive ? `'${group.term}' ê·¸ë£¹ í•„í„° í•´ì œ` : `'${group.term}' ê·¸ë£¹ìœ¼ë¡œ í•„í„°ë§`;
        const countTooltip = `'${group.term}' ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í–‰ì˜ ì´ ê°œìˆ˜ì…ë‹ˆë‹¤.`;

        html += `<tr style="background-color: ${group.color};">`;
        html += `<td style="background-color: transparent; text-align: left; display: flex; align-items: center;"><span class="summary-term" data-term="${group.term}">${group.term}</span><i class="filter-icon ${isActive ? 'active' : ''}" data-term="${group.term}" title="${filterTooltip}">â§±</i></td>`;
        html += `<td style="background-color: transparent; text-align: center;" title="${countTooltip.replace(/"/g, '"')}">${count}</td>`;
        amountColumnIndices.forEach(idx => html += `<td style="background-color: transparent;">${formatNumber(totals[idx])}</td>`);
        html += `</tr>`;
    });
    
    html += '</tbody></table>';
    summaryContainer.innerHTML = html;
    const table = summaryContainer.querySelector('table');
    if (table) {
        adjustAllColumnWidths(table, []); 
        makeResizable(table);
    }
}

function renderTable(container, rows, withSort) {
    const { header, amountColumnIndices, specialNotesColumnIndex, summaryGroups } = finalResults;
    let sortedDisplayData = [...rows]; 

    if (withSort && viewState.sortedViewSort.key !== null && viewState.sortedViewSort.direction !== 'none') {
        const { key, direction } = viewState.sortedViewSort;
        
        if (key === -1) {
            if (direction === 'desc') {
                sortedDisplayData.reverse();
            }
        } else {
            sortedDisplayData.sort((a, b) => {
                const valA = a.data[key], valB = b.data[key];
                let comparison = 0;
                if (typeof valA === 'number' && typeof valB === 'number') { comparison = valA - valB; } 
                else if (valA instanceof Date && valB instanceof Date) { comparison = valA - valB; } 
                else { comparison = String(valA).localeCompare(String(valB)); }
                return direction === 'asc' ? comparison : -comparison;
            });
        }
    }

    const totalRows = sortedDisplayData.length;
    const padLength = String(totalRows).length;
    let html = `<div class="focus-overlay"></div><div class="focus-overlay"></div><table><colgroup><col>`;
    header.forEach((h, i) => { if (viewState.visibleColumns[i]) { html += '<col>'; } });
    html += `</colgroup><thead><tr>`;
    
    if (withSort) {
        const { key, direction } = viewState.sortedViewSort;
        let asc_class = (key === -1 && direction === 'asc') ? 'active' : '';
        let desc_class = (key === -1 && direction === 'desc') ? 'active' : '';
        html += `<th>
                    <div class="header-content" data-key="-1">
                        ë²ˆí˜¸
                        <div class="sort-arrows">
                            <span class="sort-arrow sort-up ${asc_class}">â–²</span>
                            <span class="sort-arrow sort-down ${desc_class}">â–¼</span>
                        </div>
                    </div>
                 </th>`;
    } else {
        html += `<th>ë²ˆí˜¸</th>`;
    }

    header.forEach((h, i) => {
        if (viewState.visibleColumns[i]) {
            if (withSort) {
                const { key, direction } = viewState.sortedViewSort;
                let asc_class = (key === i && direction === 'asc') ? 'active' : '';
                let desc_class = (key === i && direction === 'desc') ? 'active' : '';
                
                html += `<th>
                            <div class="header-content" data-key="${i}">
                                ${h}
                                <div class="sort-arrows">
                                    <span class="sort-arrow sort-up ${asc_class}">â–²</span>
                                    <span class="sort-arrow sort-down ${desc_class}">â–¼</span>
                                </div>
                            </div>
                         </th>`;
            } else {
                html += `<th>${h}</th>`;
            }
        }
    });
    html += `</tr></thead><tbody>`;

    sortedDisplayData.forEach((row, index) => {
        let rowColor = '';
        const group = summaryGroups.get(row.groupKey);
        if (group) {
            rowColor = group.color;
        }

        html += '<tr>';
        const rowNumber = String(index + 1).padStart(padLength, '0');
        const numberCellStyle = `background-color: ${rowColor}; text-align: center;`;
        html += `<td style="${numberCellStyle}">${rowNumber}</td>`;

        row.data.forEach((cell, i) => {
            if (viewState.visibleColumns[i]) {
                let cellStyle = '';
                if (row.matchingTerms && row.matchingTerms.some(term => cellContains(cell, term))) {
                    cellStyle = `background-color: ${rowColor};`;
                }

                let alignmentStyle = '';
                if (amountColumnIndices.includes(i)) { alignmentStyle = 'text-align: right;'; } 
                else if (i !== specialNotesColumnIndex) { alignmentStyle = 'text-align: center;'; }
                html += `<td style="${cellStyle} ${alignmentStyle}">${formatValue(cell, i)}</td>`;
            }
        });
        html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
    const table = container.querySelector('table');
    if (table) {
        adjustAllColumnWidths(table, finalResults.displayRows);
        makeResizable(table);
    }
}

function setupCustomTooltips() {
    const tooltip = document.getElementById('custom-tooltip');
    const tooltipContent = document.getElementById('tooltip-content');
    const tooltipCloseBtn = document.getElementById('tooltip-close-btn');

    if (!tooltip || !tooltipContent || !tooltipCloseBtn) return;

    const containers = [resultContainer, summaryContainer];
    
    let isDragging = false;
    let offsetX, offsetY;
    let sourceCell = null; 

    const hideTooltip = () => {
        tooltip.style.display = 'none';
        tooltip.style.width = '';
        tooltip.style.height = '';
        if (sourceCell) {
            sourceCell.classList.remove('tooltip-source-cell');
            sourceCell = null;
        }
    };
    
    containers.forEach(container => {
        container.addEventListener('mouseover', e => {
            const cell = e.target;
            if (cell.tagName === 'TD' && cell.scrollWidth > cell.clientWidth) {
                cell.title = 'Ctrl+Clickìœ¼ë¡œ ì „ì²´ ë‚´ìš©ì„ í™•ì¸í•©ë‹ˆë‹¤.';
            }
        });
        container.addEventListener('mouseout', e => {
            const cell = e.target;
            if (cell.tagName === 'TD') {
                cell.title = '';
            }
        });

        container.addEventListener('click', e => {
            if (e.ctrlKey && e.target.tagName === 'TD') {
                e.preventDefault();
                const cell = e.target;
                
                if (sourceCell) {
                    sourceCell.classList.remove('tooltip-source-cell');
                }
                
                sourceCell = cell;
                sourceCell.classList.add('tooltip-source-cell');
                
                tooltipContent.textContent = cell.textContent;
                tooltip.style.left = (e.pageX + 5) + 'px';
                tooltip.style.top = (e.pageY + 5) + 'px';
                tooltip.style.display = 'block';
            }
        });
    });

    tooltip.addEventListener('mousedown', e => {
        if (e.target.id === 'tooltip-close-btn' || getComputedStyle(e.target).cursor === 'se-resize') {
            return;
        }
        isDragging = true;
        offsetX = e.clientX - tooltip.offsetLeft;
        offsetY = e.clientY - tooltip.offsetTop;
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', onStopDrag);
    });

    function onDrag(e) {
        if (isDragging) {
            tooltip.style.left = (e.clientX - offsetX) + 'px';
            tooltip.style.top = (e.clientY - offsetY) + 'px';
        }
    }

    function onStopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', onStopDrag);
    }
    
    tooltipCloseBtn.addEventListener('click', hideTooltip);
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            hideTooltip();
        }
    });
}


function handleDownload() { if (!finalResults || !finalResults.displayRows.length === 0) { alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; } const { header, displayRows } = finalResults; const visibleHeader = ['ë²ˆí˜¸', ...header.filter((h, i) => viewState.visibleColumns[i])]; const totalRows = displayRows.length; const padLength = String(totalRows).length; const dataForSheet = displayRows.map((row, rowIndex) => { const rowNumber = String(rowIndex + 1).padStart(padLength, '0'); const visibleRowData = row.data.filter((cell, i) => viewState.visibleColumns[i]); return [rowNumber, ...visibleRowData.map((cell, i) => formatValue(cell, header.indexOf(visibleHeader[i + 1]), true))]; }); const ws = XLSX.utils.aoa_to_sheet([visibleHeader, ...dataForSheet]); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data"); XLSX.writeFile(wb, `Export_${new Date().toISOString().slice(0, 19).replace(/[-T:]/g, "")}.xlsx`); }
function renderResultTable() { 
    renderTable(resultContainer, finalResults.displayRows, true); 
}
function handleSortInteraction(e) { const headerContent = e.target.closest('.header-content'); if (!headerContent) return; const key = Number(headerContent.dataset.key); if (viewState.sortedViewSort.key === key) { const currentDirection = viewState.sortedViewSort.direction; if (currentDirection === 'asc') { viewState.sortedViewSort.direction = 'desc'; } else if (currentDirection === 'desc') { viewState.sortedViewSort.direction = 'none'; } else { viewState.sortedViewSort.direction = 'asc'; } } else { viewState.sortedViewSort = { key, direction: 'asc' }; } renderResultTable(); }
function handleSummaryInteraction(e) { const filterIcon = e.target.closest('.filter-icon'); if (filterIcon) { const term = filterIcon.dataset.term; viewState.colorFilter = viewState.colorFilter === term ? null : term; updateAndRender(); } }
function handleReset() { viewState.colorFilter = null; viewState.sortedViewSort = { key: null, direction: 'none' }; if (finalResults && finalResults.originalRows) { updateAndRender(); } else { resultsArea.style.display = 'none'; } }
function handleCellFocus(e) { 
    if (e.ctrlKey) return;

    const clickedCell = e.target; 
    if (clickedCell.tagName !== 'TD' || clickedCell.closest('thead')) return; 
    const container = clickedCell.closest('.table-container'); 
    if (!container) return; 
    const focusOverlays = container.querySelectorAll('.focus-overlay'); 
    if (focusOverlays.length < 2) return; 
    const [focusRow, focusCol] = focusOverlays; 
    focusRow.style.display = 'none'; 
    focusCol.style.display = 'none'; 
    const table = clickedCell.closest('table'); 
    const tbody = table.querySelector('tbody'); 
    const parentRow = clickedCell.parentNode; 
    if (!tbody || !parentRow) return; 
    const containerRect = container.getBoundingClientRect(); 
    const tableRect = table.getBoundingClientRect(); 
    const tbodyRect = tbody.getBoundingClientRect();
    const rowRect = parentRow.getBoundingClientRect(); 
    const cellRect = clickedCell.getBoundingClientRect(); 
    
    const scrollTop = container.scrollTop;
    const scrollLeft = container.scrollLeft;
    
    focusRow.style.top = `${rowRect.top - containerRect.top + scrollTop}px`; 
    focusRow.style.left = `${tableRect.left - containerRect.left + scrollLeft}px`; 
    focusRow.style.width = `${tableRect.width}px`; 
    focusRow.style.height = `${rowRect.height}px`; 
    
    focusCol.style.top = `${tbodyRect.top - containerRect.top + scrollTop}px`; 
    focusCol.style.left = `${cellRect.left - containerRect.left + scrollLeft}px`; 
    focusCol.style.width = `${cellRect.width}px`; 
    focusCol.style.height = `${tbodyRect.height}px`; 
    
    focusRow.style.clipPath = `polygon(0% 0%, 0% 100%, ${cellRect.left - tableRect.left}px 100%, ${cellRect.left - tableRect.left}px 0%, ${cellRect.right - tableRect.left}px 0%, ${cellRect.right - tableRect.left}px 100%, 100% 100%, 100% 0%)`;
    focusCol.style.clipPath = `polygon(0% 0%, 100% 0%, 100% ${rowRect.top - tbodyRect.top}px, 0% ${rowRect.top - tbodyRect.top}px, 0% ${rowRect.bottom - tbodyRect.top}px, 100% ${rowRect.bottom - tbodyRect.top}px, 100% 100%, 0% 100%)`;

    focusRow.style.display = 'block'; 
    focusCol.style.display = 'block'; 
}
function hideFocusOnScroll(e) { const container = e.currentTarget; const overlays = container.querySelectorAll('.focus-overlay'); overlays.forEach(overlay => { overlay.style.display = 'none'; }); }
[resultContainer, summaryContainer].forEach(container => { container.addEventListener('scroll', hideFocusOnScroll); });
function formatValue(value, index, forExport = false) { if (finalResults && finalResults.amountColumnIndices.includes(index) && typeof value === 'number') { return forExport ? value : formatNumber(value); } if (value instanceof Date) return value.toISOString().split('T')[0]; return value; }
function cellContains(v, s) { if (v === null || v === undefined || s === null || s === undefined || s === '') return false; return String(v).toLowerCase().includes(s.toLowerCase()); }

function formatNumber(n) { 
    if (typeof n === 'number') {
        return Math.round(n).toLocaleString('ko-KR');
    }
    return n;
}

function generatePaleColor() { const r = Math.floor(Math.random() * 76) + 180; const g = Math.floor(Math.random() * 76) + 180; const b = Math.floor(Math.random() * 76) + 180; return `rgba(${r}, ${g}, ${b}, 0.4)`; }
const getTextWidth = (text, font) => { const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas")); const context = canvas.getContext("2d"); context.font = font; return context.measureText(text).width; };


function adjustAllColumnWidths(table, dataRows) {
    if (!table || !finalResults || !finalResults.header) return;

    const PADDING = 35;
    const FIXED_NUMBER_COL_WIDTH = 60;

    const headers = table.querySelectorAll("thead th");
    const anyHeaderElement = headers[0];
    if (!anyHeaderElement) return;

    const style = window.getComputedStyle(anyHeaderElement);
    const font = `${style.fontWeight} ${style.fontSize} ${style.fontFamily}`;
    
    const firstCol = table.querySelector("colgroup col:first-child");
    const firstHeader = headers[0];
    if (firstCol && firstHeader && firstHeader.textContent.includes('ë²ˆí˜¸')) {
        firstCol.style.width = `${FIXED_NUMBER_COL_WIDTH}px`;
    }

    let visibleColumnDomIndex = (firstCol && firstHeader && firstHeader.textContent.includes('ë²ˆí˜¸')) ? 2 : 1;
    finalResults.header.forEach((headerText, headerIndex) => {
        if (!viewState.visibleColumns[headerIndex]) {
            return;
        }

        const colElement = table.querySelector(`colgroup col:nth-child(${visibleColumnDomIndex})`);
        if (!colElement) return;

        let finalWidth;

        if (headerText === 'ê³„ì•½ëª…') {
            let maxWidth = getTextWidth(headerText, font);
            dataRows.forEach(row => {
                const cellValue = row.data[headerIndex];
                const textWidth = getTextWidth(cellValue ? String(cellValue) : '', font);
                if (textWidth > maxWidth) {
                    maxWidth = textWidth;
                }
            });
            const constrainedWidth = Math.max(maxWidth + PADDING, MIN_COLUMN_WIDTH);
            finalWidth = Math.min(constrainedWidth, MAX_COLUMN_WIDTH);

        } else {
            const headerWidth = getTextWidth(headerText, font);
            finalWidth = Math.max(headerWidth + PADDING, MIN_COLUMN_WIDTH);
        }
        
        colElement.style.width = `${finalWidth}px`;
        visibleColumnDomIndex++;
    });
}

function makeResizable(table) { if (!table) return; const headers = table.querySelectorAll("thead th"); const cols = table.querySelectorAll("colgroup > col"); const firstHeader = headers[0]; const hasNumberColumn = firstHeader && firstHeader.textContent.includes('ë²ˆí˜¸'); headers.forEach((header, i) => { if ((hasNumberColumn && i === 0) || i === headers.length - 1) return; const resizer = document.createElement("div"); resizer.className = "resizer"; header.appendChild(resizer); resizer.addEventListener("mousedown", (e) => { e.preventDefault(); const startX = e.pageX; const colIndex = i; const startWidth = cols[colIndex].offsetWidth; const handleMouseMove = (me) => { const newWidth = startWidth + (me.pageX - startX); if (newWidth > 30) cols[colIndex].style.width = newWidth + "px"; }; const handleMouseUp = () => { document.removeEventListener("mousemove", handleMouseMove); document.removeEventListener("mouseup", handleMouseUp); }; document.addEventListener("mousemove", handleMouseMove); document.addEventListener("mouseup", handleMouseUp); }); }); }

function handleSaveAsHTML() {
    const initialHeaders = (finalResults.header || []).filter((h, i) => viewState.visibleColumns[i]);
    
    const prValue = document.getElementById('pr-header-input').value;
    const poValue = document.getElementById('po-header-input').value;
    const buildingValue = document.getElementById('building-header-input').value;
    const unitValue = document.getElementById('unit-header-input').value;
    const amountValue = document.getElementById('amount-keyword-input').value;
    
    let newHtml = document.documentElement.outerHTML;

    const newDefaultHeaders = `const DEFAULT_INITIAL_HEADERS = ${JSON.stringify(initialHeaders)};`;
    newHtml = newHtml.replace(/const DEFAULT_INITIAL_HEADERS = .*?;/, newDefaultHeaders);

    newHtml = newHtml.replace(/(<input.*?id="pr-header-input".*?value=").*?"/, `$1${prValue}"`);
    newHtml = newHtml.replace(/(<input.*?id="po-header-input".*?value=").*?"/, `$1${poValue}"`);
    newHtml = newHtml.replace(/(<input.*?id="building-header-input".*?value=").*?"/, `$1${buildingValue}"`);
    newHtml = newHtml.replace(/(<input.*?id="unit-header-input".*?value=").*?"/, `$1${unitValue}"`);
    newHtml = newHtml.replace(/(<input.*?id="amount-keyword-input".*?value=").*?"/, `$1${amountValue}"`);

    const blob = new Blob([newHtml], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ì¶”ì¶œê¸°_í…œí”Œë¦¿_${new Date().toISOString().slice(0, 10)}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('í˜„ì¬ ì„¤ì •ì´ í¬í•¨ëœ ìƒˆ HTML íŒŒì¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
</script>
</body>
</html>