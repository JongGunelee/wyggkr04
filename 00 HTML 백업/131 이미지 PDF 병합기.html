<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>고급 폴더 PDF 병합 도구</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
      body {
        font-family: "Malgun Gothic", sans-serif;
        padding: 20px;
        background: #f0f2f5;
      }

      .card {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #1a73e8;
        border-bottom: 2px solid #1a73e8;
        padding-bottom: 10px;
      }

      .section {
        margin-bottom: 25px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .title {
        font-weight: bold;
        display: block;
        margin-bottom: 10px;
        color: #555;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 6px;
      }

      button:disabled {
        background: #ccc;
      }

      .ext-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .ext-item {
        background: #e8f0fe;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
      }

      #log {
        background: #333;
        color: #00ff00;
        padding: 15px;
        border-radius: 8px;
        height: 250px;
        overflow-y: auto;
        font-family: "Consolas", monospace;
        font-size: 13px;
        margin-top: 20px;
      }

      .warning {
        color: #d93025;
        font-size: 13px;
        margin-top: 5px;
      }

      /* ═══════════════════════════════════════════════════════════════════════════════
       CUSTOM CURSOR SYSTEM (PRD COMPLIANT - ABSOLUTE ENFORCEMENT v2.0)
       ═══════════════════════════════════════════════════════════════════════════════ */
      :root {
        --cursor-default:
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='39' height='39' viewBox='0 0 32 32'%3E%3Cpath d='M17 2a2 2 0 0 0-2 2v11l-1.4-1.4a2.1 2.1 0 0 0-3 0 2.1 2.1 0 0 0 0 3L17 23v6h10v-6l3-8.5a2 2 0 0 0-1.1-2.6 2 2 0 0 0-2.6 1.1L25 16V4a2 2 0 0 0-4 0v8h-2V4a2 2 0 0 0-2-2z' fill='%23f4c030' stroke='%23d4a017' stroke-width='0.5'/%3E%3C/svg%3E")
            13 3,
          auto !important;
        --cursor-active:
          url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='39' height='39' viewBox='0 0 32 32'%3E%3Cpath d='M10 14a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v0a2 2 0 0 1 2-2h1a2 2 0 0 1 2 2v7c0 5-3 8-7 8h-3c-4 0-7-3-7-8v-3a2 2 0 0 1 2-2z' fill='%23f4c030' stroke='%23d4a017' stroke-width='0.5'/%3E%3C/svg%3E")
            13 10,
          auto !important;
      }

      /* 1. Base Enforcement: Absolute override on all elements */
      html,
      body,
      *,
      *::before,
      *::after {
        cursor: var(--cursor-default) !important;
      }

      /* 2. Exceptions: Text input areas */
      input,
      textarea,
      [contenteditable="true"],
      [contenteditable="true"] *,
      .select-text,
      .select-text * {
        cursor: text !important;
      }

      button:disabled,
      .not-allowed {
        cursor: not-allowed !important;
      }

      /* 3. Explicit Function Cursors */
      [style*="cursor: nwse-resize"],
      [class*="top-left"],
      [class*="bottom-right"] {
        cursor: nwse-resize !important;
      }

      [style*="cursor: nesw-resize"],
      [class*="top-right"],
      [class*="bottom-left"] {
        cursor: nesw-resize !important;
      }

      [style*="cursor: ns-resize"],
      [class*="ch-top"],
      [class*="ch-bottom"] {
        cursor: ns-resize !important;
      }

      [style*="cursor: ew-resize"],
      [class*="ch-left"],
      [class*="ch-right"] {
        cursor: ew-resize !important;
      }

      [style*="cursor: se-resize"] {
        cursor: se-resize !important;
      }

      [style*="cursor: col-resize"],
      .resizer {
        cursor: col-resize !important;
      }

      [style*="cursor: move"],
      .image-annotation-text,
      #cropBox {
        cursor: move !important;
      }

      [style*="cursor: grabbing"],
      [style*="cursor: grab"] {
        cursor: grab !important;
      }

      [style*="cursor: copy"] {
        cursor: copy !important;
      }

      [style*="cursor: crosshair"],
      .resize-handle-img,
      .ghost-image {
        cursor: crosshair !important;
      }

      [style*="cursor: zoom-in"] {
        cursor: zoom-in !important;
      }

      [style*="cursor: zoom-out"] {
        cursor: zoom-out !important;
      }

      [style*="cursor: help"],
      .tooltip-source-cell {
        cursor: help !important;
      }

      /* 4. Clicking state: Highest Priority Universal Override */
      body.is-clicking,
      body.is-clicking * {
        cursor: var(--cursor-active) !important;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>문서 폴더 PDF 병합 도구</h1>

      <div class="section">
        <span class="title">1. 대상 폴더 선택</span>
        <button id="btnScan">폴더 선택 및 분석</button>
        <p class="warning">
          * 브라우저 보안 정책상 이미지(JPG, PNG)와 PDF만 실제 병합이
          가능합니다. (문서 파일 제외)
        </p>
      </div>

      <div id="settings" class="section" style="display: none">
        <span class="title">2. 병합 옵션 설정</span>

        <div style="margin-bottom: 15px">
          <strong>포함할 확장자 선택:</strong>
          <div id="extList" class="ext-group" style="margin-top: 10px"></div>
        </div>

        <div style="margin-bottom: 15px">
          <strong>페이지 방향 설정:</strong><br />
          <label
            ><input type="radio" name="orient" value="auto" checked /> 원본
            유지</label
          >
          <label style="margin-left: 15px"
            ><input type="radio" name="orient" value="portrait" /> A4
            세로</label
          >
          <label style="margin-left: 15px"
            ><input type="radio" name="orient" value="landscape" /> A4
            가로</label
          >
        </div>

        <button id="btnStart" style="background: #34a853; width: 100%">
          PDF 병합 및 원본 폴더에 저장 시작
        </button>
      </div>

      <div id="log">로그가 여기에 표시됩니다...</div>
    </div>

    <script>
      let rootHandle;
      let folderMap = new Map();
      let foundExtensions = new Set();

      const btnScan = document.getElementById("btnScan");
      const btnStart = document.getElementById("btnStart");
      const settings = document.getElementById("settings");
      const extList = document.getElementById("extList");
      const logElement = document.getElementById("log");

      function log(msg, color = "") {
        const div = document.createElement("div");
        div.textContent = `> ${msg}`;
        if (color) div.style.color = color;
        logElement.appendChild(div);
        logElement.scrollTop = logElement.scrollHeight;
      }

      btnScan.addEventListener("click", async () => {
        try {
          rootHandle = await window.showDirectoryPicker();
          const permission = await rootHandle.requestPermission({
            mode: "readwrite",
          });
          if (permission !== "granted") return alert("쓰기 권한이 필요합니다.");

          log(`폴더 스캔 중: ${rootHandle.name}`);
          folderMap.clear();
          foundExtensions.clear();
          await traverse(rootHandle);

          extList.innerHTML = "";
          foundExtensions.forEach((ext) => {
            const div = document.createElement("label");
            div.className = "ext-item";
            const isSupported = ["pdf", "jpg", "jpeg", "png"].includes(ext);
            div.innerHTML = `<input type="checkbox" value="${ext}" ${isSupported ? "checked" : ""}> ${ext.toUpperCase()}${!isSupported ? "(지원불가)" : ""}`;
            if (!isSupported) div.style.opacity = "0.5";
            extList.appendChild(div);
          });

          settings.style.display = "block";
          log("스캔 완료. 병합할 확장자를 선택하고 시작을 누르세요.");
        } catch (e) {
          log("오류: " + e.message, "red");
        }
      });

      async function traverse(dirHandle) {
        const files = [];
        for await (const entry of dirHandle.values()) {
          if (entry.kind === "directory") await traverse(entry);
          else {
            const ext = entry.name.split(".").pop().toLowerCase();
            if (ext) {
              files.push(entry);
              foundExtensions.add(ext);
            }
          }
        }
        if (files.length > 0) folderMap.set(dirHandle, files);
      }

      btnStart.addEventListener("click", async () => {
        const selectedExts = Array.from(
          extList.querySelectorAll("input:checked"),
        ).map((el) => el.value);
        const orientation = document.querySelector(
          'input[name="orient"]:checked',
        ).value;

        btnStart.disabled = true;
        for (const [dirHandle, entries] of folderMap) {
          const targetFiles = [];
          for (const entry of entries) {
            const file = await entry.getFile();
            const ext = file.name.split(".").pop().toLowerCase();
            if (selectedExts.includes(ext)) targetFiles.push(file);
          }

          if (targetFiles.length > 0) {
            await processFolder(dirHandle, targetFiles, orientation);
          }
        }
        log("전체 작업 종료", "#00ff00");
        btnStart.disabled = false;
      });

      async function processFolder(dirHandle, files, orient) {
        log(`${dirHandle.name} 폴더 병합 중...`);
        files.sort((a, b) =>
          a.name.localeCompare(b.name, undefined, { numeric: true }),
        );

        const mergedPdf = await PDFLib.PDFDocument.create();
        let addedCount = 0;

        for (const file of files) {
          const ext = file.name.split(".").pop().toLowerCase();
          if (!["pdf", "jpg", "jpeg", "png"].includes(ext)) {
            log(`- 건너뜀 (지원하지 않는 형식): ${file.name}`, "orange");
            continue;
          }

          try {
            const bytes = await file.arrayBuffer();
            if (ext === "pdf") {
              const doc = await PDFLib.PDFDocument.load(bytes);
              const pages = await mergedPdf.copyPages(
                doc,
                doc.getPageIndices(),
              );
              pages.forEach((p) => mergedPdf.addPage(p));
            } else {
              const img =
                ext === "png"
                  ? await mergedPdf.embedPng(bytes)
                  : await mergedPdf.embedJpg(bytes);
              const page = mergedPdf.addPage([
                orient === "landscape" ? 841.89 : 595.28,
                orient === "landscape" ? 595.28 : 841.89,
              ]);
              const { width, height } = img.scaleToFit(
                page.getWidth(),
                page.getHeight(),
              );
              page.drawImage(img, {
                x: (page.getWidth() - width) / 2,
                y: (page.getHeight() - height) / 2,
                width,
                height,
              });
            }
            addedCount++;
          } catch (e) {
            log(`- 실패: ${file.name}`, "red");
          }
        }

        if (addedCount > 0) {
          const pdfBytes = await mergedPdf.save();
          const outName = `${dirHandle.name}.pdf`;
          const fileHandle = await dirHandle.getFileHandle(outName, {
            create: true,
          });
          const writable = await fileHandle.createWritable();
          await writable.write(pdfBytes);
          await writable.close();
          log(`${outName} 저장 완료!`, "cyan");
        }
      }
    </script>

    <!-- ═══════════════════════════════════════════════════════════════════════════════
// GLOBAL INTERACTION HANDLERS (Custom Cursor Tracker)
// ═══════════════════════════════════════════════════════════════════════════════ -->
    <script>
      document.addEventListener("mousedown", () => {
        document.body.classList.add("is-clicking");
      });

      document.addEventListener("mouseup", () => {
        document.body.classList.remove("is-clicking");
      });
    </script>
  </body>
</html>
