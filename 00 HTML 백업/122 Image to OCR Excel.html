<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ë¯¸ì§€ OCR ë° ë¶„ì„</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SheetJS (Excel Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Marked (Markdown Rendering) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f1f5f9;
        }

        /* Loader Animation */
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Custom Scrollbar */
        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .chat-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        /* Markdown Styles */
        .prose p {
            margin-bottom: 0.5em;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.2em;
            margin-bottom: 0.5em;
        }

        .prose strong {
            color: #4338ca;
        }

        /* Fullscreen Animation */
        .fullscreen-transition {
            transition: all 0.3s ease-in-out;
        }

        /* Tooltip Styles */
        .custom-tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: 110%;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            z-index: 100;
            font-size: 0.8rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none;
            line-height: 1.5;
        }

        .custom-tooltip::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: transparent transparent #1f2937 transparent;
        }

        .group:hover .custom-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .tooltip-link {
            color: #60a5fa;
            text-decoration: underline;
            pointer-events: auto;
        }

        /* Table Styles */
        th {
            position: relative;
            text-align: center !important;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            background-color: transparent;
            z-index: 10;
        }

        .resize-handle:hover,
        .resize-handle.active {
            background-color: #6366f1;
        }

        tbody tr:hover td {
            background-color: #e0e7ff;
        }

        .selected-row td {
            background-color: #fef08a !important;
            border-top: 1px solid #ca8a04;
            border-bottom: 1px solid #ca8a04;
        }

        .selected-row td:first-child {
            border-left: 4px solid #ca8a04;
        }

        /* Image Styles */
        #compareImage {
            max-width: none !important;
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        /* Input Range Style */
        input[type=range] {
            -webkit-appearance: none;
            width: 100px;
            height: 4px;
            background: #6366f1;
            border-radius: 5px;
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            border: 2px solid #4f46e5;
        }

        /* Modal Styles */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        /* Photo Grid */
        .photo-item {
            position: relative;
            cursor: pointer;
            overflow: hidden;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
            background-color: #f3f4f6;
        }

        .photo-item:hover {
            transform: scale(1.02);
            border-color: #4285F4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .photo-check {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4285F4;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-item:hover .photo-check {
            opacity: 1;
        }

        /* API Key Selector Dropdown */
        .api-key-selector {
            position: relative;
            display: inline-block;
        }

        .api-key-toggle {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .api-key-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .api-key-dropdown {
            position: absolute;
            top: 110%;
            right: 0;
            background: #1f2937;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            z-index: 200;
            min-width: 280px;
            display: none;
            overflow: hidden;
        }

        .api-key-dropdown.show {
            display: block;
            animation: dropdownFadeIn 0.2s ease;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .api-key-option {
            padding: 10px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .api-key-option:last-child {
            border-bottom: none;
        }

        .api-key-option:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .api-key-option.selected {
            background: rgba(99, 102, 241, 0.5);
        }

        .api-key-option .key-number {
            background: #6366f1;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            min-width: 20px;
            text-align: center;
        }

        .api-key-option .key-label {
            flex: 1;
            color: #e5e7eb;
            font-size: 12px;
        }

        .api-key-option .key-preview {
            color: #9ca3af;
            font-size: 10px;
            font-family: monospace;
        }

        .api-key-option.custom-input {
            background: rgba(34, 197, 94, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .api-key-option.custom-input:hover {
            background: rgba(34, 197, 94, 0.2);
        }

        .api-key-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 4px;
        }

        .api-key-status.active {
            background: #22c55e;
            color: white;
        }

        .api-key-status.error {
            background: #ef4444;
            color: white;
        }

        /* ============================================ */
        /* [NEW] Gemini ëª¨ë¸ ì„ íƒ UI ìŠ¤íƒ€ì¼ */
        /* ============================================ */
        .model-selector-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 12px;
        }

        .model-selector-label {
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
        }

        .model-selector-dropdown {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            min-width: 150px;
        }

        .model-selector-dropdown:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .model-selector-dropdown option {
            background: #1f2937;
            color: white;
            padding: 8px;
        }

        .model-validate-btn {
            background: rgba(34, 197, 94, 0.8);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .model-validate-btn:hover {
            background: rgba(34, 197, 94, 1);
            transform: scale(1.02);
        }

        .model-validate-btn:disabled {
            background: rgba(156, 163, 175, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .model-status-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }

        .model-status-badge.success {
            background: #22c55e;
            color: white;
        }

        .model-status-badge.error {
            background: #ef4444;
            color: white;
        }

        .model-status-badge.pending {
            background: #f59e0b;
            color: white;
        }

        .model-status-badge.unknown {
            background: #6b7280;
            color: white;
        }

        .model-latency {
            color: rgba(255, 255, 255, 0.5);
            font-size: 10px;
        }

        /* ============================================ */
        /* [NEW] í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì„ íƒ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        /* ============================================ */
        .clipboard-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 500px;
            width: 95%;
            overflow: hidden;
        }

        .clipboard-modal-header {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clipboard-modal-header h3 {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clipboard-modal-body {
            padding: 20px;
        }

        .clipboard-preview-container {
            background: #f8fafc;
            border: 2px dashed #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .clipboard-preview-container.has-image {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .clipboard-preview-container.no-image {
            border-color: #fca5a5;
            background: #fef2f2;
        }

        .clipboard-thumbnail {
            max-width: 100%;
            max-height: 250px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 12px;
        }

        .clipboard-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
        }

        .clipboard-info.error {
            color: #dc2626;
        }

        .clipboard-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .clipboard-actions button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .clipboard-btn-cancel {
            background: #f1f5f9;
            color: #475569;
        }

        .clipboard-btn-cancel:hover {
            background: #e2e8f0;
        }

        .clipboard-btn-upload {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
        }

        .clipboard-btn-upload:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .clipboard-btn-upload:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        .clipboard-btn-refresh {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .clipboard-btn-refresh:hover {
            background: #dcfce7;
        }

        /* í´ë¦½ë³´ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì—…ë¡œë“œ ì˜ì—­ìš©) */
        .clipboard-upload-btn {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 1px solid #86efac;
            color: #15803d;
        }

        .clipboard-upload-btn:hover {
            background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
            border-color: #4ade80;
        }

        @keyframes clipboardPulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .clipboard-loading {
            animation: clipboardPulse 1.5s ease-in-out infinite;
        }
    </style>
</head>

<body class="text-gray-800 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-indigo-900 text-white p-4 shadow-lg shrink-0 z-50">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-lg font-bold flex items-center gap-2">
                <span class="text-2xl">âš¡</span>
                <span>ì´ë¯¸ì§€ OCR ë° ë¶„ì„</span>
                <span class="text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded-full font-bold">OCR + LLM</span>
            </h1>

            <div
                class="flex items-center bg-indigo-800 rounded-lg p-1 border border-indigo-600 w-full md:w-auto group relative">
                <span class="text-xs text-indigo-300 px-3">API Key</span>
                <input type="password" id="apiKeyInput" value="AIzaSyCiNN5_B-7zB2AooKHVAEpt5x-N5AEuYjo"
                    placeholder="Google AI Studio Key ì…ë ¥"
                    class="bg-transparent border-none text-white text-sm focus:ring-0 placeholder-indigo-400 w-52 outline-none">

                <!-- API Key Selector -->
                <div class="api-key-selector ml-2">
                    <button type="button" id="apiKeyToggleBtn" class="api-key-toggle" title="API Key ë³€ê²½">
                        <span id="currentKeyNumber">1</span>ë²ˆ
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    <div id="apiKeyDropdown" class="api-key-dropdown">
                        <div class="p-2 bg-gray-800 border-b border-gray-700">
                            <p class="text-xs text-gray-400 text-center">ğŸ”‘ API Key ì„ íƒ</p>
                        </div>
                        <div class="api-key-option selected" data-key-index="0">
                            <span class="key-number">1</span>
                            <span class="key-label">ê¸°ë³¸ API Key</span>
                            <span class="key-preview">...uYjo</span>
                        </div>
                        <div class="api-key-option" data-key-index="1">
                            <span class="key-number">2</span>
                            <span class="key-label">ì˜ˆë¹„ API Key #1</span>
                            <span class="key-preview">...ISp0</span>
                        </div>
                        <div class="api-key-option" data-key-index="2">
                            <span class="key-number">3</span>
                            <span class="key-label">ì˜ˆë¹„ API Key #2</span>
                            <span class="key-preview">...GjkGTc</span>
                        </div>
                        <div class="api-key-option custom-input" data-key-index="-1">
                            <span class="key-number" style="background:#22c55e;">âœ</span>
                            <span class="key-label">ì§ì ‘ ì…ë ¥</span>
                            <span class="key-preview">ì…ë ¥ì°½ì— ì§ì ‘ ì…ë ¥</span>
                        </div>
                    </div>
                </div>

                <!-- [NEW] Gemini ëª¨ë¸ ì„ íƒ UI -->
                <div class="model-selector-container">
                    <span class="model-selector-label">ğŸ¤– ëª¨ë¸:</span>
                    <select id="modelSelector" class="model-selector-dropdown">
                        <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì˜µì…˜ ì¶”ê°€ -->
                    </select>
                    <button type="button" id="validateModelBtn" class="model-validate-btn" title="ì„ íƒí•œ ëª¨ë¸ì˜ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•©ë‹ˆë‹¤">
                        ğŸ” ê²€ì¦
                    </button>
                    <span id="modelStatusBadge" class="model-status-badge unknown">ë¯¸í™•ì¸</span>
                    <span id="modelLatency" class="model-latency"></span>
                </div>

                <div class="custom-tooltip w-72 cursor-help" style="pointer-events: auto;">
                    <h4 class="font-bold text-yellow-300 mb-2 border-b border-gray-600 pb-1">ğŸ”‘ API Key ì •ë³´ ê°€ì´ë“œ</h4>
                    <ul class="list-disc pl-4 space-y-1.5 text-gray-200">
                        <li><strong class="text-white">APIë€?</strong> Google AI ëª¨ë¸(Gemini) ì‚¬ìš© ì¸ì¦ í‚¤ì…ë‹ˆë‹¤.</li>
                        <li><strong class="text-white">Key ë³€ê²½:</strong> ì˜¤ë¥¸ìª½ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ 1ë²ˆ/2ë²ˆ/3ë²ˆ Keyë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</li>
                        <li><strong class="text-white">ë°œê¸‰ ë°©ë²•:</strong> <a href="https://aistudio.google.com/app/apikey"
                                target="_blank" class="tooltip-link">Google AI Studio</a>ì—ì„œ ë°œê¸‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        <li class="text-blue-300"><strong class="text-blue-200">ğŸ’° ë¹„ìš© ì•ˆë‚´:</strong> í˜„ì¬ ë¬´ë£Œ ê°œë°œììš© Key ì‚¬ìš© ì¤‘.
                            ì‚¬ìš©ëŸ‰ ì œí•œ(429 ì˜¤ë¥˜) ì‹œ <a href="https://ai.google.dev/pricing" target="_blank"
                                class="tooltip-link">ìœ ë£Œ Key ë°œê¸‰</a> í›„ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        <li class="text-red-300"><strong class="text-red-200">âš ï¸ 429/403 ì˜¤ë¥˜:</strong> API í•œë„ ì´ˆê³¼ ì‹œ ë‹¤ë¥¸
                            Keyë¡œ ë³€ê²½í•´ë³´ì„¸ìš”.</li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto p-4 overflow-hidden flex flex-col md:flex-row gap-6 relative">

        <!-- Left Panel: Input & Table View -->
        <div class="w-full md:w-1/2 flex flex-col gap-4 overflow-y-auto pr-2" id="leftPanel">

            <!-- Upload & Preview -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 shrink-0 flex flex-col gap-4">
                <div id="dropZone"
                    class="border-2 border-dashed border-indigo-200 rounded-lg p-6 text-center cursor-pointer hover:bg-indigo-50 transition-colors relative group">
                    <input type="file" id="imageInput" accept="image/*" class="hidden">

                    <div class="flex flex-col items-center gap-2">
                        <div class="text-4xl mb-1">ğŸ“‚</div>
                        <p class="text-sm text-gray-600 font-bold">ì´ë¯¸ì§€ ì—…ë¡œë“œ (í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸)</p>
                        <p class="text-xs text-gray-400">PNG, JPG ì§€ì›</p>
                    </div>

                    <!-- Action Buttons -->
                    <div class="mt-4 flex gap-2 justify-center flex-wrap">
                        <button type="button" id="sampleBtn"
                            class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-3 py-1.5 rounded-full text-xs font-bold border border-indigo-200 transition flex items-center gap-1 shadow-sm">
                            <span class="text-lg">ğŸ§ª</span> ìƒ˜í”Œë¡œ ì²´í—˜í•˜ê¸°
                        </button>
                        <!-- [NEW] í´ë¦½ë³´ë“œì—ì„œ ê°€ì ¸ì˜¤ê¸° ë²„íŠ¼ -->
                        <button type="button" id="clipboardBtn"
                            class="clipboard-upload-btn px-3 py-1.5 rounded-full text-xs font-bold transition flex items-center gap-1 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                            </svg>
                            í´ë¦½ë³´ë“œ
                        </button>
                        <!-- ì›¹/ë“œë¼ì´ë¸Œ URL ë²„íŠ¼ -->
                        <button type="button" id="urlBtn"
                            class="bg-white hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded-full text-xs font-bold border border-gray-300 transition flex items-center gap-1 shadow-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                            ì›¹/ë“œë¼ì´ë¸Œ URL
                        </button>
                    </div>

                    <div class="custom-tooltip">
                        <h4 class="font-bold text-yellow-300 mb-2 border-b border-gray-600 pb-1">ğŸ’¡ íŒ: ì†ê¸€ì”¨ ì¸ì‹ë¥  ë†’ì´ê¸°</h4>
                        <ul class="list-disc pl-4 space-y-1 text-gray-200 leading-relaxed">
                            <li><b class="text-white">ì†ê¸€ì”¨ í…Œì´ë¸”:</b> ì¢…ì´ì— í‘œë¥¼ ê·¸ë¦¬ê³  ì‚¬ì§„ì„ ì°ì–´ë³´ì„¸ìš”.</li>
                            <li><b class="text-white">íŠ¹ìˆ˜ ê¸°í˜¸:</b> ì²´í¬ í‘œì‹œ, í™”ì‚´í‘œ ë“±ë„ ì¸ì‹í•©ë‹ˆë‹¤.</li>
                            <li><b class="text-white">í™”ì´íŠ¸ë³´ë“œ:</b> íšŒì˜ ë‚´ìš©ì„ ì—‘ì…€ë¡œ ë³€í™˜í•˜ì„¸ìš”.</li>
                        </ul>
                    </div>
                </div>

                <div id="previewArea" class="hidden relative group">
                    <div class="relative cursor-pointer hover:opacity-90 transition" title="í´ë¦­í•˜ì—¬ ë‹¤ë¥¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ">
                        <img id="previewImage" class="max-h-48 object-contain mx-auto rounded border" alt="Preview">
                        <div
                            class="absolute inset-0 flex items-center justify-center bg-black/10 opacity-0 group-hover:opacity-100 transition rounded pointer-events-none">
                            <span class="bg-black/50 text-white text-xs px-2 py-1 rounded">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ë³€ê²½</span>
                        </div>
                    </div>
                    <button id="runAnalysisBtn"
                        class="mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold shadow transition-all flex items-center justify-center gap-2">
                        <span>ğŸ‘ï¸ ì´ë¯¸ì§€ í…Œì´ë¸”ë¡œ í‘œ ì¶”ì¶œí•˜ê¸°</span>
                    </button>
                </div>
            </div>

            <!-- Extracted Table Data -->
            <div id="resultContainer"
                class="hidden flex-1 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col min-h-[300px] fullscreen-transition">
                <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl"
                    id="resultHeader">
                    <h2 class="text-sm font-bold text-gray-700">ğŸ“Š ì¶”ì¶œ</h2>
                    <div class="flex gap-2">
                        <button onclick="app.runAutoCategorization()" id="categoryBtn"
                            class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 text-xs rounded font-bold shadow-sm flex items-center gap-1 transition-colors">
                            <span>âœ¨ ë¶„ë¥˜</span>
                        </button>
                        <button onclick="app.toggleComparisonMode()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 text-xs rounded font-bold shadow-sm flex items-center gap-1 transition-colors border border-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                            </svg>
                            <span>ğŸ‘ï¸ ê²€ì¦</span>
                        </button>
                        <button onclick="app.exportToExcel()"
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs rounded font-bold shadow-sm">
                            ì—‘ì…€
                        </button>
                    </div>
                </div>
                <div class="overflow-auto flex-1 relative" id="tableWrapper">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10" id="tableHead"></thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-sm" id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Panel: AI Analyst Chat -->
        <div class="w-full md:w-1/2 flex flex-col bg-white rounded-xl shadow-lg border border-indigo-100 overflow-hidden relative"
            id="rightPanel">
            <div
                class="p-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white flex justify-between items-center shadow-md z-10">
                <div class="flex items-center gap-2">
                    <div class="bg-white/20 p-1.5 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="font-bold text-sm">AI ë¶„ì„</h2>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.generateReport()" id="reportBtn" disabled
                        class="bg-white/20 hover:bg-white/30 text-xs px-3 py-1.5 rounded-full transition disabled:opacity-50 disabled:cursor-not-allowed">
                        ğŸ“‘ ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±
                    </button>
                </div>
            </div>

            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50 chat-scroll">
                <div class="flex gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center shrink-0 border border-indigo-200 text-lg">
                        ğŸ¤–</div>
                    <div
                        class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100 max-w-[85%] text-sm text-gray-700">
                        <p>ì•ˆë…•í•˜ì„¸ìš”! <strong>API Key</strong>ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ <strong>'ğŸ§ª ìƒ˜í”Œ'</strong> ë˜ëŠ”
                            <strong>'URL ê°€ì ¸ì˜¤ê¸°'</strong> ê¸°ëŠ¥ì„ ì´ìš©í•´ë³´ì„¸ìš”.
                        </p>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-white border-t border-gray-100">
                <div class="relative">
                    <input type="text" id="chatInput" disabled placeholder="ë°ì´í„°ê°€ ì¶”ì¶œë˜ë©´ ì§ˆë¬¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: ì´ ë¹„ìš©ì´ ì–¼ë§ˆì•¼?)"
                        class="w-full bg-gray-100 border-none rounded-full py-3 pl-4 pr-12 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none disabled:bg-gray-50 disabled:text-gray-400">
                    <button id="sendBtn" disabled
                        class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors disabled:bg-gray-300 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-center">AIëŠ” ì‹¤ìˆ˜ë¥¼ í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¤‘ìš”í•œ ì •ë³´ëŠ” í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
            </div>

            <div id="loadingOverlay"
                class="absolute inset-0 bg-white/80 hidden flex-col items-center justify-center z-50 backdrop-blur-sm">
                <div class="loader mb-3"></div>
                <p id="loadingText" class="text-indigo-600 font-bold animate-pulse text-sm">ì²˜ë¦¬ ì¤‘...</p>
            </div>
        </div>
    </main>

    <!-- URL Import Modal -->
    <div id="urlImportModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-backdrop animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-[90%] transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                    </svg>
                    ì›¹/ë“œë¼ì´ë¸Œ ì´ë¯¸ì§€ URL
                </h3>
                <button onclick="ui.hideUrlImportModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ì´ë¯¸ì§€ ì£¼ì†Œ (URL)</label>
                    <input type="text" id="imageUrlInput" placeholder="https://..."
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <p class="text-[10px] text-gray-400 mt-1">ì´ë¯¸ì§€ íŒŒì¼ì˜ ì§ì ‘ ë§í¬ì—¬ì•¼ í•©ë‹ˆë‹¤. (jpg, png ë“±)</p>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-700 leading-relaxed">
                    <p class="font-bold mb-1">ğŸ’¡ íŒ: ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•</p>
                    <p>êµ¬ê¸€ í¬í† ëŠ” ë³´ì•ˆì´ ê°•ë ¥í•©ë‹ˆë‹¤. <strong>ì‚¬ì§„ì„ ìš°í´ë¦­í•˜ì—¬ 'ì´ë¯¸ì§€ ì£¼ì†Œ ë³µì‚¬'</strong>í•œ í›„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. ë‹¨ìˆœ ê³µìœ  ë§í¬ëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                </div>
                <button onclick="app.handleUrlImport()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors text-sm">
                    ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- [NEW] í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì„ íƒ ëª¨ë‹¬ -->
    <div id="clipboardModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-backdrop animate-fade-in">
        <div class="clipboard-modal">
            <div class="clipboard-modal-header">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                    í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                </h3>
                <button onclick="app.hideClipboardModal()"
                    class="text-white hover:text-gray-200 text-xl">&times;</button>
            </div>
            <div class="clipboard-modal-body">
                <div id="clipboardPreviewContainer" class="clipboard-preview-container">
                    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë˜ëŠ” ì•ˆë‚´ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    <div id="clipboardEmptyState" class="text-gray-500">
                        <div class="text-4xl mb-3">ğŸ“‹</div>
                        <p class="font-medium">í´ë¦½ë³´ë“œ ì½ëŠ” ì¤‘...</p>
                        <p class="text-xs mt-1">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                    </div>
                    <img id="clipboardThumbnail" class="clipboard-thumbnail hidden" alt="í´ë¦½ë³´ë“œ ì´ë¯¸ì§€">
                    <div id="clipboardImageInfo" class="clipboard-info hidden"></div>
                </div>

                <div class="clipboard-actions">
                    <button type="button" onclick="app.hideClipboardModal()" class="clipboard-btn-cancel">
                        ì·¨ì†Œ
                    </button>
                    <button type="button" onclick="app.refreshClipboard()" class="clipboard-btn-refresh"
                        title="í´ë¦½ë³´ë“œ ë‹¤ì‹œ ì½ê¸°">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                    <button type="button" id="clipboardUploadBtn" onclick="app.uploadFromClipboard()"
                        class="clipboard-btn-upload" disabled>
                        ğŸ“¤ ì—…ë¡œë“œ
                    </button>
                </div>

                <div class="mt-4 bg-indigo-50 p-3 rounded-lg border border-indigo-100 text-xs text-indigo-700">
                    <p class="font-bold mb-1">ğŸ’¡ ì‚¬ìš© ë°©ë²•</p>
                    <ul class="list-disc pl-4 space-y-0.5">
                        <li>ìŠ¤í¬ë¦°ìƒ· (Win+Shift+S) ë˜ëŠ” ì´ë¯¸ì§€ ë³µì‚¬ í›„ í´ë¦­</li>
                        <li>OCR ìµœì í™”ê°€ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤</li>
                        <li>ì§€ì› í˜•ì‹: PNG, JPG, BMP, WEBP</li>
                    </ul>
                    <p class="mt-2 text-[10px] text-gray-500">
                        âš ï¸ ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ë‹¨ì¼ ì´ë¯¸ì§€ë§Œ ì½ê¸° ê°€ëŠ¥ (ì—¬ëŸ¬ ì´ë¯¸ì§€ X)<br>
                        âœ… Chrome 76+ | Edge | Firefox 127+ | Safari 13.1+ ì§€ì›
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Photos Login Modal -->
    <div id="googlePhotosModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-backdrop animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-[90%] transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none">
                        <path d="M12 7L9 12L12 17L15 12L12 7Z" fill="#4285F4" />
                        <path d="M17 12L12 9L7 12L12 15L17 12Z" fill="#FBBC05" />
                        <path
                            d="M11.99 2C6.47 2 1.52 6.48 1.52 12C1.52 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM11.99 20C7.57 20 3.52 16.41 3.52 12C3.52 7.59 7.57 4 11.99 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 11.99 20Z"
                            fill="#EA4335" />
                        <path d="M12 7L15 12L12 17L9 12L12 7Z" fill="#34A853" />
                    </svg>
                    Google Photos ì—°ë™
                </h3>
                <button onclick="ui.hideGooglePhotosModal()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Google ID (Email)</label>
                    <input type="text" id="gpId"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                        value="" placeholder="example@gmail.com">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">Password</label>
                    <input type="password" id="gpPw"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                        value="" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-700">
                    âš ï¸ <strong>ë³´ì•ˆ ì•Œë¦¼:</strong> ì…ë ¥í•˜ì‹  ê³„ì • ì •ë³´ëŠ” ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”ë˜ì–´ ì „ì†¡ë˜ë©°, ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Mockup Test)
                </div>
                <button onclick="app.handleGooglePhotosLogin()"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors text-sm">
                    ì—°ë™í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- Google Photos Gallery Modal -->
    <div id="googlePhotosGallery"
        class="fixed inset-0 z-[110] hidden flex items-center justify-center modal-backdrop animate-fade-in">
        <div
            class="bg-white rounded-xl shadow-2xl w-[800px] max-w-[95%] h-[600px] flex flex-col transform transition-all scale-100">
            <!-- Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-1.5 rounded-full shadow-sm border">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none">
                            <path d="M12 7L9 12L12 17L15 12L12 7Z" fill="#4285F4" />
                            <path d="M17 12L12 9L7 12L12 15L17 12Z" fill="#FBBC05" />
                            <path
                                d="M11.99 2C6.47 2 1.52 6.48 1.52 12C1.52 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM11.99 20C7.57 20 3.52 16.41 3.52 12C3.52 7.59 7.57 4 11.99 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 11.99 20Z"
                                fill="#EA4335" />
                            <path d="M12 7L15 12L12 17L9 12L12 7Z" fill="#34A853" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">Google Photos</h3>
                    <span class="text-xs text-gray-500 bg-gray-200 px-2 py-0.5 rounded-full">ìµœê·¼ ë¬¸ì„œ</span>
                </div>
                <button onclick="ui.hideGooglePhotosGallery()"
                    class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-200">âœ•</button>
            </div>

            <!-- Gallery Grid -->
            <div id="galleryGrid"
                class="flex-1 overflow-y-auto p-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 bg-white">
                <!-- Items will be injected by JS -->
            </div>

            <!-- ì‹œë®¬ë ˆì´ì…˜ ì•Œë¦¼ -->
            <div class="px-6 py-2 bg-yellow-50 text-xs text-yellow-700 border-t border-yellow-100">
                â€» í˜„ì¬ëŠ” <strong>ì‹œë®¬ë ˆì´ì…˜ ëª¨ë“œ</strong>ì…ë‹ˆë‹¤. ë³´ì•ˆìƒ ì‹¤ì œ ê³„ì • ì‚¬ì§„ ëŒ€ì‹  ì˜ˆì‹œ ë°ì´í„°(Mock Data)ê°€ í‘œì‹œë©ë‹ˆë‹¤.
            </div>

            <!-- Footer -->
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-between items-center text-xs text-gray-500">
                <span>ê³„ì •: <b id="connectedAccount" class="text-gray-700"></b></span>
                <span>ì´ <b id="photoCount">0</b>ì¥ì˜ ì‚¬ì§„</span>
            </div>
        </div>
    </div>

    <!-- OCR í”„ë¡¬í”„íŠ¸ ì…ë ¥ ëª¨ë‹¬ -->
    <div id="ocrPromptModal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-backdrop animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[500px] max-w-[95%] transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="text-2xl">ğŸ¯</span>
                    OCR ì¶”ì¶œ ìš”ì²­ì‚¬í•­ ì…ë ¥
                </h3>
                <button onclick="ui.hideOcrPromptModal()" class="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¯¸ì§€ì—ì„œ ì¶”ì¶œí•  ë‚´ìš©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”:</label>
                    <textarea id="ocrPromptInput" rows="4"
                        placeholder="ì˜ˆì‹œ:&#10;â€¢ í‘œì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”&#10;â€¢ ê¸ˆì•¡ ì»¬ëŸ¼ì€ ìˆ«ìë§Œ ì¶”ì¶œí•´ì£¼ì„¸ìš”&#10;â€¢ ë‚ ì§œ í˜•ì‹ì€ YYYY-MM-DDë¡œ í†µì¼í•´ì£¼ì„¸ìš”&#10;â€¢ ë¹ˆ ì…€ì€ '-'ë¡œ í‘œì‹œí•´ì£¼ì„¸ìš”"
                        class="w-full border border-gray-300 rounded-lg px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none resize-none"></textarea>
                </div>

                <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100">
                    <p class="text-xs text-indigo-700 font-medium mb-2">ğŸ’¡ í”„ë¡¬í”„íŠ¸ ì‘ì„± íŒ:</p>
                    <ul class="text-xs text-indigo-600 space-y-1 list-disc pl-4">
                        <li>ì¶”ì¶œí•  ì»¬ëŸ¼ëª…ì„ ëª…ì‹œí•˜ë©´ ì •í™•ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤</li>
                        <li>íŠ¹ìˆ˜ ê¸°í˜¸ë‚˜ ë‹¨ìœ„ ì²˜ë¦¬ ë°©ë²•ì„ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li>ì†ê¸€ì”¨ì˜ ê²½ìš° "ì†ê¸€ì”¨ ì¸ì‹" ì–¸ê¸‰ ê¶Œì¥</li>
                    </ul>
                </div>

                <div class="flex gap-3">
                    <button onclick="app.executeOcrWithPrompt()"
                        class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow transition-colors text-sm flex items-center justify-center gap-2">
                        <span>ğŸš€</span> OCR ì‹¤í–‰ <span class="text-indigo-300 text-xs">(Ctrl+Enter)</span>
                    </button>
                    <button onclick="app.executeOcrWithPrompt('')"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg transition-colors text-sm">
                        ê¸°ë³¸ ì¶”ì¶œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¹„êµ ê²€ì¦ ëª¨ë“œ ì˜¤ë²„ë ˆì´ -->
    <div id="comparisonOverlay" class="fixed inset-0 z-[100] bg-white hidden flex flex-col animate-fade-in">
        <!-- Overlay Header -->
        <div class="bg-indigo-900 text-white p-4 flex justify-between items-center shadow-lg shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ë¹„êµ ê²€ì¦ ëª¨ë“œ
                </h2>
                <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
                <div class="flex items-center gap-4 bg-indigo-800 px-4 py-1.5 rounded-lg border border-indigo-600">
                    <button onclick="app.swapSides()"
                        class="hover:text-yellow-300 transition flex items-center gap-1 text-sm border-r border-indigo-600 pr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                        ì¢Œìš° ì „í™˜
                    </button>

                    <button onclick="app.clearDrawing()"
                        class="hover:text-yellow-300 transition flex items-center gap-1 text-sm border-r border-indigo-600 pr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        ğŸ–Œï¸ ì´ˆê¸°í™”
                    </button>

                    <!-- ì¤Œ ì»¨íŠ¸ë¡¤ëŸ¬ -->
                    <div class="flex items-center gap-2">
                        <button id="heightFitBtn" onclick="app.zoomToFitTableHeight()"
                            class="bg-indigo-600 hover:bg-indigo-500 text-xs px-2 py-1 rounded transition border border-indigo-500 flex items-center gap-1"
                            title="í‘œ ë†’ì´ì— ë§ì¶° ë¹„ìœ¨ ìœ ì§€í•˜ë©° í™•ëŒ€">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                            </svg>
                            í™•ëŒ€ ë§ì¶¤
                        </button>
                        <div class="flex items-center gap-2 border-l border-indigo-600 pl-3">
                            <button onclick="app.adjustZoom(-10)"
                                class="hover:text-yellow-300 font-bold px-1 text-lg">-</button>
                            <input type="range" id="zoomRange" min="10" max="1000" step="10" value="100"
                                class="w-24 h-1.5 bg-indigo-400 rounded-lg appearance-none cursor-pointer"
                                oninput="app.setZoom(this.value)">
                            <button onclick="app.adjustZoom(10)"
                                class="hover:text-yellow-300 font-bold px-1 text-lg">+</button>
                            <span id="zoomLabel" class="text-xs font-mono w-12 text-right">100%</span>
                        </div>
                    </div>
                </div>
            </div>
            <button onclick="app.toggleComparisonMode()"
                class="bg-red-500 hover:bg-red-600 text-white px-5 py-2 rounded-lg font-bold shadow transition-all flex items-center gap-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                ë‹«ê¸° (ESC)
            </button>
        </div>

        <div id="splitViewContainer" class="flex-1 flex overflow-hidden">
            <div id="compareTableContainer"
                class="w-1/2 border-r-4 border-indigo-100 bg-white overflow-auto p-4 shadow-inner flex flex-col">
                <h3 class="text-sm font-bold text-gray-500 mb-2 sticky top-0 bg-white z-20 pb-2 border-b">ğŸ“ ì¶”ì¶œëœ ë°ì´í„°
                </h3>
            </div>

            <div id="compareImageContainer" class="w-1/2 bg-gray-800 overflow-auto relative p-0 cursor-crosshair">
                <div id="imgPlaceholder"
                    class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                    <p class="text-gray-500 text-sm opacity-50 font-mono">Original Image Viewer</p>
                </div>

                <div id="imageWrapper" class="relative z-10 origin-top-left transition-all duration-200 ease-out"
                    style="width: auto; height: auto;">
                    <img id="compareImage" class="block shadow-2xl border border-white/10"
                        style="width: 100%; height: 100%;" crossorigin="anonymous">
                    <canvas id="drawingCanvas" class="absolute inset-0 pointer-events-auto"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // [Configuration Layer]
        const CONFIG = {
            MOCK_DATA: {
                "headers": ["ì…ì°°ëª…", "ë‹´ë‹¹ìì˜ˆê°€", "PR No.", "ê³µì‚¬ë²ˆí˜¸"],
                "rows": [
                    ["[ESPR:93138073]ì‚¬íƒ 103-301 ìˆ˜ì¥ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "5,388,000", "93138073-60", "CI26001506"],
                    ["[ESPR:93138073]ì‚¬íƒ 103-301 ë‹¨ì—´ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "1,055,000", "93138073-50", "CI26001507"],
                    ["[ESPR:93138073]ì‚¬íƒ 103-205 ìˆ˜ì¥ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "5,388,000", "93138073-40", "CI26001508"],
                    ["[ESPR:93138073]ì‚¬íƒ 103-105 ìˆ˜ì¥ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "5,388,000", "93138073-30", "CI26001509"],
                    ["[ESPR:93138073]ì‚¬íƒ 103-105 ë² ë€ë‹¤ ëˆ„ìˆ˜(ì „ë©´)-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "830,000", "93138073-20", "CI26001510"],
                    ["[ESPR:93138073]ì‚¬íƒ 103-105 ë‹¨ì—´ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "1,868,000", "93138073-10", "CI26001511"],
                    ["[ESPR:93138072]ì‚¬íƒ 103-103 ìˆ˜ì¥ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "5,388,000", "93138072-80", "CI26001512"],
                    ["[ESPR:93138072]ì‚¬íƒ 103-103 ë‹¨ì—´ì‘ì—…-ìœ ì§€ê´€ë¦¬(ë§ˆê°)", "1,374,000", "93138072-70", "CI26001513"]
                ]
            },
            // [ê°œì„ ] ë‹¤ì¤‘ API Key ì§€ì› - 1ë²ˆ(ê¸°ì¡´), 2ë²ˆ, 3ë²ˆ ì„ íƒ ê°€ëŠ¥
            API_KEYS: [
                "AIzaSyCiNN5_B-7zB2AooKHVAEpt5x-N5AEuYjo",  // 1ë²ˆ: ê¸°ë³¸ (ê¸°ì¡´)
                "AIzaSyCjKem0x_hZeaOELsKMOpU3IPHYJ6rISp0",  // 2ë²ˆ: ì˜ˆë¹„ #1
                "AIzaSyArSemIibnUtm8FskniUsIX2w7X6AjkGTc"   // 3ë²ˆ: ì˜ˆë¹„ #2
            ],
            DEFAULT_API_KEY: "AIzaSyCiNN5_B-7zB2AooKHVAEpt5x-N5AEuYjo",
            CURRENT_KEY_INDEX: 0, // [DEPRECATED] App.currentKeyIndexë¡œ ì´ì „ë¨ - í˜¸í™˜ì„± ìœ ì§€ìš©

            // ============================================
            // [NEW] Gemini ëª¨ë¸ ì„ íƒ ì‹œìŠ¤í…œ
            // - ì‚¬ìš©ìê°€ ëª¨ë¸ì„ ì§ì ‘ ì„ íƒ/ë³€ê²½ ê°€ëŠ¥
            // - ì ‘ê·¼ ê¶Œí•œ ê²€ì¦ ê¸°ëŠ¥ í¬í•¨
            // ============================================
            GEMINI_MODELS: [
                {
                    id: "gemini-2.0-flash",
                    name: "Gemini 2.0 Flash",
                    description: "ì•ˆì • ë²„ì „ (ê¶Œì¥)",
                    tier: "stable",
                    isDefault: true
                },
                {
                    id: "gemini-1.5-flash",
                    name: "Gemini 1.5 Flash",
                    description: "ì´ì „ ì•ˆì • ë²„ì „",
                    tier: "stable",
                    isDefault: false
                },
                {
                    id: "gemini-1.5-pro",
                    name: "Gemini 1.5 Pro",
                    description: "ê³ ì„±ëŠ¥ (ëŠë¦¼)",
                    tier: "pro",
                    isDefault: false
                },
                {
                    id: "gemini-2.0-flash-lite",
                    name: "Gemini 2.0 Flash Lite",
                    description: "ê²½ëŸ‰ ë²„ì „ (ë¹ ë¦„)",
                    tier: "lite",
                    isDefault: false
                }
            ],
            DEFAULT_MODEL_INDEX: 0, // ê¸°ë³¸ ëª¨ë¸ ì¸ë±ìŠ¤ (gemini-2.0-flash)

            ZOOM: { MIN: 10, MAX: 1000, STEP: 1, DEFAULT: 100 },
            GOOGLE_PHOTOS: {
                DEFAULT_ID: "", // [SECURITY] ìê²© ì¦ëª… ì œê±°ë¨
                DEFAULT_PW: ""  // [SECURITY] ìê²© ì¦ëª… ì œê±°ë¨
            }
        };

        // Single Sample Image (Document Type)
        const SAMPLE_IMAGE_DATA = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABAAAAAIAAQMAAACX/wA3AAAAA1BMVEX///+nxBvIAAAANElEQVR42u3BAQ0AAADCoPdPbQ8HFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/Bhu0AAB2P4m2AAAAABJRU5ErkJggg==";

        // [FIX] Mock Gallery Images for Google Photos Simulation
        const MOCK_GALLERY_IMAGES = [
            { url: "https://picsum.photos/seed/doc1/400/300", name: "ë¬¸ì„œ_ìƒ˜í”Œ_1.jpg", date: "2025-01-15" },
            { url: "https://picsum.photos/seed/doc2/400/300", name: "ì˜ìˆ˜ì¦_ìƒ˜í”Œ.png", date: "2025-01-14" },
            { url: "https://picsum.photos/seed/doc3/400/300", name: "í‘œ_ì´ë¯¸ì§€.jpg", date: "2025-01-13" },
            { url: "https://picsum.photos/seed/doc4/400/300", name: "ìŠ¤ìº”_ë¬¸ì„œ.png", date: "2025-01-12" },
            { url: "https://picsum.photos/seed/doc5/400/300", name: "ì†ê¸€ì”¨_ë©”ëª¨.jpg", date: "2025-01-11" },
            { url: "https://picsum.photos/seed/doc6/400/300", name: "íšŒì˜ë¡_ì‚¬ì§„.png", date: "2025-01-10" }
        ];

        /**
         * [Service Layer] Image Service (New)
         * Handles image fetching, proxying, and scraping.
         */
        class ImageService {
            /**
             * [ê°œì„ ] URL ì´ë¯¸ì§€ë¥¼ File ê°ì²´ë¡œ ì™„ì „íˆ ë‹¤ìš´ë¡œë“œ
             * - ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì „ì²´ ë°ì´í„° ìˆ˜ì‹  í™•ì¸
             * - Content-Lengthì™€ ì‹¤ì œ ìˆ˜ì‹  í¬ê¸° ë¹„êµ
             * - íƒ€ì„ì•„ì›ƒ ë° ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§
             */
            async downloadAsFile(url, onProgress = null) {
                // ë‹¤ì¤‘ í”„ë¡ì‹œ ì‹œë„
                const proxyConfigs = [
                    { name: 'corsproxy', url: `https://corsproxy.io/?${encodeURIComponent(url)}` },
                    { name: 'allorigins', url: `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}` },
                    { name: 'direct', url: url }
                ];

                let lastError = null;

                for (const config of proxyConfigs) {
                    try {
                        console.log(`[${config.name}] ë‹¤ìš´ë¡œë“œ ì‹œë„...`);

                        // íƒ€ì„ì•„ì›ƒ ì„¤ì • (60ì´ˆ)
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 60000);

                        const response = await fetch(config.url, {
                            signal: controller.signal,
                            cache: 'no-store' // ìºì‹œ ì‚¬ìš© ì•ˆ í•¨
                        });

                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }

                        // Content-Length í™•ì¸ (ì˜ˆìƒ í¬ê¸°)
                        const contentLength = parseInt(response.headers.get('content-length') || '0');
                        console.log(`[${config.name}] ì˜ˆìƒ í¬ê¸°: ${contentLength ? Math.round(contentLength / 1024) + 'KB' : 'ì•Œ ìˆ˜ ì—†ìŒ'}`);

                        // ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì „ì²´ ë°ì´í„° ìˆ˜ì‹ 
                        const reader = response.body.getReader();
                        const chunks = [];
                        let receivedLength = 0;

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            chunks.push(value);
                            receivedLength += value.length;

                            // ì§„í–‰ ìƒí™© ë¡œê·¸
                            if (contentLength > 0) {
                                const percent = Math.round((receivedLength / contentLength) * 100);
                                console.log(`[${config.name}] ë‹¤ìš´ë¡œë“œ ì§„í–‰: ${percent}% (${Math.round(receivedLength / 1024)}KB / ${Math.round(contentLength / 1024)}KB)`);
                            }
                        }

                        // ì „ì²´ ë°ì´í„° ìˆ˜ì‹  í™•ì¸
                        if (contentLength > 0 && receivedLength < contentLength * 0.95) {
                            throw new Error(`ë¶ˆì™„ì „í•œ ë‹¤ìš´ë¡œë“œ: ${receivedLength}/${contentLength} bytes (${Math.round(receivedLength / contentLength * 100)}%)`);
                        }

                        console.log(`[${config.name}] ìˆ˜ì‹  ì™„ë£Œ: ${Math.round(receivedLength / 1024)}KB`);

                        // ì²­í¬ë“¤ì„ í•˜ë‚˜ì˜ Blobìœ¼ë¡œ í•©ì¹˜ê¸°
                        const blob = new Blob(chunks);

                        if (blob.size < 1000) {
                            throw new Error("íŒŒì¼ì´ ë„ˆë¬´ ì‘ìŒ (ì˜¤ë¥˜ ì‘ë‹µì¼ ìˆ˜ ìˆìŒ)");
                        }

                        // MIME íƒ€ì… í™•ì¸
                        const contentType = response.headers.get('content-type') || 'image/jpeg';
                        if (!contentType.startsWith('image/')) {
                            // Blobì˜ ì²˜ìŒ ëª‡ ë°”ì´íŠ¸ë¡œ ì´ë¯¸ì§€ íƒ€ì… í™•ì¸
                            const header = new Uint8Array(await blob.slice(0, 4).arrayBuffer());
                            const isImage = (
                                (header[0] === 0xFF && header[1] === 0xD8) || // JPEG
                                (header[0] === 0x89 && header[1] === 0x50) || // PNG
                                (header[0] === 0x47 && header[1] === 0x49) || // GIF
                                (header[0] === 0x52 && header[1] === 0x49)    // WEBP
                            );
                            if (!isImage) {
                                throw new Error("ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹˜");
                            }
                        }

                        // íŒŒì¼ í™•ì¥ì ê²°ì •
                        const ext = contentType.includes('png') ? 'png' :
                            contentType.includes('gif') ? 'gif' :
                                contentType.includes('webp') ? 'webp' : 'jpg';

                        // Blob â†’ File ê°ì²´ë¡œ ë³€í™˜
                        const fileName = `downloaded_image_${Date.now()}.${ext}`;
                        const file = new File([blob], fileName, { type: contentType.startsWith('image/') ? contentType : `image/${ext}` });

                        console.log(`âœ… [${config.name}] ë‹¤ìš´ë¡œë“œ ì„±ê³µ: ${fileName} (${Math.round(blob.size / 1024)}KB)`);
                        return file;

                    } catch (e) {
                        if (e.name === 'AbortError') {
                            console.warn(`[${config.name}] íƒ€ì„ì•„ì›ƒ`);
                            lastError = new Error('ë‹¤ìš´ë¡œë“œ íƒ€ì„ì•„ì›ƒ (60ì´ˆ ì´ˆê³¼)');
                        } else {
                            console.warn(`[${config.name}] ì‹¤íŒ¨: ${e.message}`);
                            lastError = e;
                        }
                    }
                }

                throw new Error(lastError?.message || "ëª¨ë“  í”„ë¡ì‹œì—ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
            }

            /**
             * [í•µì‹¬] Google Photos URLì„ ì›ë³¸ í¬ê¸°ë¡œ ë³€í™˜
             * - ì¸ë„¤ì¼ URL â†’ ì›ë³¸ í¬ê¸° URL
             * - =w640-h480 ë˜ëŠ” =s640 ê°™ì€ í¬ê¸° ì œí•œ ì œê±°
             * - =s0 ë˜ëŠ” =w0 íŒŒë¼ë¯¸í„°ë¡œ ì›ë³¸ ìš”ì²­
             */
            convertToOriginalSize(url) {
                if (!url) return url;

                // Google Photos / Google User Content URL íŒ¨í„´
                if (url.includes('googleusercontent.com') || url.includes('ggpht.com')) {
                    // ê¸°ì¡´ í¬ê¸° íŒŒë¼ë¯¸í„° ì œê±°í•˜ê³  ì›ë³¸ í¬ê¸° ìš”ì²­
                    // íŒ¨í„´: =w123-h456, =s123, =w123, =h123, =w123-h456-k-no ë“±
                    let originalUrl = url
                        .replace(/=w\d+(-h\d+)?(-[a-z]+)*$/i, '=s0')  // =w640-h480 â†’ =s0
                        .replace(/=s\d+(-[a-z]+)*$/i, '=s0')          // =s640 â†’ =s0
                        .replace(/=h\d+(-[a-z]+)*$/i, '=s0');         // =h480 â†’ =s0

                    // íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ =s0 ì¶”ê°€
                    if (!originalUrl.includes('=s0') && !originalUrl.includes('=w0')) {
                        // [FIX] URL íŒŒë¼ë¯¸í„° ì—°ê²° ë¡œì§ ìˆ˜ì •
                        if (originalUrl.includes('?')) {
                            originalUrl += '&s=0';
                        } else {
                            originalUrl += '=s0';
                        }
                    }

                    console.log(`Google Photos URL ë³€í™˜: ì¸ë„¤ì¼ â†’ ì›ë³¸`);
                    console.log(`  ì›ë˜: ${url.substring(0, 80)}...`);
                    console.log(`  ë³€í™˜: ${originalUrl.substring(0, 80)}...`);

                    return originalUrl;
                }

                return url;
            }

            // [ì¶”ê°€] ë§í¬ì—ì„œ ì˜¤í”ˆ ê·¸ë˜í”„ ì´ë¯¸ì§€ ì¶”ì¶œ (HTML íŒŒì‹±)
            async scrapeOgImage(pageUrl) {
                // í˜ì´ì§€ HTML ê°€ì ¸ì˜¤ê¸° (Proxy í•„ìˆ˜)
                // ë‹¤ì¤‘ í”„ë¡ì‹œ ì‹œë„
                const proxies = [
                    url => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
                    url => `https://corsproxy.io/?${encodeURIComponent(url)}`
                ];

                for (const createProxy of proxies) {
                    try {
                        const proxyUrl = createProxy(pageUrl);
                        const response = await fetch(proxyUrl);
                        let html = '';

                        // allorigins returns JSON with .contents, corsproxy returns raw HTML
                        if (proxyUrl.includes('allorigins')) {
                            const data = await response.json();
                            html = data.contents;
                        } else {
                            html = await response.text();
                        }

                        if (!html) continue;

                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");

                        // og:image ë˜ëŠ” twitter:image ì°¾ê¸°
                        let ogImage = doc.querySelector('meta[property="og:image"]')?.content ||
                            doc.querySelector('meta[name="twitter:image"]')?.content ||
                            doc.querySelector('link[rel="image_src"]')?.href;

                        if (ogImage) {
                            // Google Photos ì¸ë„¤ì¼ â†’ ì›ë³¸ í¬ê¸°ë¡œ ë³€í™˜!
                            ogImage = this.convertToOriginalSize(ogImage);
                            return ogImage;
                        }

                    } catch (e) {
                        console.warn(`Scraping attempt failed with ${createProxy(pageUrl)}`, e);
                    }
                }
                return null;
            }

            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            /**
             * [FIX] ëˆ„ë½ëœ fetchImage ë©”ì„œë“œ ì¶”ê°€
             * URLì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì™€ Base64ë¡œ ë³€í™˜
             */
            async fetchImage(url) {
                try {
                    const file = await this.downloadAsFile(url);
                    return await this.blobToBase64(file);
                } catch (error) {
                    console.error('fetchImage ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            /**
             * [OCR ìµœì í™”] ì´ë¯¸ì§€ë¥¼ OCRì— ìµœì í™”ëœ í˜•íƒœë¡œ ë³€í™˜
             * - ë©”íƒ€ë°ì´í„°(EXIF ë“±) ì™„ì „ ì œê±°
             * - ì ì ˆí•œ í•´ìƒë„ ìœ ì§€ (OCR ìµœì : 1500-2500px)
             * - ëŒ€ë¹„ í–¥ìƒ
             * - ì„ ëª…ë„ í–¥ìƒ
             * - ë…¸ì´ì¦ˆ ì œê±°
             * - ìµœì  í’ˆì§ˆë¡œ ì••ì¶•
             */
            async optimizeForOCR(base64Image) {
                return new Promise((resolve, reject) => {
                    const img = new Image();

                    img.onload = () => {
                        try {
                            // OCR ìµœì  í•´ìƒë„ ì„¤ì • (ë„ˆë¬´ ì‘ìœ¼ë©´ ì •í™•ë„ ë–¨ì–´ì§, ë„ˆë¬´ í¬ë©´ ë¶ˆí•„ìš”)
                            const OCR_OPTIMAL_SIZE = 2000; // ìµœì  í¬ê¸°
                            const OCR_MIN_SIZE = 800;      // ìµœì†Œ í¬ê¸°
                            const OCR_MAX_SIZE = 3000;     // ìµœëŒ€ í¬ê¸°

                            let { width, height } = img;
                            const originalWidth = width;
                            const originalHeight = height;

                            // í¬ê¸° ì¡°ì • (ë¹„ìœ¨ ìœ ì§€)
                            const maxDimension = Math.max(width, height);
                            const minDimension = Math.min(width, height);

                            if (maxDimension > OCR_MAX_SIZE) {
                                // ë„ˆë¬´ í¬ë©´ ì¶•ì†Œ
                                const scale = OCR_MAX_SIZE / maxDimension;
                                width = Math.round(width * scale);
                                height = Math.round(height * scale);
                            } else if (maxDimension < OCR_MIN_SIZE && maxDimension > 100) {
                                // ë„ˆë¬´ ì‘ìœ¼ë©´ í™•ëŒ€ (ìµœëŒ€ 2ë°°ê¹Œì§€)
                                const scale = Math.min(2, OCR_MIN_SIZE / maxDimension);
                                width = Math.round(width * scale);
                                height = Math.round(height * scale);
                            }

                            // Canvas ìƒì„±
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');

                            // ê³ í’ˆì§ˆ ë¦¬ìƒ˜í”Œë§
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';

                            // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸° (ë©”íƒ€ë°ì´í„° ìë™ ì œê±°ë¨)
                            ctx.drawImage(img, 0, 0, width, height);

                            // OCR ìµœì í™” í•„í„° ì ìš©
                            this.applyOCRFilters(ctx, width, height);

                            // ìµœì  í’ˆì§ˆë¡œ ì¶œë ¥ (PNGëŠ” ë¬´ì†ì‹¤, JPEGì€ 95% í’ˆì§ˆ)
                            // í…ìŠ¤íŠ¸ ì´ë¯¸ì§€ëŠ” PNGê°€ ë” ì¢‹ì§€ë§Œ, ìš©ëŸ‰ì„ ìœ„í•´ ê³ í’ˆì§ˆ JPEG ì‚¬ìš©
                            const optimizedBase64 = canvas.toDataURL('image/jpeg', 0.95);

                            // ê²°ê³¼ ë¡œê·¸
                            const originalSize = Math.round(base64Image.length * 0.75 / 1024);
                            const optimizedSize = Math.round(optimizedBase64.length * 0.75 / 1024);
                            console.log(`ğŸ”§ OCR ìµœì í™” ì™„ë£Œ:`);
                            console.log(`   ì›ë³¸: ${originalWidth}x${originalHeight} (${originalSize}KB)`);
                            console.log(`   ìµœì í™”: ${width}x${height} (${optimizedSize}KB)`);
                            console.log(`   ë©”íƒ€ë°ì´í„° ì œê±°, ëŒ€ë¹„/ì„ ëª…ë„ í–¥ìƒ ì ìš©`);

                            resolve(optimizedBase64);
                        } catch (e) {
                            console.error('OCR ìµœì í™” ì‹¤íŒ¨:', e);
                            resolve(base64Image); // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
                        }
                    };

                    img.onerror = () => {
                        console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
                        resolve(base64Image); // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
                    };

                    img.src = base64Image;
                });
            }

            /**
             * OCR ìµœì í™” í•„í„° ì ìš©
             * - ëŒ€ë¹„ í–¥ìƒ (í…ìŠ¤íŠ¸ì™€ ë°°ê²½ êµ¬ë¶„ ëª…í™•íˆ)
             * - ì„ ëª…ë„ í–¥ìƒ
             * - ì•½ê°„ì˜ ë…¸ì´ì¦ˆ ì œê±°
             */
            applyOCRFilters(ctx, width, height) {
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;

                // 1. ìë™ ë ˆë²¨ ì¡°ì • (ëŒ€ë¹„ í–¥ìƒ)
                let minR = 255, maxR = 0;
                let minG = 255, maxG = 0;
                let minB = 255, maxB = 0;

                // íˆìŠ¤í† ê·¸ë¨ ë¶„ì„
                for (let i = 0; i < data.length; i += 4) {
                    minR = Math.min(minR, data[i]);
                    maxR = Math.max(maxR, data[i]);
                    minG = Math.min(minG, data[i + 1]);
                    maxG = Math.max(maxG, data[i + 1]);
                    minB = Math.min(minB, data[i + 2]);
                    maxB = Math.max(maxB, data[i + 2]);
                }

                // ë ˆë²¨ ì¡°ì •
                const rangeR = maxR - minR || 1;
                const rangeG = maxG - minG || 1;
                const rangeB = maxB - minB || 1;

                // ëŒ€ë¹„ í–¥ìƒ ê³„ìˆ˜ (OCRì— ì í•©í•˜ê²Œ ì•½ê°„ ê°•í•˜ê²Œ)
                const contrastBoost = 1.1;

                for (let i = 0; i < data.length; i += 4) {
                    // ë ˆë²¨ ì¡°ì • + ëŒ€ë¹„ í–¥ìƒ
                    let r = ((data[i] - minR) / rangeR) * 255 * contrastBoost;
                    let g = ((data[i + 1] - minG) / rangeG) * 255 * contrastBoost;
                    let b = ((data[i + 2] - minB) / rangeB) * 255 * contrastBoost;

                    // í´ë¦¬í•‘
                    data[i] = Math.max(0, Math.min(255, r));
                    data[i + 1] = Math.max(0, Math.min(255, g));
                    data[i + 2] = Math.max(0, Math.min(255, b));
                }

                ctx.putImageData(imageData, 0, 0);

                // 2. ì–¸ìƒ¤í”„ ë§ˆìŠ¤í¬ (ì„ ëª…ë„ í–¥ìƒ) - CSS í•„í„°ë¡œ ëŒ€ì²´
                // Canvas 2DëŠ” ë³µì¡í•œ í•„í„°ê°€ ì œí•œì ì´ë¯€ë¡œ, ê¸°ë³¸ ëŒ€ë¹„ í–¥ìƒìœ¼ë¡œ ì¶©ë¶„
            }
        }

        /**
         * [Service Layer] Gemini Vision & Text Service
         * Clean Architecture: ì™¸ë¶€ API í†µì‹  ë‹´ë‹¹
         */
        class GeminiService {
            constructor() {
                // [NEW] ë™ì  ëª¨ë¸ ì„¤ì • - ê¸°ë³¸ê°’ì€ CONFIGì—ì„œ ê°€ì ¸ì˜´
                const defaultModel = CONFIG.GEMINI_MODELS.find(m => m.isDefault) || CONFIG.GEMINI_MODELS[0];
                this.modelVision = defaultModel.id;
                this.modelText = defaultModel.id;
                this.baseUrl = "https://generativelanguage.googleapis.com/v1beta/models";
            }

            /**
             * [NEW] ëª¨ë¸ ì„¤ì • ë³€ê²½
             * @param {string} modelId - ëª¨ë¸ ID
             */
            setModel(modelId) {
                this.modelVision = modelId;
                this.modelText = modelId;
                console.log(`ğŸ¤– Gemini ëª¨ë¸ ë³€ê²½: ${modelId}`);
            }

            /**
             * [NEW] í˜„ì¬ ëª¨ë¸ ID ë°˜í™˜
             * @returns {string} í˜„ì¬ ëª¨ë¸ ID
             */
            getCurrentModel() {
                return this.modelVision;
            }

            /**
             * [NEW] ëª¨ë¸ ì ‘ê·¼ ê¶Œí•œ ê²€ì¦
             * - API í‚¤ì™€ ëª¨ë¸ë¡œ ê°„ë‹¨í•œ ìš”ì²­ì„ ë³´ë‚´ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
             * @param {string} apiKey - API í‚¤
             * @param {string} modelId - ê²€ì¦í•  ëª¨ë¸ ID
             * @returns {Promise<{success: boolean, error?: string, latency?: number}>}
             */
            async validateModel(apiKey, modelId) {
                const url = `${this.baseUrl}/${modelId}:generateContent?key=${apiKey}`;
                const startTime = performance.now();

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Hello" }] }],
                            generationConfig: { maxOutputTokens: 10 }
                        })
                    });

                    const latency = Math.round(performance.now() - startTime);

                    if (response.ok) {
                        return { success: true, latency };
                    } else if (response.status === 403) {
                        return { success: false, error: 'ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ (403)', latency };
                    } else if (response.status === 404) {
                        return { success: false, error: 'ëª¨ë¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ (404)', latency };
                    } else if (response.status === 429) {
                        return { success: false, error: 'í• ë‹¹ëŸ‰ ì´ˆê³¼ (429)', latency };
                    } else {
                        return { success: false, error: `ì˜¤ë¥˜ (${response.status})`, latency };
                    }
                } catch (error) {
                    return { success: false, error: `ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}` };
                }
            }

            /**
             * [NEW] ëª¨ë“  ëª¨ë¸ì˜ ì ‘ê·¼ ê¶Œí•œì„ ì¼ê´„ ê²€ì¦
             * @param {string} apiKey - API í‚¤
             * @param {Array} models - ê²€ì¦í•  ëª¨ë¸ ëª©ë¡
             * @returns {Promise<Map<string, {success: boolean, error?: string, latency?: number}>>}
             */
            async validateAllModels(apiKey, models) {
                const results = new Map();

                for (const model of models) {
                    const result = await this.validateModel(apiKey, model.id);
                    results.set(model.id, result);
                }

                return results;
            }

            // [ìˆ˜ì •] MIME íƒ€ì… ê°ì§€ + ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ ë°˜ì˜
            async extractTable(apiKey, base64Image, userPrompt = '') {
                const url = `${this.baseUrl}/${this.modelVision}:generateContent?key=${apiKey}`;

                // ë””ë²„ê¹…: í”„ë¡¬í”„íŠ¸ í™•ì¸
                console.log('=== OCR ìš”ì²­ ì‹œì‘ ===');
                console.log('ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸:', userPrompt || '(ì—†ìŒ)');

                // [NEW] MIME íƒ€ì… ìë™ ê°ì§€
                let mimeType = "image/png"; // ê¸°ë³¸ê°’
                let cleanBase64 = base64Image;

                if (base64Image.startsWith("data:")) {
                    const parts = base64Image.split(",");
                    if (parts.length === 2) {
                        // "data:image/jpeg;base64" -> "image/jpeg"
                        const mimeMatch = parts[0].match(/:(.*?);/);
                        if (mimeMatch) mimeType = mimeMatch[1];
                        cleanBase64 = parts[1];
                    }
                }

                // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (í•œêµ­ì–´ + ì˜ì–´ í˜¼í•©ìœ¼ë¡œ ë” ëª…í™•í•˜ê²Œ)
                let basePrompt = `ë‹¹ì‹ ì€ ì´ë¯¸ì§€ì—ì„œ í‘œ(í…Œì´ë¸”) ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” OCR ì „ë¬¸ê°€ì…ë‹ˆë‹¤.

[ê¸°ë³¸ ì§€ì‹œì‚¬í•­]
1. ì´ë¯¸ì§€ì—ì„œ í‘œ ë°ì´í„°ë¥¼ ì •í™•í•˜ê²Œ ì¶”ì¶œí•˜ì„¸ìš”.
2. ì†ê¸€ì”¨, í•„ê¸°ì²´, íŠ¹ìˆ˜ê¸°í˜¸ë„ ë¬¸ë§¥ì— ë§ê²Œ ì¸ì‹í•˜ì„¸ìš”.
3. ìˆ«ì, ë‚ ì§œ, í…ìŠ¤íŠ¸ë¥¼ ì´ë¯¸ì§€ì— ë³´ì´ëŠ” ê·¸ëŒ€ë¡œ ì •í™•íˆ ë³´ì¡´í•˜ì„¸ìš”.
4. ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”:
   { "headers": ["ì»¬ëŸ¼1", "ì»¬ëŸ¼2", ...], "rows": [["ê°’1", "ê°’2", ...], ...] }
5. ë§ˆí¬ë‹¤ìš´ ì½”ë“œë¸”ë¡(\`\`\`json)ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.`;

                // ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ê°€ ìˆìœ¼ë©´ ì¶”ê°€
                if (userPrompt && userPrompt.trim()) {
                    basePrompt += `

[ì¤‘ìš”: ì‚¬ìš©ì íŠ¹ë³„ ìš”ì²­ì‚¬í•­]
ì•„ë˜ ì‚¬ìš©ìì˜ ìš”ì²­ì‚¬í•­ì„ ë°˜ë“œì‹œ ìš°ì„ ì ìœ¼ë¡œ ë°˜ì˜í•˜ì—¬ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”:

${userPrompt}

ìœ„ ìš”ì²­ì‚¬í•­ì„ ê¼­ ì§€ì¼œì„œ ì¶”ì¶œí•´ì£¼ì„¸ìš”.`;
                    console.log('ìµœì¢… í”„ë¡¬í”„íŠ¸ì— ì‚¬ìš©ì ìš”ì²­ í¬í•¨ë¨');
                }

                console.log('ìµœì¢… í”„ë¡¬í”„íŠ¸ ê¸¸ì´:', basePrompt.length, 'ì');

                const payload = {
                    contents: [{
                        parts: [
                            { text: basePrompt },
                            { inlineData: { mimeType: mimeType, data: cleanBase64 } }
                        ]
                    }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Vision API Error: ${response.status}`);
                const data = await response.json();
                return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
            }

            async categorizeItems(apiKey, items) {
                const url = `${this.baseUrl}/${this.modelText}:generateContent?key=${apiKey}`;
                const prompt = `Classify items: ${JSON.stringify(items)}. Return ONLY JSON array.`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "[]");
            }

            async askData(apiKey, tableData, userQuery) {
                const url = `${this.baseUrl}/${this.modelText}:generateContent?key=${apiKey}`;
                const prompt = `Analyze data: ${JSON.stringify(tableData)}. Question: ${userQuery}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Text API Error: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "ë‹µë³€ ë¶ˆê°€";
            }
        }

        /**
         * [View Layer] UI Manager
         */
        class UIManager {
            constructor() {
                this.elements = {
                    loadingOverlay: document.getElementById('loadingOverlay'),
                    loadingText: document.getElementById('loadingText'),
                    resultContainer: document.getElementById('resultContainer'),
                    tableHead: document.getElementById('tableHead'),
                    tableBody: document.getElementById('tableBody'),
                    chatContainer: document.getElementById('chatContainer'),
                    zoomRange: document.getElementById('zoomRange'),
                    zoomLabel: document.getElementById('zoomLabel'),
                    imageWrapper: document.getElementById('imageWrapper'),
                    compareImage: document.getElementById('compareImage'),
                    drawingCanvas: document.getElementById('drawingCanvas'),
                    heightFitBtn: document.getElementById('heightFitBtn'),
                    previewArea: document.getElementById('previewArea'),
                    dropZone: document.getElementById('dropZone'),
                    previewImage: document.getElementById('previewImage'),
                    urlImportModal: document.getElementById('urlImportModal'),
                    imageUrlInput: document.getElementById('imageUrlInput'),
                    imageInput: document.getElementById('imageInput'),
                    googlePhotosModal: document.getElementById('googlePhotosModal'),
                    googlePhotosGallery: document.getElementById('googlePhotosGallery'),
                    galleryGrid: document.getElementById('galleryGrid'),
                    connectedAccount: document.getElementById('connectedAccount'),
                    photoCount: document.getElementById('photoCount'),
                    ocrPromptModal: document.getElementById('ocrPromptModal'),
                    ocrPromptInput: document.getElementById('ocrPromptInput')
                };
            }

            setLoading(isLoading, text = "ì²˜ë¦¬ ì¤‘...") {
                this.elements.loadingText.innerText = text;
                this.elements.loadingOverlay.classList.toggle('hidden', !isLoading);
                this.elements.loadingOverlay.classList.toggle('flex', isLoading);
            }

            // Google Photos Login
            showGooglePhotosModal() { this.elements.googlePhotosModal.classList.remove('hidden'); }
            hideGooglePhotosModal() { this.elements.googlePhotosModal.classList.add('hidden'); }
            getGooglePhotosCredentials() {
                return {
                    id: document.getElementById('gpId').value,
                    pw: document.getElementById('gpPw').value
                };
            }

            // Google Photos Gallery
            showGooglePhotosGallery(accountId, photos) {
                this.elements.googlePhotosGallery.classList.remove('hidden');
                this.elements.connectedAccount.innerText = accountId;
                this.elements.photoCount.innerText = photos.length;
                this.renderGallery(photos);
            }
            hideGooglePhotosGallery() { this.elements.googlePhotosGallery.classList.add('hidden'); }

            renderGallery(photos) {
                this.elements.galleryGrid.innerHTML = photos.map(photo => `
                    <div class="photo-item group" onclick="app.selectGalleryPhoto('${photo.url}')">
                        <img src="${photo.url}" alt="${photo.name}" crossorigin="anonymous">
                        <div class="photo-check">âœ”</div>
                        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2">
                            <p class="text-white text-xs truncate">${photo.name}</p>
                            <p class="text-gray-300 text-[10px]">${photo.date}</p>
                        </div>
                    </div>
                `).join('');
            }

            // URL Import Modal Control
            showUrlImportModal() { this.elements.urlImportModal.classList.remove('hidden'); }
            hideUrlImportModal() { this.elements.urlImportModal.classList.add('hidden'); }
            getImportUrl() { return this.elements.imageUrlInput.value.trim(); }

            // OCR Prompt Modal Control
            showOcrPromptModal() {
                this.elements.ocrPromptModal.classList.remove('hidden');
                this.elements.ocrPromptInput.value = '';
                this.elements.ocrPromptInput.focus();
            }
            hideOcrPromptModal() { this.elements.ocrPromptModal.classList.add('hidden'); }
            getOcrPrompt() { return this.elements.ocrPromptInput.value.trim(); }

            // ============================================
            // [NEW] Clipboard Modal Control (Clean Architecture)
            // Controller(App)ì˜ DOM ì§ì ‘ ì ‘ê·¼ ì—†ì´ View ë ˆì´ì–´ì—ì„œ ì²˜ë¦¬
            // ============================================

            /**
             * í´ë¦½ë³´ë“œ ëª¨ë‹¬ í‘œì‹œ
             */
            showClipboardModal() {
                const modal = document.getElementById('clipboardModal');
                if (modal) modal.classList.remove('hidden');
            }

            /**
             * í´ë¦½ë³´ë“œ ëª¨ë‹¬ ìˆ¨ê¹€
             */
            hideClipboardModal() {
                const modal = document.getElementById('clipboardModal');
                if (modal) modal.classList.add('hidden');
            }

            /**
             * í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
             * @param {string|null} imageData - Base64 ì´ë¯¸ì§€ ë°ì´í„° (nullì´ë©´ ë¹ˆ ìƒíƒœ)
             * @param {Object|null} imageInfo - ì´ë¯¸ì§€ ì •ë³´ {width, height, size}
             */
            updateClipboardPreview(imageData, imageInfo = null) {
                const container = document.getElementById('clipboardPreviewContainer');
                const emptyState = document.getElementById('clipboardEmptyState');
                const thumbnail = document.getElementById('clipboardThumbnail');
                const infoDiv = document.getElementById('clipboardImageInfo');
                const uploadBtn = document.getElementById('clipboardUploadBtn');

                if (imageData) {
                    // ì´ë¯¸ì§€ ìˆìŒ
                    container.classList.add('has-image');
                    container.classList.remove('no-image');
                    emptyState.classList.add('hidden');
                    thumbnail.classList.remove('hidden');
                    thumbnail.src = imageData;
                    uploadBtn.disabled = false;

                    if (imageInfo) {
                        infoDiv.classList.remove('hidden');
                        infoDiv.classList.remove('error');
                        const sizeKB = imageInfo.size ? Math.round(imageInfo.size / 1024) : '?';
                        infoDiv.textContent = `ğŸ“ ${imageInfo.width} Ã— ${imageInfo.height}px Â· ğŸ“¦ ${sizeKB}KB`;
                    }
                } else {
                    // ì´ë¯¸ì§€ ì—†ìŒ
                    container.classList.remove('has-image');
                    emptyState.classList.remove('hidden');
                    thumbnail.classList.add('hidden');
                    thumbnail.src = '';
                    uploadBtn.disabled = true;
                    infoDiv.classList.add('hidden');
                }
            }

            /**
             * í´ë¦½ë³´ë“œ ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
             * @param {string} message - ì—ëŸ¬ ë©”ì‹œì§€
             */
            showClipboardError(message) {
                const container = document.getElementById('clipboardPreviewContainer');
                const emptyState = document.getElementById('clipboardEmptyState');
                const thumbnail = document.getElementById('clipboardThumbnail');
                const infoDiv = document.getElementById('clipboardImageInfo');
                const uploadBtn = document.getElementById('clipboardUploadBtn');

                container.classList.add('no-image');
                container.classList.remove('has-image');
                emptyState.innerHTML = `
                    <div class="text-4xl mb-3">âŒ</div>
                    <p class="font-medium text-red-600">${message}</p>
                    <p class="text-xs mt-1 text-gray-500">í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ë¥¼ ë³µì‚¬í•œ í›„ ìƒˆë¡œê³ ì¹¨ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                `;
                emptyState.classList.remove('hidden');
                thumbnail.classList.add('hidden');
                infoDiv.classList.add('hidden');
                uploadBtn.disabled = true;
            }

            /**
             * í´ë¦½ë³´ë“œ ë¡œë”© ìƒíƒœ í‘œì‹œ
             */
            showClipboardLoading() {
                const emptyState = document.getElementById('clipboardEmptyState');
                emptyState.innerHTML = `
                    <div class="text-4xl mb-3 clipboard-loading">ğŸ“‹</div>
                    <p class="font-medium">í´ë¦½ë³´ë“œ ì½ëŠ” ì¤‘...</p>
                    <p class="text-xs mt-1">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                `;
                emptyState.classList.remove('hidden');
                document.getElementById('clipboardThumbnail').classList.add('hidden');
                document.getElementById('clipboardUploadBtn').disabled = true;
            }

            // ============================================
            // [NEW] Gemini ëª¨ë¸ ì„ íƒ UI ê´€ë¦¬ (Clean Architecture - View)
            // Controller(App)ì˜ DOM ì§ì ‘ ì ‘ê·¼ ì—†ì´ View ë ˆì´ì–´ì—ì„œ ì²˜ë¦¬
            // ============================================

            /**
             * ëª¨ë¸ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
             * @param {Array} models - CONFIG.GEMINI_MODELS
             * @param {string} defaultModelId - í˜„ì¬ ì„ íƒëœ ëª¨ë¸ ID
             */
            initModelSelector(models, defaultModelId) {
                const selector = document.getElementById('modelSelector');
                if (!selector) return;

                selector.innerHTML = models.map(model => {
                    const tierBadge = model.tier === 'preview' ? 'ğŸ§ª' :
                        model.tier === 'pro' ? 'â­' : 'âœ…';
                    const selected = model.id === defaultModelId ? 'selected' : '';
                    return `<option value="${model.id}" ${selected}>${tierBadge} ${model.name}</option>`;
                }).join('');
            }

            /**
             * í˜„ì¬ ì„ íƒëœ ëª¨ë¸ ID ë°˜í™˜
             * @returns {string} ëª¨ë¸ ID
             */
            getSelectedModelId() {
                const selector = document.getElementById('modelSelector');
                return selector ? selector.value : null;
            }

            /**
             * ëª¨ë¸ ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
             * @param {'success'|'error'|'pending'|'unknown'} status - ìƒíƒœ
             * @param {string} text - í‘œì‹œí•  í…ìŠ¤íŠ¸
             * @param {number} latency - ì‘ë‹µ ì‹œê°„ (ms)
             */
            updateModelStatus(status, text, latency = null) {
                const badge = document.getElementById('modelStatusBadge');
                const latencyEl = document.getElementById('modelLatency');

                if (badge) {
                    badge.className = `model-status-badge ${status}`;
                    badge.textContent = text;
                }

                if (latencyEl) {
                    latencyEl.textContent = latency ? `(${latency}ms)` : '';
                }
            }

            /**
             * ëª¨ë¸ ê²€ì¦ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
             * @param {boolean} disabled - ë¹„í™œì„±í™” ì—¬ë¶€
             * @param {string} text - ë²„íŠ¼ í…ìŠ¤íŠ¸
             */
            setModelValidateBtnState(disabled, text = 'ğŸ” ê²€ì¦') {
                const btn = document.getElementById('validateModelBtn');
                if (btn) {
                    btn.disabled = disabled;
                    btn.innerHTML = text;
                }
            }

            /**
             * ëª¨ë¸ ì„ íƒ UI ìš”ì†Œ ë°˜í™˜
             */
            getModelSelectorElements() {
                return {
                    selector: document.getElementById('modelSelector'),
                    validateBtn: document.getElementById('validateModelBtn'),
                    statusBadge: document.getElementById('modelStatusBadge'),
                    latencyEl: document.getElementById('modelLatency')
                };
            }

            updateZoomUI(percent, isFit) {
                this.elements.zoomRange.value = percent;
                this.elements.zoomLabel.innerText = `${percent}%`;

                if (isFit) {
                    this.elements.heightFitBtn.classList.replace('bg-indigo-600', 'bg-yellow-600');
                    this.elements.heightFitBtn.classList.replace('hover:bg-indigo-500', 'hover:bg-yellow-500');
                    this.elements.heightFitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg> ë§ì¶¤ í•´ì œ`;
                } else {
                    this.elements.heightFitBtn.classList.replace('bg-yellow-600', 'bg-indigo-600');
                    this.elements.heightFitBtn.classList.replace('hover:bg-yellow-500', 'hover:bg-indigo-500');
                    this.elements.heightFitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 4l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg> í™•ëŒ€ ë§ì¶¤`;
                }
            }

            renderTable(data, onRowClick) {
                this.elements.resultContainer.classList.remove('hidden');
                this.elements.tableHead.innerHTML = `<tr>${data.headers.map(h => `<th class="px-4 py-2 text-center bg-gray-100 font-bold border-b text-gray-600 whitespace-nowrap sticky top-0 relative group">${h}<div class="resize-handle"></div></th>`).join('')}</tr>`;
                this.elements.tableBody.innerHTML = data.rows.map((row, idx) => `<tr class="hover:bg-indigo-50/50 transition cursor-pointer" data-idx="${idx}">${row.map((cell, cellIdx) => `<td class="px-4 py-2 border-b border-gray-100" contenteditable="true" data-row="${idx}" data-col="${cellIdx}" onclick="event.stopPropagation()">${cell}</td>`).join('')}</tr>`).join('');
                this.elements.tableBody.querySelectorAll('tr').forEach(tr => tr.onclick = () => onRowClick(tr));

                // ì…€ í¸ì§‘ ì‹œ currentData ì‹¤ì‹œê°„ ë™ê¸°í™”
                this.elements.tableBody.querySelectorAll('td[contenteditable="true"]').forEach(td => {
                    td.addEventListener('input', (e) => {
                        const rowIdx = parseInt(e.target.dataset.row);
                        const colIdx = parseInt(e.target.dataset.col);
                        const newValue = e.target.textContent.trim();

                        // currentData ì—…ë°ì´íŠ¸
                        if (window.app && window.app.currentData && window.app.currentData.rows[rowIdx]) {
                            window.app.currentData.rows[rowIdx][colIdx] = newValue;
                        }
                    });

                    // í¸ì§‘ ì‹œ ì‹œê°ì  í”¼ë“œë°± (ìˆ˜ì •ëœ ì…€ í‘œì‹œ)
                    td.addEventListener('focus', (e) => {
                        e.target.classList.add('ring-2', 'ring-indigo-400', 'bg-indigo-50');
                    });
                    td.addEventListener('blur', (e) => {
                        e.target.classList.remove('ring-2', 'ring-indigo-400', 'bg-indigo-50');
                        // ê°’ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ë°°ê²½ìƒ‰ ìœ ì§€ (ìˆ˜ì •ë¨ í‘œì‹œ)
                        const rowIdx = parseInt(e.target.dataset.row);
                        const colIdx = parseInt(e.target.dataset.col);
                        const currentValue = e.target.textContent.trim();
                        const originalValue = data.rows[rowIdx]?.[colIdx] || '';
                        if (currentValue !== originalValue) {
                            e.target.classList.add('bg-yellow-50', 'border-yellow-300');
                        }
                    });
                });
            }

            toggleRowHighlight(row) { row.classList.toggle('selected-row'); }

            addChatMessage(sender, text) {
                const isBot = sender === 'bot';
                const html = `<div class="flex gap-3 ${isBot ? '' : 'flex-row-reverse'} animate-fade-in-up"><div class="w-8 h-8 rounded-full flex items-center justify-center shrink-0 text-lg border ${isBot ? 'bg-indigo-100 border-indigo-200' : 'bg-gray-200 border-gray-300'}">${isBot ? 'ğŸ¤–' : 'ğŸ‘¤'}</div><div class="p-3 rounded-2xl shadow-sm border text-sm max-w-[85%] ${isBot ? 'bg-white border-gray-100 rounded-tl-none text-gray-700 prose' : 'bg-indigo-600 border-indigo-600 rounded-tr-none text-white'}">${isBot ? marked.parse(text) : text}</div></div>`;
                this.elements.chatContainer.insertAdjacentHTML('beforeend', html);
                this.elements.chatContainer.scrollTop = this.elements.chatContainer.scrollHeight;
            }

            // ============================================
            // [NEW] API Key UI ê´€ë¦¬ ë©”ì„œë“œ (Clean Architecture)
            // Controller(App)ì˜ DOM ì§ì ‘ ì ‘ê·¼ì„ View(UIManager)ë¡œ ìœ„ì„
            // ============================================

            /**
             * API Key UI ìš”ì†Œë“¤ ë°˜í™˜
             * Controllerê°€ DOMì— ì§ì ‘ ì ‘ê·¼í•˜ì§€ ì•Šê³  UIManagerë¥¼ í†µí•´ ì ‘ê·¼
             */
            getApiKeyElements() {
                return {
                    toggleBtn: document.getElementById('apiKeyToggleBtn'),
                    dropdown: document.getElementById('apiKeyDropdown'),
                    input: document.getElementById('apiKeyInput'),
                    keyNumber: document.getElementById('currentKeyNumber'),
                    options: document.querySelectorAll('.api-key-option')
                };
            }

            /**
             * API Key ì…ë ¥ê°’ ì¡°íšŒ
             */
            getApiKeyValue() {
                return document.getElementById('apiKeyInput')?.value.trim() || '';
            }

            /**
             * API Key UI ì—…ë°ì´íŠ¸
             * @param {number} keyIndex - Key ì¸ë±ìŠ¤ (0, 1, 2 ë˜ëŠ” -1=ì§ì ‘ì…ë ¥)
             * @param {string} keyValue - ì…ë ¥ì°½ì— í‘œì‹œí•  Key ê°’
             */
            updateApiKeyUI(keyIndex, keyValue) {
                const input = document.getElementById('apiKeyInput');
                const keyNumber = document.getElementById('currentKeyNumber');

                if (input) input.value = keyValue;
                if (keyNumber) {
                    keyNumber.textContent = keyIndex >= 0 ? (keyIndex + 1) : 'âœ';
                }

                // ë“œë¡­ë‹¤ìš´ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
                this.setApiKeyDropdownSelected(keyIndex);
            }

            /**
             * API Key ë“œë¡­ë‹¤ìš´ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
             * @param {number} selectedIndex - ì„ íƒëœ Key ì¸ë±ìŠ¤
             */
            setApiKeyDropdownSelected(selectedIndex) {
                const options = document.querySelectorAll('.api-key-option');
                options.forEach(opt => {
                    const optIndex = parseInt(opt.dataset.keyIndex);
                    opt.classList.toggle('selected', optIndex === selectedIndex);
                });
            }

            /**
             * API Key ë“œë¡­ë‹¤ìš´ í† ê¸€
             * @param {boolean} show - trueë©´ í‘œì‹œ, falseë©´ ìˆ¨ê¹€, undefinedë©´ í† ê¸€
             */
            toggleApiKeyDropdown(show) {
                const dropdown = document.getElementById('apiKeyDropdown');
                if (dropdown) {
                    if (show === undefined) {
                        dropdown.classList.toggle('show');
                    } else {
                        dropdown.classList.toggle('show', show);
                    }
                }
            }

            /**
             * API Key ì…ë ¥ì°½ í¬ì»¤ìŠ¤
             */
            focusApiKeyInput() {
                const input = document.getElementById('apiKeyInput');
                if (input) input.focus();
            }
        }

        /**
         * [Controller Layer] Main Application Logic
         */
        class App {
            constructor() {
                this.gemini = new GeminiService();
                this.imageService = new ImageService(); // [ì¶”ê°€]
                this.ui = new UIManager();

                // App State
                this.currentData = null;
                this.imageBase64 = null;
                this.isSample = false;
                this.naturalWidth = 0;
                this.naturalHeight = 0;
                this.isZoomFit = false;

                // [ê°œì„ ] API Key ìƒíƒœë¥¼ App ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ê´€ë¦¬ (ì „ì—­ CONFIG ì˜ì¡´ ì œê±°)
                this.currentKeyIndex = 0;  // 0=1ë²ˆ, 1=2ë²ˆ, 2=3ë²ˆ, -1=ì§ì ‘ì…ë ¥

                // [NEW] Gemini ëª¨ë¸ ì„ íƒ ìƒíƒœ ê´€ë¦¬ (Clean Architecture - Controller State)
                this.currentModelIndex = CONFIG.DEFAULT_MODEL_INDEX;
                this.modelValidationCache = new Map(); // ê²€ì¦ ê²°ê³¼ ìºì‹œ

                // ì§ì„  ê·¸ë¦¬ê¸° ìƒíƒœ
                this.isDrawing = false;
                this.drawingHistory = [];  // [{start: {x,y}, end: {x,y}}, ...]
                this.lineStart = null;
                this.lineEnd = null;

                this.bindEvents();

                // [NEW] ëª¨ë¸ ì„ íƒ UI ì´ˆê¸°í™”
                this.initModelSelector();
            }

            bindEvents() {
                const self = this;
                const dropZone = document.getElementById('dropZone');
                const imageInput = document.getElementById('imageInput');
                const sampleBtn = document.getElementById('sampleBtn');
                const urlBtn = document.getElementById('urlBtn');
                const runAnalysisBtn = document.getElementById('runAnalysisBtn');
                const previewImage = document.getElementById('previewImage');

                // íŒŒì¼ ì…ë ¥ ë³€ê²½
                if (imageInput) {
                    imageInput.addEventListener('change', function (e) {
                        self.isSample = false;
                        self.handleFile(e.target.files[0]);
                    });
                }

                // ë“œë˜ê·¸ì•¤ë“œë¡­
                if (dropZone) {
                    dropZone.addEventListener('dragover', function (e) {
                        e.preventDefault();
                        dropZone.classList.add('bg-indigo-50');
                    });
                    dropZone.addEventListener('dragleave', function (e) {
                        e.preventDefault();
                        dropZone.classList.remove('bg-indigo-50');
                    });
                    dropZone.addEventListener('drop', function (e) {
                        e.preventDefault();
                        self.isSample = false;
                        dropZone.classList.remove('bg-indigo-50');
                        if (e.dataTransfer.files.length) self.handleFile(e.dataTransfer.files[0]);
                    });
                    // dropZone í´ë¦­ ì‹œ íŒŒì¼ ì„ íƒ (ë²„íŠ¼ ì œì™¸)
                    dropZone.addEventListener('click', function (e) {
                        if (e.target.closest('button')) return;
                        if (imageInput) imageInput.click();
                    });
                }

                // ìƒ˜í”Œ ë²„íŠ¼ í´ë¦­
                if (sampleBtn) {
                    sampleBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ìƒ˜í”Œ ë²„íŠ¼ í´ë¦­ë¨');
                        self.loadSampleImage();
                    });
                }

                // URL ë²„íŠ¼ í´ë¦­
                if (urlBtn) {
                    urlBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('URL ë²„íŠ¼ í´ë¦­ë¨');
                        self.ui.showUrlImportModal();
                    });
                }

                // [NEW] í´ë¦½ë³´ë“œ ë²„íŠ¼ í´ë¦­
                const clipboardBtn = document.getElementById('clipboardBtn');
                if (clipboardBtn) {
                    clipboardBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('í´ë¦½ë³´ë“œ ë²„íŠ¼ í´ë¦­ë¨');
                        self.showClipboardModal();
                    });
                }

                // ë¶„ì„ ë²„íŠ¼
                if (runAnalysisBtn) {
                    runAnalysisBtn.addEventListener('click', function () {
                        self.runVision();
                    });
                }

                // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ í´ë¦­
                if (previewImage) {
                    previewImage.addEventListener('click', function () {
                        if (imageInput) imageInput.click();
                    });
                }

                const chatInput = document.getElementById('chatInput');
                const sendBtn = document.getElementById('sendBtn');
                const sendChat = () => { if (chatInput.value.trim()) this.handleChat(chatInput.value.trim()); };
                sendBtn.onclick = sendChat;
                chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendChat(); };

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        // OCR í”„ë¡¬í”„íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
                        const ocrModal = document.getElementById('ocrPromptModal');
                        if (!ocrModal.classList.contains('hidden')) {
                            this.ui.hideOcrPromptModal();
                            return;
                        }
                        // [NEW] í´ë¦½ë³´ë“œ ëª¨ë‹¬ ë‹«ê¸°
                        const clipboardModal = document.getElementById('clipboardModal');
                        if (clipboardModal && !clipboardModal.classList.contains('hidden')) {
                            this.hideClipboardModal();
                            return;
                        }
                        // ë¹„êµ ê²€ì¦ ëª¨ë“œ ë‹«ê¸°
                        const overlay = document.getElementById('comparisonOverlay');
                        if (!overlay.classList.contains('hidden')) this.toggleComparisonMode();
                    }
                });

                // OCR í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ì—ì„œ Ctrl+Enterë¡œ ì‹¤í–‰
                const ocrPromptInput = document.getElementById('ocrPromptInput');
                if (ocrPromptInput) {
                    ocrPromptInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && e.ctrlKey) {
                            e.preventDefault();
                            this.executeOcrWithPrompt();
                        }
                    });
                }

                // Ensure app instance is globally available for inline handlers
                window.ui = this.ui;

                // [NEW] API Key Selector ì´ë²¤íŠ¸ ë°”ì¸ë”©
                this.initApiKeySelector();
            }

            /**
             * [NEW] API Key ì„ íƒê¸° ì´ˆê¸°í™” (Clean Architecture ë¦¬íŒ©í† ë§)
             * - UIManagerë¥¼ í†µí•´ DOM ì¡°ì‘ ìœ„ì„
             * - App ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ìƒíƒœ ê´€ë¦¬
             */
            initApiKeySelector() {
                // [ê°œì„ ] UIManagerë¥¼ í†µí•´ DOM ìš”ì†Œ ì ‘ê·¼ (Clean Architecture)
                const elements = this.ui.getApiKeyElements();
                if (!elements.toggleBtn || !elements.dropdown) return;

                // ë“œë¡­ë‹¤ìš´ í† ê¸€ - UIManager ë©”ì„œë“œ ì‚¬ìš©
                elements.toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.ui.toggleApiKeyDropdown();
                });

                // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.api-key-selector')) {
                        this.ui.toggleApiKeyDropdown(false);
                    }
                });

                // API Key ì˜µì…˜ ì„ íƒ
                elements.options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const keyIndex = parseInt(option.dataset.keyIndex);

                        // [ê°œì„ ] App ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸ (CONFIG ì „ì—­ ë³€ìˆ˜ ëŒ€ì‹ )
                        this.currentKeyIndex = keyIndex;

                        if (keyIndex >= 0 && keyIndex < CONFIG.API_KEYS.length) {
                            // í•˜ë“œì½”ë”©ëœ Key ì„ íƒ - UIManagerë¥¼ í†µí•´ UI ì—…ë°ì´íŠ¸
                            this.ui.updateApiKeyUI(keyIndex, CONFIG.API_KEYS[keyIndex]);
                            console.log(`ğŸ”‘ API Key ${keyIndex + 1}ë²ˆ ì„ íƒë¨`);
                        } else {
                            // ì§ì ‘ ì…ë ¥ ëª¨ë“œ (-1) - UIManagerë¥¼ í†µí•´ UI ì—…ë°ì´íŠ¸
                            this.ui.updateApiKeyUI(-1, '');
                            this.ui.focusApiKeyInput();
                            console.log('ğŸ”‘ ì§ì ‘ ì…ë ¥ ëª¨ë“œ');
                        }

                        this.ui.toggleApiKeyDropdown(false);
                    });
                });

                // API Key ì…ë ¥ì°½ ë³€ê²½ ì‹œ ìƒíƒœ ë™ê¸°í™”
                elements.input.addEventListener('input', () => {
                    const currentValue = this.ui.getApiKeyValue();
                    const matchIndex = CONFIG.API_KEYS.findIndex(key => key === currentValue);

                    if (matchIndex >= 0) {
                        // í•˜ë“œì½”ë”©ëœ Keyì™€ ì¼ì¹˜í•˜ë©´ í•´ë‹¹ ë²ˆí˜¸ í‘œì‹œ
                        this.currentKeyIndex = matchIndex;
                        this.ui.updateApiKeyUI(matchIndex, currentValue);
                    } else if (currentValue) {
                        // ì§ì ‘ ì…ë ¥ëœ ê°’
                        this.currentKeyIndex = -1;
                        this.ui.setApiKeyDropdownSelected(-1);
                        // keyNumberë§Œ ì—…ë°ì´íŠ¸ (ì…ë ¥ê°’ì€ ì´ë¯¸ inputì— ìˆìŒ) - UIManager ë©”ì„œë“œë¡œ ì²˜ë¦¬
                        const keyNumber = document.getElementById('currentKeyNumber');
                        if (keyNumber) keyNumber.textContent = 'âœ';
                    }
                });
            }

            /**
             * [Helper] í˜„ì¬ API Key ê°’ ë°˜í™˜
             * @returns {string} API Key ë¬¸ìì—´
             */
            getApiKey() {
                return this.ui.getApiKeyValue();
            }

            // ============================================
            // [NEW] Gemini ëª¨ë¸ ì„ íƒ ì‹œìŠ¤í…œ (Clean Architecture)
            // - Controller(App): ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ + ìƒíƒœ ê´€ë¦¬
            // - View(UIManager): UI í‘œì‹œ/ì—…ë°ì´íŠ¸
            // - Service(GeminiService): ëª¨ë¸ ê²€ì¦ API í˜¸ì¶œ
            // ============================================

            /**
             * ëª¨ë¸ ì„ íƒê¸° ì´ˆê¸°í™”
             */
            initModelSelector() {
                // UI ì´ˆê¸°í™” (UIManagerì— ìœ„ì„)
                const currentModel = this.gemini.getCurrentModel();
                this.ui.initModelSelector(CONFIG.GEMINI_MODELS, currentModel);

                // ëª¨ë¸ ì„ íƒ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                const elements = this.ui.getModelSelectorElements();

                if (elements.selector) {
                    elements.selector.addEventListener('change', (e) => {
                        this.onModelChange(e.target.value);
                    });
                }

                if (elements.validateBtn) {
                    elements.validateBtn.addEventListener('click', () => {
                        this.validateCurrentModel();
                    });
                }

                console.log(`ğŸ¤– ëª¨ë¸ ì„ íƒê¸° ì´ˆê¸°í™” ì™„ë£Œ: ${currentModel}`);
            }

            /**
             * ëª¨ë¸ ë³€ê²½ ì²˜ë¦¬
             * @param {string} modelId - ì„ íƒëœ ëª¨ë¸ ID
             */
            onModelChange(modelId) {
                // GeminiServiceì— ëª¨ë¸ ì„¤ì • (Service ë ˆì´ì–´)
                this.gemini.setModel(modelId);

                // ìºì‹œëœ ê²€ì¦ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                if (this.modelValidationCache.has(modelId)) {
                    const cached = this.modelValidationCache.get(modelId);
                    if (cached.success) {
                        this.ui.updateModelStatus('success', 'âœ“ ì‚¬ìš©ê°€ëŠ¥', cached.latency);
                    } else {
                        this.ui.updateModelStatus('error', cached.error);
                    }
                } else {
                    // ìºì‹œ ì—†ìœ¼ë©´ ë¯¸í™•ì¸ ìƒíƒœ
                    this.ui.updateModelStatus('unknown', 'ë¯¸í™•ì¸');
                }

                // ì„ íƒëœ ëª¨ë¸ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                this.currentModelIndex = CONFIG.GEMINI_MODELS.findIndex(m => m.id === modelId);

                this.ui.addChatMessage('bot', `ğŸ¤– **Gemini ëª¨ë¸ ë³€ê²½ë¨**\n\nëª¨ë¸: \`${modelId}\`\n\nê²€ì¦ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            }

            /**
             * í˜„ì¬ ì„ íƒëœ ëª¨ë¸ ê²€ì¦
             */
            async validateCurrentModel() {
                const modelId = this.ui.getSelectedModelId();
                const apiKey = this.getApiKey();

                if (!apiKey) {
                    this.ui.addChatMessage('bot', 'âš ï¸ API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤. API Keyë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // UI ìƒíƒœ ë³€ê²½ (ë¡œë”©)
                this.ui.setModelValidateBtnState(true, 'â³ ê²€ì¦ì¤‘...');
                this.ui.updateModelStatus('pending', 'ê²€ì¦ì¤‘...');

                try {
                    // GeminiServiceë¥¼ í†µí•´ ëª¨ë¸ ê²€ì¦ (Service ë ˆì´ì–´)
                    const result = await this.gemini.validateModel(apiKey, modelId);

                    // ê²°ê³¼ ìºì‹±
                    this.modelValidationCache.set(modelId, result);

                    if (result.success) {
                        this.ui.updateModelStatus('success', 'âœ“ ì‚¬ìš©ê°€ëŠ¥', result.latency);
                        this.ui.addChatMessage('bot', `âœ… **ëª¨ë¸ ê²€ì¦ ì„±ê³µ!**\n\nëª¨ë¸: \`${modelId}\`\nìƒíƒœ: ì ‘ê·¼ ê°€ëŠ¥\nì‘ë‹µ ì‹œê°„: ${result.latency}ms`);
                    } else {
                        this.ui.updateModelStatus('error', result.error);
                        this.ui.addChatMessage('bot', `âŒ **ëª¨ë¸ ê²€ì¦ ì‹¤íŒ¨**\n\nëª¨ë¸: \`${modelId}\`\nì˜¤ë¥˜: ${result.error}\n\në‹¤ë¥¸ ëª¨ë¸ì„ ì„ íƒí•˜ê±°ë‚˜ API Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                    }
                } catch (error) {
                    this.ui.updateModelStatus('error', 'ê²€ì¦ ì‹¤íŒ¨');
                    this.ui.addChatMessage('bot', `âŒ ëª¨ë¸ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                } finally {
                    this.ui.setModelValidateBtnState(false, 'ğŸ” ê²€ì¦');
                }
            }

            /**
             * ëª¨ë“  ëª¨ë¸ ì¼ê´„ ê²€ì¦
             */
            async validateAllModels() {
                const apiKey = this.getApiKey();
                if (!apiKey) {
                    this.ui.addChatMessage('bot', 'âš ï¸ API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                this.ui.addChatMessage('bot', 'ğŸ” ëª¨ë“  ëª¨ë¸ ê²€ì¦ ì‹œì‘...');

                const results = await this.gemini.validateAllModels(apiKey, CONFIG.GEMINI_MODELS);

                // ê²°ê³¼ ìºì‹±
                results.forEach((result, modelId) => {
                    this.modelValidationCache.set(modelId, result);
                });

                // ê²°ê³¼ ë©”ì‹œì§€ ìƒì„±
                const lines = CONFIG.GEMINI_MODELS.map(model => {
                    const result = results.get(model.id);
                    const status = result.success ? 'âœ…' : 'âŒ';
                    const info = result.success ? `${result.latency}ms` : result.error;
                    return `${status} **${model.name}**: ${info}`;
                });

                this.ui.addChatMessage('bot', `ğŸ¤– **ëª¨ë¸ ê²€ì¦ ê²°ê³¼**\n\n${lines.join('\n')}`);

                // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                const currentModel = this.ui.getSelectedModelId();
                const currentResult = results.get(currentModel);
                if (currentResult) {
                    if (currentResult.success) {
                        this.ui.updateModelStatus('success', 'âœ“ ì‚¬ìš©ê°€ëŠ¥', currentResult.latency);
                    } else {
                        this.ui.updateModelStatus('error', currentResult.error);
                    }
                }
            }

            /**
             * [ê°œì„ ] íŒŒì¼ ì²˜ë¦¬ + OCR ìµœì í™” ìë™ ì ìš©
             * - ìˆ˜ë™ ì—…ë¡œë“œ, URL ë‹¤ìš´ë¡œë“œ ëª¨ë‘ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
             * - ë©”íƒ€ë°ì´í„° ì œê±°, ëŒ€ë¹„ í–¥ìƒ, ìµœì  í•´ìƒë„ ì ìš©
             */
            async handleFile(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const originalBase64 = e.target.result;

                    // OCR ìµœì í™” ì ìš©
                    this.ui.setLoading(true, "OCR ìµœì í™” ì¤‘...");

                    try {
                        // ì´ë¯¸ì§€ ìµœì í™” (ë©”íƒ€ë°ì´í„° ì œê±°, ëŒ€ë¹„ í–¥ìƒ, í•´ìƒë„ ìµœì í™”)
                        this.imageBase64 = await this.imageService.optimizeForOCR(originalBase64);

                        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        this.ui.elements.previewImage.src = this.imageBase64;
                        this.ui.elements.previewArea.classList.remove('hidden');
                        this.ui.elements.dropZone.classList.add('hidden');

                        this.ui.setLoading(false);

                    } catch (error) {
                        console.error('OCR ìµœì í™” ì˜¤ë¥˜:', error);
                        // ìµœì í™” ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš©
                        this.imageBase64 = originalBase64;
                        this.ui.elements.previewImage.src = this.imageBase64;
                        this.ui.elements.previewArea.classList.remove('hidden');
                        this.ui.elements.dropZone.classList.add('hidden');
                        this.ui.setLoading(false);
                    }
                };
                reader.readAsDataURL(file);
            }

            // [ì¶”ê°€] Google Drive Link Parser
            parseGoogleDriveLink(url) {
                let fileId = null;
                const match1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
                if (match1) fileId = match1[1];
                const match2 = url.match(/id=([a-zA-Z0-9_-]+)/);
                if (match2) fileId = match2[1];

                if (fileId) {
                    return `https://drive.google.com/uc?export=download&id=${fileId}`; // Changed to export=download
                }
                return url;
            }

            /**
             * [ê°œì„ ] URL ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
             * - ìŠ¤íŠ¸ë¦¬ë° ë‹¤ìš´ë¡œë“œë¡œ ì „ì²´ ì´ë¯¸ì§€ ìˆ˜ì‹  ë³´ì¥
             * - ì§„í–‰ ìƒí™© í‘œì‹œ
             * - ë¶ˆì™„ì „ ë‹¤ìš´ë¡œë“œ ê°ì§€
             */
            async handleUrlImport() {
                const rawUrl = this.ui.getImportUrl();
                if (!rawUrl) { alert("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

                this.ui.hideUrlImportModal();
                this.ui.setLoading(true, "ì´ë¯¸ì§€ URL ë¶„ì„ ì¤‘...");

                let targetUrl = rawUrl;

                // 1. êµ¬ê¸€ ë“œë¼ì´ë¸Œ/í¬í†  ë“± í˜ì´ì§€ ë§í¬ ì²˜ë¦¬
                if (!rawUrl.match(/\.(jpeg|jpg|png|gif|webp)(\?.*)?$/i)) {
                    try {
                        this.ui.setLoading(true, "ì´ë¯¸ì§€ ë§í¬ ì¶”ì¶œ ì¤‘...");
                        const ogImage = await this.imageService.scrapeOgImage(rawUrl);
                        if (ogImage) {
                            targetUrl = ogImage;
                            console.log("Found OG Image:", targetUrl);
                        }
                    } catch (e) {
                        console.warn("OG Image ì¶”ì¶œ ì‹¤íŒ¨:", e);
                    }
                }

                // Google Drive View Link -> Direct Link ë³€í™˜ ì‹œë„
                targetUrl = this.parseGoogleDriveLink(targetUrl);

                // Google Photos ì¸ë„¤ì¼ â†’ ì›ë³¸ í¬ê¸°ë¡œ ë³€í™˜! (í•µì‹¬!)
                targetUrl = this.imageService.convertToOriginalSize(targetUrl);

                // 2. ì´ë¯¸ì§€ë¥¼ File ê°ì²´ë¡œ ì™„ì „íˆ ë‹¤ìš´ë¡œë“œ
                try {
                    this.ui.setLoading(true, "ì›ë³¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘... (ìµœëŒ€ 60ì´ˆ)");

                    // ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ ì „ì²´ ë°ì´í„° ìˆ˜ì‹ 
                    const file = await this.imageService.downloadAsFile(targetUrl);
                    const originalSizeKB = Math.round(file.size / 1024);

                    // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ í™•ì¸
                    console.log(`ë‹¤ìš´ë¡œë“œ ì™„ë£Œ í™•ì¸: ${file.name}, ${file.size} bytes`);

                    // ê¸°ì¡´ handleFile í•¨ìˆ˜ ì‚¬ìš© (OCR ìµœì í™” í¬í•¨!)
                    this.isSample = false;
                    await this.handleFile(file);

                    // ì„±ê³µ ë©”ì‹œì§€ (OCR ìµœì í™” ì™„ë£Œ í›„)
                    setTimeout(() => {
                        const optimizedSizeKB = Math.round(this.imageBase64.length * 0.75 / 1024);
                        this.ui.addChatMessage('bot', `âœ… **ì´ë¯¸ì§€ ì¤€ë¹„ ì™„ë£Œ!**\n\nğŸ“ ì›ë³¸: ${file.name} (${originalSizeKB}KB)\nğŸ”§ OCR ìµœì í™”: ${optimizedSizeKB}KB\nâœ“ ë©”íƒ€ë°ì´í„° ì œê±°\nâœ“ ëŒ€ë¹„/ì„ ëª…ë„ í–¥ìƒ\nâœ“ í•´ìƒë„ ìµœì í™”\n\n**'ì´ë¯¸ì§€ í…Œì´ë¸”ë¡œ í‘œ ì¶”ì¶œí•˜ê¸°'** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
                    }, 300);

                } catch (error) {
                    this.ui.setLoading(false);
                    console.error("URL Import Error:", error);

                    // ìƒì„¸ ì˜¤ë¥˜ ë©”ì‹œì§€
                    const errorMsg = error.message.includes('ë¶ˆì™„ì „')
                        ? `âš ï¸ ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ë‹¤ìš´ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\n${error.message}\n\në„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë‹¤ìš´ë¡œë“œí•´ì£¼ì„¸ìš”.`
                        : `âš ï¸ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨\n\n${error.message}\n\n[í•´ê²° ë°©ë²•]\n1. ì´ë¯¸ì§€ URLì„ ë¸Œë¼ìš°ì €ì—ì„œ ì—´ì–´ ì§ì ‘ ë‹¤ìš´ë¡œë“œ\n2. ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸ì•¤ë“œë¡­`;

                    alert(errorMsg);
                }
            }

            loadSampleImage() {
                this.imageBase64 = SAMPLE_IMAGE_DATA;
                this.isSample = true;
                this.ui.elements.previewImage.src = this.imageBase64;
                this.ui.elements.previewArea.classList.remove('hidden');
                this.ui.elements.dropZone.classList.add('hidden');
                this.ui.addChatMessage('bot', "ğŸ§ª **ìƒ˜í”Œ ëª¨ë“œ**ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. 'ì´ë¯¸ì§€ í…Œì´ë¸”ë¡œ í‘œ ì¶”ì¶œí•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.");
            }

            // ============================================
            // [NEW] í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ëŠ¥ (Clean Architecture)
            // - Controller(App): ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ + ìƒíƒœ ê´€ë¦¬
            // - View(UIManager): UI í‘œì‹œ/ìˆ¨ê¹€/ì—…ë°ì´íŠ¸
            // - Service(ImageService): ì´ë¯¸ì§€ OCR ìµœì í™”
            // ============================================

            /**
             * í´ë¦½ë³´ë“œ ëª¨ë‹¬ í‘œì‹œ ë° í´ë¦½ë³´ë“œ ì½ê¸°
             */
            async showClipboardModal() {
                // ëª¨ë‹¬ í‘œì‹œ + ë¡œë”© ìƒíƒœ (UIManager ìœ„ì„)
                this.ui.showClipboardModal();
                this.ui.showClipboardLoading();

                // í´ë¦½ë³´ë“œ ì„ì‹œ ì €ì¥ìš© ìƒíƒœ
                this.clipboardImageData = null;
                this.clipboardImageInfo = null;

                // í´ë¦½ë³´ë“œ ì½ê¸°
                await this.readClipboardImage();
            }

            /**
             * í´ë¦½ë³´ë“œ ëª¨ë‹¬ ìˆ¨ê¹€
             */
            hideClipboardModal() {
                this.ui.hideClipboardModal();
                this.clipboardImageData = null;
                this.clipboardImageInfo = null;
            }

            /**
             * í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ ì½ê¸°
             * Clipboard APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
             * 
             * [2024-2025 ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±… ëŒ€ì‘]
             * - HTTPS í•„ìˆ˜ (file:// í”„ë¡œí† ì½œì—ì„œëŠ” ì œí•œì )
             * - ì‚¬ìš©ì ìƒí˜¸ì‘ìš©(í´ë¦­) í•„ìˆ˜
             * - Chrome/Edge: ê¶Œí•œ í”„ë¡¬í”„íŠ¸
             * - Firefox 127+: ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ "ë¶™ì—¬ë„£ê¸°" ì„ íƒ í•„ìš”
             * - Safari 13.1+: ê¶Œí•œ í”„ë¡¬í”„íŠ¸
             */
            async readClipboardImage() {
                try {
                    // [ë³´ì•ˆ ì •ì±…] Secure Context í™•ì¸ (HTTPS ë˜ëŠ” localhost)
                    const isSecureContext = window.isSecureContext;
                    const isLocalFile = window.location.protocol === 'file:';

                    // Clipboard API ì§€ì› í™•ì¸
                    if (!navigator.clipboard || !navigator.clipboard.read) {
                        let errorMsg = 'ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” í´ë¦½ë³´ë“œ ì½ê¸°ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤';

                        // Firefox êµ¬ë²„ì „ ì•ˆë‚´
                        if (navigator.userAgent.includes('Firefox')) {
                            const ffVersion = navigator.userAgent.match(/Firefox\/(\d+)/);
                            if (ffVersion && parseInt(ffVersion[1]) < 127) {
                                errorMsg = 'Firefox 127 ì´ìƒì—ì„œë§Œ í´ë¦½ë³´ë“œ ì½ê¸°ê°€ ì§€ì›ë©ë‹ˆë‹¤.\ní˜„ì¬ ë²„ì „ì„ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.';
                            }
                        }

                        this.ui.showClipboardError(errorMsg);
                        return;
                    }

                    // [ë³´ì•ˆ ì •ì±…] file:// í”„ë¡œí† ì½œì—ì„œëŠ” ì œí•œë  ìˆ˜ ìˆìŒ
                    if (isLocalFile && !isSecureContext) {
                        console.warn('âš ï¸ ë¡œì»¬ íŒŒì¼(file://) í™˜ê²½ì—ì„œ í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }

                    // í´ë¦½ë³´ë“œ ì½ê¸° ê¶Œí•œ ìš”ì²­ ë° ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    // [ì°¸ê³ ] ë¸Œë¼ìš°ì €ê°€ ê¶Œí•œ í”„ë¡¬í”„íŠ¸ë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŒ
                    const clipboardItems = await navigator.clipboard.read();

                    // [2024 ë³´ì•ˆ ì •ì±…] OS í´ë¦½ë³´ë“œëŠ” ì—¬ëŸ¬ ì´ë¯¸ì§€ ë³µì‚¬ ì‹œì—ë„ 
                    // ë‹¨ì¼ í•­ëª©ìœ¼ë¡œ í†µí•©ë˜ê±°ë‚˜ ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë§Œ ì €ì¥ë¨
                    // ë”°ë¼ì„œ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ í•­ëª©ë§Œ ì‚¬ìš©
                    let imageBlob = null;
                    let imageType = null;

                    for (const item of clipboardItems) {
                        // ì´ë¯¸ì§€ íƒ€ì… ì°¾ê¸° (PNG ìš°ì„ , ì—†ìœ¼ë©´ ë‹¤ë¥¸ ì´ë¯¸ì§€ í˜•ì‹)
                        const imageTypes = item.types.filter(t => t.startsWith('image/'));

                        // PNG ìš°ì„  ì„ íƒ (OCRì— ê°€ì¥ ì í•©)
                        const pngType = imageTypes.find(t => t === 'image/png');
                        imageType = pngType || imageTypes[0];

                        if (imageType) {
                            imageBlob = await item.getType(imageType);
                            console.log(`ğŸ“‹ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ í˜•ì‹: ${imageType}`);
                            break;
                        }
                    }

                    if (!imageBlob) {
                        this.ui.showClipboardError('í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }

                    // Blobì„ Base64ë¡œ ë³€í™˜
                    const base64 = await this.blobToBase64(imageBlob);

                    // ì´ë¯¸ì§€ ì •ë³´ ì¶”ì¶œ
                    const imageInfo = await this.getImageInfo(base64, imageBlob.size);

                    // ìƒíƒœ ì €ì¥
                    this.clipboardImageData = base64;
                    this.clipboardImageInfo = imageInfo;

                    // UI ì—…ë°ì´íŠ¸ (UIManager ìœ„ì„)
                    this.ui.updateClipboardPreview(base64, imageInfo);

                    console.log(`ğŸ“‹ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì½ê¸° ì™„ë£Œ: ${imageInfo.width}x${imageInfo.height}, ${Math.round(imageInfo.size / 1024)}KB`);

                } catch (error) {
                    console.error('í´ë¦½ë³´ë“œ ì½ê¸° ì˜¤ë¥˜:', error);

                    // [2024-2025 ë¸Œë¼ìš°ì €ë³„ ìƒì„¸ ì—ëŸ¬ ì²˜ë¦¬]
                    let errorMsg = 'í´ë¦½ë³´ë“œë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';

                    if (error.name === 'NotAllowedError') {
                        // ê¶Œí•œ ê±°ë¶€
                        if (navigator.userAgent.includes('Firefox')) {
                            // FirefoxëŠ” ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ì—ì„œ "ë¶™ì—¬ë„£ê¸°" ì„ íƒ í•„ìš”
                            errorMsg = 'í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nFirefoxì—ì„œëŠ” ê¶Œí•œ í”„ë¡¬í”„íŠ¸ê°€ í‘œì‹œë  ë•Œ\n"ë¶™ì—¬ë„£ê¸°"ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                        } else {
                            errorMsg = 'í´ë¦½ë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì˜† ğŸ”’ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬\ní´ë¦½ë³´ë“œ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
                        }
                    } else if (error.name === 'SecurityError') {
                        // ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì˜¤ë¥˜ (file://, http://)
                        const isLocalFile = window.location.protocol === 'file:';
                        if (isLocalFile) {
                            errorMsg = 'ë¡œì»¬ íŒŒì¼ì—ì„œëŠ” í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì œí•œë©ë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ë¡œì»¬ ì›¹ì„œë²„ë¡œ ì‹¤í–‰ (Live Server ë“±)\n2. ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë“œë˜ê·¸ì•¤ë“œë¡­';
                        } else {
                            errorMsg = 'HTTPS í™˜ê²½ì—ì„œë§Œ í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                        }
                    } else if (error.name === 'DataError') {
                        // í´ë¦½ë³´ë“œ ë°ì´í„° í˜•ì‹ ì˜¤ë¥˜
                        errorMsg = 'í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nìŠ¤í¬ë¦°ìƒ·(Win+Shift+S)ì„ ìº¡ì²˜í•˜ê±°ë‚˜\nì´ë¯¸ì§€ë¥¼ ë³µì‚¬í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    }

                    this.ui.showClipboardError(errorMsg);
                }
            }

            /**
             * í´ë¦½ë³´ë“œ ìƒˆë¡œê³ ì¹¨ (ë‹¤ì‹œ ì½ê¸°)
             */
            async refreshClipboard() {
                this.ui.showClipboardLoading();
                await this.readClipboardImage();
            }

            /**
             * í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ (OCR ìµœì í™” í›„)
             */
            async uploadFromClipboard() {
                if (!this.clipboardImageData) {
                    alert('ì—…ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // [ë””ë²„ê·¸] í´ë¦½ë³´ë“œ ë°ì´í„° í™•ì¸
                console.log('ğŸ“‹ í´ë¦½ë³´ë“œ ì—…ë¡œë“œ ì‹œì‘');
                console.log('ğŸ“‹ ë°ì´í„° íƒ€ì…:', typeof this.clipboardImageData);
                console.log('ğŸ“‹ ë°ì´í„° ì‹œì‘ë¶€ë¶„:', this.clipboardImageData.substring(0, 50));

                // ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
                if (!this.clipboardImageData.startsWith('data:image/')) {
                    console.error('âŒ ì˜ëª»ëœ ì´ë¯¸ì§€ ë°ì´í„° í˜•ì‹:', this.clipboardImageData.substring(0, 30));
                    alert('í´ë¦½ë³´ë“œ ë°ì´í„°ê°€ ì˜¬ë°”ë¥¸ ì´ë¯¸ì§€ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    return;
                }

                // [FIX] ë°ì´í„°ë¥¼ ë¡œì»¬ ë³€ìˆ˜ì— ë³µì‚¬ (hideClipboardModalì—ì„œ null ì²˜ë¦¬ë˜ê¸° ì „ì—)
                const imageDataToProcess = this.clipboardImageData;
                const imageInfoForMessage = this.clipboardImageInfo;

                // ëª¨ë‹¬ ë‹«ê¸° (ì´ ì‹œì ì—ì„œ this.clipboardImageDataê°€ nullì´ ë¨)
                this.hideClipboardModal();

                // OCR ìµœì í™” ì ìš©
                this.ui.setLoading(true, "í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ OCR ìµœì í™” ì¤‘...");
                this.isSample = false;

                try {
                    // [FIX] ë¡œì»¬ ë³€ìˆ˜ ì‚¬ìš© (this.clipboardImageData ëŒ€ì‹ )
                    console.log('ğŸ“‹ OCR ìµœì í™” ì‹œì‘...');
                    this.imageBase64 = await this.imageService.optimizeForOCR(imageDataToProcess);
                    console.log('ğŸ“‹ OCR ìµœì í™” ì™„ë£Œ, ê²°ê³¼ ê¸¸ì´:', this.imageBase64?.length);

                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ (UIManagerì˜ elements ì‚¬ìš©)
                    this.ui.elements.previewImage.src = this.imageBase64;
                    this.ui.elements.previewArea.classList.remove('hidden');
                    this.ui.elements.dropZone.classList.add('hidden');

                    this.ui.setLoading(false);

                    // [FIX] ë¡œì»¬ ë³€ìˆ˜ ì‚¬ìš© (ì„±ê³µ ë©”ì‹œì§€ìš©)
                    const originalKB = imageInfoForMessage ? Math.round(imageInfoForMessage.size / 1024) : '?';
                    const optimizedKB = Math.round(this.imageBase64.length * 0.75 / 1024);
                    const dimensions = imageInfoForMessage ? `${imageInfoForMessage.width}Ã—${imageInfoForMessage.height}` : '?Ã—?';

                    this.ui.addChatMessage('bot', `ğŸ“‹ **í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!**\n\nğŸ“ ì›ë³¸ í¬ê¸°: ${dimensions}px\nğŸ“¦ ì›ë³¸ ìš©ëŸ‰: ${originalKB}KB\nğŸ”§ ìµœì í™” í›„: ${optimizedKB}KB\n\nâœ“ ë©”íƒ€ë°ì´í„° ì œê±°\nâœ“ ëŒ€ë¹„/ì„ ëª…ë„ í–¥ìƒ\nâœ“ OCR ìµœì í™” ì™„ë£Œ\n\n**'ì´ë¯¸ì§€ í…Œì´ë¸”ë¡œ í‘œ ì¶”ì¶œí•˜ê¸°'** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);


                    console.log('ğŸ“‹ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° OCR ìµœì í™” ì™„ë£Œ');

                } catch (error) {
                    console.error('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ìµœì í™” ì˜¤ë¥˜:', error);

                    // [FIX] ìµœì í™” ì‹¤íŒ¨ ì‹œ ì›ë³¸ ì‚¬ìš© (ë¡œì»¬ ë³€ìˆ˜ ì‚¬ìš©)
                    this.imageBase64 = imageDataToProcess;
                    this.ui.elements.previewImage.src = this.imageBase64;
                    this.ui.elements.previewArea.classList.remove('hidden');
                    this.ui.elements.dropZone.classList.add('hidden');
                    this.ui.setLoading(false);

                    this.ui.addChatMessage('bot', `ğŸ“‹ **í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!**\n\nâš ï¸ OCR ìµœì í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì—¬ ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.\n\n**'ì´ë¯¸ì§€ í…Œì´ë¸”ë¡œ í‘œ ì¶”ì¶œí•˜ê¸°'** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`);
                }
                // [NOTE] ì„ì‹œ ë°ì´í„° í´ë¦¬ì–´ëŠ” hideClipboardModal()ì—ì„œ ì´ë¯¸ ì²˜ë¦¬ë¨
            }

            /**
             * Blobì„ Base64 ë¬¸ìì—´ë¡œ ë³€í™˜
             * @param {Blob} blob - ë³€í™˜í•  Blob
             * @returns {Promise<string>} Base64 data URL
             */
            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            /**
             * ì´ë¯¸ì§€ ì •ë³´ ì¶”ì¶œ (width, height, size)
             * @param {string} base64 - Base64 ì´ë¯¸ì§€ ë°ì´í„°
             * @param {number} size - íŒŒì¼ í¬ê¸° (bytes)
             * @returns {Promise<Object>} {width, height, size}
             */
            getImageInfo(base64, size) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        resolve({
                            width: img.naturalWidth,
                            height: img.naturalHeight,
                            size: size || base64.length * 0.75 // Base64ëŠ” ì•½ 4/3 í¬ê¸°
                        });
                    };
                    img.onerror = () => {
                        resolve({ width: 0, height: 0, size: size || 0 });
                    };
                    img.src = base64;
                });
            }

            // Google Photos Handlers
            async handleGooglePhotosLogin() {
                const creds = this.ui.getGooglePhotosCredentials();
                if (!creds.id || !creds.pw) { alert("IDì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

                this.ui.hideGooglePhotosModal();
                this.ui.setLoading(true, "Google Photos ì—°ê²° ì¤‘...");

                setTimeout(() => {
                    this.ui.setLoading(false);
                    this.ui.showGooglePhotosGallery(creds.id, MOCK_GALLERY_IMAGES);
                }, 1000);
            }

            async selectGalleryPhoto(url) {
                this.ui.hideGooglePhotosGallery();
                this.ui.setLoading(true, "ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ë° ì—…ë¡œë“œ ì¤‘...");

                // Convert selected URL to Base64 for app compatibility
                this.imageBase64 = await this.urlToBase64(url);
                this.isSample = true;

                const img = this.ui.elements.previewImage;
                img.src = this.imageBase64;

                this.ui.elements.previewArea.classList.remove('hidden');
                this.ui.elements.dropZone.classList.add('hidden');

                this.ui.setLoading(false);
                this.ui.addChatMessage('bot', "ğŸ“¸ **ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!**\nêµ¬ê¸€ í¬í† ì—ì„œ ì„ íƒí•œ ì´ë¯¸ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }

            // [Helper] Convert URL to Base64 (CORS aware)
            async urlToBase64(url) {
                if (url.startsWith('data:')) return url;
                try {
                    return await this.imageService.fetchImage(url);
                } catch (error) {
                    console.error("Image fetch failed", error);
                    return url; // Fallback
                }
            }

            /**
             * [ê°œì„ ] í˜„ì¬ ì„ íƒëœ API Key ë°˜í™˜ (Clean Architecture ë¦¬íŒ©í† ë§)
             * - UIManagerë¥¼ í†µí•´ UI ì¡°ì‘
             * - App ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ì‚¬ìš©
             */
            getApiKey() {
                // [ê°œì„ ] UIManagerë¥¼ í†µí•´ ê°’ ì¡°íšŒ
                let key = this.ui.getApiKeyValue();

                // Keyê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ (1ë²ˆ Key) ì‚¬ìš©
                if (!key) {
                    key = CONFIG.API_KEYS[0]; // 1ë²ˆ Key
                    this.currentKeyIndex = 0;
                    // [ê°œì„ ] UIManagerë¥¼ í†µí•´ UI ì—…ë°ì´íŠ¸
                    this.ui.updateApiKeyUI(0, key);
                }

                if (!key) {
                    alert('API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.\nì˜¤ë¥¸ìª½ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ 1ë²ˆ/2ë²ˆ/3ë²ˆ Keyë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return null;
                }

                // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ Key ì •ë³´ ë¡œê·¸
                const keyIndex = CONFIG.API_KEYS.indexOf(key);
                if (keyIndex >= 0) {
                    console.log(`ğŸ”‘ API Key ì‚¬ìš©: ${keyIndex + 1}ë²ˆ (${key.substring(0, 10)}...${key.slice(-4)})`);
                } else {
                    console.log(`ğŸ”‘ API Key ì‚¬ìš©: ì§ì ‘ì…ë ¥ (${key.substring(0, 10)}...${key.slice(-4)})`);
                }

                return key;
            }

            /**
             * [NEW] API Key ë³€ê²½ (ë‹¤ìŒ Keyë¡œ ìˆœí™˜) (Clean Architecture ë¦¬íŒ©í† ë§)
             * API ì—ëŸ¬ ë°œìƒ ì‹œ í˜¸ì¶œí•˜ì—¬ ë‹¤ìŒ Keyë¡œ ìë™ ë³€ê²½
             * - UIManagerë¥¼ í†µí•´ UI ì¡°ì‘
             * - App ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ì‚¬ìš©
             */
            switchToNextApiKey() {
                // [ê°œì„ ] ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ ì‚¬ìš©
                const currentIndex = this.currentKeyIndex;
                let nextIndex = (currentIndex + 1) % CONFIG.API_KEYS.length;

                // ì§ì ‘ ì…ë ¥ ëª¨ë“œ(-1)ì¸ ê²½ìš° 0ë²ˆ(1ë²ˆ Key)ë¶€í„° ì‹œì‘
                if (currentIndex < 0) nextIndex = 0;

                // [ê°œì„ ] ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
                this.currentKeyIndex = nextIndex;
                const newKey = CONFIG.API_KEYS[nextIndex];

                // [ê°œì„ ] UIManagerë¥¼ í†µí•´ UI ì—…ë°ì´íŠ¸
                this.ui.updateApiKeyUI(nextIndex, newKey);

                console.log(`ğŸ”„ API Key ë³€ê²½: ${nextIndex + 1}ë²ˆìœ¼ë¡œ ì „í™˜`);
                return newKey;
            }

            // [í•µì‹¬] ì´ë¯¸ì§€ì—ì„œ í…Œì´ë¸” ì¶”ì¶œ - í”„ë¡¬í”„íŠ¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
            async runVision() {
                const key = this.getApiKey();
                if (!key) return;

                if (!this.imageBase64) {
                    alert('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                    return;
                }

                // ìƒ˜í”Œ ëª¨ë“œë©´ ë°”ë¡œ ì‹¤í–‰ (í”„ë¡¬í”„íŠ¸ ë¶ˆí•„ìš”)
                if (this.isSample) {
                    await this.executeOcrWithPrompt('');
                    return;
                }

                // OCR í”„ë¡¬í”„íŠ¸ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
                this.ui.showOcrPromptModal();
            }

            // [NEW] ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ë¥¼ ë°›ì•„ OCR ì‹¤í–‰
            async executeOcrWithPrompt(customPrompt = null) {
                // ëª¨ë‹¬ì—ì„œ í˜¸ì¶œëœ ê²½ìš° í”„ë¡¬í”„íŠ¸ ê°€ì ¸ì˜¤ê¸°
                const userPrompt = customPrompt !== null ? customPrompt : this.ui.getOcrPrompt();

                // ë””ë²„ê¹…: í”„ë¡¬í”„íŠ¸ ê°’ í™•ì¸
                console.log('=== executeOcrWithPrompt í˜¸ì¶œ ===');
                console.log('customPrompt íŒŒë¼ë¯¸í„°:', customPrompt);
                console.log('ui.getOcrPrompt() ê²°ê³¼:', this.ui.getOcrPrompt());
                console.log('ìµœì¢… userPrompt:', userPrompt);

                // ëª¨ë‹¬ ë‹«ê¸°
                this.ui.hideOcrPromptModal();

                const key = this.getApiKey();
                if (!key) return;

                this.ui.setLoading(true, "ì´ë¯¸ì§€ì—ì„œ í‘œ ì¶”ì¶œ ì¤‘...");

                try {
                    // ìƒ˜í”Œ ëª¨ë“œë©´ MOCK ë°ì´í„° ì‚¬ìš©
                    if (this.isSample) {
                        this.currentData = CONFIG.MOCK_DATA;
                    } else {
                        // ì‹¤ì œ Gemini Vision API í˜¸ì¶œ (ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í¬í•¨)
                        this.currentData = await this.gemini.extractTable(key, this.imageBase64, userPrompt);
                    }

                    // ê²°ê³¼ ê²€ì¦
                    if (!this.currentData || !this.currentData.headers || !this.currentData.rows) {
                        throw new Error("í…Œì´ë¸” ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ì— ëª…í™•í•œ í‘œê°€ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }

                    // í…Œì´ë¸” ë Œë”ë§
                    this.ui.renderTable(this.currentData, (row) => this.ui.toggleRowHighlight(row));

                    // ì±„íŒ… ë° ë¦¬í¬íŠ¸ ë²„íŠ¼ í™œì„±í™”
                    document.getElementById('chatInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('reportBtn').disabled = false;

                    // í”„ë¡¬í”„íŠ¸ ì ìš© ì—¬ë¶€ì— ë”°ë¥¸ ë©”ì‹œì§€
                    const promptMsg = userPrompt ? `\nğŸ“ **ì ìš©ëœ ìš”ì²­:** ${userPrompt.substring(0, 50)}${userPrompt.length > 50 ? '...' : ''}` : '';
                    this.ui.addChatMessage('bot', `âœ… **í‘œ ì¶”ì¶œ ì™„ë£Œ!**\n${this.currentData.rows.length}ê°œì˜ í–‰ê³¼ ${this.currentData.headers.length}ê°œì˜ ì—´ì´ ì¶”ì¶œë˜ì—ˆìŠµë‹ˆë‹¤.${promptMsg}\n\nì´ì œ ì§ˆë¬¸í•˜ê±°ë‚˜ ì—‘ì…€ë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);

                } catch (error) {
                    console.error("Vision API Error:", error);
                    this.ui.addChatMessage('bot', `âŒ **ì¶”ì¶œ ì˜¤ë¥˜:** ${error.message}`);
                } finally {
                    this.ui.setLoading(false);
                }
            }

            // [í•µì‹¬] AI ìë™ ë¶„ë¥˜ ê¸°ëŠ¥
            async runAutoCategorization() {
                const key = this.getApiKey();
                if (!key) return;

                if (!this.currentData || !this.currentData.rows || this.currentData.rows.length === 0) {
                    alert('ë¨¼ì € í‘œë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.');
                    return;
                }

                this.ui.setLoading(true, "AI ìë™ ë¶„ë¥˜ ì¤‘...");

                try {
                    const items = this.currentData.rows.map(row => row[0]); // ì²« ë²ˆì§¸ ì»¬ëŸ¼ ê¸°ì¤€ ë¶„ë¥˜
                    const categories = await this.gemini.categorizeItems(key, items);

                    // ë¶„ë¥˜ ê²°ê³¼ ì ìš© - headersì— 'ë¶„ë¥˜' ì»¬ëŸ¼ ì¶”ê°€
                    if (!this.currentData.headers.includes('ë¶„ë¥˜')) {
                        this.currentData.headers.push('ë¶„ë¥˜');
                    }

                    // ê° í–‰ì— ë¶„ë¥˜ ì¶”ê°€
                    this.currentData.rows.forEach((row, idx) => {
                        const category = categories[idx] || 'ë¯¸ë¶„ë¥˜';
                        const categoryText = typeof category === 'object' ? (category.category || category.label || 'ë¯¸ë¶„ë¥˜') : category;
                        // ì´ë¯¸ ë¶„ë¥˜ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
                        if (row.length < this.currentData.headers.length) {
                            row.push(categoryText);
                        } else {
                            row[this.currentData.headers.length - 1] = categoryText;
                        }
                    });

                    // í…Œì´ë¸” ë‹¤ì‹œ ë Œë”ë§
                    this.ui.renderTable(this.currentData, (row) => this.ui.toggleRowHighlight(row));

                    this.ui.addChatMessage('bot', 'âœ¨ **ìë™ ë¶„ë¥˜ ì™„ë£Œ!**\nê° í•­ëª©ì— AIê°€ ë¶„ë¥˜ë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤.');

                } catch (error) {
                    console.error("Categorization Error:", error);
                    this.ui.addChatMessage('bot', `âŒ **ë¶„ë¥˜ ì˜¤ë¥˜:** ${error.message}`);
                } finally {
                    this.ui.setLoading(false);
                }
            }

            toggleComparisonMode() {
                const overlay = document.getElementById('comparisonOverlay');
                const tableWrapper = document.getElementById('tableWrapper');
                const originalContainer = document.getElementById('resultContainer');
                const compareTableContainer = document.getElementById('compareTableContainer');
                const compareImage = document.getElementById('compareImage');
                const zoomRange = document.getElementById('zoomRange');

                if (overlay.classList.contains('hidden')) {
                    overlay.classList.remove('hidden');
                    compareTableContainer.appendChild(tableWrapper);

                    if (this.imageBase64) {
                        compareImage.src = this.imageBase64;
                        const initImage = () => {
                            this.naturalWidth = compareImage.naturalWidth;
                            this.naturalHeight = compareImage.naturalHeight;
                            this.isZoomFit = false;
                            this.setZoom(100);
                            this.initDrawing();
                            this.ui.updateZoomUI(100, false);
                        };
                        if (compareImage.complete) initImage();
                        else compareImage.onload = initImage;
                    }
                    document.body.style.overflow = 'hidden';
                } else {
                    overlay.classList.add('hidden');
                    originalContainer.appendChild(tableWrapper);
                    document.body.style.overflow = '';
                }
            }

            swapSides() {
                const container = document.getElementById('splitViewContainer');
                const imageContainer = document.getElementById('compareImageContainer');

                if (container.classList.contains('flex-row-reverse')) {
                    container.classList.remove('flex-row-reverse');
                    imageContainer.classList.remove('justify-end');
                    imageContainer.classList.add('justify-start');
                } else {
                    container.classList.add('flex-row-reverse');
                    imageContainer.classList.remove('justify-start');
                    imageContainer.classList.add('justify-end');
                }
            }

            adjustZoom(delta) {
                const range = document.getElementById('zoomRange');
                let newVal = parseInt(range.value) + delta;
                newVal = Math.round(newVal / 10) * 10;
                newVal = Math.max(CONFIG.ZOOM.MIN, Math.min(CONFIG.ZOOM.MAX, newVal));
                range.value = newVal;
                this.isZoomFit = false;
                this.setZoom(newVal);
                this.ui.updateZoomUI(newVal, false);
            }

            zoomToFitTableHeight() {
                const table = document.querySelector('#tableWrapper table');

                if (!table || this.naturalHeight === 0) return;

                if (this.isZoomFit) {
                    this.isZoomFit = false;
                    this.setZoom(100);
                    this.ui.updateZoomUI(100, false);
                } else {
                    const targetHeight = table.scrollHeight + 50;
                    const scale = targetHeight / this.naturalHeight;
                    let percent = Math.round(scale * 100);
                    percent = Math.max(CONFIG.ZOOM.MIN, Math.min(CONFIG.ZOOM.MAX, percent));

                    this.isZoomFit = true;
                    this.setZoom(percent);
                    this.ui.updateZoomUI(percent, true);

                    const container = document.getElementById('compareImageContainer');
                    container.scrollTop = 0;
                    container.scrollLeft = 0;
                }
            }

            setZoom(percent) {
                const wrapper = document.getElementById('imageWrapper');
                const canvas = document.getElementById('drawingCanvas');

                if (wrapper && this.naturalWidth > 0) {
                    const scale = percent / 100;
                    const newWidth = Math.round(this.naturalWidth * scale);
                    const newHeight = Math.round(this.naturalHeight * scale);

                    wrapper.style.width = `${newWidth}px`;
                    wrapper.style.height = `${newHeight}px`;

                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    this.redraw();
                }
            }

            // --- Drawing Logic (ìˆ˜í‰/ìˆ˜ì§ ì§ì„ ) ---
            redraw() {
                const canvas = document.getElementById('drawingCanvas');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // ì €ì¥ëœ ì§ì„ ë“¤ ê·¸ë¦¬ê¸°
                this.drawingHistory.forEach(line => {
                    if (!line.start || !line.end) return;
                    this.drawLine(ctx, line.start, line.end, "rgba(255, 0, 0, 0.8)", 3);
                });
            }

            // ì§ì„  ê·¸ë¦¬ê¸° í—¬í¼
            drawLine(ctx, start, end, color, width) {
                const canvas = ctx.canvas;
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = width;
                ctx.lineCap = "round";
                ctx.moveTo(start.x * canvas.width, start.y * canvas.height);
                ctx.lineTo(end.x * canvas.width, end.y * canvas.height);
                ctx.stroke();
            }

            // ìˆ˜í‰/ìˆ˜ì§ìœ¼ë¡œ ìŠ¤ëƒ… (ê°€ì¥ ê°€ê¹Œìš´ ë°©í–¥ìœ¼ë¡œ)
            snapToAxis(start, end) {
                const dx = Math.abs(end.x - start.x);
                const dy = Math.abs(end.y - start.y);

                // ìˆ˜í‰ ë˜ëŠ” ìˆ˜ì§ ì¤‘ ë” í° ë°©í–¥ìœ¼ë¡œ ìŠ¤ëƒ…
                if (dx > dy) {
                    // ìˆ˜í‰ì„  (Y ê³ ì •)
                    return { x: end.x, y: start.y };
                } else {
                    // ìˆ˜ì§ì„  (X ê³ ì •)
                    return { x: start.x, y: end.y };
                }
            }

            clearDrawing() { this.drawingHistory = []; this.redraw(); }

            initDrawing() {
                const canvas = document.getElementById('drawingCanvas');
                const self = this;

                const getCoords = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: (clientX - rect.left) / rect.width, y: (clientY - rect.top) / rect.height };
                };

                // ì‹œì‘ì  ì €ì¥
                const start = (e) => {
                    if (e.button !== 0 && !e.touches) return;
                    e.preventDefault();
                    self.isDrawing = true;
                    self.lineStart = getCoords(e);
                    self.lineEnd = null;
                };

                // ë“œë˜ê·¸: ë¯¸ë¦¬ë³´ê¸° ì§ì„  í‘œì‹œ
                const move = (e) => {
                    if (!self.isDrawing || !self.lineStart) return;
                    e.preventDefault();

                    const currentPos = getCoords(e);
                    // ìˆ˜í‰/ìˆ˜ì§ìœ¼ë¡œ ìŠ¤ëƒ…
                    self.lineEnd = self.snapToAxis(self.lineStart, currentPos);

                    // ê¸°ì¡´ ì§ì„ ë“¤ + í˜„ì¬ ê·¸ë¦¬ëŠ” ì§ì„  ë¯¸ë¦¬ë³´ê¸°
                    self.redraw();
                    const ctx = canvas.getContext('2d');
                    // ë¯¸ë¦¬ë³´ê¸° ì§ì„  (ì ì„ )
                    ctx.setLineDash([5, 5]);
                    self.drawLine(ctx, self.lineStart, self.lineEnd, "rgba(255, 0, 0, 0.6)", 2);
                    ctx.setLineDash([]);

                    // ì‹œì‘ì  í‘œì‹œ (ì‘ì€ ì›)
                    ctx.beginPath();
                    ctx.fillStyle = "rgba(255, 0, 0, 0.8)";
                    ctx.arc(self.lineStart.x * canvas.width, self.lineStart.y * canvas.height, 4, 0, Math.PI * 2);
                    ctx.fill();

                    // ëì  í‘œì‹œ (ì‘ì€ ì›)
                    ctx.beginPath();
                    ctx.fillStyle = "rgba(255, 0, 0, 0.8)";
                    ctx.arc(self.lineEnd.x * canvas.width, self.lineEnd.y * canvas.height, 4, 0, Math.PI * 2);
                    ctx.fill();
                };

                // ë§ˆìš°ìŠ¤ ë†“ê¸°: ì§ì„  í™•ì •
                const end = (e) => {
                    if (!self.isDrawing) return;

                    if (self.lineStart && self.lineEnd) {
                        // ìµœì†Œ ê±°ë¦¬ ì²´í¬ (ë„ˆë¬´ ì§§ì€ ì„  ë¬´ì‹œ)
                        const dx = Math.abs(self.lineEnd.x - self.lineStart.x);
                        const dy = Math.abs(self.lineEnd.y - self.lineStart.y);
                        if (dx > 0.01 || dy > 0.01) {
                            // ì§ì„  ì €ì¥
                            self.drawingHistory.push({
                                start: { ...self.lineStart },
                                end: { ...self.lineEnd }
                            });
                        }
                    }

                    self.isDrawing = false;
                    self.lineStart = null;
                    self.lineEnd = null;
                    self.redraw();
                };

                canvas.onmousedown = start;
                canvas.onmousemove = move;
                canvas.onmouseup = end;
                canvas.onmouseleave = end;
                canvas.ontouchstart = start;
                canvas.ontouchmove = move;
                canvas.ontouchend = end;
            }

            // --- Chat & Export ---
            async handleChat(query) {
                const key = this.getApiKey();
                if (!key || !this.currentData) return;
                document.getElementById('chatInput').value = '';
                this.ui.addChatMessage('user', query);
                const tempId = 'thinking-' + Date.now();
                document.getElementById('chatContainer').insertAdjacentHTML('beforeend', `<div id="${tempId}" class="flex gap-3"><div class="ml-11 text-xs text-gray-400 animate-pulse">AIê°€ ë¶„ì„ ì¤‘...</div></div>`);
                try {
                    const answer = await this.gemini.askData(key, this.currentData, query);
                    document.getElementById(tempId).remove();
                    this.ui.addChatMessage('bot', answer);
                } catch (e) {
                    document.getElementById(tempId).remove();
                    this.ui.addChatMessage('bot', `âŒ ì˜¤ë¥˜: ${e.message}`);
                }
            }

            async generateReport() {
                this.handleChat("ì´ í‘œ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ 'ìš”ì•½ ë³´ê³ ì„œ'ë¥¼ ì‘ì„±í•´ì¤˜. ì£¼ìš” í•­ëª©, ë¹„ìš© ë¶„ì„, íŠ¹ì´ì‚¬í•­ì„ í¬í•¨í•´ì„œ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ê¹”ë”í•˜ê²Œ ì •ë¦¬í•´.");
            }

            exportToExcel() {
                if (!this.currentData) return;

                // DOM í…Œì´ë¸”ì—ì„œ í˜„ì¬ í¸ì§‘ëœ ê°’ì„ ì§ì ‘ ì½ì–´ì˜´ (ìˆ˜ì •ëœ ê°’ ë°˜ì˜)
                const tableHead = document.getElementById('tableHead');
                const tableBody = document.getElementById('tableBody');

                // í—¤ë” ì¶”ì¶œ (DOMì—ì„œ ì§ì ‘)
                const headers = [];
                const headerCells = tableHead.querySelectorAll('th');
                headerCells.forEach(th => {
                    // resize-handle div ì œì™¸í•˜ê³  í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                    const text = th.childNodes[0]?.textContent?.trim() || th.textContent.trim();
                    headers.push(text);
                });

                // í–‰ ë°ì´í„° ì¶”ì¶œ (DOMì—ì„œ ì§ì ‘ - í¸ì§‘ëœ ê°’ í¬í•¨)
                const rows = [];
                const tableRows = tableBody.querySelectorAll('tr');
                tableRows.forEach(tr => {
                    const rowData = [];
                    const cells = tr.querySelectorAll('td');
                    cells.forEach(td => {
                        // contenteditableë¡œ í¸ì§‘ëœ í˜„ì¬ ê°’ì„ ì½ì–´ì˜´
                        rowData.push(td.textContent.trim());
                    });
                    if (rowData.length > 0) {
                        rows.push(rowData);
                    }
                });

                // í¸ì§‘ëœ ê°’ìœ¼ë¡œ currentDataë„ ì—…ë°ì´íŠ¸ (ë™ê¸°í™”)
                if (headers.length > 0) {
                    this.currentData.headers = headers;
                }
                if (rows.length > 0) {
                    this.currentData.rows = rows;
                }

                const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, "OCR_Result.xlsx");
            }
        }

        // DOM ì™„ì „ ë¡œë“œ í›„ App ì´ˆê¸°í™”
        let app;
        document.addEventListener('DOMContentLoaded', function () {
            try {
                console.log('DOM ë¡œë“œ ì™„ë£Œ, App ì´ˆê¸°í™” ì‹œì‘...');
                app = new App();
                window.app = app;
                console.log('App ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('App ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        });

        // ì¦‰ì‹œ ì‹¤í–‰ (fallback - DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°)
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(function () {
                if (!app) {
                    try {
                        console.log('Fallback: App ì´ˆê¸°í™” ì‹œì‘...');
                        app = new App();
                        window.app = app;
                        console.log('Fallback: App ì´ˆê¸°í™” ì™„ë£Œ');
                    } catch (error) {
                        console.error('Fallback App ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                    }
                }
            }, 100);
        }
    </script>
</body>

</html>