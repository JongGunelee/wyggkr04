<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì£¼ê°„ íšŒì˜ë¡ ë‚´ìš© í•©ì¹˜ê¸° ë„êµ¬</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #eef2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            color: #1a3b5d;
            margin-bottom: 10px;
        }

        p.description {
            color: #5a7184;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .step-wrapper {
            margin-bottom: 25px;
            position: relative; /* íˆ´íŒ ê¸°ì¤€ì  */
        }

        .drop-area {
            border: 2px dashed #c1d9e9;
            border-radius: 8px;
            padding: 30px;
            transition: background-color 0.3s, border-color 0.3s;
            cursor: pointer;
        }

        .drop-area.drag-over {
            background-color: #f0f8ff;
            border-color: #007bff;
        }

        .drop-area.file-loaded {
            border-style: solid;
            border-color: #28a745;
            background-color: #f2fff5;
        }

        .drop-area-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .drop-area-icon {
            font-size: 32px;
            color: #007bff;
        }

        .drop-area.file-loaded .drop-area-icon {
            color: #28a745;
        }

        .drop-area-text {
            font-weight: 500;
            color: #1a3b5d;
        }

        .file-name {
            font-weight: 700;
            color: #17a2b8;
            margin-top: 5px;
        }

        input[type="file"] {
            display: none;
        }

        #mergeBtn {
            width: 100%;
            background-image: linear-gradient(to right, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative; /* íˆ´íŒ ê¸°ì¤€ì  */
        }

        #mergeBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        #mergeBtn:disabled {
            background-image: none;
            background-color: #b0c4de;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #status {
            margin-top: 20px;
            font-weight: 500;
            min-height: 24px;
        }
        #status.success { color: #28a745; }
        #status.error { color: #dc3545; }
        #status.processing { color: #007bff; }

        .tooltip {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 115%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .step-wrapper:hover .tooltip, #mergeBtn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>íšŒì˜ë¡ í•©ì¹˜ê¸° ë„êµ¬ âœ¨</h1>
        <p class="description">
            ì´ì „ ì£¼ì˜ 'ê¸ˆì£¼' ë‚´ìš©ì„ ìƒˆë¡œìš´ ì–‘ì‹ì˜ 'ì „ì£¼' ì¹¸ìœ¼ë¡œ ê°„í¸í•˜ê²Œ ì˜®ê²¨ë³´ì„¸ìš”.<br>
            íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜, ì•„ë˜ ì˜ì—­ìœ¼ë¡œ íŒŒì¼ì„ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”.
        </p>

        <div class="step-wrapper" id="source-wrapper">
            <div class="tooltip"><b>[ë‚´ìš© ê°€ì ¸ì˜¬ íŒŒì¼]</b><br>ì§€ë‚œ ì£¼ì— ì‘ì—…í•˜ê³  "HTMLë¡œ ì €ì¥"í•œ íšŒì˜ë¡ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”. ì´ íŒŒì¼ì˜ 'ê¸ˆì£¼' ì»¬ëŸ¼ ë‚´ìš©ì´ ë³µì‚¬ë©ë‹ˆë‹¤.</div>
            <div class="drop-area" id="sourceDropArea">
                <input type="file" id="sourceFile" accept=".html">
                <div class="drop-area-content">
                    <div class="drop-area-icon" id="sourceIcon">ğŸ“‚</div>
                    <div class="drop-area-text"><b>1ë‹¨ê³„:</b> ì§€ë‚œ ì£¼ íŒŒì¼ ì„ íƒ</div>
                    <div class="file-name" id="sourceFileName"></div>
                </div>
            </div>
        </div>

        <div class="step-wrapper" id="target-wrapper">
            <div class="tooltip"><b>[ë‚´ìš© ë¶™ì—¬ë„£ì„ íŒŒì¼]</b><br>ì´ë²ˆ ì£¼ì— ìƒˆë¡œ ì‘ì—…í•  ì›ë³¸(í…œí”Œë¦¿) íšŒì˜ë¡ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”. ì´ íŒŒì¼ì˜ ë¹„ì–´ìˆëŠ” 'ì „ì£¼' ì»¬ëŸ¼ì´ ì±„ì›Œì§‘ë‹ˆë‹¤.</div>
            <div class="drop-area" id="targetDropArea">
                <input type="file" id="targetFile" accept=".html">
                <div class="drop-area-content">
                    <div class="drop-area-icon" id="targetIcon">ğŸ“„</div>
                    <div class="drop-area-text"><b>2ë‹¨ê³„:</b> ì–‘ì‹ íŒŒì¼ ì„ íƒ</div>
                    <div class="file-name" id="targetFileName"></div>
                </div>
            </div>
        </div>

        <div style="position: relative;">
            <div class="tooltip">ë‘ ê°œì˜ íŒŒì¼ì´ ëª¨ë‘ ì„ íƒë˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤. í´ë¦­ ì‹œ ì‚¬ìš©ìê°€ ì§€ì •í•œ ìœ„ì¹˜ì— ë‘ íŒŒì¼ì˜ ë‚´ìš©ì´ í•©ì³ì§„ ìƒˆë¡œìš´ íŒŒì¼ì´ ì €ì¥ë©ë‹ˆë‹¤.</div>
            <button id="mergeBtn" disabled>ğŸš€ ë‚´ìš© í•©ì¹˜ê¸° ë° ì €ì¥</button>
        </div>
        <div id="status"></div>
    </div>

    <script>
        const sourceFileInput = document.getElementById('sourceFile');
        const targetFileInput = document.getElementById('targetFile');
        const sourceDropArea = document.getElementById('sourceDropArea');
        const targetDropArea = document.getElementById('targetDropArea');
        const mergeBtn = document.getElementById('mergeBtn');
        const statusDiv = document.getElementById('status');
        const sourceFileNameSpan = document.getElementById('sourceFileName');
        const targetFileNameSpan = document.getElementById('targetFileName');
        const sourceIcon = document.getElementById('sourceIcon');
        const targetIcon = document.getElementById('targetIcon');

        let sourceFile = null;
        let targetFile = null;

        const getWeekOfMonth = (date) => {
            const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
            return Math.ceil((date.getDate() + firstDayOfMonth) / 7);
        };

        const generateMergedFileName = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const week = String(getWeekOfMonth(now)).padStart(2, '0');
            return `[í†µí•©]${year}_${month}_${week}_íšŒì˜ë¡.html`;
        };

        const checkFilesAndToggleMergeButton = () => {
            mergeBtn.disabled = !(sourceFile && targetFile);
        };

        const handleFile = (file, fileVarSetter, fileNameSpan, iconEl, dropAreaEl) => {
            if (!file || !file.type.match('text/html')) {
                statusDiv.textContent = 'ì˜¬ë°”ë¥¸ HTML íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
                statusDiv.className = 'error';
                return;
            }
            fileVarSetter(file);
            fileNameSpan.textContent = file.name;
            iconEl.textContent = 'âœ”ï¸';
            dropAreaEl.classList.add('file-loaded');
            statusDiv.textContent = '';
            statusDiv.className = '';
            checkFilesAndToggleMergeButton();
        };

        sourceFileInput.addEventListener('change', () => handleFile(sourceFileInput.files[0], (file) => sourceFile = file, sourceFileNameSpan, sourceIcon, sourceDropArea));
        targetFileInput.addEventListener('change', () => handleFile(targetFileInput.files[0], (file) => targetFile = file, targetFileNameSpan, targetIcon, targetDropArea));

        const setupDragDrop = (dropArea, fileInput) => {
            dropArea.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false));
            ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false));
            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                if (dt.files.length > 0) {
                    fileInput.files = dt.files;
                    const changeEvent = new Event('change');
                    fileInput.dispatchEvent(changeEvent);
                }
            }, false);
        };

        setupDragDrop(sourceDropArea, sourceFileInput);
        setupDragDrop(targetDropArea, targetFileInput);

        // --- START: ìµœì¢… í•µì‹¬ ë¡œì§ (ë§ˆìŠ¤í„° í…œí”Œë¦¿ ê¸°ë°˜ ë°ì´í„° ì£¼ì…) ---
        mergeBtn.addEventListener('click', async () => {
            try {
                statusDiv.textContent = 'íŒŒì¼ì„ ë¶„ì„í•˜ê³  í•©ì¹˜ëŠ” ì¤‘...';
                statusDiv.className = 'processing';

                const sourceContent = await sourceFile.text();
                const targetContent = await targetFile.text();

                const parser = new DOMParser();
                
                // 1. ì›ë³¸(ì§€ë‚œ ì£¼) ë¬¸ì„œë¥¼ íŒŒì‹±í•˜ì—¬ 'ê¸ˆì£¼(this-week)' ì»¬ëŸ¼ ì¶”ì¶œ
                const sourceDoc = parser.parseFromString(sourceContent, 'text/html');
                const sourceThisWeekColumn = sourceDoc.querySelector('.column[data-column-type="this-week"]');
                if (!sourceThisWeekColumn) throw new Error("ì§€ë‚œ ì£¼ íŒŒì¼ì—ì„œ 'ê¸ˆì£¼' ì˜ì—­(.column[data-column-type=\"this-week\"])ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                
                // 2. ëŒ€ìƒ(ì´ë²ˆ ì£¼ ì–‘ì‹) ë¬¸ì„œë¥¼ íŒŒì‹±
                const targetDoc = parser.parseFromString(targetContent, 'text/html');
                const targetLastWeekColumn = targetDoc.querySelector('.column[data-column-type="last-week"]');
                if (!targetLastWeekColumn) throw new Error("ìƒˆë¡œìš´ ì–‘ì‹ íŒŒì¼ì—ì„œ 'ì „ì£¼' ì˜ì—­(.column[data-column-type=\"last-week\"])ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                
                // 3. 'ì§€ë‚œì£¼' íŒŒì¼ì—ì„œ í•„ìš”í•œ ë°ì´í„°ë§Œ ì¶”ì¶œ
                const sourceTitleElement = sourceThisWeekColumn.querySelector('.column-title');
                const sourceContentNodes = sourceThisWeekColumn.querySelectorAll(':scope > *:not(.column-title)');
                
                // 4. ëŒ€ìƒ 'ì „ì£¼' ì»¬ëŸ¼ì˜ ì œëª©ê³¼ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸
                const targetTitleSpan = targetLastWeekColumn.querySelector('.column-title span[data-editable-type="column-title-text"]');
                if (targetTitleSpan && sourceTitleElement) {
                    const sourceTitleText = sourceTitleElement.textContent.trim().replace(/^ê¸ˆì£¼/, 'ì „ì£¼');
                    targetTitleSpan.textContent = sourceTitleText;
                }
                
                // ëŒ€ìƒì˜ ê¸°ì¡´ ë‚´ìš© ì‚­ì œ
                targetLastWeekColumn.querySelectorAll(':scope > *:not(.column-title)').forEach(el => el.remove());
                
                // ì¶”ì¶œí•œ ë‚´ìš©ì„ ëŒ€ìƒì— ì¶”ê°€
                sourceContentNodes.forEach(node => {
                    targetLastWeekColumn.appendChild(node.cloneNode(true));
                });
                
                // 5. ìˆ˜ì •ëœ ë¬¸ì„œ ê°ì²´ë¥¼ ë‹¤ì‹œ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ìµœì¢… HTML ìƒì„±
                let finalHTML = '<!DOCTYPE html>\n' + targetDoc.documentElement.outerHTML;
                
                // 6. í†µí•©ëœ íŒŒì¼ì— ë‚¨ì•„ìˆì„ ìˆ˜ ìˆëŠ” ëª¨ë“  __SAVED_APP_STATE__ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì œê±°
                finalHTML = finalHTML.replace(/<script[^>]*>window\.__SAVED_APP_STATE__.*?<\/script>/gs, '');

                // 7. íŒŒì¼ ì €ì¥
                const newFileName = generateMergedFileName();
                if (window.showSaveFilePicker) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: newFileName,
                        types: [{ description: 'HTML íŒŒì¼', accept: { 'text/html': ['.html'] } }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(finalHTML);
                    await writable.close();
                    statusDiv.textContent = `ì„±ê³µ! íŒŒì¼ì´ ì§€ì •ëœ ìœ„ì¹˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                } else {
                    const blob = new Blob([finalHTML], { type: 'text/html;charset=utf-8' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = newFileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                    statusDiv.textContent = `ì„±ê³µ! íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                }
                statusDiv.className = 'success';

            } catch (error) {
                statusDiv.textContent = `ì˜¤ë¥˜: ${error.message}`;
                statusDiv.className = 'error';
                console.error(error);
            }
        });
        // --- END: í•µì‹¬ ë¡œì§ ---
    </script>
</body>
</html>